From 01fdc3a3136911a317970ba28e8faa9e7bc1bcb1 Mon Sep 17 00:00:00 2001
From: wangtongli <tongliwang@tju.edu.cn>
Date: Tue, 15 Nov 2016 03:10:11 +0800
Subject: [PATCH] fix-double-app

---
 .../com/android/server/am/ActiveServices.smali     |  234 +-
 .../ActivityManagerService$1StoppingReceiver.smali |    2 +-
 .../server/am/ActivityManagerService$MemItem.smali |   12 +-
 ...agerService$userStoppingBroadcastRunnable.smali |  101 +
 .../android/server/am/ActivityManagerService.smali | 4317 +++++++++++---------
 .../com/android/server/am/ActivityStack.smali      |  567 ++-
 .../server/am/ActivityStackSupervisor.smali        | 1546 +++----
 .../com/android/server/am/BroadcastQueue.smali     |  349 +-
 .../com/android/server/am/ServiceRecord$1.smali    |   12 +-
 .../smali/com/android/server/pm/Installer.smali    |  111 +-
 .../pm/PackageManagerService$PackageHandler.smali  |   43 +-
 ...anagerService$deleteApplicationCacheFiles.smali |  132 +
 ...ManagerService$processPackageManagerQueue.smali |   65 +
 .../android/server/pm/PackageManagerService.smali  | 2009 +++------
 .../smali/com/android/server/pm/Settings.smali     |   59 +-
 .../com/android/server/pm/UserManagerService.smali |  956 +----
 16 files changed, 5310 insertions(+), 5205 deletions(-)
 create mode 100644 services/smali/com/android/server/am/ActivityManagerService$userStoppingBroadcastRunnable.smali
 create mode 100644 services/smali/com/android/server/pm/PackageManagerService$deleteApplicationCacheFiles.smali
 create mode 100644 services/smali/com/android/server/pm/PackageManagerService$processPackageManagerQueue.smali

--- a/services/smali/com/android/server/am/ActiveServices.smali
+++ b/services/smali/com/android/server/am/ActiveServices.smali
@@ -1078,7 +1078,7 @@
     iget-object v5, v0, Lcom/android/server/am/ServiceRecord;->processName:Ljava/lang/String;
 
     .local v5, "procName":Ljava/lang/String;
-    if-nez v12, :cond_7
+    if-nez v12, :cond_8
 
     move-object/from16 v0, p0
 
@@ -1228,7 +1228,21 @@
     .end local v15    # "e":Landroid/os/RemoteException;
     :cond_6
     :goto_2
-    if-nez v14, :cond_9
+    if-nez v14, :cond_a
+
+    move-object/from16 v0, p1
+
+    iget-object v4, v0, Lcom/android/server/am/ServiceRecord;->name:Landroid/content/ComponentName;
+
+    move/from16 v0, p2
+
+    move/from16 v1, p4
+
+    invoke-static {v4, v0, v1}, Lcom/miui/whetstone/client/WhetstoneClientManager;->startServiceAllowed(Landroid/content/ComponentName;IZ)Z
+
+    move-result v4
+
+    if-eqz v4, :cond_7
 
     move-object/from16 v0, p0
 
@@ -1256,8 +1270,9 @@
 
     move-result-object v14
 
-    if-nez v14, :cond_8
+    if-nez v14, :cond_9
 
+    :cond_7
     new-instance v4, Ljava/lang/StringBuilder;
 
     invoke-direct {v4}, Ljava/lang/StringBuilder;-><init>()V
@@ -1342,7 +1357,7 @@
 
     .end local v14    # "app":Lcom/android/server/am/ProcessRecord;
     .end local v16    # "e":Landroid/os/TransactionTooLargeException;
-    :cond_7
+    :cond_8
     move-object/from16 v0, p1
 
     iget-object v14, v0, Lcom/android/server/am/ServiceRecord;->isolatedProc:Lcom/android/server/am/ProcessRecord;
@@ -1350,14 +1365,14 @@
     .restart local v14    # "app":Lcom/android/server/am/ProcessRecord;
     goto :goto_2
 
-    :cond_8
-    if-eqz v12, :cond_9
+    :cond_9
+    if-eqz v12, :cond_a
 
     move-object/from16 v0, p1
 
     iput-object v14, v0, Lcom/android/server/am/ServiceRecord;->isolatedProc:Lcom/android/server/am/ProcessRecord;
 
-    :cond_9
+    :cond_a
     move-object/from16 v0, p0
 
     iget-object v4, v0, Lcom/android/server/am/ActiveServices;->mPendingServices:Ljava/util/ArrayList;
@@ -1368,7 +1383,7 @@
 
     move-result v4
 
-    if-nez v4, :cond_a
+    if-nez v4, :cond_b
 
     move-object/from16 v0, p0
 
@@ -1378,12 +1393,12 @@
 
     invoke-virtual {v4, v0}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
 
-    :cond_a
+    :cond_b
     move-object/from16 v0, p1
 
     iget-boolean v4, v0, Lcom/android/server/am/ServiceRecord;->delayedStop:Z
 
-    if-eqz v4, :cond_b
+    if-eqz v4, :cond_c
 
     const/4 v4, 0x0
 
@@ -1395,11 +1410,11 @@
 
     iget-boolean v4, v0, Lcom/android/server/am/ServiceRecord;->startRequested:Z
 
-    if-eqz v4, :cond_b
+    if-eqz v4, :cond_c
 
     invoke-direct/range {p0 .. p1}, Lcom/android/server/am/ActiveServices;->stopServiceLocked(Lcom/android/server/am/ServiceRecord;)V
 
-    :cond_b
+    :cond_c
     const/4 v4, 0x0
 
     return-object v4
@@ -3519,6 +3534,29 @@
     .param p2, "allowCancel"    # Z
 
     .prologue
+    if-eqz p2, :cond_rick0
+
+    move-object/from16 v0, p0
+
+    iget-object v0, v0, Lcom/android/server/am/ActiveServices;->mAm:Lcom/android/server/am/ActivityManagerService;
+
+    move-object/from16 v20, v0
+
+    move-object/from16 v0, p1
+
+    move-object/from16 v1, v20
+
+    invoke-static {v0, v1}, Lcom/android/server/am/ActiveServicesInjector;->canRestartServiceLocked(Lcom/android/server/am/ServiceRecord;Lcom/android/server/am/ActivityManagerService;)Z
+
+    move-result v20
+
+    if-nez v20, :cond_rick0
+
+    const/16 v20, 0x1
+
+    return v20
+
+    :cond_rick0
     const/4 v5, 0x0
 
     .local v5, "canceled":Z
@@ -6094,6 +6132,60 @@
 
     invoke-static/range {v20 .. v21}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
+    const/16 v4, 0x7577
+
+    const/4 v5, 0x6
+
+    new-array v5, v5, [Ljava/lang/Object;
+
+    const/4 v6, 0x0
+
+    iget v7, v13, Lcom/android/server/am/ProcessRecord;->uid:I
+
+    invoke-static {v7}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v7
+
+    aput-object v7, v5, v6
+
+    const/4 v6, 0x1
+
+    iget-object v7, v13, Lcom/android/server/am/ProcessRecord;->processName:Ljava/lang/String;
+
+    aput-object v7, v5, v6
+
+    const/4 v6, 0x2
+
+    move-object/from16 v0, v22
+
+    iget-object v7, v0, Lcom/android/server/am/ServiceRecord;->appInfo:Landroid/content/pm/ApplicationInfo;
+
+    iget v7, v7, Landroid/content/pm/ApplicationInfo;->uid:I
+
+    invoke-static {v7}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v7
+
+    aput-object v7, v5, v6
+
+    const/4 v6, 0x3
+
+    move-object/from16 v0, v22
+
+    iget-object v7, v0, Lcom/android/server/am/ServiceRecord;->processName:Ljava/lang/String;
+
+    aput-object v7, v5, v6
+
+    const/4 v6, 0x4
+
+    move-object/from16 v0, v22
+
+    iget-object v7, v0, Lcom/android/server/am/ServiceRecord;->shortName:Ljava/lang/String;
+
+    aput-object v7, v5, v6
+
+    const/4 v6, 0x5
+
     const/4 v4, 0x1
 
     return v4
@@ -12493,7 +12585,7 @@
 .end method
 
 .method startServiceLocked(Landroid/app/IApplicationThread;Landroid/content/Intent;Ljava/lang/String;IILjava/lang/String;I)Landroid/content/ComponentName;
-    .locals 20
+    .locals 21
     .param p1, "caller"    # Landroid/app/IApplicationThread;
     .param p2, "service"    # Landroid/content/Intent;
     .param p3, "resolvedType"    # Ljava/lang/String;
@@ -12629,6 +12721,9 @@
     const/4 v10, 0x1
 
     .restart local v10    # "callerFg":Z
+    const/16 v17, 0x0
+
+    .restart local v17    # "callerApp":Lcom/android/server/am/ProcessRecord;
     goto :goto_0
 
     .restart local v19    # "res":Lcom/android/server/am/ActiveServices$ServiceLookupResult;
@@ -12911,8 +13006,111 @@
 
     invoke-virtual/range {v11 .. v16}, Lcom/android/server/am/ActiveServices;->startServiceInnerLocked(Lcom/android/server/am/ActiveServices$ServiceMap;Landroid/content/Intent;Lcom/android/server/am/ServiceRecord;ZZ)Landroid/content/ComponentName;
 
+    move-result-object v20
+
+    .local v20, "retName":Landroid/content/ComponentName;
+    const/16 v3, 0x7576
+
+    const/4 v2, 0x6
+
+    new-array v4, v2, [Ljava/lang/Object;
+
+    const/4 v5, 0x0
+
+    if-eqz v17, :cond_d
+
+    move-object/from16 v0, v17
+
+    iget v2, v0, Lcom/android/server/am/ProcessRecord;->uid:I
+
+    :goto_3
+    invoke-static {v2}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
     move-result-object v2
 
+    aput-object v2, v4, v5
+
+    const/4 v5, 0x1
+
+    if-eqz v17, :cond_e
+
+    move-object/from16 v0, v17
+
+    iget-object v2, v0, Lcom/android/server/am/ProcessRecord;->processName:Ljava/lang/String;
+
+    :goto_4
+    aput-object v2, v4, v5
+
+    const/4 v2, 0x2
+
+    iget-object v5, v14, Lcom/android/server/am/ServiceRecord;->appInfo:Landroid/content/pm/ApplicationInfo;
+
+    iget v5, v5, Landroid/content/pm/ApplicationInfo;->uid:I
+
+    invoke-static {v5}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v5
+
+    aput-object v5, v4, v2
+
+    const/4 v2, 0x3
+
+    iget-object v5, v14, Lcom/android/server/am/ServiceRecord;->processName:Ljava/lang/String;
+
+    aput-object v5, v4, v2
+
+    const/4 v2, 0x4
+
+    iget-object v5, v14, Lcom/android/server/am/ServiceRecord;->shortName:Ljava/lang/String;
+
+    aput-object v5, v4, v2
+
+    const/4 v2, 0x5
+
+    new-instance v5, Ljava/lang/StringBuilder;
+
+    invoke-direct {v5}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v6, "{"
+
+    invoke-virtual {v5, v6}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v5
+
+    const/4 v6, 0x0
+
+    const/4 v8, 0x1
+
+    const/4 v9, 0x0
+
+    const/4 v11, 0x0
+
+    move-object/from16 v0, p2
+
+    invoke-virtual {v0, v6, v8, v9, v11}, Landroid/content/Intent;->toShortString(ZZZZ)Ljava/lang/String;
+
+    move-result-object v6
+
+    invoke-virtual {v5, v6}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v5
+
+    const-string v6, "}"
+
+    invoke-virtual {v5, v6}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v5
+
+    invoke-virtual {v5}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v5
+
+    aput-object v5, v4, v2
+
+    invoke-static {v3, v4}, Landroid/util/EventLog;->writeEvent(I[Ljava/lang/Object;)I
+
+    move-object/from16 v2, v20
+
     return-object v2
 
     .restart local v18    # "proc":Lcom/android/server/am/ProcessRecord;
@@ -12928,6 +13126,16 @@
     const/16 v16, 0x1
 
     goto :goto_2
+
+    :cond_d
+    const/4 v2, -0x1
+
+    goto :goto_3
+
+    :cond_e
+    const/4 v2, 0x0
+
+    goto :goto_4
 .end method
 
 .method stopServiceLocked(Landroid/app/IApplicationThread;Landroid/content/Intent;Ljava/lang/String;I)I
--- a/services/smali/com/android/server/am/ActivityManagerService$1StoppingReceiver.smali
+++ b/services/smali/com/android/server/am/ActivityManagerService$1StoppingReceiver.smali
@@ -247,7 +247,7 @@
     move/from16 v18, v0
 
     # invokes: Lcom/android/server/am/ActivityManagerService;->broadcastIntentLocked(Lcom/android/server/am/ProcessRecord;Ljava/lang/String;Landroid/content/Intent;Ljava/lang/String;Landroid/content/IIntentReceiver;ILjava/lang/String;Landroid/os/Bundle;[Ljava/lang/String;ILandroid/os/Bundle;ZZIII)I
-    invoke-static/range {v2 .. v18}, Lcom/android/server/am/ActivityManagerService;->access$200(Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/ProcessRecord;Ljava/lang/String;Landroid/content/Intent;Ljava/lang/String;Landroid/content/IIntentReceiver;ILjava/lang/String;Landroid/os/Bundle;[Ljava/lang/String;ILandroid/os/Bundle;ZZIII)I
+    invoke-static/range {v2 .. v18}, Lcom/android/server/am/ActivityManagerService;->-wrap5(Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/ProcessRecord;Ljava/lang/String;Landroid/content/Intent;Ljava/lang/String;Landroid/content/IIntentReceiver;ILjava/lang/String;Landroid/os/Bundle;[Ljava/lang/String;ILandroid/os/Bundle;ZZIII)I
 
     goto/16 :goto_0
 .end method
--- a/services/smali/com/android/server/am/ActivityManagerService$MemItem.smali
+++ b/services/smali/com/android/server/am/ActivityManagerService$MemItem.smali
@@ -41,7 +41,7 @@
 
 # direct methods
 .method public constructor <init>(Ljava/lang/String;Ljava/lang/String;JI)V
-    .locals 1
+    .locals 3
     .param p1, "_label"    # Ljava/lang/String;
     .param p2, "_shortLabel"    # Ljava/lang/String;
     .param p3, "_pss"    # J
@@ -60,6 +60,10 @@
 
     iput-wide p3, p0, Lcom/android/server/am/ActivityManagerService$MemItem;->pss:J
 
+    const-wide/16 v1, 0x0
+
+    iput-wide v1, p0, Lcom/android/server/am/ActivityManagerService$MemItem;->swap:J
+
     iput p5, p0, Lcom/android/server/am/ActivityManagerService$MemItem;->id:I
 
     iput-boolean v0, p0, Lcom/android/server/am/ActivityManagerService$MemItem;->hasActivities:Z
@@ -68,7 +72,7 @@
 .end method
 
 .method public constructor <init>(Ljava/lang/String;Ljava/lang/String;JIZ)V
-    .locals 1
+    .locals 3
     .param p1, "_label"    # Ljava/lang/String;
     .param p2, "_shortLabel"    # Ljava/lang/String;
     .param p3, "_pss"    # J
@@ -88,6 +92,10 @@
 
     iput-wide p3, p0, Lcom/android/server/am/ActivityManagerService$MemItem;->pss:J
 
+    const-wide/16 v0, 0x0
+
+    iput-wide v0, p0, Lcom/android/server/am/ActivityManagerService$MemItem;->swap:J
+
     iput p5, p0, Lcom/android/server/am/ActivityManagerService$MemItem;->id:I
 
     iput-boolean p6, p0, Lcom/android/server/am/ActivityManagerService$MemItem;->hasActivities:Z
--- a/services/smali/com/android/server/am/ActivityManagerService$userStoppingBroadcastRunnable.smali
+++ b/services/smali/com/android/server/am/ActivityManagerService$userStoppingBroadcastRunnable.smali
@@ -0,0 +1,101 @@
+.class Lcom/android/server/am/ActivityManagerService$userStoppingBroadcastRunnable;
+.super Ljava/lang/Object;
+.source "ActivityManagerService.java"
+
+# interfaces
+.implements Ljava/lang/Runnable;
+
+
+# annotations
+.annotation system Ldalvik/annotation/EnclosingMethod;
+    value = Lcom/android/server/am/ActivityManagerService;->stopUserLocked(ILandroid/app/IStopUserCallback;)I
+.end annotation
+
+.annotation system Ldalvik/annotation/InnerClass;
+    accessFlags = 0x0
+    name = null
+.end annotation
+
+
+# instance fields
+.field final synthetic this$0:Lcom/android/server/am/ActivityManagerService;
+
+.field final synthetic val$stoppingIntent:Landroid/content/Intent;
+
+.field final synthetic val$stoppingReceiver:Lcom/android/server/am/ActivityManagerService$1StoppingReceiver;
+
+
+# direct methods
+.method constructor <init>(Lcom/android/server/am/ActivityManagerService;Landroid/content/Intent;Lcom/android/server/am/ActivityManagerService$1StoppingReceiver;)V
+    .locals 0
+
+    .prologue
+    iput-object p1, p0, Lcom/android/server/am/ActivityManagerService$userStoppingBroadcastRunnable;->this$0:Lcom/android/server/am/ActivityManagerService;
+
+    iput-object p2, p0, Lcom/android/server/am/ActivityManagerService$userStoppingBroadcastRunnable;->val$stoppingIntent:Landroid/content/Intent;
+
+    iput-object p3, p0, Lcom/android/server/am/ActivityManagerService$userStoppingBroadcastRunnable;->val$stoppingReceiver:Lcom/android/server/am/ActivityManagerService$1StoppingReceiver;
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public run()V
+    .locals 18
+
+    .prologue
+    move-object/from16 v0, p0
+
+    iget-object v1, v0, Lcom/android/server/am/ActivityManagerService$userStoppingBroadcastRunnable;->this$0:Lcom/android/server/am/ActivityManagerService;
+
+    const/4 v2, 0x0
+
+    const/4 v3, 0x0
+
+    move-object/from16 v0, p0
+
+    iget-object v4, v0, Lcom/android/server/am/ActivityManagerService$userStoppingBroadcastRunnable;->val$stoppingIntent:Landroid/content/Intent;
+
+    const/4 v5, 0x0
+
+    move-object/from16 v0, p0
+
+    iget-object v6, v0, Lcom/android/server/am/ActivityManagerService$userStoppingBroadcastRunnable;->val$stoppingReceiver:Lcom/android/server/am/ActivityManagerService$1StoppingReceiver;
+
+    const/4 v7, -0x1
+
+    const/4 v8, 0x0
+
+    const/4 v9, 0x0
+
+    const/4 v10, 0x1
+
+    new-array v10, v10, [Ljava/lang/String;
+
+    const/4 v11, 0x0
+
+    const-string v12, "android.permission.INTERACT_ACROSS_USERS"
+
+    aput-object v12, v10, v11
+
+    const/4 v11, -0x1
+
+    const/4 v12, 0x0
+
+    const/4 v13, 0x1
+
+    const/4 v14, 0x0
+
+    sget v15, Lcom/android/server/am/ActivityManagerService;->MY_PID:I
+
+    const/16 v16, 0x3e8
+
+    const/16 v17, -0x1
+
+    invoke-static/range {v1 .. v17}, Lcom/android/server/am/ActivityManagerService;->-wrap5(Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/ProcessRecord;Ljava/lang/String;Landroid/content/Intent;Ljava/lang/String;Landroid/content/IIntentReceiver;ILjava/lang/String;Landroid/os/Bundle;[Ljava/lang/String;ILandroid/os/Bundle;ZZIII)I
+
+    return-void
+.end method
--- a/services/smali/com/android/server/am/ActivityManagerService.smali
+++ b/services/smali/com/android/server/am/ActivityManagerService.smali
@@ -2445,6 +2445,10 @@
     .local v8, "systemDir":Ljava/io/File;
     invoke-virtual {v8}, Ljava/io/File;->mkdirs()Z
 
+    iget-object v0, p0, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+
+    invoke-static {v0}, Lcom/android/server/am/ActivityManagerServiceInjector;->init(Landroid/content/Context;)V
+
     new-instance v0, Lcom/android/server/am/BatteryStatsService;
 
     iget-object v1, p0, Lcom/android/server/am/ActivityManagerService;->mHandler:Lcom/android/server/am/ActivityManagerService$MainHandler;
@@ -5061,9 +5065,15 @@
 
     move-object/from16 v0, p0
 
-    iget-object v6, v0, Lcom/android/server/am/ActivityManagerService;->mBackupAppName:Ljava/lang/String;
+    iget-object v6, v0, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
 
-    invoke-virtual {v6, v7}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    move-object/from16 v0, p0
+
+    iget-object v10, v0, Lcom/android/server/am/ActivityManagerService;->mBackupAppName:Ljava/lang/String;
+
+    move-object/from16 v0, v24
+
+    invoke-static {v6, v10, v0}, Lcom/android/server/am/ActivityManagerServiceInjector;->isStartWithBackupRestriction(Landroid/content/Context;Ljava/lang/String;Lcom/android/server/am/ProcessRecord;)Z
 
     move-result v6
 
@@ -5801,6 +5811,10 @@
 
     .end local p3    # "intent":Landroid/content/Intent;
     .local v14, "intent":Landroid/content/Intent;
+    move-object/from16 v0, p2
+
+    invoke-virtual {v14, v0}, Landroid/content/Intent;->setSender(Ljava/lang/String;)V
+
     const/16 v4, 0x10
 
     invoke-virtual {v14, v4}, Landroid/content/Intent;->addFlags(I)Landroid/content/Intent;
@@ -8600,7 +8614,24 @@
     const/4 v15, 0x0
 
     .local v15, "checkedGrants":Z
-    if-eqz p4, :cond_4
+    if-eqz p2, :cond_2
+
+    move-object/from16 v0, p2
+
+    iget-object v4, v0, Lcom/android/server/am/ProcessRecord;->processName:Ljava/lang/String;
+
+    :goto_2
+    move-object/from16 v0, p1
+
+    move/from16 v1, p3
+
+    move/from16 v2, p4
+
+    invoke-static {v0, v4, v1, v2}, Lmiui/securityspace/CrossUserUtils;->needCheckUser(Landroid/content/pm/ProviderInfo;Ljava/lang/String;IZ)Z
+
+    move-result p4
+
+    if-eqz p4, :cond_5
 
     move-object/from16 v0, p0
 
@@ -8617,7 +8648,7 @@
 
     move/from16 v0, v20
 
-    if-eq v0, v4, :cond_3
+    if-eq v0, v4, :cond_4
 
     move-object/from16 v0, p0
 
@@ -8631,7 +8662,7 @@
 
     move-result v4
 
-    if-eqz v4, :cond_2
+    if-eqz v4, :cond_3
 
     const/4 v4, 0x0
 
@@ -8658,11 +8689,16 @@
     goto :goto_1
 
     .restart local v15    # "checkedGrants":Z
-    .restart local v20    # "tmpTargetUserId":I
     :cond_2
-    const/4 v15, 0x1
+    const/4 v4, 0x0
+
+    goto :goto_2
 
+    .restart local v20    # "tmpTargetUserId":I
     :cond_3
+    const/4 v15, 0x1
+
+    :cond_4
     new-instance v4, Ljava/lang/StringBuilder;
 
     invoke-direct {v4}, Ljava/lang/StringBuilder;-><init>()V
@@ -8703,12 +8739,12 @@
 
     move/from16 v1, v20
 
-    if-eq v0, v1, :cond_4
+    if-eq v0, v1, :cond_5
 
     const/4 v15, 0x0
 
     .end local v20    # "tmpTargetUserId":I
-    :cond_4
+    :cond_5
     move-object/from16 v0, p1
 
     iget-object v8, v0, Landroid/content/pm/ProviderInfo;->readPermission:Ljava/lang/String;
@@ -8733,13 +8769,13 @@
 
     move-result v4
 
-    if-nez v4, :cond_5
+    if-nez v4, :cond_6
 
     const/4 v4, 0x0
 
     return-object v4
 
-    :cond_5
+    :cond_6
     move-object/from16 v0, p1
 
     iget-object v8, v0, Landroid/content/pm/ProviderInfo;->writePermission:Ljava/lang/String;
@@ -8764,13 +8800,13 @@
 
     move-result v4
 
-    if-nez v4, :cond_6
+    if-nez v4, :cond_7
 
     const/4 v4, 0x0
 
     return-object v4
 
-    :cond_6
+    :cond_7
     move-object/from16 v0, p1
 
     iget-object v0, v0, Landroid/content/pm/ProviderInfo;->pathPermissions:[Landroid/content/pm/PathPermission;
@@ -8778,7 +8814,7 @@
     move-object/from16 v19, v0
 
     .local v19, "pps":[Landroid/content/pm/PathPermission;
-    if-eqz v19, :cond_9
+    if-eqz v19, :cond_a
 
     move-object/from16 v0, v19
 
@@ -8787,8 +8823,8 @@
     move/from16 v16, v0
 
     .local v16, "i":I
-    :cond_7
-    if-lez v16, :cond_9
+    :cond_8
+    if-lez v16, :cond_a
 
     add-int/lit8 v16, v16, -0x1
 
@@ -8800,7 +8836,7 @@
     move-result-object v8
 
     .local v8, "pprperm":Ljava/lang/String;
-    if-eqz v8, :cond_8
+    if-eqz v8, :cond_9
 
     move-object/from16 v0, p1
 
@@ -8822,19 +8858,19 @@
 
     move-result v4
 
-    if-nez v4, :cond_8
+    if-nez v4, :cond_9
 
     const/4 v4, 0x0
 
     return-object v4
 
-    :cond_8
+    :cond_9
     invoke-virtual/range {v18 .. v18}, Landroid/content/pm/PathPermission;->getWritePermission()Ljava/lang/String;
 
     move-result-object v10
 
     .local v10, "ppwperm":Ljava/lang/String;
-    if-eqz v10, :cond_7
+    if-eqz v10, :cond_8
 
     move-object/from16 v0, p1
 
@@ -8856,7 +8892,7 @@
 
     move-result v4
 
-    if-nez v4, :cond_7
+    if-nez v4, :cond_8
 
     const/4 v4, 0x0
 
@@ -8866,8 +8902,8 @@
     .end local v10    # "ppwperm":Ljava/lang/String;
     .end local v16    # "i":I
     .end local v18    # "pp":Landroid/content/pm/PathPermission;
-    :cond_9
-    if-nez v15, :cond_a
+    :cond_a
+    if-nez v15, :cond_b
 
     move-object/from16 v0, p0
 
@@ -8881,18 +8917,18 @@
 
     move-result v4
 
-    if-eqz v4, :cond_a
+    if-eqz v4, :cond_b
 
     const/4 v4, 0x0
 
     return-object v4
 
-    :cond_a
+    :cond_b
     move-object/from16 v0, p1
 
     iget-boolean v4, v0, Landroid/content/pm/ProviderInfo;->exported:Z
 
-    if-nez v4, :cond_c
+    if-nez v4, :cond_d
 
     new-instance v4, Ljava/lang/StringBuilder;
 
@@ -8918,10 +8954,10 @@
 
     move-result-object v4
 
-    if-eqz p2, :cond_b
+    if-eqz p2, :cond_c
 
     .end local p2    # "r":Lcom/android/server/am/ProcessRecord;
-    :goto_2
+    :goto_3
     move-object/from16 v0, p2
 
     invoke-virtual {v4, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/Object;)Ljava/lang/StringBuilder;
@@ -8969,7 +9005,7 @@
     move-result-object v17
 
     .local v17, "msg":Ljava/lang/String;
-    :goto_3
+    :goto_4
     const-string v4, "ActivityManager"
 
     move-object/from16 v0, v17
@@ -8980,12 +9016,12 @@
 
     .end local v17    # "msg":Ljava/lang/String;
     .restart local p2    # "r":Lcom/android/server/am/ProcessRecord;
-    :cond_b
+    :cond_c
     const-string p2, "(null)"
 
-    goto :goto_2
+    goto :goto_3
 
-    :cond_c
+    :cond_d
     new-instance v4, Ljava/lang/StringBuilder;
 
     invoke-direct {v4}, Ljava/lang/StringBuilder;-><init>()V
@@ -9010,10 +9046,10 @@
 
     move-result-object v4
 
-    if-eqz p2, :cond_d
+    if-eqz p2, :cond_e
 
     .end local p2    # "r":Lcom/android/server/am/ProcessRecord;
-    :goto_4
+    :goto_5
     move-object/from16 v0, p2
 
     invoke-virtual {v4, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/Object;)Ljava/lang/StringBuilder;
@@ -9073,14 +9109,14 @@
     move-result-object v17
 
     .restart local v17    # "msg":Ljava/lang/String;
-    goto :goto_3
+    goto :goto_4
 
     .end local v17    # "msg":Ljava/lang/String;
     .restart local p2    # "r":Lcom/android/server/am/ProcessRecord;
-    :cond_d
+    :cond_e
     const-string p2, "(null)"
 
-    goto :goto_4
+    goto :goto_5
 .end method
 
 .method private final checkHoldingPermissionsInternalLocked(Landroid/content/pm/IPackageManager;Landroid/content/pm/ProviderInfo;Lcom/android/server/am/ActivityManagerService$GrantUri;IIZ)Z
@@ -14573,6 +14609,12 @@
 
     invoke-virtual {v13, v5, v0}, Ljava/util/HashMap;->put(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;
 
+    const-string v5, "crash"
+
+    move-object/from16 v0, p2
+
+    invoke-virtual {v13, v5, v0}, Ljava/util/HashMap;->put(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;
+
     move-object/from16 v0, v17
 
     iput-object v13, v0, Landroid/os/Message;->obj:Ljava/lang/Object;
@@ -16056,7 +16098,7 @@
 
     if-eqz p4, :cond_0
 
-    if-eqz p5, :cond_2
+    if-eqz p5, :cond_3
 
     :cond_0
     :goto_0
@@ -16068,7 +16110,7 @@
 
     move-result v0
 
-    if-ge v6, v0, :cond_6
+    if-ge v6, v0, :cond_7
 
     invoke-virtual {p3, v6}, Ljava/util/ArrayList;->get(I)Ljava/lang/Object;
 
@@ -16077,7 +16119,7 @@
     check-cast v7, Lcom/android/server/am/ActivityManagerService$MemItem;
 
     .local v7, "mi":Lcom/android/server/am/ActivityManagerService$MemItem;
-    if-nez p5, :cond_3
+    if-nez p5, :cond_4
 
     invoke-virtual {p0, p1}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
@@ -16097,6 +16139,27 @@
 
     invoke-virtual {p0, v0, v1}, Ljava/io/PrintWriter;->printf(Ljava/lang/String;[Ljava/lang/Object;)Ljava/io/PrintWriter;
 
+    const-string v0, "cat"
+
+    if-eq p2, v0, :cond_1
+
+    const-string v0, "%7d kB: "
+
+    new-array v1, v4, [Ljava/lang/Object;
+
+    iget-wide v2, v7, Lcom/android/server/am/ActivityManagerService$MemItem;->swap:J
+
+    invoke-static {v2, v3}, Ljava/lang/Long;->valueOf(J)Ljava/lang/Long;
+
+    move-result-object v2
+
+    const/4 v3, 0x0
+
+    aput-object v2, v1, v3
+
+    invoke-virtual {p0, v0, v1}, Ljava/io/PrintWriter;->printf(Ljava/lang/String;[Ljava/lang/Object;)Ljava/io/PrintWriter;
+
+    :cond_1
     iget-object v0, v7, Lcom/android/server/am/ActivityManagerService$MemItem;->label:Ljava/lang/String;
 
     invoke-virtual {p0, v0}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
@@ -16104,7 +16167,7 @@
     :goto_2
     iget-object v0, v7, Lcom/android/server/am/ActivityManagerService$MemItem;->subitems:Ljava/util/ArrayList;
 
-    if-eqz v0, :cond_1
+    if-eqz v0, :cond_2
 
     new-instance v0, Ljava/lang/StringBuilder;
 
@@ -16134,14 +16197,14 @@
 
     invoke-static/range {v0 .. v5}, Lcom/android/server/am/ActivityManagerService;->dumpMemItems(Ljava/io/PrintWriter;Ljava/lang/String;Ljava/lang/String;Ljava/util/ArrayList;ZZ)V
 
-    :cond_1
+    :cond_2
     add-int/lit8 v6, v6, 0x1
 
     goto :goto_1
 
     .end local v6    # "i":I
     .end local v7    # "mi":Lcom/android/server/am/ActivityManagerService$MemItem;
-    :cond_2
+    :cond_3
     new-instance v0, Lcom/android/server/am/ActivityManagerService$21;
 
     invoke-direct {v0}, Lcom/android/server/am/ActivityManagerService$21;-><init>()V
@@ -16152,10 +16215,10 @@
 
     .restart local v6    # "i":I
     .restart local v7    # "mi":Lcom/android/server/am/ActivityManagerService$MemItem;
-    :cond_3
+    :cond_4
     iget-boolean v0, v7, Lcom/android/server/am/ActivityManagerService$MemItem;->isProc:Z
 
-    if-eqz v0, :cond_5
+    if-eqz v0, :cond_6
 
     const-string v0, "proc,"
 
@@ -16189,7 +16252,7 @@
 
     iget-boolean v0, v7, Lcom/android/server/am/ActivityManagerService$MemItem;->hasActivities:Z
 
-    if-eqz v0, :cond_4
+    if-eqz v0, :cond_5
 
     const-string v0, ",a"
 
@@ -16198,12 +16261,12 @@
 
     goto :goto_2
 
-    :cond_4
+    :cond_5
     const-string v0, ",e"
 
     goto :goto_3
 
-    :cond_5
+    :cond_6
     invoke-virtual {p0, p2}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
     const-string v0, ","
@@ -16225,7 +16288,7 @@
     goto/16 :goto_2
 
     .end local v7    # "mi":Lcom/android/server/am/ActivityManagerService$MemItem;
-    :cond_6
+    :cond_7
     return-void
 .end method
 
@@ -19379,6 +19442,14 @@
     .end local v19    # "ip":I
     .end local v22    # "pmap":Landroid/util/ArrayMap;, "Landroid/util/ArrayMap<Ljava/lang/String;Landroid/util/SparseArray<Ljava/lang/Long;>;>;"
     :cond_9
+    move-object/from16 v0, p0
+
+    iget-object v3, v0, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+
+    move-object/from16 v0, p1
+
+    invoke-static {v3, v0}, Lcom/android/server/am/ActivityManagerServiceInjector;->killNativePackageProcesses(Landroid/content/Context;Ljava/lang/String;)V
+
     if-nez p1, :cond_a
 
     new-instance v3, Ljava/lang/StringBuilder;
@@ -19948,6 +20019,8 @@
 
     invoke-direct/range {v1 .. v17}, Lcom/android/server/am/ActivityManagerService;->broadcastIntentLocked(Lcom/android/server/am/ProcessRecord;Ljava/lang/String;Landroid/content/Intent;Ljava/lang/String;Landroid/content/IIntentReceiver;ILjava/lang/String;Landroid/os/Bundle;[Ljava/lang/String;ILandroid/os/Bundle;ZZIII)I
 
+    invoke-static/range {p1 .. p2}, Lcom/android/server/am/ActivityManagerServiceInjector;->forceStopUserLocked(ILjava/lang/String;)V
+
     return-void
 .end method
 
@@ -20367,7 +20440,7 @@
 .end method
 
 .method private final getContentProviderImpl(Landroid/app/IApplicationThread;Ljava/lang/String;Landroid/os/IBinder;ZI)Landroid/app/IActivityManager$ContentProviderHolder;
-    .locals 43
+    .locals 40
     .param p1, "caller"    # Landroid/app/IApplicationThread;
     .param p2, "name"    # Ljava/lang/String;
     .param p3, "token"    # Landroid/os/IBinder;
@@ -20386,20 +20459,19 @@
     :try_start_0
     invoke-static {}, Landroid/os/SystemClock;->elapsedRealtime()J
 
-    move-result-wide v40
+    move-result-wide v38
 
-    .local v40, "startTime":J
-    const/16 v39, 0x0
+    .local v38, "startTime":J
+    const/16 v36, 0x0
 
-    .local v39, "r":Lcom/android/server/am/ProcessRecord;
+    .local v36, "r":Lcom/android/server/am/ProcessRecord;
     if-eqz p1, :cond_0
 
     invoke-virtual/range {p0 .. p1}, Lcom/android/server/am/ActivityManagerService;->getRecordForAppLocked(Landroid/app/IApplicationThread;)Lcom/android/server/am/ProcessRecord;
 
-    move-result-object v39
+    move-result-object v36
 
-    .local v39, "r":Lcom/android/server/am/ProcessRecord;
-    if-nez v39, :cond_0
+    if-nez v36, :cond_0
 
     new-instance v5, Ljava/lang/SecurityException;
 
@@ -20452,23 +20524,20 @@
     invoke-direct {v5, v10}, Ljava/lang/SecurityException;-><init>(Ljava/lang/String;)V
 
     throw v5
-    :try_end_0
-    .catchall {:try_start_0 .. :try_end_0} :catchall_0
 
-    .end local v6    # "cpi":Landroid/content/pm/ProviderInfo;
-    .end local v22    # "conn":Lcom/android/server/am/ContentProviderConnection;
-    .end local v39    # "r":Lcom/android/server/am/ProcessRecord;
-    .end local v40    # "startTime":J
+    .end local v36    # "r":Lcom/android/server/am/ProcessRecord;
+    .end local v38    # "startTime":J
     :catchall_0
     move-exception v5
 
     monitor-exit p0
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
 
     throw v5
 
-    .restart local v6    # "cpi":Landroid/content/pm/ProviderInfo;
-    .restart local v22    # "conn":Lcom/android/server/am/ContentProviderConnection;
-    .restart local v40    # "startTime":J
+    .restart local v36    # "r":Lcom/android/server/am/ProcessRecord;
+    .restart local v38    # "startTime":J
     :cond_0
     const/16 v21, 0x1
 
@@ -20478,7 +20547,7 @@
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
@@ -20515,7 +20584,6 @@
 
     iget-object v6, v4, Lcom/android/server/am/ContentProviderRecord;->info:Landroid/content/pm/ProviderInfo;
 
-    .local v6, "cpi":Landroid/content/pm/ProviderInfo;
     iget-object v5, v6, Landroid/content/pm/ProviderInfo;->processName:Ljava/lang/String;
 
     iget-object v10, v6, Landroid/content/pm/ProviderInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
@@ -20532,7 +20600,7 @@
 
     if-eqz v5, :cond_2
 
-    move-object/from16 v0, v39
+    move-object/from16 v0, v36
 
     iget v5, v0, Lcom/android/server/am/ProcessRecord;->uid:I
 
@@ -20552,32 +20620,29 @@
 
     const/16 v21, 0x0
 
-    .end local v4    # "cpr":Lcom/android/server/am/ContentProviderRecord;
-    .end local v6    # "cpi":Landroid/content/pm/ProviderInfo;
     :cond_1
     :goto_0
-    if-eqz v4, :cond_3
+    if-eqz v4, :cond_4
 
-    const/16 v38, 0x1
+    const/16 v35, 0x1
 
-    .local v38, "providerRunning":Z
+    .local v35, "providerRunning":Z
     :goto_1
-    if-eqz v38, :cond_a
+    if-eqz v35, :cond_b
 
     iget-object v6, v4, Lcom/android/server/am/ContentProviderRecord;->info:Landroid/content/pm/ProviderInfo;
 
-    .restart local v6    # "cpi":Landroid/content/pm/ProviderInfo;
     const-string v5, "getContentProviderImpl: before checkContentProviderPermission"
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
     move-object/from16 v0, p0
 
-    move-object/from16 v1, v39
+    move-object/from16 v1, v36
 
     move/from16 v2, p5
 
@@ -20585,101 +20650,117 @@
 
     invoke-direct {v0, v6, v1, v2, v3}, Lcom/android/server/am/ActivityManagerService;->checkContentProviderPermissionLocked(Landroid/content/pm/ProviderInfo;Lcom/android/server/am/ProcessRecord;IZ)Ljava/lang/String;
 
-    move-result-object v34
+    move-result-object v31
 
-    .local v34, "msg":Ljava/lang/String;
-    if-eqz v34, :cond_4
+    .local v31, "msg":Ljava/lang/String;
+    if-eqz v31, :cond_5
 
     new-instance v5, Ljava/lang/SecurityException;
 
-    move-object/from16 v0, v34
+    move-object/from16 v0, v31
 
     invoke-direct {v5, v0}, Ljava/lang/SecurityException;-><init>(Ljava/lang/String;)V
 
     throw v5
 
-    .end local v34    # "msg":Ljava/lang/String;
-    .end local v38    # "providerRunning":Z
-    .restart local v4    # "cpr":Lcom/android/server/am/ContentProviderRecord;
+    .end local v31    # "msg":Ljava/lang/String;
+    .end local v35    # "providerRunning":Z
     :cond_2
+    invoke-static/range {p5 .. p5}, Lmiui/securityspace/XSpaceUserHandle;->isXSpaceUserId(I)Z
+
+    move-result v5
+
+    if-eqz v5, :cond_3
+
+    move-object/from16 v0, p0
+
+    move-object/from16 v1, p2
+
+    move/from16 v2, p5
+
+    invoke-direct {v0, v1, v2}, Lcom/android/server/am/ActivityManagerService;->getProviderInfoLocked(Ljava/lang/String;I)Landroid/content/pm/ProviderInfo;
+
+    move-result-object v5
+
+    if-nez v5, :cond_3
+
+    const/16 p5, 0x0
+
+    const/16 v21, 0x0
+
+    goto :goto_0
+
+    :cond_3
     const/4 v4, 0x0
 
-    .local v4, "cpr":Lcom/android/server/am/ContentProviderRecord;
     const/4 v6, 0x0
 
-    .local v6, "cpi":Landroid/content/pm/ProviderInfo;
     goto :goto_0
 
-    .end local v4    # "cpr":Lcom/android/server/am/ContentProviderRecord;
-    .end local v6    # "cpi":Landroid/content/pm/ProviderInfo;
-    :cond_3
-    const/16 v38, 0x0
+    :cond_4
+    const/16 v35, 0x0
 
-    .restart local v38    # "providerRunning":Z
     goto :goto_1
 
-    .local v6, "cpi":Landroid/content/pm/ProviderInfo;
-    .restart local v34    # "msg":Ljava/lang/String;
-    :cond_4
+    .restart local v31    # "msg":Ljava/lang/String;
+    .restart local v35    # "providerRunning":Z
+    :cond_5
     const-string v5, "getContentProviderImpl: after checkContentProviderPermission"
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
-    if-eqz v39, :cond_5
+    if-eqz v36, :cond_6
 
-    move-object/from16 v0, v39
+    move-object/from16 v0, v36
 
     invoke-virtual {v4, v0}, Lcom/android/server/am/ContentProviderRecord;->canRunHere(Lcom/android/server/am/ProcessRecord;)Z
 
     move-result v5
 
-    if-eqz v5, :cond_5
+    if-eqz v5, :cond_6
 
     const/4 v5, 0x0
 
     invoke-virtual {v4, v5}, Lcom/android/server/am/ContentProviderRecord;->newHolder(Lcom/android/server/am/ContentProviderConnection;)Landroid/app/IActivityManager$ContentProviderHolder;
 
-    move-result-object v29
+    move-result-object v26
 
-    .local v29, "holder":Landroid/app/IActivityManager$ContentProviderHolder;
+    .local v26, "holder":Landroid/app/IActivityManager$ContentProviderHolder;
     const/4 v5, 0x0
 
-    move-object/from16 v0, v29
+    move-object/from16 v0, v26
 
     iput-object v5, v0, Landroid/app/IActivityManager$ContentProviderHolder;->provider:Landroid/content/IContentProvider;
-    :try_end_1
-    .catchall {:try_start_1 .. :try_end_1} :catchall_0
 
     monitor-exit p0
 
-    return-object v29
+    .end local v26    # "holder":Landroid/app/IActivityManager$ContentProviderHolder;
+    .end local v31    # "msg":Ljava/lang/String;
+    :goto_2
+    return-object v26
 
-    .end local v29    # "holder":Landroid/app/IActivityManager$ContentProviderHolder;
-    :cond_5
-    :try_start_2
+    .restart local v31    # "msg":Ljava/lang/String;
+    :cond_6
     invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
 
-    move-result-wide v36
+    move-result-wide v32
 
-    .local v36, "origId":J
+    .local v32, "origId":J
     const-string v5, "getContentProviderImpl: incProviderCountLocked"
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
-    const/16 v31, 0x0
-
-    .local v31, "importantCaller":Z
     move-object/from16 v0, p0
 
-    move-object/from16 v1, v39
+    move-object/from16 v1, v36
 
     move-object/from16 v2, p3
 
@@ -20689,8 +20770,7 @@
 
     move-result-object v22
 
-    .local v22, "conn":Lcom/android/server/am/ContentProviderConnection;
-    if-eqz v22, :cond_6
+    if-eqz v22, :cond_7
 
     move-object/from16 v0, v22
 
@@ -20704,27 +20784,25 @@
 
     const/4 v10, 0x1
 
-    if-ne v5, v10, :cond_6
+    if-ne v5, v10, :cond_7
 
     iget-object v5, v4, Lcom/android/server/am/ContentProviderRecord;->proc:Lcom/android/server/am/ProcessRecord;
 
-    if-eqz v5, :cond_6
+    if-eqz v5, :cond_7
 
-    move-object/from16 v0, v39
+    move-object/from16 v0, v36
 
     iget v5, v0, Lcom/android/server/am/ProcessRecord;->setAdj:I
 
     const/4 v10, 0x2
 
-    if-gt v5, v10, :cond_6
-
-    const/16 v31, 0x1
+    if-gt v5, v10, :cond_7
 
     const-string v5, "getContentProviderImpl: before updateLruProcess"
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
@@ -20742,32 +20820,20 @@
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
-    :cond_6
-    iget-object v5, v4, Lcom/android/server/am/ContentProviderRecord;->proc:Lcom/android/server/am/ProcessRecord;
-
-    if-eqz v5, :cond_9
-
+    :cond_7
     iget-object v5, v4, Lcom/android/server/am/ContentProviderRecord;->proc:Lcom/android/server/am/ProcessRecord;
 
-    iget-boolean v5, v5, Lcom/android/server/am/ProcessRecord;->killedByAm:Z
-
-    if-eqz v5, :cond_b
-
-    const/16 v42, 0x0
-
-    .local v42, "success":Z
-    :goto_2
-    if-eqz v42, :cond_7
+    if-eqz v5, :cond_a
 
     const-string v5, "getContentProviderImpl: before updateOomAdj"
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
@@ -20777,16 +20843,16 @@
 
     invoke-virtual {v0, v5}, Lcom/android/server/am/ActivityManagerService;->updateOomAdjLocked(Lcom/android/server/am/ProcessRecord;)Z
 
-    move-result v42
+    move-result v37
 
-    .local v42, "success":Z
+    .local v37, "success":Z
     iget-object v5, v4, Lcom/android/server/am/ContentProviderRecord;->info:Landroid/content/pm/ProviderInfo;
 
     iget-object v5, v5, Landroid/content/pm/ProviderInfo;->packageName:Ljava/lang/String;
 
     move-object/from16 v0, p0
 
-    move-object/from16 v1, v39
+    move-object/from16 v1, v36
 
     move-object/from16 v2, p2
 
@@ -20796,28 +20862,19 @@
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
-    .end local v42    # "success":Z
-    :cond_7
-    if-eqz v42, :cond_8
-
-    if-eqz v31, :cond_8
-
-    if-eqz v39, :cond_8
+    if-eqz v37, :cond_8
 
-    move-object/from16 v0, v39
+    iget-object v5, v4, Lcom/android/server/am/ContentProviderRecord;->proc:Lcom/android/server/am/ProcessRecord;
 
-    iget-boolean v5, v0, Lcom/android/server/am/ProcessRecord;->persistent:Z
+    iget-boolean v5, v5, Lcom/android/server/am/ProcessRecord;->killedByAm:Z
 
-    if-eqz v5, :cond_c
+    if-eqz v5, :cond_a
 
     :cond_8
-    :goto_3
-    if-nez v42, :cond_9
-
     const-string v5, "ActivityManager"
 
     new-instance v10, Ljava/lang/StringBuilder;
@@ -20840,13 +20897,13 @@
 
     move-result-object v10
 
-    const-string v11, " is gone; waiting it to restart for "
+    const-string v11, " is crashing; detaching "
 
     invoke-virtual {v10, v11}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
     move-result-object v10
 
-    move-object/from16 v0, v39
+    move-object/from16 v0, v36
 
     invoke-virtual {v10, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/Object;)Ljava/lang/StringBuilder;
 
@@ -20858,39 +20915,72 @@
 
     invoke-static {v5, v10}, Landroid/util/Slog;->i(Ljava/lang/String;Ljava/lang/String;)I
 
-    const/4 v5, 0x0
+    move-object/from16 v0, p0
+
+    move-object/from16 v1, v22
+
+    move-object/from16 v2, p3
+
+    move/from16 v3, p4
+
+    invoke-virtual {v0, v1, v4, v2, v3}, Lcom/android/server/am/ActivityManagerService;->decProviderCountLocked(Lcom/android/server/am/ContentProviderConnection;Lcom/android/server/am/ContentProviderRecord;Landroid/os/IBinder;Z)Z
+
+    move-result v30
+
+    .local v30, "lastRef":Z
+    const-string v5, "getContentProviderImpl: before appDied"
+
+    move-object/from16 v0, p0
 
-    iput-object v5, v4, Lcom/android/server/am/ContentProviderRecord;->provider:Landroid/content/IContentProvider;
+    move-wide/from16 v1, v38
+
+    invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
     iget-object v5, v4, Lcom/android/server/am/ContentProviderRecord;->proc:Lcom/android/server/am/ProcessRecord;
 
-    iput-object v5, v4, Lcom/android/server/am/ContentProviderRecord;->launchingApp:Lcom/android/server/am/ProcessRecord;
+    move-object/from16 v0, p0
+
+    invoke-virtual {v0, v5}, Lcom/android/server/am/ActivityManagerService;->appDiedLocked(Lcom/android/server/am/ProcessRecord;)V
+
+    const-string v5, "getContentProviderImpl: after appDied"
 
     move-object/from16 v0, p0
 
-    iget-object v5, v0, Lcom/android/server/am/ActivityManagerService;->mLaunchingProviders:Ljava/util/ArrayList;
+    move-wide/from16 v1, v38
 
-    invoke-virtual {v5, v4}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
+    invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
+
+    if-nez v30, :cond_9
+
+    const/16 v26, 0x0
+
+    monitor-exit p0
+
+    goto/16 :goto_2
 
     :cond_9
-    invoke-static/range {v36 .. v37}, Landroid/os/Binder;->restoreCallingIdentity(J)V
-    :try_end_2
-    .catchall {:try_start_2 .. :try_end_2} :catchall_0
+    const/16 v35, 0x0
+
+    const/16 v22, 0x0
 
-    .end local v6    # "cpi":Landroid/content/pm/ProviderInfo;
-    .end local v22    # "conn":Lcom/android/server/am/ContentProviderConnection;
-    .end local v31    # "importantCaller":Z
-    .end local v34    # "msg":Ljava/lang/String;
-    .end local v36    # "origId":J
+    .end local v30    # "lastRef":Z
+    .end local v37    # "success":Z
     :cond_a
-    if-nez v38, :cond_1d
+    invoke-static/range {v32 .. v33}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_0
 
-    :try_start_3
+    .end local v31    # "msg":Ljava/lang/String;
+    .end local v32    # "origId":J
+    :cond_b
+    if-nez v35, :cond_1b
+
+    :try_start_2
     const-string v5, "getContentProviderImpl: before resolveContentProvider"
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
@@ -20908,77 +20998,60 @@
 
     move-result-object v6
 
-    .restart local v6    # "cpi":Landroid/content/pm/ProviderInfo;
     const-string v5, "getContentProviderImpl: after resolveContentProvider"
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
-    :try_end_3
-    .catch Landroid/os/RemoteException; {:try_start_3 .. :try_end_3} :catch_5
-    .catchall {:try_start_3 .. :try_end_3} :catchall_0
-
-    .end local v6    # "cpi":Landroid/content/pm/ProviderInfo;
-    :goto_4
-    if-nez v6, :cond_d
+    :try_end_2
+    .catch Landroid/os/RemoteException; {:try_start_2 .. :try_end_2} :catch_6
+    .catchall {:try_start_2 .. :try_end_2} :catchall_0
 
-    const/4 v5, 0x0
+    :goto_3
+    if-nez v6, :cond_c
 
-    monitor-exit p0
+    :try_start_3
+    invoke-static/range {p5 .. p5}, Lmiui/securityspace/XSpaceUserHandle;->isXSpaceUserId(I)Z
+    :try_end_3
+    .catchall {:try_start_3 .. :try_end_3} :catchall_0
 
-    return-object v5
+    move-result v5
 
-    .restart local v6    # "cpi":Landroid/content/pm/ProviderInfo;
-    .restart local v22    # "conn":Lcom/android/server/am/ContentProviderConnection;
-    .restart local v31    # "importantCaller":Z
-    .restart local v34    # "msg":Ljava/lang/String;
-    .restart local v36    # "origId":J
-    :cond_b
-    const/16 v42, 0x1
+    if-eqz v5, :cond_c
 
-    .local v42, "success":Z
-    goto/16 :goto_2
+    const/16 p5, 0x0
 
-    .end local v42    # "success":Z
-    :cond_c
     :try_start_4
-    move-object/from16 v0, v39
-
-    iget v5, v0, Lcom/android/server/am/ProcessRecord;->pid:I
-
-    iget-object v10, v4, Lcom/android/server/am/ContentProviderRecord;->proc:Lcom/android/server/am/ProcessRecord;
-
-    iget v10, v10, Lcom/android/server/am/ProcessRecord;->pid:I
+    invoke-static {}, Landroid/app/AppGlobals;->getPackageManager()Landroid/content/pm/IPackageManager;
 
-    if-eq v5, v10, :cond_8
+    move-result-object v5
 
-    iget-object v5, v4, Lcom/android/server/am/ContentProviderRecord;->proc:Lcom/android/server/am/ProcessRecord;
+    const/16 v10, 0xc00
 
-    iget-boolean v5, v5, Lcom/android/server/am/ProcessRecord;->persistent:Z
+    move-object/from16 v0, p2
 
-    if-nez v5, :cond_8
+    move/from16 v1, p5
 
-    iget-object v5, v4, Lcom/android/server/am/ContentProviderRecord;->proc:Lcom/android/server/am/ProcessRecord;
+    invoke-interface {v5, v0, v10, v1}, Landroid/content/pm/IPackageManager;->resolveContentProvider(Ljava/lang/String;II)Landroid/content/pm/ProviderInfo;
+    :try_end_4
+    .catch Landroid/os/RemoteException; {:try_start_4 .. :try_end_4} :catch_5
+    .catchall {:try_start_4 .. :try_end_4} :catchall_0
 
-    iget v5, v5, Lcom/android/server/am/ProcessRecord;->pid:I
+    move-result-object v6
 
-    const/4 v10, 0x1
+    :cond_c
+    :goto_4
+    if-nez v6, :cond_d
 
-    invoke-static {v5, v10}, Lcom/android/server/am/ProcessList;->isAlive(IZ)Z
+    const/16 v26, 0x0
 
-    move-result v42
+    :try_start_5
+    monitor-exit p0
 
-    .local v42, "success":Z
-    goto/16 :goto_3
+    goto/16 :goto_2
 
-    .end local v6    # "cpi":Landroid/content/pm/ProviderInfo;
-    .end local v22    # "conn":Lcom/android/server/am/ContentProviderConnection;
-    .end local v31    # "importantCaller":Z
-    .end local v34    # "msg":Ljava/lang/String;
-    .end local v36    # "origId":J
-    .end local v42    # "success":Z
     :cond_d
     iget-object v5, v6, Landroid/content/pm/ProviderInfo;->processName:Ljava/lang/String;
 
@@ -20996,7 +21069,7 @@
 
     if-eqz v5, :cond_f
 
-    move-object/from16 v0, v39
+    move-object/from16 v0, v36
 
     iget v5, v0, Lcom/android/server/am/ProcessRecord;->uid:I
 
@@ -21008,8 +21081,13 @@
 
     invoke-virtual {v0, v5, v10}, Lcom/android/server/am/ActivityManagerService;->isValidSingletonCall(II)Z
 
-    move-result v9
+    move-result v5
+
+    if-eqz v5, :cond_f
+
+    const/4 v9, 0x1
 
+    .local v9, "singleton":Z
     :goto_5
     if-eqz v9, :cond_e
 
@@ -21032,7 +21110,7 @@
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
@@ -21040,56 +21118,56 @@
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
-    if-eqz v9, :cond_10
+    if-nez v9, :cond_10
 
-    const/4 v5, 0x0
+    const/4 v5, 0x1
 
     :goto_6
     move-object/from16 v0, p0
 
-    move-object/from16 v1, v39
+    move-object/from16 v1, v36
 
     move/from16 v2, p5
 
     invoke-direct {v0, v6, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkContentProviderPermissionLocked(Landroid/content/pm/ProviderInfo;Lcom/android/server/am/ProcessRecord;IZ)Ljava/lang/String;
 
-    move-result-object v34
+    move-result-object v31
 
-    .restart local v34    # "msg":Ljava/lang/String;
-    if-eqz v34, :cond_11
+    .restart local v31    # "msg":Ljava/lang/String;
+    if-eqz v31, :cond_11
 
     new-instance v5, Ljava/lang/SecurityException;
 
-    move-object/from16 v0, v34
+    move-object/from16 v0, v31
 
     invoke-direct {v5, v0}, Ljava/lang/SecurityException;-><init>(Ljava/lang/String;)V
 
     throw v5
 
-    .end local v34    # "msg":Ljava/lang/String;
+    .end local v9    # "singleton":Z
+    .end local v31    # "msg":Ljava/lang/String;
     :cond_f
     const/4 v9, 0x0
 
-    .local v9, "singleton":Z
     goto :goto_5
 
-    .end local v9    # "singleton":Z
+    .restart local v9    # "singleton":Z
     :cond_10
-    const/4 v5, 0x1
+    const/4 v5, 0x0
 
     goto :goto_6
 
-    .restart local v34    # "msg":Ljava/lang/String;
+    .restart local v31    # "msg":Ljava/lang/String;
     :cond_11
     const-string v5, "getContentProviderImpl: after checkContentProviderPermission"
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
@@ -21103,7 +21181,31 @@
 
     iget-boolean v5, v0, Lcom/android/server/am/ActivityManagerService;->mDidUpdate:Z
 
-    if-eqz v5, :cond_13
+    if-nez v5, :cond_12
+
+    move-object/from16 v0, p0
+
+    iget-boolean v5, v0, Lcom/android/server/am/ActivityManagerService;->mWaitingUpdate:Z
+
+    if-nez v5, :cond_12
+
+    iget-object v5, v6, Landroid/content/pm/ProviderInfo;->processName:Ljava/lang/String;
+
+    const-string v10, "system"
+
+    invoke-virtual {v5, v10}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v5
+
+    if-nez v5, :cond_12
+
+    new-instance v5, Ljava/lang/IllegalArgumentException;
+
+    const-string v10, "Attempt to launch content provider before system ready"
+
+    invoke-direct {v5, v10}, Ljava/lang/IllegalArgumentException;-><init>(Ljava/lang/String;)V
+
+    throw v5
 
     :cond_12
     const/4 v5, 0x0
@@ -21116,7 +21218,7 @@
 
     move-result v5
 
-    if-nez v5, :cond_14
+    if-nez v5, :cond_13
 
     const-string v5, "ActivityManager"
 
@@ -21187,42 +21289,14 @@
     move-result-object v10
 
     invoke-static {v5, v10}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
-    :try_end_4
-    .catchall {:try_start_4 .. :try_end_4} :catchall_0
 
-    const/4 v5, 0x0
+    const/16 v26, 0x0
 
     monitor-exit p0
 
-    return-object v5
+    goto/16 :goto_2
 
     :cond_13
-    :try_start_5
-    move-object/from16 v0, p0
-
-    iget-boolean v5, v0, Lcom/android/server/am/ActivityManagerService;->mWaitingUpdate:Z
-
-    if-nez v5, :cond_12
-
-    iget-object v5, v6, Landroid/content/pm/ProviderInfo;->processName:Ljava/lang/String;
-
-    const-string v10, "system"
-
-    invoke-virtual {v5, v10}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
-
-    move-result v5
-
-    if-nez v5, :cond_12
-
-    new-instance v5, Ljava/lang/IllegalArgumentException;
-
-    const-string v10, "Attempt to launch content provider before system ready"
-
-    invoke-direct {v5, v10}, Ljava/lang/IllegalArgumentException;-><init>(Ljava/lang/String;)V
-
-    throw v5
-
-    :cond_14
     new-instance v8, Landroid/content/ComponentName;
 
     iget-object v5, v6, Landroid/content/pm/ProviderInfo;->packageName:Ljava/lang/String;
@@ -21236,7 +21310,7 @@
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
@@ -21250,36 +21324,37 @@
 
     move-result-object v23
 
+    .end local v4    # "cpr":Lcom/android/server/am/ContentProviderRecord;
     .local v23, "cpr":Lcom/android/server/am/ContentProviderRecord;
     const-string v5, "getContentProviderImpl: after getProviderByClass"
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
-    if-nez v23, :cond_15
+    if-nez v23, :cond_14
 
-    const/16 v28, 0x1
+    const/16 v25, 0x1
 
-    .local v28, "firstClass":Z
+    .local v25, "firstClass":Z
     :goto_7
-    if-eqz v28, :cond_17
+    if-eqz v25, :cond_27
 
     invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
     :try_end_5
     .catchall {:try_start_5 .. :try_end_5} :catchall_0
 
-    move-result-wide v32
+    move-result-wide v28
 
-    .local v32, "ident":J
+    .local v28, "ident":J
     :try_start_6
     const-string v5, "getContentProviderImpl: before getApplicationInfo"
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
@@ -21304,11 +21379,11 @@
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
-    if-nez v7, :cond_16
+    if-nez v7, :cond_15
 
     const-string v5, "ActivityManager"
 
@@ -21337,29 +21412,35 @@
     .catch Landroid/os/RemoteException; {:try_start_6 .. :try_end_6} :catch_0
     .catchall {:try_start_6 .. :try_end_6} :catchall_1
 
+    const/16 v26, 0x0
+
     :try_start_7
-    invoke-static/range {v32 .. v33}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    invoke-static/range {v28 .. v29}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    monitor-exit p0
     :try_end_7
     .catchall {:try_start_7 .. :try_end_7} :catchall_0
 
-    const/4 v5, 0x0
-
-    monitor-exit p0
+    move-object/from16 v4, v23
 
-    return-object v5
+    .end local v23    # "cpr":Lcom/android/server/am/ContentProviderRecord;
+    .restart local v4    # "cpr":Lcom/android/server/am/ContentProviderRecord;
+    goto/16 :goto_2
 
+    .end local v4    # "cpr":Lcom/android/server/am/ContentProviderRecord;
     .end local v7    # "ai":Landroid/content/pm/ApplicationInfo;
-    .end local v28    # "firstClass":Z
-    .end local v32    # "ident":J
-    :cond_15
-    const/16 v28, 0x0
+    .end local v25    # "firstClass":Z
+    .end local v28    # "ident":J
+    .restart local v23    # "cpr":Lcom/android/server/am/ContentProviderRecord;
+    :cond_14
+    const/16 v25, 0x0
 
-    .restart local v28    # "firstClass":Z
     goto :goto_7
 
     .restart local v7    # "ai":Landroid/content/pm/ApplicationInfo;
-    .restart local v32    # "ident":J
-    :cond_16
+    .restart local v25    # "firstClass":Z
+    .restart local v28    # "ident":J
+    :cond_15
     :try_start_8
     move-object/from16 v0, p0
 
@@ -21379,56 +21460,49 @@
     .catchall {:try_start_8 .. :try_end_8} :catchall_1
 
     .end local v23    # "cpr":Lcom/android/server/am/ContentProviderRecord;
-    .local v4, "cpr":Lcom/android/server/am/ContentProviderRecord;
+    .restart local v4    # "cpr":Lcom/android/server/am/ContentProviderRecord;
     :try_start_9
-    invoke-static/range {v32 .. v33}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    invoke-static/range {v28 .. v29}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
     .end local v7    # "ai":Landroid/content/pm/ApplicationInfo;
-    .end local v32    # "ident":J
+    .end local v28    # "ident":J
     :goto_8
     const-string v5, "getContentProviderImpl: now have ContentProviderRecord"
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
-    if-eqz v39, :cond_18
+    if-eqz v36, :cond_16
 
-    move-object/from16 v0, v39
+    move-object/from16 v0, v36
 
     invoke-virtual {v4, v0}, Lcom/android/server/am/ContentProviderRecord;->canRunHere(Lcom/android/server/am/ProcessRecord;)Z
 
     move-result v5
 
-    if-eqz v5, :cond_18
+    if-eqz v5, :cond_16
 
     const/4 v5, 0x0
 
     invoke-virtual {v4, v5}, Lcom/android/server/am/ContentProviderRecord;->newHolder(Lcom/android/server/am/ContentProviderConnection;)Landroid/app/IActivityManager$ContentProviderHolder;
-    :try_end_9
-    .catchall {:try_start_9 .. :try_end_9} :catchall_0
 
-    move-result-object v5
+    move-result-object v26
 
     monitor-exit p0
 
-    return-object v5
+    goto/16 :goto_2
 
     .end local v4    # "cpr":Lcom/android/server/am/ContentProviderRecord;
     .restart local v23    # "cpr":Lcom/android/server/am/ContentProviderRecord;
-    .restart local v32    # "ident":J
+    .restart local v28    # "ident":J
     :catch_0
-    move-exception v26
+    move-exception v5
 
-    .local v26, "ex":Landroid/os/RemoteException;
-    :try_start_a
-    invoke-static/range {v32 .. v33}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    invoke-static/range {v28 .. v29}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
-    .end local v26    # "ex":Landroid/os/RemoteException;
-    .end local v32    # "ident":J
-    :cond_17
     move-object/from16 v4, v23
 
     .end local v23    # "cpr":Lcom/android/server/am/ContentProviderRecord;
@@ -21437,18 +21511,17 @@
 
     .end local v4    # "cpr":Lcom/android/server/am/ContentProviderRecord;
     .restart local v23    # "cpr":Lcom/android/server/am/ContentProviderRecord;
-    .restart local v32    # "ident":J
     :catchall_1
     move-exception v5
 
-    invoke-static/range {v32 .. v33}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    invoke-static/range {v28 .. v29}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
     throw v5
 
     .end local v23    # "cpr":Lcom/android/server/am/ContentProviderRecord;
-    .end local v32    # "ident":J
+    .end local v28    # "ident":J
     .restart local v4    # "cpr":Lcom/android/server/am/ContentProviderRecord;
-    :cond_18
+    :cond_16
     move-object/from16 v0, p0
 
     iget-object v5, v0, Lcom/android/server/am/ActivityManagerService;->mLaunchingProviders:Ljava/util/ArrayList;
@@ -21458,48 +21531,48 @@
     move-result v20
 
     .local v20, "N":I
-    const/16 v30, 0x0
+    const/16 v27, 0x0
 
-    .local v30, "i":I
+    .local v27, "i":I
     :goto_9
-    move/from16 v0, v30
+    move/from16 v0, v27
 
     move/from16 v1, v20
 
-    if-ge v0, v1, :cond_19
+    if-ge v0, v1, :cond_17
 
     move-object/from16 v0, p0
 
     iget-object v5, v0, Lcom/android/server/am/ActivityManagerService;->mLaunchingProviders:Ljava/util/ArrayList;
 
-    move/from16 v0, v30
+    move/from16 v0, v27
 
     invoke-virtual {v5, v0}, Ljava/util/ArrayList;->get(I)Ljava/lang/Object;
 
     move-result-object v5
 
-    if-ne v5, v4, :cond_1f
+    if-ne v5, v4, :cond_1d
 
-    :cond_19
-    move/from16 v0, v30
+    :cond_17
+    move/from16 v0, v27
 
     move/from16 v1, v20
 
-    if-lt v0, v1, :cond_1b
+    if-lt v0, v1, :cond_19
 
     invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
-    :try_end_a
-    .catchall {:try_start_a .. :try_end_a} :catchall_0
+    :try_end_9
+    .catchall {:try_start_9 .. :try_end_9} :catchall_0
 
-    move-result-wide v36
+    move-result-wide v32
 
-    .restart local v36    # "origId":J
-    :try_start_b
+    .restart local v32    # "origId":J
+    :try_start_a
     const-string v5, "getContentProviderImpl: before set stopped state"
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
@@ -21521,21 +21594,21 @@
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
-    :try_end_b
-    .catch Landroid/os/RemoteException; {:try_start_b .. :try_end_b} :catch_4
-    .catch Ljava/lang/IllegalArgumentException; {:try_start_b .. :try_end_b} :catch_1
-    .catchall {:try_start_b .. :try_end_b} :catchall_2
+    :try_end_a
+    .catch Landroid/os/RemoteException; {:try_start_a .. :try_end_a} :catch_4
+    .catch Ljava/lang/IllegalArgumentException; {:try_start_a .. :try_end_a} :catch_1
+    .catchall {:try_start_a .. :try_end_a} :catchall_3
 
     :goto_a
-    :try_start_c
+    :try_start_b
     const-string v5, "getContentProviderImpl: looking for process record"
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
@@ -21551,18 +21624,18 @@
 
     invoke-virtual {v0, v5, v10, v11}, Lcom/android/server/am/ActivityManagerService;->getProcessRecordLocked(Ljava/lang/String;IZ)Lcom/android/server/am/ProcessRecord;
 
-    move-result-object v35
+    move-result-object v34
 
-    .local v35, "proc":Lcom/android/server/am/ProcessRecord;
-    if-eqz v35, :cond_20
+    .local v34, "proc":Lcom/android/server/am/ProcessRecord;
+    if-eqz v34, :cond_1e
 
-    move-object/from16 v0, v35
+    move-object/from16 v0, v34
 
     iget-object v5, v0, Lcom/android/server/am/ProcessRecord;->thread:Landroid/app/IApplicationThread;
 
-    if-eqz v5, :cond_20
+    if-eqz v5, :cond_1e
 
-    move-object/from16 v0, v35
+    move-object/from16 v0, v34
 
     iget-object v5, v0, Lcom/android/server/am/ProcessRecord;->pubProviders:Landroid/util/ArrayMap;
 
@@ -21572,40 +21645,40 @@
 
     move-result v5
 
-    if-nez v5, :cond_1a
+    if-nez v5, :cond_18
 
     const-string v5, "getContentProviderImpl: scheduling install"
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
-    move-object/from16 v0, v35
+    move-object/from16 v0, v34
 
     iget-object v5, v0, Lcom/android/server/am/ProcessRecord;->pubProviders:Landroid/util/ArrayMap;
 
     iget-object v10, v6, Landroid/content/pm/ProviderInfo;->name:Ljava/lang/String;
 
     invoke-virtual {v5, v10, v4}, Landroid/util/ArrayMap;->put(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;
-    :try_end_c
-    .catchall {:try_start_c .. :try_end_c} :catchall_2
+    :try_end_b
+    .catchall {:try_start_b .. :try_end_b} :catchall_3
 
-    :try_start_d
-    move-object/from16 v0, v35
+    :try_start_c
+    move-object/from16 v0, v34
 
     iget-object v5, v0, Lcom/android/server/am/ProcessRecord;->thread:Landroid/app/IApplicationThread;
 
     invoke-interface {v5, v6}, Landroid/app/IApplicationThread;->scheduleInstallProvider(Landroid/content/pm/ProviderInfo;)V
-    :try_end_d
-    .catch Landroid/os/RemoteException; {:try_start_d .. :try_end_d} :catch_3
-    .catchall {:try_start_d .. :try_end_d} :catchall_2
+    :try_end_c
+    .catch Landroid/os/RemoteException; {:try_start_c .. :try_end_c} :catch_3
+    .catchall {:try_start_c .. :try_end_c} :catchall_3
 
-    :cond_1a
+    :cond_18
     :goto_b
-    :try_start_e
-    move-object/from16 v0, v35
+    :try_start_d
+    move-object/from16 v0, v34
 
     iput-object v0, v4, Lcom/android/server/am/ContentProviderRecord;->launchingApp:Lcom/android/server/am/ProcessRecord;
 
@@ -21614,24 +21687,24 @@
     iget-object v5, v0, Lcom/android/server/am/ActivityManagerService;->mLaunchingProviders:Ljava/util/ArrayList;
 
     invoke-virtual {v5, v4}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
-    :try_end_e
-    .catchall {:try_start_e .. :try_end_e} :catchall_2
+    :try_end_d
+    .catchall {:try_start_d .. :try_end_d} :catchall_3
 
-    :try_start_f
-    invoke-static/range {v36 .. v37}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    :try_start_e
+    invoke-static/range {v32 .. v33}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
-    .end local v35    # "proc":Lcom/android/server/am/ProcessRecord;
-    .end local v36    # "origId":J
-    :cond_1b
+    .end local v32    # "origId":J
+    .end local v34    # "proc":Lcom/android/server/am/ProcessRecord;
+    :cond_19
     const-string v5, "getContentProviderImpl: updating data structures"
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
-    if-eqz v28, :cond_1c
+    if-eqz v25, :cond_1a
 
     move-object/from16 v0, p0
 
@@ -21639,7 +21712,7 @@
 
     invoke-virtual {v5, v8, v4}, Lcom/android/server/am/ProviderMap;->putProviderByClass(Landroid/content/ComponentName;Lcom/android/server/am/ContentProviderRecord;)V
 
-    :cond_1c
+    :cond_1a
     move-object/from16 v0, p0
 
     iget-object v5, v0, Lcom/android/server/am/ActivityManagerService;->mProviderMap:Lcom/android/server/am/ProviderMap;
@@ -21650,7 +21723,7 @@
 
     move-object/from16 v0, p0
 
-    move-object/from16 v1, v39
+    move-object/from16 v1, v36
 
     move-object/from16 v2, p3
 
@@ -21660,8 +21733,7 @@
 
     move-result-object v22
 
-    .restart local v22    # "conn":Lcom/android/server/am/ContentProviderConnection;
-    if-eqz v22, :cond_1d
+    if-eqz v22, :cond_1b
 
     const/4 v5, 0x1
 
@@ -21669,38 +21741,101 @@
 
     iput-boolean v5, v0, Lcom/android/server/am/ContentProviderConnection;->waiting:Z
 
-    .end local v4    # "cpr":Lcom/android/server/am/ContentProviderRecord;
     .end local v8    # "comp":Landroid/content/ComponentName;
+    .end local v9    # "singleton":Z
     .end local v20    # "N":I
-    .end local v22    # "conn":Lcom/android/server/am/ContentProviderConnection;
-    .end local v28    # "firstClass":Z
-    .end local v30    # "i":I
-    .end local v34    # "msg":Ljava/lang/String;
-    :cond_1d
+    .end local v25    # "firstClass":Z
+    .end local v27    # "i":I
+    .end local v31    # "msg":Ljava/lang/String;
+    :cond_1b
     const-string v5, "getContentProviderImpl: done!"
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
-    :try_end_f
-    .catchall {:try_start_f .. :try_end_f} :catchall_0
+
+    const/16 v10, 0x7579
+
+    const/4 v5, 0x5
+
+    new-array v11, v5, [Ljava/lang/Object;
+
+    const/4 v12, 0x0
+
+    if-eqz v36, :cond_20
+
+    move-object/from16 v0, v36
+
+    iget v5, v0, Lcom/android/server/am/ProcessRecord;->uid:I
+
+    :goto_c
+    invoke-static {v5}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v5
+
+    aput-object v5, v11, v12
+
+    const/4 v12, 0x1
+
+    if-eqz v36, :cond_21
+
+    move-object/from16 v0, v36
+
+    iget-object v5, v0, Lcom/android/server/am/ProcessRecord;->processName:Ljava/lang/String;
+
+    :goto_d
+    aput-object v5, v11, v12
+
+    const/4 v5, 0x2
+
+    iget-object v12, v4, Lcom/android/server/am/ContentProviderRecord;->appInfo:Landroid/content/pm/ApplicationInfo;
+
+    iget v12, v12, Landroid/content/pm/ApplicationInfo;->uid:I
+
+    invoke-static {v12}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v12
+
+    aput-object v12, v11, v5
+
+    const/4 v5, 0x3
+
+    iget-object v12, v4, Lcom/android/server/am/ContentProviderRecord;->appInfo:Landroid/content/pm/ApplicationInfo;
+
+    iget-object v12, v12, Landroid/content/pm/ApplicationInfo;->processName:Ljava/lang/String;
+
+    aput-object v12, v11, v5
+
+    const/4 v5, 0x4
+
+    iget-object v12, v4, Lcom/android/server/am/ContentProviderRecord;->name:Landroid/content/ComponentName;
+
+    invoke-virtual {v12}, Landroid/content/ComponentName;->flattenToShortString()Ljava/lang/String;
+
+    move-result-object v12
+
+    aput-object v12, v11, v5
+
+    invoke-static {v10, v11}, Landroid/util/EventLog;->writeEvent(I[Ljava/lang/Object;)I
 
     monitor-exit p0
+    :try_end_e
+    .catchall {:try_start_e .. :try_end_e} :catchall_0
 
     monitor-enter v4
 
-    :cond_1e
-    :goto_c
-    :try_start_10
+    :cond_1c
+    :goto_e
+    :try_start_f
     iget-object v5, v4, Lcom/android/server/am/ContentProviderRecord;->provider:Landroid/content/IContentProvider;
 
-    if-nez v5, :cond_24
+    if-nez v5, :cond_25
 
     iget-object v5, v4, Lcom/android/server/am/ContentProviderRecord;->launchingApp:Lcom/android/server/am/ProcessRecord;
 
-    if-nez v5, :cond_21
+    if-nez v5, :cond_22
 
     const-string v5, "ActivityManager"
 
@@ -21760,79 +21895,86 @@
 
     invoke-static {v5, v10}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
 
-    const/4 v5, 0x4
+    const/16 v5, 0x7554
 
-    new-array v5, v5, [Ljava/lang/Object;
+    const/4 v10, 0x4
 
-    iget-object v10, v6, Landroid/content/pm/ProviderInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
+    new-array v10, v10, [Ljava/lang/Object;
 
-    iget v10, v10, Landroid/content/pm/ApplicationInfo;->uid:I
+    const/4 v11, 0x0
 
-    invoke-static {v10}, Landroid/os/UserHandle;->getUserId(I)I
+    iget-object v12, v6, Landroid/content/pm/ProviderInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
 
-    move-result v10
+    iget v12, v12, Landroid/content/pm/ApplicationInfo;->uid:I
 
-    invoke-static {v10}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+    invoke-static {v12}, Landroid/os/UserHandle;->getUserId(I)I
 
-    move-result-object v10
-
-    const/4 v11, 0x0
+    move-result v12
 
-    aput-object v10, v5, v11
+    invoke-static {v12}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
-    iget-object v10, v6, Landroid/content/pm/ProviderInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
+    move-result-object v12
 
-    iget-object v10, v10, Landroid/content/pm/ApplicationInfo;->packageName:Ljava/lang/String;
+    aput-object v12, v10, v11
 
     const/4 v11, 0x1
 
-    aput-object v10, v5, v11
+    iget-object v12, v6, Landroid/content/pm/ProviderInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
 
-    iget-object v10, v6, Landroid/content/pm/ProviderInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
+    iget-object v12, v12, Landroid/content/pm/ApplicationInfo;->packageName:Ljava/lang/String;
 
-    iget v10, v10, Landroid/content/pm/ApplicationInfo;->uid:I
+    aput-object v12, v10, v11
 
-    invoke-static {v10}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+    const/4 v11, 0x2
 
-    move-result-object v10
+    iget-object v12, v6, Landroid/content/pm/ProviderInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
 
-    const/4 v11, 0x2
+    iget v12, v12, Landroid/content/pm/ApplicationInfo;->uid:I
 
-    aput-object v10, v5, v11
+    invoke-static {v12}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
-    const/4 v10, 0x3
+    move-result-object v12
 
-    aput-object p2, v5, v10
+    aput-object v12, v10, v11
 
-    const/16 v10, 0x7554
+    const/4 v11, 0x3
 
-    invoke-static {v10, v5}, Landroid/util/EventLog;->writeEvent(I[Ljava/lang/Object;)I
-    :try_end_10
-    .catchall {:try_start_10 .. :try_end_10} :catchall_3
+    aput-object p2, v10, v11
 
-    const/4 v5, 0x0
+    invoke-static {v5, v10}, Landroid/util/EventLog;->writeEvent(I[Ljava/lang/Object;)I
+
+    const/16 v26, 0x0
 
     monitor-exit v4
 
-    return-object v5
+    goto/16 :goto_2
+
+    :catchall_2
+    move-exception v5
+
+    monitor-exit v4
+    :try_end_f
+    .catchall {:try_start_f .. :try_end_f} :catchall_2
+
+    throw v5
 
-    .restart local v4    # "cpr":Lcom/android/server/am/ContentProviderRecord;
     .restart local v8    # "comp":Landroid/content/ComponentName;
+    .restart local v9    # "singleton":Z
     .restart local v20    # "N":I
-    .restart local v28    # "firstClass":Z
-    .restart local v30    # "i":I
-    .restart local v34    # "msg":Ljava/lang/String;
-    :cond_1f
-    add-int/lit8 v30, v30, 0x1
+    .restart local v25    # "firstClass":Z
+    .restart local v27    # "i":I
+    .restart local v31    # "msg":Ljava/lang/String;
+    :cond_1d
+    add-int/lit8 v27, v27, 0x1
 
     goto/16 :goto_9
 
-    .restart local v36    # "origId":J
+    .restart local v32    # "origId":J
     :catch_1
-    move-exception v25
+    move-exception v24
 
-    .local v25, "e":Ljava/lang/IllegalArgumentException;
-    :try_start_11
+    .local v24, "e":Ljava/lang/IllegalArgumentException;
+    :try_start_10
     const-string v5, "ActivityManager"
 
     new-instance v10, Ljava/lang/StringBuilder;
@@ -21859,7 +22001,7 @@
 
     move-result-object v10
 
-    move-object/from16 v0, v25
+    move-object/from16 v0, v24
 
     invoke-virtual {v10, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/Object;)Ljava/lang/StringBuilder;
 
@@ -21870,30 +22012,79 @@
     move-result-object v10
 
     invoke-static {v5, v10}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
-    :try_end_11
-    .catchall {:try_start_11 .. :try_end_11} :catchall_2
+    :try_end_10
+    .catchall {:try_start_10 .. :try_end_10} :catchall_3
 
     goto/16 :goto_a
 
-    .end local v25    # "e":Ljava/lang/IllegalArgumentException;
-    :catchall_2
+    .end local v24    # "e":Ljava/lang/IllegalArgumentException;
+    :catchall_3
     move-exception v5
 
-    :try_start_12
-    invoke-static/range {v36 .. v37}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    :try_start_11
+    invoke-static/range {v32 .. v33}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
     throw v5
+    :try_end_11
+    .catchall {:try_start_11 .. :try_end_11} :catchall_0
+
+    .restart local v34    # "proc":Lcom/android/server/am/ProcessRecord;
+    :cond_1e
+    :try_start_12
+    invoke-static/range {v32 .. v33}, Landroid/os/Binder;->restoreCallingIdentity(J)V
     :try_end_12
-    .catchall {:try_start_12 .. :try_end_12} :catchall_0
+    .catchall {:try_start_12 .. :try_end_12} :catchall_3
 
-    .restart local v35    # "proc":Lcom/android/server/am/ProcessRecord;
-    :cond_20
     :try_start_13
+    move-object/from16 v0, p0
+
+    iget-object v10, v0, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+
+    move-object/from16 v0, p0
+
+    iget-boolean v15, v0, Lcom/android/server/am/ActivityManagerService;->mSystemReady:Z
+
+    move-object/from16 v11, p0
+
+    move-object/from16 v12, p1
+
+    move-object v13, v4
+
+    move/from16 v14, p5
+
+    invoke-static/range {v10 .. v15}, Lcom/android/server/am/ExtraActivityManagerService;->checkRunningCompatibility(Landroid/content/Context;Lcom/android/server/am/ActivityManagerService;Landroid/app/IApplicationThread;Lcom/android/server/am/ContentProviderRecord;IZ)Z
+    :try_end_13
+    .catchall {:try_start_13 .. :try_end_13} :catchall_4
+
+    move-result v5
+
+    if-nez v5, :cond_1f
+
+    const/16 v26, 0x0
+
+    :try_start_14
+    invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
+    :try_end_14
+    .catchall {:try_start_14 .. :try_end_14} :catchall_3
+
+    :try_start_15
+    invoke-static/range {v32 .. v33}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    monitor-exit p0
+    :try_end_15
+    .catchall {:try_start_15 .. :try_end_15} :catchall_0
+
+    goto/16 :goto_2
+
+    :cond_1f
+    :try_start_16
+    invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
+
     const-string v5, "getContentProviderImpl: before start process"
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
@@ -21901,6 +22092,10 @@
 
     iget-object v12, v4, Lcom/android/server/am/ContentProviderRecord;->appInfo:Landroid/content/pm/ApplicationInfo;
 
+    const/4 v13, 0x0
+
+    const/4 v14, 0x0
+
     const-string v15, "content provider"
 
     new-instance v16, Landroid/content/ComponentName;
@@ -21915,10 +22110,6 @@
 
     invoke-direct {v0, v5, v10}, Landroid/content/ComponentName;-><init>(Ljava/lang/String;Ljava/lang/String;)V
 
-    const/4 v13, 0x0
-
-    const/4 v14, 0x0
-
     const/16 v17, 0x0
 
     const/16 v18, 0x0
@@ -21929,17 +22120,17 @@
 
     invoke-virtual/range {v10 .. v19}, Lcom/android/server/am/ActivityManagerService;->startProcessLocked(Ljava/lang/String;Landroid/content/pm/ApplicationInfo;ZILjava/lang/String;Landroid/content/ComponentName;ZZZ)Lcom/android/server/am/ProcessRecord;
 
-    move-result-object v35
+    move-result-object v34
 
     const-string v5, "getContentProviderImpl: after start process"
 
     move-object/from16 v0, p0
 
-    move-wide/from16 v1, v40
+    move-wide/from16 v1, v38
 
     invoke-direct {v0, v1, v2, v5}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
-    if-nez v35, :cond_1a
+    if-nez v34, :cond_18
 
     const-string v5, "ActivityManager"
 
@@ -21998,84 +22189,92 @@
     move-result-object v10
 
     invoke-static {v5, v10}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
-    :try_end_13
-    .catchall {:try_start_13 .. :try_end_13} :catchall_2
+    :try_end_16
+    .catchall {:try_start_16 .. :try_end_16} :catchall_3
 
-    :try_start_14
-    invoke-static/range {v36 .. v37}, Landroid/os/Binder;->restoreCallingIdentity(J)V
-    :try_end_14
-    .catchall {:try_start_14 .. :try_end_14} :catchall_0
+    const/16 v26, 0x0
 
-    const/4 v5, 0x0
+    :try_start_17
+    invoke-static/range {v32 .. v33}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
     monitor-exit p0
+    :try_end_17
+    .catchall {:try_start_17 .. :try_end_17} :catchall_0
 
-    return-object v5
+    goto/16 :goto_2
+
+    :catchall_4
+    move-exception v5
+
+    :try_start_18
+    invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
+
+    throw v5
+    :try_end_18
+    .catchall {:try_start_18 .. :try_end_18} :catchall_3
 
-    .end local v4    # "cpr":Lcom/android/server/am/ContentProviderRecord;
     .end local v8    # "comp":Landroid/content/ComponentName;
+    .end local v9    # "singleton":Z
     .end local v20    # "N":I
-    .end local v28    # "firstClass":Z
-    .end local v30    # "i":I
-    .end local v34    # "msg":Ljava/lang/String;
-    .end local v35    # "proc":Lcom/android/server/am/ProcessRecord;
-    .end local v36    # "origId":J
+    .end local v25    # "firstClass":Z
+    .end local v27    # "i":I
+    .end local v31    # "msg":Ljava/lang/String;
+    .end local v32    # "origId":J
+    .end local v34    # "proc":Lcom/android/server/am/ProcessRecord;
+    :cond_20
+    const/4 v5, -0x1
+
+    goto/16 :goto_c
+
     :cond_21
-    if-eqz v22, :cond_22
+    const/4 v5, 0x0
+
+    goto/16 :goto_d
+
+    :cond_22
+    if-eqz v22, :cond_23
 
     const/4 v5, 0x1
 
-    :try_start_15
+    :try_start_19
     move-object/from16 v0, v22
 
     iput-boolean v5, v0, Lcom/android/server/am/ContentProviderConnection;->waiting:Z
 
-    :cond_22
-    invoke-virtual {v4}, Lcom/android/server/am/ContentProviderRecord;->wait()V
-    :try_end_15
-    .catch Ljava/lang/InterruptedException; {:try_start_15 .. :try_end_15} :catch_2
-    .catchall {:try_start_15 .. :try_end_15} :catchall_4
+    :cond_23
+    invoke-virtual {v4}, Ljava/lang/Object;->wait()V
+    :try_end_19
+    .catch Ljava/lang/InterruptedException; {:try_start_19 .. :try_end_19} :catch_2
+    .catchall {:try_start_19 .. :try_end_19} :catchall_5
 
-    if-eqz v22, :cond_1e
+    if-eqz v22, :cond_1c
 
     const/4 v5, 0x0
 
-    :try_start_16
+    :try_start_1a
     move-object/from16 v0, v22
 
     iput-boolean v5, v0, Lcom/android/server/am/ContentProviderConnection;->waiting:Z
-    :try_end_16
-    .catchall {:try_start_16 .. :try_end_16} :catchall_3
-
-    goto/16 :goto_c
-
-    :catchall_3
-    move-exception v5
-
-    monitor-exit v4
 
-    throw v5
+    goto/16 :goto_e
 
     :catch_2
-    move-exception v27
+    move-exception v5
 
-    .local v27, "ex":Ljava/lang/InterruptedException;
-    if-eqz v22, :cond_1e
+    if-eqz v22, :cond_1c
 
     const/4 v5, 0x0
 
-    :try_start_17
     move-object/from16 v0, v22
 
     iput-boolean v5, v0, Lcom/android/server/am/ContentProviderConnection;->waiting:Z
 
-    goto/16 :goto_c
+    goto/16 :goto_e
 
-    .end local v27    # "ex":Ljava/lang/InterruptedException;
-    :catchall_4
+    :catchall_5
     move-exception v5
 
-    if-eqz v22, :cond_23
+    if-eqz v22, :cond_24
 
     const/4 v10, 0x0
 
@@ -22083,15 +22282,15 @@
 
     iput-boolean v10, v0, Lcom/android/server/am/ContentProviderConnection;->waiting:Z
 
-    :cond_23
+    :cond_24
     throw v5
-    :try_end_17
-    .catchall {:try_start_17 .. :try_end_17} :catchall_3
 
-    :cond_24
+    :cond_25
     monitor-exit v4
+    :try_end_1a
+    .catchall {:try_start_1a .. :try_end_1a} :catchall_2
 
-    if-eqz v4, :cond_25
+    if-eqz v4, :cond_26
 
     move-object/from16 v0, v22
 
@@ -22099,49 +22298,64 @@
 
     move-result-object v5
 
-    :goto_d
-    return-object v5
+    :goto_f
+    move-object/from16 v26, v5
 
-    :cond_25
+    goto/16 :goto_2
+
+    :cond_26
     const/4 v5, 0x0
 
-    goto :goto_d
+    goto :goto_f
 
-    .restart local v4    # "cpr":Lcom/android/server/am/ContentProviderRecord;
     .restart local v8    # "comp":Landroid/content/ComponentName;
+    .restart local v9    # "singleton":Z
     .restart local v20    # "N":I
-    .restart local v28    # "firstClass":Z
-    .restart local v30    # "i":I
-    .restart local v34    # "msg":Ljava/lang/String;
-    .restart local v35    # "proc":Lcom/android/server/am/ProcessRecord;
-    .restart local v36    # "origId":J
+    .restart local v25    # "firstClass":Z
+    .restart local v27    # "i":I
+    .restart local v31    # "msg":Ljava/lang/String;
+    .restart local v32    # "origId":J
+    .restart local v34    # "proc":Lcom/android/server/am/ProcessRecord;
     :catch_3
-    move-exception v24
+    move-exception v5
 
-    .local v24, "e":Landroid/os/RemoteException;
     goto/16 :goto_b
 
-    .end local v24    # "e":Landroid/os/RemoteException;
-    .end local v35    # "proc":Lcom/android/server/am/ProcessRecord;
+    .end local v34    # "proc":Lcom/android/server/am/ProcessRecord;
     :catch_4
-    move-exception v24
+    move-exception v5
 
-    .restart local v24    # "e":Landroid/os/RemoteException;
     goto/16 :goto_a
 
-    .end local v4    # "cpr":Lcom/android/server/am/ContentProviderRecord;
     .end local v8    # "comp":Landroid/content/ComponentName;
+    .end local v9    # "singleton":Z
     .end local v20    # "N":I
-    .end local v24    # "e":Landroid/os/RemoteException;
-    .end local v28    # "firstClass":Z
-    .end local v30    # "i":I
-    .end local v34    # "msg":Ljava/lang/String;
-    .end local v36    # "origId":J
+    .end local v25    # "firstClass":Z
+    .end local v27    # "i":I
+    .end local v31    # "msg":Ljava/lang/String;
+    .end local v32    # "origId":J
     :catch_5
-    move-exception v26
+    move-exception v5
 
-    .restart local v26    # "ex":Landroid/os/RemoteException;
     goto/16 :goto_4
+
+    :catch_6
+    move-exception v5
+
+    goto/16 :goto_3
+
+    .end local v4    # "cpr":Lcom/android/server/am/ContentProviderRecord;
+    .restart local v8    # "comp":Landroid/content/ComponentName;
+    .restart local v9    # "singleton":Z
+    .restart local v23    # "cpr":Lcom/android/server/am/ContentProviderRecord;
+    .restart local v25    # "firstClass":Z
+    .restart local v31    # "msg":Ljava/lang/String;
+    :cond_27
+    move-object/from16 v4, v23
+
+    .end local v23    # "cpr":Lcom/android/server/am/ContentProviderRecord;
+    .restart local v4    # "cpr":Lcom/android/server/am/ContentProviderRecord;
+    goto/16 :goto_8
 .end method
 
 .method public static getInputDispatchingTimeoutLocked(Lcom/android/server/am/ActivityRecord;)J
@@ -23268,7 +23482,7 @@
 
     move-result v2
 
-    if-nez v2, :cond_2
+    if-nez v2, :cond_3
 
     const/4 v0, 0x1
 
@@ -23304,10 +23518,23 @@
     if-nez v0, :cond_1
 
     :cond_1
+    if-nez v0, :cond_2
+
+    iget-object v1, p0, Lcom/android/server/am/ActivityManagerService;->mAppOpsService:Lcom/android/server/AppOpsService;
+
+    invoke-static {v1, p1, p2, p3}, Lcom/android/server/am/ActivityManagerServiceInjector;->isGetTasksOpAllowed(Lcom/android/server/AppOpsService;Ljava/lang/String;II)Z
+
+    move-result v1
+
+    if-eqz v1, :cond_2
+
+    const/4 v0, 0x1
+
+    :cond_2
     return v0
 
     .end local v0    # "allowed":Z
-    :cond_2
+    :cond_3
     const/4 v0, 0x0
 
     .restart local v0    # "allowed":Z
@@ -28475,6 +28702,14 @@
 
     aput v4, v8, v5
 
+    invoke-static {v6}, Landroid/os/UserHandle;->getUserId(I)I
+
+    move-result v5
+
+    invoke-static {v5, v8}, Lcom/android/server/am/ActivityManagerServiceInjector;->computeGids(I[I)[I
+
+    move-result-object v8
+
     .end local v8    # "gids":[I
     .end local v29    # "mountServiceInternal":Landroid/os/storage/MountServiceInternal;
     .end local v31    # "permGids":[I
@@ -29439,11 +29674,14 @@
 .end method
 
 .method private startUser(IZ)Z
-    .locals 35
+    .locals 44
     .param p1, "userId"    # I
     .param p2, "foreground"    # Z
 
     .prologue
+    move/from16 v6, p1
+
+    .local v6, "userIdOrig":I
     const-string v4, "android.permission.INTERACT_ACROSS_USERS_FULL"
 
     move-object/from16 v0, p0
@@ -29500,30 +29738,13 @@
 
     invoke-virtual {v4}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    move-result-object v27
-
-    .local v27, "msg":Ljava/lang/String;
-    const-string v4, "ActivityManager"
-
-    move-object/from16 v0, v27
-
-    invoke-static {v4, v0}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
-
-    new-instance v4, Ljava/lang/SecurityException;
-
-    move-object/from16 v0, v27
-
-    invoke-direct {v4, v0}, Ljava/lang/SecurityException;-><init>(Ljava/lang/String;)V
-
-    throw v4
-
-    .end local v27    # "msg":Ljava/lang/String;
+    .end local v39    # "msg":Ljava/lang/String;
     :cond_0
     invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
 
-    move-result-wide v28
+    move-result-wide v36
 
-    .local v28, "ident":J
+    .local v36, "ident":J
     :try_start_0
     monitor-enter p0
     :try_end_0
@@ -29532,45 +29753,39 @@
     :try_start_1
     move-object/from16 v0, p0
 
-    iget v0, v0, Lcom/android/server/am/ActivityManagerService;->mCurrentUserId:I
-
-    move/from16 v31, v0
-    :try_end_1
-    .catchall {:try_start_1 .. :try_end_1} :catchall_0
+    iget v7, v0, Lcom/android/server/am/ActivityManagerService;->mCurrentUserId:I
 
-    .local v31, "oldUserId":I
-    move/from16 v0, v31
+    .local v7, "oldUserId":I
+    move/from16 v0, p1
 
-    move/from16 v1, p1
+    if-ne v7, v0, :cond_1
 
-    if-ne v0, v1, :cond_1
+    const/4 v4, 0x1
 
-    :try_start_2
     monitor-exit p0
-    :try_end_2
-    .catchall {:try_start_2 .. :try_end_2} :catchall_1
-
-    const/4 v4, 0x1
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_0
 
-    invoke-static/range {v28 .. v29}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    invoke-static/range {v36 .. v37}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
+    :goto_0
     return v4
 
     :cond_1
-    :try_start_3
+    :try_start_2
     move-object/from16 v0, p0
 
     iget-object v4, v0, Lcom/android/server/am/ActivityManagerService;->mStackSupervisor:Lcom/android/server/am/ActivityStackSupervisor;
 
-    const-string v5, "startUser"
-
-    const/4 v6, 0x0
+    const/4 v5, 0x0
 
     const/4 v8, 0x0
 
-    const/4 v9, 0x0
+    const-string v9, "startUser"
 
-    invoke-virtual {v4, v6, v8, v5, v9}, Lcom/android/server/am/ActivityStackSupervisor;->setLockTaskModeLocked(Lcom/android/server/am/TaskRecord;ILjava/lang/String;Z)V
+    const/4 v10, 0x0
+
+    invoke-virtual {v4, v5, v8, v9, v10}, Lcom/android/server/am/ActivityStackSupervisor;->setLockTaskModeLocked(Lcom/android/server/am/TaskRecord;ILjava/lang/String;Z)V
 
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/am/ActivityManagerService;->getUserManagerLocked()Lcom/android/server/pm/UserManagerService;
 
@@ -29580,10 +29795,10 @@
 
     invoke-virtual {v4, v0}, Lcom/android/server/pm/UserManagerService;->getUserInfo(I)Landroid/content/pm/UserInfo;
 
-    move-result-object v33
+    move-result-object v42
 
-    .local v33, "userInfo":Landroid/content/pm/UserInfo;
-    if-nez v33, :cond_2
+    .local v42, "userInfo":Landroid/content/pm/UserInfo;
+    if-nez v42, :cond_2
 
     const-string v4, "ActivityManager"
 
@@ -29591,9 +29806,9 @@
 
     invoke-direct {v5}, Ljava/lang/StringBuilder;-><init>()V
 
-    const-string v6, "No user info for user #"
+    const-string v8, "No user info for user #"
 
-    invoke-virtual {v5, v6}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v5, v8}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
     move-result-object v5
 
@@ -29608,25 +29823,22 @@
     move-result-object v5
 
     invoke-static {v4, v5}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
-    :try_end_3
-    .catchall {:try_start_3 .. :try_end_3} :catchall_0
-
-    :try_start_4
-    monitor-exit p0
-    :try_end_4
-    .catchall {:try_start_4 .. :try_end_4} :catchall_1
 
     const/4 v4, 0x0
 
-    invoke-static/range {v28 .. v29}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    monitor-exit p0
+    :try_end_2
+    .catchall {:try_start_2 .. :try_end_2} :catchall_0
 
-    return v4
+    invoke-static/range {v36 .. v37}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    goto :goto_0
 
     :cond_2
     if-eqz p2, :cond_3
 
-    :try_start_5
-    invoke-virtual/range {v33 .. v33}, Landroid/content/pm/UserInfo;->isManagedProfile()Z
+    :try_start_3
+    invoke-virtual/range {v42 .. v42}, Landroid/content/pm/UserInfo;->isManagedProfile()Z
 
     move-result v4
 
@@ -29638,9 +29850,9 @@
 
     invoke-direct {v5}, Ljava/lang/StringBuilder;-><init>()V
 
-    const-string v6, "Cannot switch to User #"
+    const-string v8, "Cannot switch to User #"
 
-    invoke-virtual {v5, v6}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v5, v8}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
     move-result-object v5
 
@@ -29650,9 +29862,9 @@
 
     move-result-object v5
 
-    const-string v6, ": not a full user"
+    const-string v8, ": not a full user"
 
-    invoke-virtual {v5, v6}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v5, v8}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
     move-result-object v5
 
@@ -29661,38 +29873,100 @@
     move-result-object v5
 
     invoke-static {v4, v5}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
-    :try_end_5
-    .catchall {:try_start_5 .. :try_end_5} :catchall_0
-
-    :try_start_6
-    monitor-exit p0
-    :try_end_6
-    .catchall {:try_start_6 .. :try_end_6} :catchall_1
 
     const/4 v4, 0x0
 
-    invoke-static/range {v28 .. v29}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    monitor-exit p0
+    :try_end_3
+    .catchall {:try_start_3 .. :try_end_3} :catchall_0
 
-    return v4
+    invoke-static/range {v36 .. v37}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    goto :goto_0
 
     :cond_3
     if-eqz p2, :cond_4
 
-    :try_start_7
+    :try_start_4
     move-object/from16 v0, p0
 
     iget-object v4, v0, Lcom/android/server/am/ActivityManagerService;->mWindowManager:Lcom/android/server/wm/WindowManagerService;
 
-    const v5, 0x10a0063
+    const v5, 0x10a0060
 
-    const v6, 0x10a0062
+    const v8, 0x10a005f
 
-    invoke-virtual {v4, v5, v6}, Lcom/android/server/wm/WindowManagerService;->startFreezingScreen(II)V
+    invoke-virtual {v4, v5, v8}, Lcom/android/server/wm/WindowManagerService;->startFreezingScreen(II)V
 
     :cond_4
-    const/16 v30, 0x0
+    const/16 v40, 0x0
+
+    .local v40, "needStart":Z
+    invoke-static/range {p1 .. p1}, Landroid/service/securespaces/SpaceEncryptionManager;->needAirlockUser(I)Z
+
+    move-result v4
 
-    .local v30, "needStart":Z
+    if-eqz v4, :cond_6
+
+    if-nez p2, :cond_5
+
+    const-string v4, "ActivityManager"
+
+    new-instance v5, Ljava/lang/StringBuilder;
+
+    invoke-direct {v5}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v8, "Cannot start user "
+
+    invoke-virtual {v5, v8}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v5
+
+    move/from16 v0, p1
+
+    invoke-virtual {v5, v0}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    move-result-object v5
+
+    const-string v8, " in the background: user-authentication is required"
+
+    invoke-virtual {v5, v8}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v5
+
+    invoke-virtual {v5}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v5
+
+    invoke-static {v4, v5}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
+
+    const/4 v4, 0x0
+
+    monitor-exit p0
+    :try_end_4
+    .catchall {:try_start_4 .. :try_end_4} :catchall_0
+
+    invoke-static/range {v36 .. v37}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    goto/16 :goto_0
+
+    :cond_5
+    const/16 p1, 0x63
+
+    :cond_6
+    :try_start_5
+    invoke-static/range {p1 .. p1}, Landroid/service/securespaces/SpaceEncryptionManager;->ecryptfsMountRemovableNonOwner(I)V
+
+    const/16 v4, 0x63
+
+    move/from16 v0, p1
+
+    if-ne v0, v4, :cond_11
+
+    const/16 v38, 0x1
+
+    .local v38, "isUserAirlock":Z
+    :goto_1
     move-object/from16 v0, p0
 
     iget-object v4, v0, Lcom/android/server/am/ActivityManagerService;->mStartedUsers:Landroid/util/SparseArray;
@@ -29703,7 +29977,7 @@
 
     move-result-object v4
 
-    if-nez v4, :cond_5
+    if-nez v4, :cond_7
 
     move-object/from16 v0, p0
 
@@ -29711,15 +29985,15 @@
 
     new-instance v5, Lcom/android/server/am/UserState;
 
-    new-instance v6, Landroid/os/UserHandle;
+    new-instance v8, Landroid/os/UserHandle;
 
     move/from16 v0, p1
 
-    invoke-direct {v6, v0}, Landroid/os/UserHandle;-><init>(I)V
+    invoke-direct {v8, v0}, Landroid/os/UserHandle;-><init>(I)V
 
-    const/4 v8, 0x0
+    const/4 v9, 0x0
 
-    invoke-direct {v5, v6, v8}, Lcom/android/server/am/UserState;-><init>(Landroid/os/UserHandle;Z)V
+    invoke-direct {v5, v8, v9}, Lcom/android/server/am/UserState;-><init>(Landroid/os/UserHandle;Z)V
 
     move/from16 v0, p1
 
@@ -29727,19 +30001,21 @@
 
     invoke-direct/range {p0 .. p0}, Lcom/android/server/am/ActivityManagerService;->updateStartedUserArrayLocked()V
 
-    const/16 v30, 0x1
+    const/16 v40, 0x1
 
-    :cond_5
+    :cond_7
     invoke-static/range {p1 .. p1}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
-    move-result-object v32
+    move-result-object v41
+
+    .local v41, "userIdInt":Ljava/lang/Integer;
+    if-nez v38, :cond_8
 
-    .local v32, "userIdInt":Ljava/lang/Integer;
     move-object/from16 v0, p0
 
     iget-object v4, v0, Lcom/android/server/am/ActivityManagerService;->mUserLru:Ljava/util/ArrayList;
 
-    move-object/from16 v0, v32
+    move-object/from16 v0, v41
 
     invoke-virtual {v4, v0}, Ljava/util/ArrayList;->remove(Ljava/lang/Object;)Z
 
@@ -29747,11 +30023,12 @@
 
     iget-object v4, v0, Lcom/android/server/am/ActivityManagerService;->mUserLru:Ljava/util/ArrayList;
 
-    move-object/from16 v0, v32
+    move-object/from16 v0, v41
 
     invoke-virtual {v4, v0}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
 
-    if-eqz p2, :cond_d
+    :cond_8
+    if-eqz p2, :cond_12
 
     move/from16 v0, p1
 
@@ -29769,25 +30046,21 @@
 
     move-object/from16 v0, p0
 
-    iget-object v4, v0, Lcom/android/server/am/ActivityManagerService;->mWindowManager:Lcom/android/server/wm/WindowManagerService;
+    iget-object v4, v0, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
 
     move-object/from16 v0, p0
 
-    iget-object v5, v0, Lcom/android/server/am/ActivityManagerService;->mCurrentProfileIds:[I
-
-    move/from16 v0, p1
-
-    invoke-virtual {v4, v0, v5}, Lcom/android/server/wm/WindowManagerService;->setCurrentUser(I[I)V
+    iget-object v8, v0, Lcom/android/server/am/ActivityManagerService;->mWindowManager:Lcom/android/server/wm/WindowManagerService;
 
     move-object/from16 v0, p0
 
-    iget-object v4, v0, Lcom/android/server/am/ActivityManagerService;->mWindowManager:Lcom/android/server/wm/WindowManagerService;
+    iget-object v9, v0, Lcom/android/server/am/ActivityManagerService;->mCurrentProfileIds:[I
 
-    const/4 v5, 0x0
+    move/from16 v5, p1
 
-    invoke-virtual {v4, v5}, Lcom/android/server/wm/WindowManagerService;->lockNow(Landroid/os/Bundle;)V
+    invoke-static/range {v4 .. v9}, Lcom/android/server/am/ActivityManagerServiceInjector;->handleWindowManagerAndUserLru(Landroid/content/Context;IIILcom/android/server/wm/WindowManagerService;[I)V
 
-    :goto_0
+    :goto_2
     move-object/from16 v0, p0
 
     iget-object v4, v0, Lcom/android/server/am/ActivityManagerService;->mStartedUsers:Landroid/util/SparseArray;
@@ -29796,36 +30069,36 @@
 
     invoke-virtual {v4, v0}, Landroid/util/SparseArray;->get(I)Ljava/lang/Object;
 
-    move-result-object v34
+    move-result-object v43
 
-    check-cast v34, Lcom/android/server/am/UserState;
+    check-cast v43, Lcom/android/server/am/UserState;
 
-    .local v34, "uss":Lcom/android/server/am/UserState;
-    move-object/from16 v0, v34
+    .local v43, "uss":Lcom/android/server/am/UserState;
+    move-object/from16 v0, v43
 
     iget v4, v0, Lcom/android/server/am/UserState;->mState:I
 
     const/4 v5, 0x2
 
-    if-ne v4, v5, :cond_e
+    if-ne v4, v5, :cond_13
 
     const/4 v4, 0x1
 
-    move-object/from16 v0, v34
+    move-object/from16 v0, v43
 
     iput v4, v0, Lcom/android/server/am/UserState;->mState:I
 
     invoke-direct/range {p0 .. p0}, Lcom/android/server/am/ActivityManagerService;->updateStartedUserArrayLocked()V
 
-    const/16 v30, 0x1
+    const/16 v40, 0x1
 
-    :cond_6
-    :goto_1
-    move-object/from16 v0, v34
+    :cond_9
+    :goto_3
+    move-object/from16 v0, v43
 
     iget v4, v0, Lcom/android/server/am/UserState;->mState:I
 
-    if-nez v4, :cond_7
+    if-nez v4, :cond_a
 
     move-object/from16 v0, p0
 
@@ -29835,20 +30108,20 @@
 
     iget-object v5, v0, Lcom/android/server/am/ActivityManagerService;->mHandler:Lcom/android/server/am/ActivityManagerService$MainHandler;
 
-    const/16 v6, 0x2a
+    const/16 v8, 0x2a
 
-    const/4 v8, 0x0
+    const/4 v9, 0x0
 
     move/from16 v0, p1
 
-    invoke-virtual {v5, v6, v0, v8}, Lcom/android/server/am/ActivityManagerService$MainHandler;->obtainMessage(III)Landroid/os/Message;
+    invoke-virtual {v5, v8, v0, v9}, Lcom/android/server/am/ActivityManagerService$MainHandler;->obtainMessage(III)Landroid/os/Message;
 
     move-result-object v5
 
     invoke-virtual {v4, v5}, Lcom/android/server/am/ActivityManagerService$MainHandler;->sendMessage(Landroid/os/Message;)Z
 
-    :cond_7
-    if-eqz p2, :cond_8
+    :cond_a
+    if-eqz p2, :cond_b
 
     move-object/from16 v0, p0
 
@@ -29858,13 +30131,11 @@
 
     iget-object v5, v0, Lcom/android/server/am/ActivityManagerService;->mHandler:Lcom/android/server/am/ActivityManagerService$MainHandler;
 
-    const/16 v6, 0x2b
+    const/16 v8, 0x2b
 
     move/from16 v0, p1
 
-    move/from16 v1, v31
-
-    invoke-virtual {v5, v6, v0, v1}, Lcom/android/server/am/ActivityManagerService$MainHandler;->obtainMessage(III)Landroid/os/Message;
+    invoke-virtual {v5, v8, v0, v7}, Lcom/android/server/am/ActivityManagerService$MainHandler;->obtainMessage(III)Landroid/os/Message;
 
     move-result-object v5
 
@@ -29894,15 +30165,13 @@
 
     iget-object v5, v0, Lcom/android/server/am/ActivityManagerService;->mHandler:Lcom/android/server/am/ActivityManagerService$MainHandler;
 
-    const/16 v6, 0x22
+    const/16 v8, 0x22
 
-    move/from16 v0, v31
-
-    move/from16 v1, p1
+    move/from16 v0, p1
 
-    move-object/from16 v2, v34
+    move-object/from16 v1, v43
 
-    invoke-virtual {v5, v6, v0, v1, v2}, Lcom/android/server/am/ActivityManagerService$MainHandler;->obtainMessage(IIILjava/lang/Object;)Landroid/os/Message;
+    invoke-virtual {v5, v8, v7, v0, v1}, Lcom/android/server/am/ActivityManagerService$MainHandler;->obtainMessage(IIILjava/lang/Object;)Landroid/os/Message;
 
     move-result-object v5
 
@@ -29916,15 +30185,13 @@
 
     iget-object v5, v0, Lcom/android/server/am/ActivityManagerService;->mHandler:Lcom/android/server/am/ActivityManagerService$MainHandler;
 
-    const/16 v6, 0x24
+    const/16 v8, 0x24
 
-    move/from16 v0, v31
-
-    move/from16 v1, p1
+    move/from16 v0, p1
 
-    move-object/from16 v2, v34
+    move-object/from16 v1, v43
 
-    invoke-virtual {v5, v6, v0, v1, v2}, Lcom/android/server/am/ActivityManagerService$MainHandler;->obtainMessage(IIILjava/lang/Object;)Landroid/os/Message;
+    invoke-virtual {v5, v8, v7, v0, v1}, Lcom/android/server/am/ActivityManagerService$MainHandler;->obtainMessage(IIILjava/lang/Object;)Landroid/os/Message;
 
     move-result-object v5
 
@@ -29932,45 +30199,37 @@
 
     invoke-virtual {v4, v5, v8, v9}, Lcom/android/server/am/ActivityManagerService$MainHandler;->sendMessageDelayed(Landroid/os/Message;J)Z
 
-    :cond_8
-    if-eqz v30, :cond_9
+    :cond_b
+    if-eqz v40, :cond_c
 
-    new-instance v7, Landroid/content/Intent;
+    if-nez v38, :cond_c
+
+    new-instance v11, Landroid/content/Intent;
 
     const-string v4, "android.intent.action.USER_STARTED"
 
-    invoke-direct {v7, v4}, Landroid/content/Intent;-><init>(Ljava/lang/String;)V
+    invoke-direct {v11, v4}, Landroid/content/Intent;-><init>(Ljava/lang/String;)V
 
-    .local v7, "intent":Landroid/content/Intent;
+    .local v11, "intent":Landroid/content/Intent;
     const/high16 v4, 0x50000000
 
-    invoke-virtual {v7, v4}, Landroid/content/Intent;->addFlags(I)Landroid/content/Intent;
+    invoke-virtual {v11, v4}, Landroid/content/Intent;->addFlags(I)Landroid/content/Intent;
 
     const-string v4, "android.intent.extra.user_handle"
 
     move/from16 v0, p1
 
-    invoke-virtual {v7, v4, v0}, Landroid/content/Intent;->putExtra(Ljava/lang/String;I)Landroid/content/Intent;
-
-    sget v18, Lcom/android/server/am/ActivityManagerService;->MY_PID:I
-
-    const/4 v5, 0x0
-
-    const/4 v6, 0x0
-
-    const/4 v8, 0x0
+    invoke-virtual {v11, v4, v0}, Landroid/content/Intent;->putExtra(Ljava/lang/String;I)Landroid/content/Intent;
 
     const/4 v9, 0x0
 
     const/4 v10, 0x0
 
-    const/4 v11, 0x0
-
     const/4 v12, 0x0
 
     const/4 v13, 0x0
 
-    const/4 v14, -0x1
+    const/4 v14, 0x0
 
     const/4 v15, 0x0
 
@@ -29978,208 +30237,247 @@
 
     const/16 v17, 0x0
 
-    const/16 v19, 0x3e8
+    const/16 v18, -0x1
 
-    move-object/from16 v4, p0
+    const/16 v19, 0x0
+
+    const/16 v20, 0x0
 
-    move/from16 v20, p1
+    const/16 v21, 0x0
 
-    invoke-direct/range {v4 .. v20}, Lcom/android/server/am/ActivityManagerService;->broadcastIntentLocked(Lcom/android/server/am/ProcessRecord;Ljava/lang/String;Landroid/content/Intent;Ljava/lang/String;Landroid/content/IIntentReceiver;ILjava/lang/String;Landroid/os/Bundle;[Ljava/lang/String;ILandroid/os/Bundle;ZZIII)I
+    sget v22, Lcom/android/server/am/ActivityManagerService;->MY_PID:I
 
-    .end local v7    # "intent":Landroid/content/Intent;
-    :cond_9
-    move-object/from16 v0, v33
+    const/16 v23, 0x3e8
+
+    move-object/from16 v8, p0
+
+    move/from16 v24, p1
+
+    invoke-direct/range {v8 .. v24}, Lcom/android/server/am/ActivityManagerService;->broadcastIntentLocked(Lcom/android/server/am/ProcessRecord;Ljava/lang/String;Landroid/content/Intent;Ljava/lang/String;Landroid/content/IIntentReceiver;ILjava/lang/String;Landroid/os/Bundle;[Ljava/lang/String;ILandroid/os/Bundle;ZZIII)I
+
+    .end local v11    # "intent":Landroid/content/Intent;
+    :cond_c
+    move-object/from16 v0, v42
 
     iget v4, v0, Landroid/content/pm/UserInfo;->flags:I
 
     and-int/lit8 v4, v4, 0x10
 
-    if-nez v4, :cond_a
+    if-nez v4, :cond_d
 
-    if-eqz p1, :cond_f
+    if-nez v38, :cond_d
 
-    new-instance v7, Landroid/content/Intent;
+    move/from16 v17, p1
+
+    .local v17, "userIdFinal":I
+    if-eqz p1, :cond_14
+
+    new-instance v11, Landroid/content/Intent;
 
     const-string v4, "android.intent.action.USER_INITIALIZE"
 
-    invoke-direct {v7, v4}, Landroid/content/Intent;-><init>(Ljava/lang/String;)V
+    invoke-direct {v11, v4}, Landroid/content/Intent;-><init>(Ljava/lang/String;)V
 
-    .restart local v7    # "intent":Landroid/content/Intent;
+    .restart local v11    # "intent":Landroid/content/Intent;
     const/high16 v4, 0x10000000
 
-    invoke-virtual {v7, v4}, Landroid/content/Intent;->addFlags(I)Landroid/content/Intent;
-
-    new-instance v8, Lcom/android/server/am/ActivityManagerService$25;
+    invoke-virtual {v11, v4}, Landroid/content/Intent;->addFlags(I)Landroid/content/Intent;
 
-    move-object/from16 v9, p0
+    const/16 v19, 0x0
 
-    move-object/from16 v10, v34
+    const/16 v20, 0x0
 
-    move/from16 v11, p2
+    const/16 v22, 0x0
 
-    move/from16 v12, v31
+    new-instance v12, Lcom/android/server/am/ActivityManagerService$25;
 
-    move/from16 v13, p1
+    move-object/from16 v13, p0
 
-    invoke-direct/range {v8 .. v13}, Lcom/android/server/am/ActivityManagerService$25;-><init>(Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/UserState;ZII)V
+    move-object/from16 v14, v43
 
-    sget v23, Lcom/android/server/am/ActivityManagerService;->MY_PID:I
+    move/from16 v15, p2
 
-    const/4 v10, 0x0
+    move/from16 v16, v7
 
-    const/4 v11, 0x0
+    invoke-direct/range {v12 .. v17}, Lcom/android/server/am/ActivityManagerService$25;-><init>(Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/UserState;ZII)V
 
-    const/4 v13, 0x0
+    const/16 v24, 0x0
 
-    const/4 v15, 0x0
+    const/16 v25, 0x0
 
-    const/16 v16, 0x0
+    const/16 v26, 0x0
 
-    const/16 v17, 0x0
+    const/16 v27, 0x0
 
-    const/16 v18, 0x0
+    const/16 v28, -0x1
 
-    const/16 v19, -0x1
+    const/16 v29, 0x0
 
-    const/16 v20, 0x0
+    const/16 v30, 0x1
 
-    const/16 v21, 0x1
+    const/16 v31, 0x0
 
-    const/16 v22, 0x0
+    sget v32, Lcom/android/server/am/ActivityManagerService;->MY_PID:I
 
-    const/16 v24, 0x3e8
+    const/16 v33, 0x3e8
 
-    move-object/from16 v9, p0
+    move-object/from16 v18, p0
 
-    move-object v12, v7
+    move-object/from16 v21, v11
 
-    move-object v14, v8
+    move-object/from16 v23, v12
 
-    move/from16 v25, p1
+    move/from16 v34, p1
 
-    invoke-direct/range {v9 .. v25}, Lcom/android/server/am/ActivityManagerService;->broadcastIntentLocked(Lcom/android/server/am/ProcessRecord;Ljava/lang/String;Landroid/content/Intent;Ljava/lang/String;Landroid/content/IIntentReceiver;ILjava/lang/String;Landroid/os/Bundle;[Ljava/lang/String;ILandroid/os/Bundle;ZZIII)I
+    invoke-direct/range {v18 .. v34}, Lcom/android/server/am/ActivityManagerService;->broadcastIntentLocked(Lcom/android/server/am/ProcessRecord;Ljava/lang/String;Landroid/content/Intent;Ljava/lang/String;Landroid/content/IIntentReceiver;ILjava/lang/String;Landroid/os/Bundle;[Ljava/lang/String;ILandroid/os/Bundle;ZZIII)I
 
     const/4 v4, 0x1
 
-    move-object/from16 v0, v34
+    move-object/from16 v0, v43
 
     iput-boolean v4, v0, Lcom/android/server/am/UserState;->initializing:Z
 
-    .end local v7    # "intent":Landroid/content/Intent;
-    :cond_a
-    :goto_2
-    if-eqz p2, :cond_10
+    .end local v11    # "intent":Landroid/content/Intent;
+    .end local v17    # "userIdFinal":I
+    :cond_d
+    :goto_4
+    if-eqz p2, :cond_15
 
-    move-object/from16 v0, v34
+    move-object/from16 v0, v43
 
     iget-boolean v4, v0, Lcom/android/server/am/UserState;->initializing:Z
 
-    if-nez v4, :cond_b
+    if-nez v4, :cond_e
 
     move-object/from16 v0, p0
 
-    move-object/from16 v1, v34
+    move-object/from16 v1, v43
 
-    move/from16 v2, v31
+    move/from16 v2, p1
 
-    move/from16 v3, p1
+    invoke-virtual {v0, v1, v7, v2}, Lcom/android/server/am/ActivityManagerService;->moveUserToForeground(Lcom/android/server/am/UserState;II)V
 
-    invoke-virtual {v0, v1, v2, v3}, Lcom/android/server/am/ActivityManagerService;->moveUserToForeground(Lcom/android/server/am/UserState;II)V
+    :cond_e
+    :goto_5
+    if-eqz v40, :cond_f
 
-    :cond_b
-    :goto_3
-    if-eqz v30, :cond_c
+    if-nez v38, :cond_f
 
-    new-instance v7, Landroid/content/Intent;
+    new-instance v11, Landroid/content/Intent;
 
     const-string v4, "android.intent.action.USER_STARTING"
 
-    invoke-direct {v7, v4}, Landroid/content/Intent;-><init>(Ljava/lang/String;)V
+    invoke-direct {v11, v4}, Landroid/content/Intent;-><init>(Ljava/lang/String;)V
 
-    .restart local v7    # "intent":Landroid/content/Intent;
+    .restart local v11    # "intent":Landroid/content/Intent;
     const/high16 v4, 0x40000000    # 2.0f
 
-    invoke-virtual {v7, v4}, Landroid/content/Intent;->addFlags(I)Landroid/content/Intent;
+    invoke-virtual {v11, v4}, Landroid/content/Intent;->addFlags(I)Landroid/content/Intent;
 
     const-string v4, "android.intent.extra.user_handle"
 
     move/from16 v0, p1
 
-    invoke-virtual {v7, v4, v0}, Landroid/content/Intent;->putExtra(Ljava/lang/String;I)Landroid/content/Intent;
+    invoke-virtual {v11, v4, v0}, Landroid/content/Intent;->putExtra(Ljava/lang/String;I)Landroid/content/Intent;
 
-    new-instance v9, Lcom/android/server/am/ActivityManagerService$26;
+    const/16 v19, 0x0
 
-    move-object/from16 v0, p0
+    const/16 v20, 0x0
+
+    const/16 v22, 0x0
+
+    new-instance v23, Lcom/android/server/am/ActivityManagerService$26;
+
+    move-object/from16 v0, v23
+
+    move-object/from16 v1, p0
+
+    invoke-direct {v0, v1}, Lcom/android/server/am/ActivityManagerService$26;-><init>(Lcom/android/server/am/ActivityManagerService;)V
+
+    const/16 v24, 0x0
 
-    invoke-direct {v9, v0}, Lcom/android/server/am/ActivityManagerService$26;-><init>(Lcom/android/server/am/ActivityManagerService;)V
+    const/16 v25, 0x0
+
+    const/16 v26, 0x0
 
     const/4 v4, 0x1
 
-    new-array v13, v4, [Ljava/lang/String;
+    new-array v0, v4, [Ljava/lang/String;
 
-    const-string v4, "android.permission.INTERACT_ACROSS_USERS"
+    move-object/from16 v27, v0
 
-    const/4 v5, 0x0
+    const/4 v4, 0x0
 
-    aput-object v4, v13, v5
+    const-string v5, "android.permission.INTERACT_ACROSS_USERS"
 
-    sget v18, Lcom/android/server/am/ActivityManagerService;->MY_PID:I
+    aput-object v5, v27, v4
 
-    const/4 v5, 0x0
+    const/16 v28, -0x1
 
-    const/4 v6, 0x0
+    const/16 v29, 0x0
 
-    const/4 v8, 0x0
+    const/16 v30, 0x1
 
-    const/4 v10, 0x0
+    const/16 v31, 0x0
 
-    const/4 v11, 0x0
+    sget v32, Lcom/android/server/am/ActivityManagerService;->MY_PID:I
 
-    const/4 v12, 0x0
+    const/16 v33, 0x3e8
 
-    const/4 v14, -0x1
+    const/16 v34, -0x1
 
-    const/4 v15, 0x0
+    move-object/from16 v18, p0
 
-    const/16 v16, 0x1
+    move-object/from16 v21, v11
 
-    const/16 v17, 0x0
+    invoke-direct/range {v18 .. v34}, Lcom/android/server/am/ActivityManagerService;->broadcastIntentLocked(Lcom/android/server/am/ProcessRecord;Ljava/lang/String;Landroid/content/Intent;Ljava/lang/String;Landroid/content/IIntentReceiver;ILjava/lang/String;Landroid/os/Bundle;[Ljava/lang/String;ILandroid/os/Bundle;ZZIII)I
 
-    const/16 v19, 0x3e8
+    .end local v11    # "intent":Landroid/content/Intent;
+    :cond_f
+    const/16 v4, 0x63
 
-    const/16 v20, -0x1
+    if-ne v7, v4, :cond_10
 
-    move-object/from16 v4, p0
+    const/16 v4, 0x63
 
-    invoke-direct/range {v4 .. v20}, Lcom/android/server/am/ActivityManagerService;->broadcastIntentLocked(Lcom/android/server/am/ProcessRecord;Ljava/lang/String;Landroid/content/Intent;Ljava/lang/String;Landroid/content/IIntentReceiver;ILjava/lang/String;Landroid/os/Bundle;[Ljava/lang/String;ILandroid/os/Bundle;ZZIII)I
-    :try_end_7
-    .catchall {:try_start_7 .. :try_end_7} :catchall_0
+    const/4 v5, 0x0
 
-    .end local v7    # "intent":Landroid/content/Intent;
-    :cond_c
-    :try_start_8
+    move-object/from16 v0, p0
+
+    invoke-virtual {v0, v4, v5}, Lcom/android/server/am/ActivityManagerService;->stopUser(ILandroid/app/IStopUserCallback;)I
+
+    :cond_10
     monitor-exit p0
-    :try_end_8
-    .catchall {:try_start_8 .. :try_end_8} :catchall_1
+    :try_end_5
+    .catchall {:try_start_5 .. :try_end_5} :catchall_0
 
-    invoke-static/range {v28 .. v29}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    invoke-static/range {v36 .. v37}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
     const/4 v4, 0x1
 
-    return v4
+    goto/16 :goto_0
 
-    .end local v34    # "uss":Lcom/android/server/am/UserState;
-    :cond_d
-    :try_start_9
+    .end local v38    # "isUserAirlock":Z
+    .end local v41    # "userIdInt":Ljava/lang/Integer;
+    .end local v43    # "uss":Lcom/android/server/am/UserState;
+    :cond_11
+    const/16 v38, 0x0
+
+    goto/16 :goto_1
+
+    .restart local v38    # "isUserAirlock":Z
+    .restart local v41    # "userIdInt":Ljava/lang/Integer;
+    :cond_12
+    :try_start_6
     move-object/from16 v0, p0
 
     iget v4, v0, Lcom/android/server/am/ActivityManagerService;->mCurrentUserId:I
 
     invoke-static {v4}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
-    move-result-object v26
+    move-result-object v35
 
-    .local v26, "currentUserIdInt":Ljava/lang/Integer;
+    .local v35, "currentUserIdInt":Ljava/lang/Integer;
     invoke-direct/range {p0 .. p0}, Lcom/android/server/am/ActivityManagerService;->updateCurrentProfileIdsLocked()V
 
     move-object/from16 v0, p0
@@ -30196,7 +30494,7 @@
 
     iget-object v4, v0, Lcom/android/server/am/ActivityManagerService;->mUserLru:Ljava/util/ArrayList;
 
-    move-object/from16 v0, v26
+    move-object/from16 v0, v35
 
     invoke-virtual {v4, v0}, Ljava/util/ArrayList;->remove(Ljava/lang/Object;)Z
 
@@ -30204,90 +30502,94 @@
 
     iget-object v4, v0, Lcom/android/server/am/ActivityManagerService;->mUserLru:Ljava/util/ArrayList;
 
-    move-object/from16 v0, v26
+    move-object/from16 v0, v35
 
     invoke-virtual {v4, v0}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
-    :try_end_9
-    .catchall {:try_start_9 .. :try_end_9} :catchall_0
 
-    goto/16 :goto_0
+    goto/16 :goto_2
 
-    .end local v26    # "currentUserIdInt":Ljava/lang/Integer;
-    .end local v30    # "needStart":Z
-    .end local v31    # "oldUserId":I
-    .end local v32    # "userIdInt":Ljava/lang/Integer;
-    .end local v33    # "userInfo":Landroid/content/pm/UserInfo;
+    .end local v7    # "oldUserId":I
+    .end local v35    # "currentUserIdInt":Ljava/lang/Integer;
+    .end local v38    # "isUserAirlock":Z
+    .end local v40    # "needStart":Z
+    .end local v41    # "userIdInt":Ljava/lang/Integer;
+    .end local v42    # "userInfo":Landroid/content/pm/UserInfo;
     :catchall_0
     move-exception v4
 
-    :try_start_a
     monitor-exit p0
+    :try_end_6
+    .catchall {:try_start_6 .. :try_end_6} :catchall_0
 
+    :try_start_7
     throw v4
-    :try_end_a
-    .catchall {:try_start_a .. :try_end_a} :catchall_1
+    :try_end_7
+    .catchall {:try_start_7 .. :try_end_7} :catchall_1
 
     :catchall_1
     move-exception v4
 
-    invoke-static/range {v28 .. v29}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    invoke-static/range {v36 .. v37}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
     throw v4
 
-    .restart local v30    # "needStart":Z
-    .restart local v31    # "oldUserId":I
-    .restart local v32    # "userIdInt":Ljava/lang/Integer;
-    .restart local v33    # "userInfo":Landroid/content/pm/UserInfo;
-    .restart local v34    # "uss":Lcom/android/server/am/UserState;
-    :cond_e
-    :try_start_b
-    move-object/from16 v0, v34
+    .restart local v7    # "oldUserId":I
+    .restart local v38    # "isUserAirlock":Z
+    .restart local v40    # "needStart":Z
+    .restart local v41    # "userIdInt":Ljava/lang/Integer;
+    .restart local v42    # "userInfo":Landroid/content/pm/UserInfo;
+    .restart local v43    # "uss":Lcom/android/server/am/UserState;
+    :cond_13
+    :try_start_8
+    move-object/from16 v0, v43
 
     iget v4, v0, Lcom/android/server/am/UserState;->mState:I
 
     const/4 v5, 0x3
 
-    if-ne v4, v5, :cond_6
+    if-ne v4, v5, :cond_9
 
     const/4 v4, 0x0
 
-    move-object/from16 v0, v34
+    move-object/from16 v0, v43
 
     iput v4, v0, Lcom/android/server/am/UserState;->mState:I
 
     invoke-direct/range {p0 .. p0}, Lcom/android/server/am/ActivityManagerService;->updateStartedUserArrayLocked()V
 
-    const/16 v30, 0x1
+    const/16 v40, 0x1
 
-    goto/16 :goto_1
+    goto/16 :goto_3
 
-    :cond_f
+    .restart local v17    # "userIdFinal":I
+    :cond_14
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/am/ActivityManagerService;->getUserManagerLocked()Lcom/android/server/pm/UserManagerService;
 
     move-result-object v4
 
-    move-object/from16 v0, v33
+    move-object/from16 v0, v42
 
     iget v5, v0, Landroid/content/pm/UserInfo;->id:I
 
     invoke-virtual {v4, v5}, Lcom/android/server/pm/UserManagerService;->makeInitialized(I)V
 
-    goto/16 :goto_2
+    goto/16 :goto_4
 
-    :cond_10
+    .end local v17    # "userIdFinal":I
+    :cond_15
     move-object/from16 v0, p0
 
     iget-object v4, v0, Lcom/android/server/am/ActivityManagerService;->mStackSupervisor:Lcom/android/server/am/ActivityStackSupervisor;
 
     move/from16 v0, p1
 
-    move-object/from16 v1, v34
+    move-object/from16 v1, v43
 
     invoke-virtual {v4, v0, v1}, Lcom/android/server/am/ActivityStackSupervisor;->startBackgroundUserLocked(ILcom/android/server/am/UserState;)V
-    :try_end_b
-    .catchall {:try_start_b .. :try_end_b} :catchall_0
+    :try_end_8
+    .catchall {:try_start_8 .. :try_end_8} :catchall_0
 
-    goto/16 :goto_3
+    goto/16 :goto_5
 .end method
 
 .method private stopGuestUserIfBackground()V
@@ -30461,215 +30763,158 @@
 .end method
 
 .method private stopUserLocked(ILandroid/app/IStopUserCallback;)I
-    .locals 30
+    .locals 12
     .param p1, "userId"    # I
     .param p2, "callback"    # Landroid/app/IStopUserCallback;
 
     .prologue
-    move-object/from16 v0, p0
-
-    iget v5, v0, Lcom/android/server/am/ActivityManagerService;->mCurrentUserId:I
+    const/4 v11, 0x2
 
-    move/from16 v0, p1
+    const/4 v10, 0x0
 
-    if-ne v5, v0, :cond_0
+    iget v1, p0, Lcom/android/server/am/ActivityManagerService;->mCurrentUserId:I
 
-    move-object/from16 v0, p0
+    if-ne v1, p1, :cond_0
 
-    iget v5, v0, Lcom/android/server/am/ActivityManagerService;->mTargetUserId:I
+    iget v1, p0, Lcom/android/server/am/ActivityManagerService;->mTargetUserId:I
 
-    const/16 v7, -0x2710
+    const/16 v3, -0x2710
 
-    if-ne v5, v7, :cond_0
+    if-ne v1, v3, :cond_0
 
-    const/4 v5, -0x2
+    const/4 v1, -0x2
 
-    return v5
+    :goto_0
+    return v1
 
     :cond_0
-    move-object/from16 v0, p0
-
-    iget-object v5, v0, Lcom/android/server/am/ActivityManagerService;->mStartedUsers:Landroid/util/SparseArray;
-
-    move/from16 v0, p1
+    iget-object v1, p0, Lcom/android/server/am/ActivityManagerService;->mStartedUsers:Landroid/util/SparseArray;
 
-    invoke-virtual {v5, v0}, Landroid/util/SparseArray;->get(I)Ljava/lang/Object;
+    invoke-virtual {v1, p1}, Landroid/util/SparseArray;->get(I)Ljava/lang/Object;
 
-    move-result-object v6
+    move-result-object v2
 
-    check-cast v6, Lcom/android/server/am/UserState;
+    check-cast v2, Lcom/android/server/am/UserState;
 
-    .local v6, "uss":Lcom/android/server/am/UserState;
-    if-nez v6, :cond_2
+    .local v2, "uss":Lcom/android/server/am/UserState;
+    if-nez v2, :cond_2
 
     if-eqz p2, :cond_1
 
-    move-object/from16 v0, p0
-
-    iget-object v5, v0, Lcom/android/server/am/ActivityManagerService;->mHandler:Lcom/android/server/am/ActivityManagerService$MainHandler;
-
-    new-instance v7, Lcom/android/server/am/ActivityManagerService$28;
-
-    move-object/from16 v0, p0
-
-    move-object/from16 v1, p2
+    iget-object v1, p0, Lcom/android/server/am/ActivityManagerService;->mHandler:Lcom/android/server/am/ActivityManagerService$MainHandler;
 
-    move/from16 v2, p1
+    new-instance v3, Lcom/android/server/am/ActivityManagerService$28;
 
-    invoke-direct {v7, v0, v1, v2}, Lcom/android/server/am/ActivityManagerService$28;-><init>(Lcom/android/server/am/ActivityManagerService;Landroid/app/IStopUserCallback;I)V
+    invoke-direct {v3, p0, p2, p1}, Lcom/android/server/am/ActivityManagerService$28;-><init>(Lcom/android/server/am/ActivityManagerService;Landroid/app/IStopUserCallback;I)V
 
-    invoke-virtual {v5, v7}, Lcom/android/server/am/ActivityManagerService$MainHandler;->post(Ljava/lang/Runnable;)Z
+    invoke-virtual {v1, v3}, Lcom/android/server/am/ActivityManagerService$MainHandler;->post(Ljava/lang/Runnable;)Z
 
     :cond_1
-    const/4 v5, 0x0
+    move v1, v10
 
-    return v5
+    goto :goto_0
 
     :cond_2
     if-eqz p2, :cond_3
 
-    iget-object v5, v6, Lcom/android/server/am/UserState;->mStopCallbacks:Ljava/util/ArrayList;
+    iget-object v1, v2, Lcom/android/server/am/UserState;->mStopCallbacks:Ljava/util/ArrayList;
 
-    move-object/from16 v0, p2
-
-    invoke-virtual {v5, v0}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
+    invoke-virtual {v1, p2}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
 
     :cond_3
-    iget v5, v6, Lcom/android/server/am/UserState;->mState:I
-
-    const/4 v7, 0x2
+    iget v1, v2, Lcom/android/server/am/UserState;->mState:I
 
-    if-eq v5, v7, :cond_4
+    if-eq v1, v11, :cond_4
 
-    iget v5, v6, Lcom/android/server/am/UserState;->mState:I
+    iget v1, v2, Lcom/android/server/am/UserState;->mState:I
 
-    const/4 v7, 0x3
+    const/4 v3, 0x3
 
-    if-eq v5, v7, :cond_4
+    if-eq v1, v3, :cond_4
 
-    const/4 v5, 0x2
+    iput v11, v2, Lcom/android/server/am/UserState;->mState:I
 
-    iput v5, v6, Lcom/android/server/am/UserState;->mState:I
-
-    invoke-direct/range {p0 .. p0}, Lcom/android/server/am/ActivityManagerService;->updateStartedUserArrayLocked()V
+    invoke-direct {p0}, Lcom/android/server/am/ActivityManagerService;->updateStartedUserArrayLocked()V
 
     invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
 
-    move-result-wide v28
+    move-result-wide v6
 
-    .local v28, "ident":J
+    .local v6, "ident":J
     :try_start_0
-    new-instance v13, Landroid/content/Intent;
-
-    const-string v5, "android.intent.action.USER_STOPPING"
-
-    invoke-direct {v13, v5}, Landroid/content/Intent;-><init>(Ljava/lang/String;)V
-
-    .local v13, "stoppingIntent":Landroid/content/Intent;
-    const/high16 v5, 0x40000000    # 2.0f
-
-    invoke-virtual {v13, v5}, Landroid/content/Intent;->addFlags(I)Landroid/content/Intent;
-
-    const-string v5, "android.intent.extra.user_handle"
-
-    move/from16 v0, p1
-
-    invoke-virtual {v13, v5, v0}, Landroid/content/Intent;->putExtra(Ljava/lang/String;I)Landroid/content/Intent;
-
-    const-string v5, "android.intent.extra.SHUTDOWN_USERSPACE_ONLY"
-
-    const/4 v7, 0x1
-
-    invoke-virtual {v13, v5, v7}, Landroid/content/Intent;->putExtra(Ljava/lang/String;Z)Landroid/content/Intent;
-
     new-instance v8, Landroid/content/Intent;
 
-    const-string v5, "android.intent.action.ACTION_SHUTDOWN"
-
-    invoke-direct {v8, v5}, Landroid/content/Intent;-><init>(Ljava/lang/String;)V
-
-    .local v8, "shutdownIntent":Landroid/content/Intent;
-    new-instance v9, Lcom/android/server/am/ActivityManagerService$29;
-
-    move-object/from16 v0, p0
-
-    invoke-direct {v9, v0, v6}, Lcom/android/server/am/ActivityManagerService$29;-><init>(Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/UserState;)V
-
-    .local v9, "shutdownReceiver":Landroid/content/IIntentReceiver;
-    new-instance v4, Lcom/android/server/am/ActivityManagerService$30;
-
-    move-object/from16 v5, p0
-
-    move/from16 v7, p1
+    const-string v1, "android.intent.action.USER_STOPPING"
 
-    invoke-direct/range {v4 .. v9}, Lcom/android/server/am/ActivityManagerService$30;-><init>(Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/UserState;ILandroid/content/Intent;Landroid/content/IIntentReceiver;)V
+    invoke-direct {v8, v1}, Landroid/content/Intent;-><init>(Ljava/lang/String;)V
 
-    .local v4, "stoppingReceiver":Landroid/content/IIntentReceiver;
-    const/4 v5, 0x1
-
-    new-array v0, v5, [Ljava/lang/String;
+    .local v8, "stoppingIntent":Landroid/content/Intent;
+    const/high16 v1, 0x40000000    # 2.0f
 
-    move-object/from16 v19, v0
+    invoke-virtual {v8, v1}, Landroid/content/Intent;->addFlags(I)Landroid/content/Intent;
 
-    const-string v5, "android.permission.INTERACT_ACROSS_USERS"
-
-    const/4 v7, 0x0
+    const-string v1, "android.intent.extra.user_handle"
 
-    aput-object v5, v19, v7
+    invoke-virtual {v8, v1, p1}, Landroid/content/Intent;->putExtra(Ljava/lang/String;I)Landroid/content/Intent;
 
-    sget v24, Lcom/android/server/am/ActivityManagerService;->MY_PID:I
+    const-string v1, "android.intent.extra.SHUTDOWN_USERSPACE_ONLY"
 
-    const/4 v11, 0x0
+    const/4 v3, 0x1
 
-    const/4 v12, 0x0
+    invoke-virtual {v8, v1, v3}, Landroid/content/Intent;->putExtra(Ljava/lang/String;Z)Landroid/content/Intent;
 
-    const/4 v14, 0x0
+    new-instance v4, Landroid/content/Intent;
 
-    const/16 v16, 0x0
+    const-string v1, "android.intent.action.ACTION_SHUTDOWN"
 
-    const/16 v17, 0x0
+    invoke-direct {v4, v1}, Landroid/content/Intent;-><init>(Ljava/lang/String;)V
 
-    const/16 v18, 0x0
+    .local v4, "shutdownIntent":Landroid/content/Intent;
+    new-instance v5, Lcom/android/server/am/ActivityManagerService$29;
 
-    const/16 v20, -0x1
+    invoke-direct {v5, p0, v2}, Lcom/android/server/am/ActivityManagerService$29;-><init>(Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/UserState;)V
 
-    const/16 v21, 0x0
+    .local v5, "shutdownReceiver":Landroid/content/IIntentReceiver;
+    new-instance v0, Lcom/android/server/am/ActivityManagerService$1StoppingReceiver;
 
-    const/16 v22, 0x1
+    move-object v1, p0
 
-    const/16 v23, 0x0
+    move v3, p1
 
-    const/16 v25, 0x3e8
+    invoke-direct/range {v0 .. v5}, Lcom/android/server/am/ActivityManagerService$1StoppingReceiver;-><init>(Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/UserState;ILandroid/content/Intent;Landroid/content/IIntentReceiver;)V
 
-    const/16 v26, -0x1
+    .local v0, "stoppingReceiver":Lcom/android/server/am/ActivityManagerService$1StoppingReceiver;
+    new-instance v9, Lcom/android/server/am/ActivityManagerService$userStoppingBroadcastRunnable;
 
-    move-object/from16 v10, p0
+    invoke-direct {v9, p0, v8, v0}, Lcom/android/server/am/ActivityManagerService$userStoppingBroadcastRunnable;-><init>(Lcom/android/server/am/ActivityManagerService;Landroid/content/Intent;Lcom/android/server/am/ActivityManagerService$1StoppingReceiver;)V
 
-    move-object v15, v4
+    .local v9, "userStoppingBroadcastRunnable":Ljava/lang/Runnable;
+    iput-object v9, v0, Lcom/android/server/am/ActivityManagerService$1StoppingReceiver;->broadcastRunnable:Ljava/lang/Runnable;
 
-    invoke-direct/range {v10 .. v26}, Lcom/android/server/am/ActivityManagerService;->broadcastIntentLocked(Lcom/android/server/am/ProcessRecord;Ljava/lang/String;Landroid/content/Intent;Ljava/lang/String;Landroid/content/IIntentReceiver;ILjava/lang/String;Landroid/os/Bundle;[Ljava/lang/String;ILandroid/os/Bundle;ZZIII)I
+    invoke-interface {v9}, Ljava/lang/Runnable;->run()V
     :try_end_0
     .catchall {:try_start_0 .. :try_end_0} :catchall_0
 
-    invoke-static/range {v28 .. v29}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    invoke-static {v6, v7}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
-    .end local v4    # "stoppingReceiver":Landroid/content/IIntentReceiver;
-    .end local v8    # "shutdownIntent":Landroid/content/Intent;
-    .end local v9    # "shutdownReceiver":Landroid/content/IIntentReceiver;
-    .end local v13    # "stoppingIntent":Landroid/content/Intent;
-    .end local v28    # "ident":J
+    .end local v0    # "stoppingReceiver":Lcom/android/server/am/ActivityManagerService$1StoppingReceiver;
+    .end local v4    # "shutdownIntent":Landroid/content/Intent;
+    .end local v5    # "shutdownReceiver":Landroid/content/IIntentReceiver;
+    .end local v6    # "ident":J
+    .end local v8    # "stoppingIntent":Landroid/content/Intent;
+    .end local v9    # "userStoppingBroadcastRunnable":Ljava/lang/Runnable;
     :cond_4
-    const/4 v5, 0x0
+    move v1, v10
 
-    return v5
+    goto :goto_0
 
-    .restart local v28    # "ident":J
+    .restart local v6    # "ident":J
     :catchall_0
-    move-exception v5
+    move-exception v1
 
-    invoke-static/range {v28 .. v29}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    invoke-static {v6, v7}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
-    throw v5
+    throw v1
 .end method
 
 .method private updateCurrentProfileIdsLocked()V
@@ -33323,7 +33568,7 @@
     iput-boolean v2, v0, Lcom/android/server/am/ActivityManagerService;->mAllowLowerMemLevel:Z
 
     :goto_1
-    const/4 v2, 0x3
+    const/4 v2, 0x4
 
     new-array v2, v2, [Ljava/lang/Object;
 
@@ -33359,6 +33604,18 @@
 
     aput-object v4, v2, v5
 
+    const/4 v5, 0x3
+
+    move-object/from16 v0, p1
+
+    iget v4, v0, Lcom/android/server/am/ProcessRecord;->curProcState:I
+
+    invoke-static {v4}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v4
+
+    aput-object v4, v2, v5
+
     const/16 v4, 0x753b
 
     invoke-static {v4, v2}, Landroid/util/EventLog;->writeEvent(I[Ljava/lang/Object;)I
@@ -33553,7 +33810,7 @@
 
     invoke-static {v2, v4}, Landroid/util/Slog;->i(Ljava/lang/String;Ljava/lang/String;)I
 
-    const/4 v2, 0x3
+    const/4 v2, 0x4
 
     new-array v2, v2, [Ljava/lang/Object;
 
@@ -33589,6 +33846,18 @@
 
     aput-object v4, v2, v5
 
+    const/4 v5, 0x3
+
+    move-object/from16 v0, p1
+
+    iget v4, v0, Lcom/android/server/am/ProcessRecord;->curProcState:I
+
+    invoke-static {v4}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v4
+
+    aput-object v4, v2, v5
+
     const/16 v4, 0x753b
 
     invoke-static {v4, v2}, Landroid/util/EventLog;->writeEvent(I[Ljava/lang/Object;)I
@@ -35786,7 +36055,38 @@
     throw v0
 
     :cond_0
-    if-nez p7, :cond_1
+    iget-object v0, p0, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+
+    invoke-static {}, Landroid/os/Binder;->getCallingUid()I
+
+    move-result v1
+
+    invoke-static {v1}, Landroid/os/UserHandle;->getUserId(I)I
+
+    move-result v5
+
+    iget-boolean v6, p0, Lcom/android/server/am/ActivityManagerService;->mSystemReady:Z
+
+    move-object v1, p0
+
+    move-object v2, p1
+
+    move-object v3, p3
+
+    move-object v4, p4
+
+    invoke-static/range {v0 .. v6}, Lcom/android/server/am/ExtraActivityManagerService;->checkRunningCompatibility(Landroid/content/Context;Lcom/android/server/am/ActivityManagerService;Landroid/app/IApplicationThread;Landroid/content/Intent;Ljava/lang/String;IZ)Z
+
+    move-result v0
+
+    if-nez v0, :cond_1
+
+    const/4 v0, 0x0
+
+    goto :goto_0
+
+    :cond_1
+    if-nez p7, :cond_2
 
     new-instance v0, Ljava/lang/IllegalArgumentException;
 
@@ -35796,7 +36096,7 @@
 
     throw v0
 
-    :cond_1
+    :cond_2
     monitor-enter p0
 
     :try_start_0
@@ -35826,6 +36126,7 @@
 
     monitor-exit p0
 
+    :goto_0
     return v0
 
     :catchall_0
@@ -42730,9 +43031,9 @@
     .param p6, "categoryPw"    # Ljava/io/PrintWriter;
 
     .prologue
-    const/16 v74, 0x0
+    const/16 v76, 0x0
 
-    .local v74, "dumpDetails":Z
+    .local v76, "dumpDetails":Z
     const/16 v17, 0x0
 
     .local v17, "dumpFullDetails":Z
@@ -42742,42 +43043,54 @@
     const/16 v19, 0x0
 
     .local v19, "dumpSummaryOnly":Z
-    const/16 v97, 0x0
+    const/16 v98, 0x0
 
-    .local v97, "oomOnly":Z
+    .local v98, "oomOnly":Z
     const/4 v13, 0x0
 
     .local v13, "isCompact":Z
-    const/16 v85, 0x0
+    const/16 v86, 0x0
 
-    .local v85, "localOnly":Z
-    const/16 v102, 0x0
+    .local v86, "localOnly":Z
+    const/16 v103, 0x0
 
-    .local v102, "packages":Z
-    const/16 v101, 0x0
+    .local v103, "packages":Z
+    const/16 v102, 0x0
 
-    .local v101, "opti":I
+    .local v102, "opti":I
     :goto_0
     move-object/from16 v0, p4
 
     array-length v6, v0
 
-    move/from16 v0, v101
+    move/from16 v0, v102
 
     if-ge v0, v6, :cond_0
 
-    aget-object v100, p4, v101
+    aget-object v101, p4, v102
+
+    .local v101, "opt":Ljava/lang/String;
+    if-eqz v101, :cond_0
 
-    .local v100, "opt":Ljava/lang/String;
-    if-eqz v100, :cond_0
+    invoke-virtual/range {v101 .. v101}, Ljava/lang/String;->length()I
 
-    invoke-virtual/range {v100 .. v100}, Ljava/lang/String;->length()I
+    move-result v6
+
+    if-lez v6, :cond_0
+
+    const/4 v6, 0x0
+
+    move-object/from16 v0, v101
+
+    invoke-virtual {v0, v6}, Ljava/lang/String;->charAt(I)C
 
     move-result v6
 
-    if-gtz v6, :cond_3
+    const/16 v7, 0x2d
+
+    if-eq v6, v7, :cond_3
 
-    .end local v100    # "opt":Ljava/lang/String;
+    .end local v101    # "opt":Ljava/lang/String;
     :cond_0
     const-string v6, "--checkin"
 
@@ -42809,18 +43122,18 @@
 
     move-object/from16 v1, p2
 
-    move/from16 v2, v101
+    move/from16 v2, v102
 
-    move/from16 v3, v102
+    move/from16 v3, v103
 
     move-object/from16 v4, p4
 
     invoke-virtual {v0, v1, v2, v3, v4}, Lcom/android/server/am/ActivityManagerService;->collectProcesses(Ljava/io/PrintWriter;IZ[Ljava/lang/String;)Ljava/util/ArrayList;
 
-    move-result-object v105
+    move-result-object v106
 
-    .local v105, "procs":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ProcessRecord;>;"
-    if-nez v105, :cond_14
+    .local v106, "procs":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ProcessRecord;>;"
+    if-nez v106, :cond_14
 
     if-eqz p4, :cond_13
 
@@ -42828,11 +43141,11 @@
 
     array-length v6, v0
 
-    move/from16 v0, v101
+    move/from16 v0, v102
 
     if-le v6, v0, :cond_13
 
-    aget-object v6, p4, v101
+    aget-object v6, p4, v102
 
     const/4 v7, 0x0
 
@@ -42844,24 +43157,24 @@
 
     if-eq v6, v7, :cond_13
 
-    new-instance v91, Ljava/util/ArrayList;
+    new-instance v92, Ljava/util/ArrayList;
 
-    invoke-direct/range {v91 .. v91}, Ljava/util/ArrayList;-><init>()V
+    invoke-direct/range {v92 .. v92}, Ljava/util/ArrayList;-><init>()V
 
-    .local v91, "nativeProcs":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/internal/os/ProcessCpuTracker$Stats;>;"
+    .local v92, "nativeProcs":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/internal/os/ProcessCpuTracker$Stats;>;"
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/am/ActivityManagerService;->updateCpuStatsNow()V
 
-    const/16 v77, -0x1
+    const/16 v78, -0x1
 
-    .local v77, "findPid":I
+    .local v78, "findPid":I
     :try_start_0
-    aget-object v6, p4, v101
+    aget-object v6, p4, v102
 
     invoke-static {v6}, Ljava/lang/Integer;->parseInt(Ljava/lang/String;)I
     :try_end_0
     .catch Ljava/lang/NumberFormatException; {:try_start_0 .. :try_end_0} :catch_1
 
-    move-result v77
+    move-result v78
 
     :goto_1
     move-object/from16 v0, p0
@@ -42877,24 +43190,24 @@
 
     invoke-virtual {v6}, Lcom/android/internal/os/ProcessCpuTracker;->countStats()I
 
-    move-result v36
+    move-result v38
 
-    .local v36, "N":I
-    const/16 v80, 0x0
+    .local v38, "N":I
+    const/16 v79, 0x0
 
-    .local v80, "i":I
+    .local v79, "i":I
     :goto_2
-    move/from16 v0, v80
+    move/from16 v0, v79
 
-    move/from16 v1, v36
+    move/from16 v1, v38
 
-    if-ge v0, v1, :cond_c
+    if-ge v0, v1, :cond_d
 
     move-object/from16 v0, p0
 
     iget-object v6, v0, Lcom/android/server/am/ActivityManagerService;->mProcessCpuTracker:Lcom/android/internal/os/ProcessCpuTracker;
 
-    move/from16 v0, v80
+    move/from16 v0, v79
 
     invoke-virtual {v6, v0}, Lcom/android/internal/os/ProcessCpuTracker;->getStats(I)Lcom/android/internal/os/ProcessCpuTracker$Stats;
 
@@ -42905,7 +43218,7 @@
 
     iget v6, v0, Lcom/android/internal/os/ProcessCpuTracker$Stats;->pid:I
 
-    move/from16 v0, v77
+    move/from16 v0, v78
 
     if-eq v6, v0, :cond_1
 
@@ -42919,7 +43232,7 @@
 
     iget-object v6, v0, Lcom/android/internal/os/ProcessCpuTracker$Stats;->baseName:Ljava/lang/String;
 
-    aget-object v14, p4, v101
+    aget-object v14, p4, v102
 
     invoke-virtual {v6, v14}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
@@ -42928,7 +43241,7 @@
     if-eqz v6, :cond_2
 
     :cond_1
-    move-object/from16 v0, v91
+    move-object/from16 v0, v92
 
     move-object/from16 v1, v108
 
@@ -42937,39 +43250,27 @@
     .catchall {:try_start_1 .. :try_end_1} :catchall_0
 
     :cond_2
-    add-int/lit8 v80, v80, 0x1
+    add-int/lit8 v79, v79, 0x1
 
     goto :goto_2
 
     .end local v8    # "uptime":J
     .end local v10    # "realtime":J
     .end local v12    # "isCheckinRequest":Z
-    .end local v36    # "N":I
-    .end local v77    # "findPid":I
-    .end local v80    # "i":I
-    .end local v91    # "nativeProcs":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/internal/os/ProcessCpuTracker$Stats;>;"
-    .end local v105    # "procs":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ProcessRecord;>;"
+    .end local v38    # "N":I
+    .end local v78    # "findPid":I
+    .end local v79    # "i":I
+    .end local v92    # "nativeProcs":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/internal/os/ProcessCpuTracker$Stats;>;"
+    .end local v106    # "procs":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ProcessRecord;>;"
     .end local v108    # "st":Lcom/android/internal/os/ProcessCpuTracker$Stats;
     .end local v109    # "tmpLong":[J
-    .restart local v100    # "opt":Ljava/lang/String;
+    .restart local v101    # "opt":Ljava/lang/String;
     :cond_3
-    const/4 v6, 0x0
-
-    move-object/from16 v0, v100
-
-    invoke-virtual {v0, v6}, Ljava/lang/String;->charAt(I)C
-
-    move-result v6
-
-    const/16 v7, 0x2d
-
-    if-ne v6, v7, :cond_0
-
-    add-int/lit8 v101, v101, 0x1
+    add-int/lit8 v102, v102, 0x1
 
     const-string v6, "-a"
 
-    move-object/from16 v0, v100
+    move-object/from16 v0, v101
 
     invoke-virtual {v6, v0}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
@@ -42977,7 +43278,7 @@
 
     if-eqz v6, :cond_4
 
-    const/16 v74, 0x1
+    const/16 v76, 0x1
 
     const/16 v17, 0x1
 
@@ -42988,7 +43289,7 @@
     :cond_4
     const-string v6, "-d"
 
-    move-object/from16 v0, v100
+    move-object/from16 v0, v101
 
     invoke-virtual {v6, v0}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
@@ -43003,7 +43304,7 @@
     :cond_5
     const-string v6, "-c"
 
-    move-object/from16 v0, v100
+    move-object/from16 v0, v101
 
     invoke-virtual {v6, v0}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
@@ -43018,7 +43319,7 @@
     :cond_6
     const-string v6, "-s"
 
-    move-object/from16 v0, v100
+    move-object/from16 v0, v101
 
     invoke-virtual {v6, v0}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
@@ -43026,7 +43327,7 @@
 
     if-eqz v6, :cond_7
 
-    const/16 v74, 0x1
+    const/16 v76, 0x1
 
     const/16 v19, 0x1
 
@@ -43035,7 +43336,7 @@
     :cond_7
     const-string v6, "--oom"
 
-    move-object/from16 v0, v100
+    move-object/from16 v0, v101
 
     invoke-virtual {v6, v0}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
@@ -43043,14 +43344,14 @@
 
     if-eqz v6, :cond_8
 
-    const/16 v97, 0x1
+    const/16 v98, 0x1
 
     goto/16 :goto_0
 
     :cond_8
     const-string v6, "--local"
 
-    move-object/from16 v0, v100
+    move-object/from16 v0, v101
 
     invoke-virtual {v6, v0}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
@@ -43058,14 +43359,14 @@
 
     if-eqz v6, :cond_9
 
-    const/16 v85, 0x1
+    const/16 v86, 0x1
 
     goto/16 :goto_0
 
     :cond_9
     const-string v6, "--package"
 
-    move-object/from16 v0, v100
+    move-object/from16 v0, v101
 
     invoke-virtual {v6, v0}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
@@ -43073,20 +43374,20 @@
 
     if-eqz v6, :cond_a
 
-    const/16 v102, 0x1
+    const/16 v103, 0x1
 
     goto/16 :goto_0
 
     :cond_a
     const-string v6, "-h"
 
-    move-object/from16 v0, v100
+    move-object/from16 v0, v101
 
     invoke-virtual {v6, v0}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
     move-result v6
 
-    if-eqz v6, :cond_b
+    if-eqz v6, :cond_c
 
     const-string v6, "meminfo dump options: [-a] [-d] [-c] [-s] [--oom] [process]"
 
@@ -43154,9 +43455,13 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
 
+    .end local v101    # "opt":Ljava/lang/String;
+    :cond_b
+    :goto_3
     return-void
 
-    :cond_b
+    .restart local v101    # "opt":Ljava/lang/String;
+    :cond_c
     new-instance v6, Ljava/lang/StringBuilder;
 
     invoke-direct {v6}, Ljava/lang/StringBuilder;-><init>()V
@@ -43167,7 +43472,7 @@
 
     move-result-object v6
 
-    move-object/from16 v0, v100
+    move-object/from16 v0, v101
 
     invoke-virtual {v6, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
@@ -43189,20 +43494,23 @@
 
     goto/16 :goto_0
 
-    .end local v100    # "opt":Ljava/lang/String;
+    .end local v101    # "opt":Ljava/lang/String;
     .restart local v8    # "uptime":J
     .restart local v10    # "realtime":J
     .restart local v12    # "isCheckinRequest":Z
-    .restart local v36    # "N":I
-    .restart local v77    # "findPid":I
-    .restart local v80    # "i":I
-    .restart local v91    # "nativeProcs":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/internal/os/ProcessCpuTracker$Stats;>;"
-    .restart local v105    # "procs":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ProcessRecord;>;"
+    .restart local v38    # "N":I
+    .restart local v78    # "findPid":I
+    .restart local v79    # "i":I
+    .restart local v92    # "nativeProcs":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/internal/os/ProcessCpuTracker$Stats;>;"
+    .restart local v106    # "procs":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ProcessRecord;>;"
     .restart local v109    # "tmpLong":[J
-    :cond_c
+    :cond_d
+    :try_start_2
     monitor-exit v7
+    :try_end_2
+    .catchall {:try_start_2 .. :try_end_2} :catchall_0
 
-    invoke-virtual/range {v91 .. v91}, Ljava/util/ArrayList;->size()I
+    invoke-virtual/range {v92 .. v92}, Ljava/util/ArrayList;->size()I
 
     move-result v6
 
@@ -43217,37 +43525,36 @@
     const/4 v15, 0x0
 
     .local v15, "mi":Landroid/os/Debug$MemoryInfo;
-    invoke-virtual/range {v91 .. v91}, Ljava/util/ArrayList;->size()I
+    invoke-virtual/range {v92 .. v92}, Ljava/util/ArrayList;->size()I
 
     move-result v6
 
-    add-int/lit8 v80, v6, -0x1
+    add-int/lit8 v79, v6, -0x1
 
-    .end local v15    # "mi":Landroid/os/Debug$MemoryInfo;
-    :goto_3
-    if-ltz v80, :cond_12
+    :goto_4
+    if-ltz v79, :cond_b
 
-    move-object/from16 v0, v91
+    move-object/from16 v0, v92
 
-    move/from16 v1, v80
+    move/from16 v1, v79
 
     invoke-virtual {v0, v1}, Ljava/util/ArrayList;->get(I)Ljava/lang/Object;
 
-    move-result-object v106
+    move-result-object v107
 
-    check-cast v106, Lcom/android/internal/os/ProcessCpuTracker$Stats;
+    check-cast v107, Lcom/android/internal/os/ProcessCpuTracker$Stats;
 
-    .local v106, "r":Lcom/android/internal/os/ProcessCpuTracker$Stats;
-    move-object/from16 v0, v106
+    .local v107, "r":Lcom/android/internal/os/ProcessCpuTracker$Stats;
+    move-object/from16 v0, v107
 
     iget v0, v0, Lcom/android/internal/os/ProcessCpuTracker$Stats;->pid:I
 
     move/from16 v20, v0
 
     .local v20, "pid":I
-    if-nez v12, :cond_d
+    if-nez v12, :cond_e
 
-    if-eqz v74, :cond_d
+    if-eqz v76, :cond_e
 
     new-instance v6, Ljava/lang/StringBuilder;
 
@@ -43271,7 +43578,7 @@
 
     move-result-object v6
 
-    move-object/from16 v0, v106
+    move-object/from16 v0, v107
 
     iget-object v7, v0, Lcom/android/internal/os/ProcessCpuTracker$Stats;->baseName:Ljava/lang/String;
 
@@ -43293,45 +43600,29 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
 
-    :cond_d
-    if-nez v15, :cond_e
+    :cond_e
+    if-nez v15, :cond_f
 
     new-instance v15, Landroid/os/Debug$MemoryInfo;
 
+    .end local v15    # "mi":Landroid/os/Debug$MemoryInfo;
     invoke-direct {v15}, Landroid/os/Debug$MemoryInfo;-><init>()V
 
-    :cond_e
-    if-nez v74, :cond_11
-
-    if-nez p5, :cond_f
-
-    if-eqz v97, :cond_11
-
+    .restart local v15    # "mi":Landroid/os/Debug$MemoryInfo;
     :cond_f
-    const/4 v6, 0x0
-
-    move/from16 v0, v20
-
-    move-object/from16 v1, v109
-
-    invoke-static {v0, v1, v6}, Landroid/os/Debug;->getPss(I[J[J)J
-
-    move-result-wide v6
-
-    long-to-int v6, v6
-
-    iput v6, v15, Landroid/os/Debug$MemoryInfo;->dalvikPss:I
+    if-nez v76, :cond_10
 
-    const/4 v6, 0x0
+    if-nez p5, :cond_12
 
-    aget-wide v6, v109, v6
+    if-nez v98, :cond_12
 
-    long-to-int v6, v6
+    :cond_10
+    move/from16 v0, v20
 
-    iput v6, v15, Landroid/os/Debug$MemoryInfo;->dalvikPrivateDirty:I
+    invoke-static {v0, v15}, Landroid/os/Debug;->getMemoryInfo(ILandroid/os/Debug$MemoryInfo;)V
 
-    :goto_4
-    move-object/from16 v0, v106
+    :goto_5
+    move-object/from16 v0, v107
 
     iget-object v0, v0, Lcom/android/internal/os/ProcessCpuTracker$Stats;->baseName:Ljava/lang/String;
 
@@ -43355,46 +43646,67 @@
 
     invoke-static/range {v14 .. v33}, Landroid/app/ActivityThread;->dumpMemInfoTable(Ljava/io/PrintWriter;Landroid/os/Debug$MemoryInfo;ZZZZILjava/lang/String;JJJJJJ)V
 
-    if-eqz v12, :cond_10
+    if-eqz v12, :cond_11
 
     invoke-virtual/range {p2 .. p2}, Ljava/io/PrintWriter;->println()V
 
-    :cond_10
-    add-int/lit8 v80, v80, -0x1
+    :cond_11
+    add-int/lit8 v79, v79, -0x1
 
-    goto/16 :goto_3
+    goto :goto_4
 
+    .end local v15    # "mi":Landroid/os/Debug$MemoryInfo;
     .end local v20    # "pid":I
-    .end local v36    # "N":I
-    .end local v80    # "i":I
-    .end local v106    # "r":Lcom/android/internal/os/ProcessCpuTracker$Stats;
+    .end local v38    # "N":I
+    .end local v79    # "i":I
+    .end local v107    # "r":Lcom/android/internal/os/ProcessCpuTracker$Stats;
     :catchall_0
     move-exception v6
 
+    :try_start_3
     monitor-exit v7
+    :try_end_3
+    .catchall {:try_start_3 .. :try_end_3} :catchall_0
 
     throw v6
 
+    .restart local v15    # "mi":Landroid/os/Debug$MemoryInfo;
     .restart local v20    # "pid":I
-    .restart local v36    # "N":I
-    .restart local v80    # "i":I
-    .restart local v106    # "r":Lcom/android/internal/os/ProcessCpuTracker$Stats;
-    :cond_11
+    .restart local v38    # "N":I
+    .restart local v79    # "i":I
+    .restart local v107    # "r":Lcom/android/internal/os/ProcessCpuTracker$Stats;
+    :cond_12
+    const/4 v6, 0x0
+
     move/from16 v0, v20
 
-    invoke-static {v0, v15}, Landroid/os/Debug;->getMemoryInfo(ILandroid/os/Debug$MemoryInfo;)V
+    move-object/from16 v1, v109
 
-    goto :goto_4
+    invoke-static {v0, v1, v6}, Landroid/os/Debug;->getPss(I[J[J)J
 
-    .end local v20    # "pid":I
-    .end local v106    # "r":Lcom/android/internal/os/ProcessCpuTracker$Stats;
-    :cond_12
-    return-void
+    move-result-wide v6
+
+    long-to-int v6, v6
 
-    .end local v36    # "N":I
-    .end local v77    # "findPid":I
-    .end local v80    # "i":I
-    .end local v91    # "nativeProcs":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/internal/os/ProcessCpuTracker$Stats;>;"
+    iput v6, v15, Landroid/os/Debug$MemoryInfo;->dalvikPss:I
+
+    const/4 v6, 0x0
+
+    aget-wide v6, v109, v6
+
+    long-to-int v6, v6
+
+    iput v6, v15, Landroid/os/Debug$MemoryInfo;->dalvikPrivateDirty:I
+
+    goto :goto_5
+
+    .end local v15    # "mi":Landroid/os/Debug$MemoryInfo;
+    .end local v20    # "pid":I
+    .end local v38    # "N":I
+    .end local v78    # "findPid":I
+    .end local v79    # "i":I
+    .end local v92    # "nativeProcs":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/internal/os/ProcessCpuTracker$Stats;>;"
+    .end local v107    # "r":Lcom/android/internal/os/ProcessCpuTracker$Stats;
     :cond_13
     new-instance v6, Ljava/lang/StringBuilder;
 
@@ -43406,7 +43718,7 @@
 
     move-result-object v6
 
-    aget-object v7, p4, v101
+    aget-object v7, p4, v102
 
     invoke-virtual {v6, v7}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
@@ -43420,15 +43732,29 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
 
-    return-void
+    goto/16 :goto_3
 
     :cond_14
-    if-nez p5, :cond_15
+    if-nez p5, :cond_16
 
-    if-eqz v97, :cond_1b
+    if-nez v98, :cond_16
+
+    invoke-virtual/range {v106 .. v106}, Ljava/util/ArrayList;->size()I
+
+    move-result v6
+
+    const/4 v7, 0x1
+
+    if-eq v6, v7, :cond_15
+
+    if-nez v12, :cond_15
+
+    if-eqz v103, :cond_16
 
     :cond_15
-    :goto_5
+    const/16 v76, 0x1
+
+    :cond_16
     move-object/from16 v6, p0
 
     move-object/from16 v7, p2
@@ -43439,106 +43765,107 @@
 
     array-length v6, v0
 
-    sub-int v6, v6, v101
+    sub-int v6, v6, v102
 
     new-array v0, v6, [Ljava/lang/String;
 
-    move-object/from16 v81, v0
+    move-object/from16 v82, v0
 
-    .local v81, "innerArgs":[Ljava/lang/String;
-    move-object/from16 v0, p4
+    .local v82, "innerArgs":[Ljava/lang/String;
+    const/4 v6, 0x0
 
-    array-length v6, v0
+    move-object/from16 v0, p4
 
-    sub-int v6, v6, v101
+    array-length v7, v0
 
-    const/4 v7, 0x0
+    sub-int v7, v7, v102
 
     move-object/from16 v0, p4
 
-    move/from16 v1, v101
+    move/from16 v1, v102
 
-    move-object/from16 v2, v81
+    move-object/from16 v2, v82
 
-    invoke-static {v0, v1, v2, v7, v6}, Ljava/lang/System;->arraycopy(Ljava/lang/Object;ILjava/lang/Object;II)V
+    invoke-static {v0, v1, v2, v6, v7}, Ljava/lang/System;->arraycopy(Ljava/lang/Object;ILjava/lang/Object;II)V
 
-    new-instance v103, Ljava/util/ArrayList;
+    new-instance v104, Ljava/util/ArrayList;
 
-    invoke-direct/range {v103 .. v103}, Ljava/util/ArrayList;-><init>()V
+    invoke-direct/range {v104 .. v104}, Ljava/util/ArrayList;-><init>()V
 
-    .local v103, "procMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    new-instance v104, Landroid/util/SparseArray;
+    .local v104, "procMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
+    new-instance v105, Landroid/util/SparseArray;
 
-    invoke-direct/range {v104 .. v104}, Landroid/util/SparseArray;-><init>()V
+    invoke-direct/range {v105 .. v105}, Landroid/util/SparseArray;-><init>()V
 
-    .local v104, "procMemsMap":Landroid/util/SparseArray;, "Landroid/util/SparseArray<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    const-wide/16 v92, 0x0
+    .local v105, "procMemsMap":Landroid/util/SparseArray;, "Landroid/util/SparseArray<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
+    const-wide/16 v94, 0x0
 
-    .local v92, "nativePss":J
-    const-wide/16 v72, 0x0
+    .local v94, "nativePss":J
+    const-wide/16 v74, 0x0
 
-    .local v72, "dalvikPss":J
-    if-eqz v18, :cond_1d
+    .local v74, "dalvikPss":J
+    if-eqz v18, :cond_1c
 
     const/16 v6, 0x8
 
     new-array v0, v6, [J
 
-    move-object/from16 v71, v0
+    move-object/from16 v73, v0
 
-    .local v71, "dalvikSubitemPss":[J
+    .local v73, "dalvikSubitemPss":[J
     :goto_6
-    const-wide/16 v48, 0x0
+    const-wide/16 v50, 0x0
 
-    .local v48, "otherPss":J
+    .local v50, "otherPss":J
     const/16 v6, 0x11
 
     new-array v0, v6, [J
 
-    move-object/from16 v90, v0
+    move-object/from16 v91, v0
 
-    .local v90, "miscPss":[J
+    .local v91, "miscPss":[J
     sget-object v6, Lcom/android/server/am/ActivityManagerService;->DUMP_MEM_OOM_LABEL:[Ljava/lang/String;
 
     array-length v6, v6
 
     new-array v0, v6, [J
 
-    move-object/from16 v99, v0
+    move-object/from16 v100, v0
 
-    .local v99, "oomPss":[J
+    .local v100, "oomPss":[J
     sget-object v6, Lcom/android/server/am/ActivityManagerService;->DUMP_MEM_OOM_LABEL:[Ljava/lang/String;
 
     array-length v6, v6
 
     new-array v0, v6, [Ljava/util/ArrayList;
 
-    move-object/from16 v98, v0
+    move-object/from16 v99, v0
+
+    check-cast v99, [Ljava/util/ArrayList;
 
-    .local v98, "oomProcs":[Ljava/util/ArrayList;, "[Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
+    .local v99, "oomProcs":[Ljava/util/ArrayList;, "[Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
     const-wide/16 v110, 0x0
 
     .local v110, "totalPss":J
-    const-wide/16 v68, 0x0
+    const-wide/16 v70, 0x0
 
-    .local v68, "cachedPss":J
+    .local v70, "cachedPss":J
     const/4 v15, 0x0
 
     .restart local v15    # "mi":Landroid/os/Debug$MemoryInfo;
-    invoke-virtual/range {v105 .. v105}, Ljava/util/ArrayList;->size()I
+    invoke-virtual/range {v106 .. v106}, Ljava/util/ArrayList;->size()I
 
     move-result v6
 
-    add-int/lit8 v80, v6, -0x1
+    add-int/lit8 v79, v6, -0x1
 
-    .end local v15    # "mi":Landroid/os/Debug$MemoryInfo;
-    .restart local v80    # "i":I
+    .restart local v79    # "i":I
     :goto_7
-    if-ltz v80, :cond_29
+    if-ltz v79, :cond_28
 
-    move-object/from16 v0, v105
+    move-object/from16 v0, v106
 
-    move/from16 v1, v80
+    move/from16 v1, v79
 
     invoke-virtual {v0, v1}, Ljava/util/ArrayList;->get(I)Ljava/lang/Object;
 
@@ -43549,7 +43876,7 @@
     .local v107, "r":Lcom/android/server/am/ProcessRecord;
     monitor-enter p0
 
-    :try_start_2
+    :try_start_4
     move-object/from16 v0, v107
 
     iget-object v0, v0, Lcom/android/server/am/ProcessRecord;->thread:Landroid/app/IApplicationThread;
@@ -43566,32 +43893,32 @@
     .restart local v20    # "pid":I
     invoke-virtual/range {v107 .. v107}, Lcom/android/server/am/ProcessRecord;->getSetAdjWithServices()I
 
-    move-result v94
+    move-result v93
 
-    .local v94, "oomAdj":I
+    .local v93, "oomAdj":I
     move-object/from16 v0, v107
 
     iget-object v6, v0, Lcom/android/server/am/ProcessRecord;->activities:Ljava/util/ArrayList;
 
     invoke-virtual {v6}, Ljava/util/ArrayList;->size()I
-    :try_end_2
-    .catchall {:try_start_2 .. :try_end_2} :catchall_1
 
     move-result v6
 
-    if-lez v6, :cond_1e
+    if-lez v6, :cond_1d
 
-    const/16 v35, 0x1
+    const/16 v37, 0x1
 
-    .local v35, "hasActivities":Z
+    .local v37, "hasActivities":Z
     :goto_8
     monitor-exit p0
+    :try_end_4
+    .catchall {:try_start_4 .. :try_end_4} :catchall_1
 
-    if-eqz v21, :cond_27
+    if-eqz v21, :cond_26
 
-    if-nez v12, :cond_16
+    if-nez v12, :cond_17
 
-    if-eqz v74, :cond_16
+    if-eqz v76, :cond_17
 
     new-instance v6, Ljava/lang/StringBuilder;
 
@@ -43637,47 +43964,31 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
 
-    :cond_16
-    if-nez v15, :cond_17
+    :cond_17
+    if-nez v15, :cond_18
 
     new-instance v15, Landroid/os/Debug$MemoryInfo;
 
+    .end local v15    # "mi":Landroid/os/Debug$MemoryInfo;
     invoke-direct {v15}, Landroid/os/Debug$MemoryInfo;-><init>()V
 
-    :cond_17
-    if-nez v74, :cond_1f
-
-    if-nez p5, :cond_18
-
-    if-eqz v97, :cond_1f
-
+    .restart local v15    # "mi":Landroid/os/Debug$MemoryInfo;
     :cond_18
-    const/4 v6, 0x0
-
-    move/from16 v0, v20
-
-    move-object/from16 v1, v109
-
-    invoke-static {v0, v1, v6}, Landroid/os/Debug;->getPss(I[J[J)J
-
-    move-result-wide v6
-
-    long-to-int v6, v6
-
-    iput v6, v15, Landroid/os/Debug$MemoryInfo;->dalvikPss:I
+    if-nez v76, :cond_19
 
-    const/4 v6, 0x0
+    if-nez p5, :cond_1e
 
-    aget-wide v6, v109, v6
+    if-nez v98, :cond_1e
 
-    long-to-int v6, v6
+    :cond_19
+    move/from16 v0, v20
 
-    iput v6, v15, Landroid/os/Debug$MemoryInfo;->dalvikPrivateDirty:I
+    invoke-static {v0, v15}, Landroid/os/Debug;->getMemoryInfo(ILandroid/os/Debug$MemoryInfo;)V
 
     :goto_9
-    if-eqz v74, :cond_19
+    if-eqz v76, :cond_1a
 
-    if-eqz v85, :cond_20
+    if-eqz v86, :cond_1f
 
     move-object/from16 v0, v107
 
@@ -43704,11 +44015,11 @@
 
     invoke-static/range {v14 .. v33}, Landroid/app/ActivityThread;->dumpMemInfoTable(Ljava/io/PrintWriter;Landroid/os/Debug$MemoryInfo;ZZZZILjava/lang/String;JJJJJJ)V
 
-    if-eqz v12, :cond_19
+    if-eqz v12, :cond_1a
 
     invoke-virtual/range {p2 .. p2}, Ljava/io/PrintWriter;->println()V
 
-    :cond_19
+    :cond_1a
     :goto_a
     invoke-virtual {v15}, Landroid/os/Debug$MemoryInfo;->getTotalPss()I
 
@@ -43728,22 +44039,31 @@
     move-wide/from16 v26, v0
 
     .local v26, "myTotalUss":J
+    invoke-virtual {v15}, Landroid/os/Debug$MemoryInfo;->getTotalSwappedOut()I
+
+    move-result v6
+
+    int-to-long v0, v6
+
+    move-wide/from16 v34, v0
+
+    .local v34, "myTotalSwap":J
     monitor-enter p0
 
-    :try_start_3
+    :try_start_5
     move-object/from16 v0, v107
 
     iget-object v6, v0, Lcom/android/server/am/ProcessRecord;->thread:Landroid/app/IApplicationThread;
 
-    if-eqz v6, :cond_1a
+    if-eqz v6, :cond_1b
 
     invoke-virtual/range {v107 .. v107}, Lcom/android/server/am/ProcessRecord;->getSetAdjWithServices()I
 
     move-result v6
 
-    move/from16 v0, v94
+    move/from16 v0, v93
 
-    if-ne v0, v6, :cond_1a
+    if-ne v0, v6, :cond_1b
 
     move-object/from16 v0, v107
 
@@ -43751,24 +44071,24 @@
 
     move-object/from16 v23, v0
 
+    const/16 v28, 0x1
+
     move-object/from16 v0, v107
 
     iget-object v0, v0, Lcom/android/server/am/ProcessRecord;->pkgList:Landroid/util/ArrayMap;
 
     move-object/from16 v29, v0
 
-    const/16 v28, 0x1
-
     invoke-virtual/range {v23 .. v29}, Lcom/android/internal/app/ProcessStats$ProcessState;->addPss(JJZLandroid/util/ArrayMap;)V
-    :try_end_3
-    .catchall {:try_start_3 .. :try_end_3} :catchall_2
 
-    :cond_1a
+    :cond_1b
     monitor-exit p0
+    :try_end_5
+    .catchall {:try_start_5 .. :try_end_5} :catchall_2
 
-    if-nez v12, :cond_27
+    if-nez v12, :cond_26
 
-    if-eqz v15, :cond_27
+    if-eqz v15, :cond_26
 
     add-long v110, v110, v24
 
@@ -43798,7 +44118,7 @@
 
     move-result-object v7
 
-    if-eqz v35, :cond_21
+    if-eqz v37, :cond_20
 
     const-string v6, " / activities)"
 
@@ -43819,18 +44139,18 @@
 
     move-wide/from16 v32, v24
 
-    move/from16 v34, v20
+    move/from16 v36, v20
 
-    invoke-direct/range {v29 .. v35}, Lcom/android/server/am/ActivityManagerService$MemItem;-><init>(Ljava/lang/String;Ljava/lang/String;JIZ)V
+    invoke-direct/range {v29 .. v37}, Lcom/android/server/am/ActivityManagerService$MemItem;-><init>(Ljava/lang/String;Ljava/lang/String;JJIZ)V
 
     .local v29, "pssItem":Lcom/android/server/am/ActivityManagerService$MemItem;
-    move-object/from16 v0, v103
+    move-object/from16 v0, v104
 
     move-object/from16 v1, v29
 
     invoke-virtual {v0, v1}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
 
-    move-object/from16 v0, v104
+    move-object/from16 v0, v105
 
     move/from16 v1, v20
 
@@ -43842,29 +44162,29 @@
 
     int-to-long v6, v6
 
-    add-long v92, v92, v6
+    add-long v94, v94, v6
 
     iget v6, v15, Landroid/os/Debug$MemoryInfo;->dalvikPss:I
 
     int-to-long v6, v6
 
-    add-long v72, v72, v6
+    add-long v74, v74, v6
 
-    const/16 v44, 0x0
+    const/16 v46, 0x0
 
-    .local v44, "j":I
+    .local v46, "j":I
     :goto_c
-    move-object/from16 v0, v71
+    move-object/from16 v0, v73
 
     array-length v6, v0
 
-    move/from16 v0, v44
+    move/from16 v0, v46
 
-    if-ge v0, v6, :cond_22
+    if-ge v0, v6, :cond_21
 
-    aget-wide v6, v71, v44
+    aget-wide v6, v73, v46
 
-    add-int/lit8 v14, v44, 0x11
+    add-int/lit8 v14, v46, 0x11
 
     invoke-virtual {v15, v14}, Landroid/os/Debug$MemoryInfo;->getOtherPss(I)I
 
@@ -43876,103 +44196,97 @@
 
     add-long v6, v6, v22
 
-    aput-wide v6, v71, v44
+    aput-wide v6, v73, v46
 
-    add-int/lit8 v44, v44, 0x1
+    add-int/lit8 v46, v46, 0x1
 
     goto :goto_c
 
+    .end local v15    # "mi":Landroid/os/Debug$MemoryInfo;
     .end local v20    # "pid":I
     .end local v24    # "myTotalPss":J
     .end local v26    # "myTotalUss":J
     .end local v29    # "pssItem":Lcom/android/server/am/ActivityManagerService$MemItem;
-    .end local v35    # "hasActivities":Z
-    .end local v44    # "j":I
-    .end local v48    # "otherPss":J
-    .end local v68    # "cachedPss":J
-    .end local v71    # "dalvikSubitemPss":[J
-    .end local v72    # "dalvikPss":J
-    .end local v80    # "i":I
-    .end local v81    # "innerArgs":[Ljava/lang/String;
-    .end local v90    # "miscPss":[J
-    .end local v92    # "nativePss":J
-    .end local v94    # "oomAdj":I
-    .end local v98    # "oomProcs":[Ljava/util/ArrayList;, "[Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    .end local v99    # "oomPss":[J
-    .end local v103    # "procMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    .end local v104    # "procMemsMap":Landroid/util/SparseArray;, "Landroid/util/SparseArray<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
+    .end local v34    # "myTotalSwap":J
+    .end local v37    # "hasActivities":Z
+    .end local v46    # "j":I
+    .end local v50    # "otherPss":J
+    .end local v70    # "cachedPss":J
+    .end local v73    # "dalvikSubitemPss":[J
+    .end local v79    # "i":I
+    .end local v91    # "miscPss":[J
+    .end local v93    # "oomAdj":I
+    .end local v99    # "oomProcs":[Ljava/util/ArrayList;, "[Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
+    .end local v100    # "oomPss":[J
     .end local v107    # "r":Lcom/android/server/am/ProcessRecord;
     .end local v110    # "totalPss":J
-    :cond_1b
-    invoke-virtual/range {v105 .. v105}, Ljava/util/ArrayList;->size()I
-
-    move-result v6
-
-    const/4 v7, 0x1
-
-    if-eq v6, v7, :cond_1c
-
-    if-nez v12, :cond_1c
-
-    if-eqz v102, :cond_15
-
     :cond_1c
-    const/16 v74, 0x1
-
-    goto/16 :goto_5
-
-    .restart local v72    # "dalvikPss":J
-    .restart local v81    # "innerArgs":[Ljava/lang/String;
-    .restart local v92    # "nativePss":J
-    .restart local v103    # "procMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    .restart local v104    # "procMemsMap":Landroid/util/SparseArray;, "Landroid/util/SparseArray<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    :cond_1d
-    sget-object v71, Llibcore/util/EmptyArray;->LONG:[J
+    sget-object v73, Llibcore/util/EmptyArray;->LONG:[J
 
-    .restart local v71    # "dalvikSubitemPss":[J
     goto/16 :goto_6
 
+    .restart local v15    # "mi":Landroid/os/Debug$MemoryInfo;
     .restart local v20    # "pid":I
     .restart local v21    # "thread":Landroid/app/IApplicationThread;
-    .restart local v48    # "otherPss":J
-    .restart local v68    # "cachedPss":J
-    .restart local v80    # "i":I
-    .restart local v90    # "miscPss":[J
-    .restart local v94    # "oomAdj":I
-    .restart local v98    # "oomProcs":[Ljava/util/ArrayList;, "[Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    .restart local v99    # "oomPss":[J
+    .restart local v50    # "otherPss":J
+    .restart local v70    # "cachedPss":J
+    .restart local v73    # "dalvikSubitemPss":[J
+    .restart local v79    # "i":I
+    .restart local v91    # "miscPss":[J
+    .restart local v93    # "oomAdj":I
+    .restart local v99    # "oomProcs":[Ljava/util/ArrayList;, "[Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
+    .restart local v100    # "oomPss":[J
     .restart local v107    # "r":Lcom/android/server/am/ProcessRecord;
     .restart local v110    # "totalPss":J
-    :cond_1e
-    const/16 v35, 0x0
+    :cond_1d
+    const/16 v37, 0x0
 
-    .restart local v35    # "hasActivities":Z
     goto/16 :goto_8
 
     .end local v20    # "pid":I
     .end local v21    # "thread":Landroid/app/IApplicationThread;
-    .end local v35    # "hasActivities":Z
-    .end local v94    # "oomAdj":I
+    .end local v93    # "oomAdj":I
     :catchall_1
     move-exception v6
 
+    :try_start_6
     monitor-exit p0
+    :try_end_6
+    .catchall {:try_start_6 .. :try_end_6} :catchall_1
 
     throw v6
 
     .restart local v20    # "pid":I
     .restart local v21    # "thread":Landroid/app/IApplicationThread;
-    .restart local v35    # "hasActivities":Z
-    .restart local v94    # "oomAdj":I
-    :cond_1f
+    .restart local v37    # "hasActivities":Z
+    .restart local v93    # "oomAdj":I
+    :cond_1e
+    const/4 v6, 0x0
+
     move/from16 v0, v20
 
-    invoke-static {v0, v15}, Landroid/os/Debug;->getMemoryInfo(ILandroid/os/Debug$MemoryInfo;)V
+    move-object/from16 v1, v109
+
+    invoke-static {v0, v1, v6}, Landroid/os/Debug;->getPss(I[J[J)J
+
+    move-result-wide v6
+
+    long-to-int v6, v6
+
+    iput v6, v15, Landroid/os/Debug$MemoryInfo;->dalvikPss:I
+
+    const/4 v6, 0x0
+
+    aget-wide v6, v109, v6
+
+    long-to-int v6, v6
+
+    iput v6, v15, Landroid/os/Debug$MemoryInfo;->dalvikPrivateDirty:I
 
     goto/16 :goto_9
 
-    :cond_20
-    :try_start_4
+    :cond_1f
+    :try_start_7
     invoke-virtual/range {p2 .. p2}, Ljava/io/PrintWriter;->flush()V
 
     move-object/from16 v22, p1
@@ -43987,19 +44301,19 @@
 
     move/from16 v27, v19
 
-    move-object/from16 v28, v81
+    move-object/from16 v28, v82
 
     invoke-interface/range {v21 .. v28}, Landroid/app/IApplicationThread;->dumpMemInfo(Ljava/io/FileDescriptor;Landroid/os/Debug$MemoryInfo;ZZZZ[Ljava/lang/String;)V
-    :try_end_4
-    .catch Landroid/os/RemoteException; {:try_start_4 .. :try_end_4} :catch_0
+    :try_end_7
+    .catch Landroid/os/RemoteException; {:try_start_7 .. :try_end_7} :catch_0
 
     goto/16 :goto_a
 
     :catch_0
-    move-exception v75
+    move-exception v77
 
-    .local v75, "e":Landroid/os/RemoteException;
-    if-nez v12, :cond_19
+    .local v77, "e":Landroid/os/RemoteException;
+    if-nez v12, :cond_1a
 
     const-string v6, "Got RemoteException!"
 
@@ -44012,40 +44326,44 @@
     goto/16 :goto_a
 
     .end local v21    # "thread":Landroid/app/IApplicationThread;
-    .end local v75    # "e":Landroid/os/RemoteException;
+    .end local v77    # "e":Landroid/os/RemoteException;
     .restart local v24    # "myTotalPss":J
     .restart local v26    # "myTotalUss":J
+    .restart local v34    # "myTotalSwap":J
     :catchall_2
     move-exception v6
 
+    :try_start_8
     monitor-exit p0
+    :try_end_8
+    .catchall {:try_start_8 .. :try_end_8} :catchall_2
 
     throw v6
 
-    :cond_21
+    :cond_20
     const-string v6, ")"
 
     goto/16 :goto_b
 
     .restart local v29    # "pssItem":Lcom/android/server/am/ActivityManagerService$MemItem;
-    .restart local v44    # "j":I
-    :cond_22
+    .restart local v46    # "j":I
+    :cond_21
     iget v6, v15, Landroid/os/Debug$MemoryInfo;->otherPss:I
 
     int-to-long v6, v6
 
-    add-long v48, v48, v6
+    add-long v50, v50, v6
 
-    const/16 v44, 0x0
+    const/16 v46, 0x0
 
     :goto_d
     const/16 v6, 0x11
 
-    move/from16 v0, v44
+    move/from16 v0, v46
 
-    if-ge v0, v6, :cond_23
+    if-ge v0, v6, :cond_22
 
-    move/from16 v0, v44
+    move/from16 v0, v46
 
     invoke-virtual {v15, v0}, Landroid/os/Debug$MemoryInfo;->getOtherPss(I)I
 
@@ -44053,81 +44371,81 @@
 
     int-to-long v0, v6
 
-    move-wide/from16 v86, v0
+    move-wide/from16 v88, v0
 
-    .local v86, "mem":J
-    aget-wide v6, v90, v44
+    .local v88, "mem":J
+    aget-wide v6, v91, v46
 
-    add-long v6, v6, v86
+    add-long v6, v6, v88
 
-    aput-wide v6, v90, v44
+    aput-wide v6, v91, v46
 
-    sub-long v48, v48, v86
+    sub-long v50, v50, v88
 
-    add-int/lit8 v44, v44, 0x1
+    add-int/lit8 v46, v46, 0x1
 
     goto :goto_d
 
-    .end local v86    # "mem":J
-    :cond_23
+    .end local v88    # "mem":J
+    :cond_22
     const/16 v6, 0x9
 
-    move/from16 v0, v94
+    move/from16 v0, v93
 
-    if-lt v0, v6, :cond_24
+    if-lt v0, v6, :cond_23
 
-    add-long v68, v68, v24
+    add-long v70, v70, v24
 
-    :cond_24
-    const/16 v95, 0x0
+    :cond_23
+    const/16 v96, 0x0
 
-    .local v95, "oomIndex":I
+    .local v96, "oomIndex":I
     :goto_e
-    move-object/from16 v0, v99
+    move-object/from16 v0, v100
 
     array-length v6, v0
 
-    move/from16 v0, v95
+    move/from16 v0, v96
 
-    if-ge v0, v6, :cond_27
+    if-ge v0, v6, :cond_26
 
     sget-object v6, Lcom/android/server/am/ActivityManagerService;->DUMP_MEM_OOM_ADJ:[I
 
-    aget v6, v6, v95
+    aget v6, v6, v96
 
-    move/from16 v0, v94
+    move/from16 v0, v93
 
-    if-le v0, v6, :cond_25
+    if-le v0, v6, :cond_24
 
-    move-object/from16 v0, v99
+    move-object/from16 v0, v100
 
     array-length v6, v0
 
     add-int/lit8 v6, v6, -0x1
 
-    move/from16 v0, v95
+    move/from16 v0, v96
 
-    if-ne v0, v6, :cond_28
+    if-ne v0, v6, :cond_27
 
-    :cond_25
-    aget-wide v6, v99, v95
+    :cond_24
+    aget-wide v6, v100, v96
 
     add-long v6, v6, v24
 
-    aput-wide v6, v99, v95
+    aput-wide v6, v100, v96
 
-    aget-object v6, v98, v95
+    aget-object v6, v99, v96
 
-    if-nez v6, :cond_26
+    if-nez v6, :cond_25
 
     new-instance v6, Ljava/util/ArrayList;
 
     invoke-direct {v6}, Ljava/util/ArrayList;-><init>()V
 
-    aput-object v6, v98, v95
+    aput-object v6, v99, v96
 
-    :cond_26
-    aget-object v6, v98, v95
+    :cond_25
+    aget-object v6, v99, v96
 
     move-object/from16 v0, v29
 
@@ -44136,20 +44454,22 @@
     .end local v24    # "myTotalPss":J
     .end local v26    # "myTotalUss":J
     .end local v29    # "pssItem":Lcom/android/server/am/ActivityManagerService$MemItem;
-    .end local v44    # "j":I
-    .end local v95    # "oomIndex":I
-    :cond_27
-    add-int/lit8 v80, v80, -0x1
+    .end local v34    # "myTotalSwap":J
+    .end local v46    # "j":I
+    .end local v96    # "oomIndex":I
+    :cond_26
+    add-int/lit8 v79, v79, -0x1
 
     goto/16 :goto_7
 
     .restart local v24    # "myTotalPss":J
     .restart local v26    # "myTotalUss":J
     .restart local v29    # "pssItem":Lcom/android/server/am/ActivityManagerService$MemItem;
-    .restart local v44    # "j":I
-    .restart local v95    # "oomIndex":I
-    :cond_28
-    add-int/lit8 v95, v95, 0x1
+    .restart local v34    # "myTotalSwap":J
+    .restart local v46    # "j":I
+    .restart local v96    # "oomIndex":I
+    :cond_27
+    add-int/lit8 v96, v96, 0x1
 
     goto :goto_e
 
@@ -44157,74 +44477,69 @@
     .end local v24    # "myTotalPss":J
     .end local v26    # "myTotalUss":J
     .end local v29    # "pssItem":Lcom/android/server/am/ActivityManagerService$MemItem;
-    .end local v35    # "hasActivities":Z
-    .end local v44    # "j":I
-    .end local v94    # "oomAdj":I
-    .end local v95    # "oomIndex":I
+    .end local v34    # "myTotalSwap":J
+    .end local v37    # "hasActivities":Z
+    .end local v46    # "j":I
+    .end local v93    # "oomAdj":I
+    .end local v96    # "oomIndex":I
     .end local v107    # "r":Lcom/android/server/am/ProcessRecord;
-    :cond_29
-    const-wide/16 v64, 0x0
+    :cond_28
+    const-wide/16 v66, 0x0
 
-    .local v64, "nativeProcTotalPss":J
-    if-nez v12, :cond_2a
+    .local v66, "nativeProcTotalPss":J
+    if-nez v12, :cond_b
 
-    invoke-virtual/range {v105 .. v105}, Ljava/util/ArrayList;->size()I
+    invoke-virtual/range {v106 .. v106}, Ljava/util/ArrayList;->size()I
 
     move-result v6
 
     const/4 v7, 0x1
 
-    if-le v6, v7, :cond_2a
-
-    if-eqz v102, :cond_2b
+    if-le v6, v7, :cond_b
 
-    :cond_2a
-    :goto_f
-    return-void
+    if-nez v103, :cond_b
 
-    :cond_2b
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/am/ActivityManagerService;->updateCpuStatsNow()V
 
     const/4 v15, 0x0
 
-    .restart local v15    # "mi":Landroid/os/Debug$MemoryInfo;
     move-object/from16 v0, p0
 
     iget-object v7, v0, Lcom/android/server/am/ActivityManagerService;->mProcessCpuTracker:Lcom/android/internal/os/ProcessCpuTracker;
 
     monitor-enter v7
 
-    :try_start_5
+    :try_start_9
     move-object/from16 v0, p0
 
     iget-object v6, v0, Lcom/android/server/am/ActivityManagerService;->mProcessCpuTracker:Lcom/android/internal/os/ProcessCpuTracker;
 
     invoke-virtual {v6}, Lcom/android/internal/os/ProcessCpuTracker;->countStats()I
-    :try_end_5
-    .catchall {:try_start_5 .. :try_end_5} :catchall_3
+    :try_end_9
+    .catchall {:try_start_9 .. :try_end_9} :catchall_3
 
-    move-result v36
+    move-result v38
 
-    .restart local v36    # "N":I
-    const/16 v80, 0x0
+    .restart local v38    # "N":I
+    const/16 v79, 0x0
 
-    move-object/from16 v89, v15
+    move-object/from16 v90, v15
 
     .end local v15    # "mi":Landroid/os/Debug$MemoryInfo;
-    .local v89, "mi":Landroid/os/Debug$MemoryInfo;
-    :goto_10
-    move/from16 v0, v80
+    .local v90, "mi":Landroid/os/Debug$MemoryInfo;
+    :goto_f
+    move/from16 v0, v79
 
-    move/from16 v1, v36
+    move/from16 v1, v38
 
-    if-ge v0, v1, :cond_32
+    if-ge v0, v1, :cond_2d
 
-    :try_start_6
+    :try_start_a
     move-object/from16 v0, p0
 
     iget-object v6, v0, Lcom/android/server/am/ActivityManagerService;->mProcessCpuTracker:Lcom/android/internal/os/ProcessCpuTracker;
 
-    move/from16 v0, v80
+    move/from16 v0, v79
 
     invoke-virtual {v6, v0}, Lcom/android/internal/os/ProcessCpuTracker;->getStats(I)Lcom/android/internal/os/ProcessCpuTracker$Stats;
 
@@ -44241,78 +44556,64 @@
 
     cmp-long v6, v22, v30
 
-    if-lez v6, :cond_2d
+    if-lez v6, :cond_48
 
     move-object/from16 v0, v108
 
     iget v6, v0, Lcom/android/internal/os/ProcessCpuTracker$Stats;->pid:I
 
-    move-object/from16 v0, v104
+    move-object/from16 v0, v105
 
     invoke-virtual {v0, v6}, Landroid/util/SparseArray;->indexOfKey(I)I
 
     move-result v6
 
-    if-gez v6, :cond_2d
+    if-gez v6, :cond_48
 
-    if-nez v89, :cond_4f
+    if-nez v90, :cond_47
 
     new-instance v15, Landroid/os/Debug$MemoryInfo;
 
     invoke-direct {v15}, Landroid/os/Debug$MemoryInfo;-><init>()V
-    :try_end_6
-    .catchall {:try_start_6 .. :try_end_6} :catchall_5
+    :try_end_a
+    .catchall {:try_start_a .. :try_end_a} :catchall_5
 
-    .end local v89    # "mi":Landroid/os/Debug$MemoryInfo;
-    .local v15, "mi":Landroid/os/Debug$MemoryInfo;
-    :goto_11
-    if-nez p5, :cond_2c
+    .end local v90    # "mi":Landroid/os/Debug$MemoryInfo;
+    .restart local v15    # "mi":Landroid/os/Debug$MemoryInfo;
+    :goto_10
+    if-nez p5, :cond_29
 
-    if-eqz v97, :cond_2e
+    if-nez v98, :cond_29
 
-    :cond_2c
-    :try_start_7
+    :try_start_b
     move-object/from16 v0, v108
 
     iget v6, v0, Lcom/android/internal/os/ProcessCpuTracker$Stats;->pid:I
 
-    const/4 v14, 0x0
-
-    move-object/from16 v0, v109
-
-    invoke-static {v6, v0, v14}, Landroid/os/Debug;->getPss(I[J[J)J
-
-    move-result-wide v22
-
-    move-wide/from16 v0, v22
-
-    long-to-int v6, v0
-
-    iput v6, v15, Landroid/os/Debug$MemoryInfo;->nativePss:I
-
-    const/4 v6, 0x0
+    invoke-static {v6, v15}, Landroid/os/Debug;->getMemoryInfo(ILandroid/os/Debug$MemoryInfo;)V
 
-    aget-wide v22, v109, v6
+    :goto_11
+    invoke-virtual {v15}, Landroid/os/Debug$MemoryInfo;->getTotalPss()I
 
-    move-wide/from16 v0, v22
+    move-result v6
 
-    long-to-int v6, v0
+    int-to-long v0, v6
 
-    iput v6, v15, Landroid/os/Debug$MemoryInfo;->nativePrivateDirty:I
+    move-wide/from16 v24, v0
 
-    :goto_12
-    invoke-virtual {v15}, Landroid/os/Debug$MemoryInfo;->getTotalPss()I
+    .restart local v24    # "myTotalPss":J
+    invoke-virtual {v15}, Landroid/os/Debug$MemoryInfo;->getTotalSwappedOut()I
 
     move-result v6
 
     int-to-long v0, v6
 
-    move-wide/from16 v24, v0
+    move-wide/from16 v34, v0
 
-    .restart local v24    # "myTotalPss":J
+    .restart local v34    # "myTotalSwap":J
     add-long v110, v110, v24
 
-    add-long v64, v64, v24
+    add-long v66, v66, v24
 
     new-instance v29, Lcom/android/server/am/ActivityManagerService$MemItem;
 
@@ -44350,30 +44651,32 @@
 
     invoke-virtual {v6}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    move-result-object v38
+    move-result-object v40
 
     move-object/from16 v0, v108
 
     iget-object v0, v0, Lcom/android/internal/os/ProcessCpuTracker$Stats;->name:Ljava/lang/String;
 
-    move-object/from16 v39, v0
+    move-object/from16 v41, v0
 
     move-object/from16 v0, v108
 
     iget v0, v0, Lcom/android/internal/os/ProcessCpuTracker$Stats;->pid:I
 
-    move/from16 v42, v0
+    move/from16 v46, v0
+
+    const/16 v47, 0x0
 
-    const/16 v43, 0x0
+    move-object/from16 v39, v29
 
-    move-object/from16 v37, v29
+    move-wide/from16 v42, v24
 
-    move-wide/from16 v40, v24
+    move-wide/from16 v44, v34
 
-    invoke-direct/range {v37 .. v43}, Lcom/android/server/am/ActivityManagerService$MemItem;-><init>(Ljava/lang/String;Ljava/lang/String;JIZ)V
+    invoke-direct/range {v39 .. v47}, Lcom/android/server/am/ActivityManagerService$MemItem;-><init>(Ljava/lang/String;Ljava/lang/String;JJIZ)V
 
     .restart local v29    # "pssItem":Lcom/android/server/am/ActivityManagerService$MemItem;
-    move-object/from16 v0, v103
+    move-object/from16 v0, v104
 
     move-object/from16 v1, v29
 
@@ -44385,7 +44688,7 @@
 
     move-wide/from16 v22, v0
 
-    add-long v92, v92, v22
+    add-long v94, v94, v22
 
     iget v6, v15, Landroid/os/Debug$MemoryInfo;->dalvikPss:I
 
@@ -44393,23 +44696,23 @@
 
     move-wide/from16 v22, v0
 
-    add-long v72, v72, v22
+    add-long v74, v74, v22
 
-    const/16 v44, 0x0
+    const/16 v46, 0x0
 
-    .restart local v44    # "j":I
-    :goto_13
-    move-object/from16 v0, v71
+    .restart local v46    # "j":I
+    :goto_12
+    move-object/from16 v0, v73
 
     array-length v6, v0
 
-    move/from16 v0, v44
+    move/from16 v0, v46
 
-    if-ge v0, v6, :cond_2f
+    if-ge v0, v6, :cond_2a
 
-    aget-wide v22, v71, v44
+    aget-wide v22, v73, v46
 
-    add-int/lit8 v6, v44, 0x11
+    add-int/lit8 v6, v46, 0x11
 
     invoke-virtual {v15, v6}, Landroid/os/Debug$MemoryInfo;->getOtherPss(I)I
 
@@ -44421,81 +44724,85 @@
 
     add-long v22, v22, v30
 
-    aput-wide v22, v71, v44
+    aput-wide v22, v73, v46
 
-    add-int/lit8 v44, v44, 0x1
+    add-int/lit8 v46, v46, 0x1
 
-    goto :goto_13
+    goto :goto_12
 
-    .end local v15    # "mi":Landroid/os/Debug$MemoryInfo;
     .end local v24    # "myTotalPss":J
     .end local v29    # "pssItem":Lcom/android/server/am/ActivityManagerService$MemItem;
-    .end local v44    # "j":I
-    .restart local v89    # "mi":Landroid/os/Debug$MemoryInfo;
-    :cond_2d
-    move-object/from16 v15, v89
+    .end local v34    # "myTotalSwap":J
+    .end local v46    # "j":I
+    :cond_29
+    move-object/from16 v0, v108
 
-    .end local v89    # "mi":Landroid/os/Debug$MemoryInfo;
-    .restart local v15    # "mi":Landroid/os/Debug$MemoryInfo;
-    :goto_14
-    add-int/lit8 v80, v80, 0x1
+    iget v6, v0, Lcom/android/internal/os/ProcessCpuTracker$Stats;->pid:I
 
-    move-object/from16 v89, v15
+    const/4 v14, 0x0
 
-    .end local v15    # "mi":Landroid/os/Debug$MemoryInfo;
-    .restart local v89    # "mi":Landroid/os/Debug$MemoryInfo;
-    goto/16 :goto_10
+    move-object/from16 v0, v109
 
-    .end local v89    # "mi":Landroid/os/Debug$MemoryInfo;
-    .restart local v15    # "mi":Landroid/os/Debug$MemoryInfo;
-    :cond_2e
-    move-object/from16 v0, v108
+    invoke-static {v6, v0, v14}, Landroid/os/Debug;->getPss(I[J[J)J
 
-    iget v6, v0, Lcom/android/internal/os/ProcessCpuTracker$Stats;->pid:I
+    move-result-wide v22
 
-    invoke-static {v6, v15}, Landroid/os/Debug;->getMemoryInfo(ILandroid/os/Debug$MemoryInfo;)V
-    :try_end_7
-    .catchall {:try_start_7 .. :try_end_7} :catchall_3
+    move-wide/from16 v0, v22
 
-    goto/16 :goto_12
+    long-to-int v6, v0
 
-    .end local v15    # "mi":Landroid/os/Debug$MemoryInfo;
-    .end local v36    # "N":I
+    iput v6, v15, Landroid/os/Debug$MemoryInfo;->nativePss:I
+
+    const/4 v6, 0x0
+
+    aget-wide v22, v109, v6
+
+    move-wide/from16 v0, v22
+
+    long-to-int v6, v0
+
+    iput v6, v15, Landroid/os/Debug$MemoryInfo;->nativePrivateDirty:I
+
+    goto/16 :goto_11
+
+    .end local v38    # "N":I
     .end local v108    # "st":Lcom/android/internal/os/ProcessCpuTracker$Stats;
     :catchall_3
     move-exception v6
 
-    :goto_15
+    :goto_13
     monitor-exit v7
+    :try_end_b
+    .catchall {:try_start_b .. :try_end_b} :catchall_3
 
     throw v6
 
-    .restart local v15    # "mi":Landroid/os/Debug$MemoryInfo;
     .restart local v24    # "myTotalPss":J
     .restart local v29    # "pssItem":Lcom/android/server/am/ActivityManagerService$MemItem;
-    .restart local v36    # "N":I
-    .restart local v44    # "j":I
+    .restart local v34    # "myTotalSwap":J
+    .restart local v38    # "N":I
+    .restart local v46    # "j":I
     .restart local v108    # "st":Lcom/android/internal/os/ProcessCpuTracker$Stats;
-    :cond_2f
-    :try_start_8
+    :cond_2a
+    :try_start_c
     iget v6, v15, Landroid/os/Debug$MemoryInfo;->otherPss:I
 
     int-to-long v0, v6
 
     move-wide/from16 v22, v0
 
-    add-long v48, v48, v22
+    add-long v50, v50, v22
 
-    const/16 v44, 0x0
+    const/16 v46, 0x0
 
-    :goto_16
+    :goto_14
     const/16 v6, 0x11
 
-    move/from16 v0, v44
+    move/from16 v0, v46
 
-    if-ge v0, v6, :cond_30
+    if-ge v0, v6, :cond_2b
 
-    move/from16 v0, v44
+    move/from16 v0, v46
 
     invoke-virtual {v15, v0}, Landroid/os/Debug$MemoryInfo;->getOtherPss(I)I
 
@@ -44503,418 +44810,479 @@
 
     int-to-long v0, v6
 
-    move-wide/from16 v86, v0
+    move-wide/from16 v88, v0
 
-    .restart local v86    # "mem":J
-    aget-wide v22, v90, v44
+    .restart local v88    # "mem":J
+    aget-wide v22, v91, v46
 
-    add-long v22, v22, v86
+    add-long v22, v22, v88
 
-    aput-wide v22, v90, v44
+    aput-wide v22, v91, v46
 
-    sub-long v48, v48, v86
+    sub-long v50, v50, v88
 
-    add-int/lit8 v44, v44, 0x1
+    add-int/lit8 v46, v46, 0x1
 
-    goto :goto_16
+    goto :goto_14
 
-    .end local v86    # "mem":J
-    :cond_30
+    .end local v88    # "mem":J
+    :cond_2b
     const/4 v6, 0x0
 
-    aget-wide v22, v99, v6
+    aget-wide v22, v100, v6
 
     add-long v22, v22, v24
 
-    aput-wide v22, v99, v6
+    aput-wide v22, v100, v6
 
     const/4 v6, 0x0
 
-    aget-object v6, v98, v6
+    aget-object v6, v99, v6
 
-    if-nez v6, :cond_31
+    if-nez v6, :cond_2c
 
-    new-instance v6, Ljava/util/ArrayList;
+    const/4 v6, 0x0
 
-    invoke-direct {v6}, Ljava/util/ArrayList;-><init>()V
+    new-instance v14, Ljava/util/ArrayList;
 
-    const/4 v14, 0x0
+    invoke-direct {v14}, Ljava/util/ArrayList;-><init>()V
 
-    aput-object v6, v98, v14
+    aput-object v14, v99, v6
 
-    :cond_31
+    :cond_2c
     const/4 v6, 0x0
 
-    aget-object v6, v98, v6
+    aget-object v6, v99, v6
 
     move-object/from16 v0, v29
 
     invoke-virtual {v6, v0}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
-    :try_end_8
-    .catchall {:try_start_8 .. :try_end_8} :catchall_3
-
-    goto :goto_14
+    :try_end_c
+    .catchall {:try_start_c .. :try_end_c} :catchall_3
 
-    .end local v15    # "mi":Landroid/os/Debug$MemoryInfo;
     .end local v24    # "myTotalPss":J
     .end local v29    # "pssItem":Lcom/android/server/am/ActivityManagerService$MemItem;
-    .end local v44    # "j":I
+    .end local v34    # "myTotalSwap":J
+    .end local v46    # "j":I
+    :goto_15
+    add-int/lit8 v79, v79, 0x1
+
+    move-object/from16 v90, v15
+
+    .end local v15    # "mi":Landroid/os/Debug$MemoryInfo;
+    .restart local v90    # "mi":Landroid/os/Debug$MemoryInfo;
+    goto/16 :goto_f
+
     .end local v108    # "st":Lcom/android/internal/os/ProcessCpuTracker$Stats;
-    .restart local v89    # "mi":Landroid/os/Debug$MemoryInfo;
-    :cond_32
+    :cond_2d
+    :try_start_d
     monitor-exit v7
+    :try_end_d
+    .catchall {:try_start_d .. :try_end_d} :catchall_5
 
-    new-instance v70, Ljava/util/ArrayList;
+    new-instance v72, Ljava/util/ArrayList;
 
-    invoke-direct/range {v70 .. v70}, Ljava/util/ArrayList;-><init>()V
+    invoke-direct/range {v72 .. v72}, Ljava/util/ArrayList;-><init>()V
 
-    .local v70, "catMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    new-instance v37, Lcom/android/server/am/ActivityManagerService$MemItem;
+    .local v72, "catMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
+    new-instance v39, Lcom/android/server/am/ActivityManagerService$MemItem;
 
-    const-string v38, "Native"
+    const-string v40, "Native"
 
-    const-string v39, "Native"
+    const-string v41, "Native"
 
-    const/16 v42, -0x1
+    const/16 v44, -0x1
 
-    move-wide/from16 v40, v92
+    move-wide/from16 v42, v94
 
-    invoke-direct/range {v37 .. v42}, Lcom/android/server/am/ActivityManagerService$MemItem;-><init>(Ljava/lang/String;Ljava/lang/String;JI)V
+    invoke-direct/range {v39 .. v44}, Lcom/android/server/am/ActivityManagerService$MemItem;-><init>(Ljava/lang/String;Ljava/lang/String;JI)V
 
-    move-object/from16 v0, v70
+    move-object/from16 v0, v72
 
-    move-object/from16 v1, v37
+    move-object/from16 v1, v39
 
     invoke-virtual {v0, v1}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
 
-    new-instance v37, Lcom/android/server/am/ActivityManagerService$MemItem;
+    new-instance v39, Lcom/android/server/am/ActivityManagerService$MemItem;
 
-    const-string v38, "Dalvik"
+    const-string v40, "Dalvik"
 
-    const-string v39, "Dalvik"
+    const-string v41, "Dalvik"
 
-    const/16 v42, -0x2
+    const/16 v44, -0x2
 
-    move-wide/from16 v40, v72
+    move-wide/from16 v42, v74
 
-    invoke-direct/range {v37 .. v42}, Lcom/android/server/am/ActivityManagerService$MemItem;-><init>(Ljava/lang/String;Ljava/lang/String;JI)V
+    invoke-direct/range {v39 .. v44}, Lcom/android/server/am/ActivityManagerService$MemItem;-><init>(Ljava/lang/String;Ljava/lang/String;JI)V
 
-    .local v37, "dalvikItem":Lcom/android/server/am/ActivityManagerService$MemItem;
-    move-object/from16 v0, v71
+    .local v39, "dalvikItem":Lcom/android/server/am/ActivityManagerService$MemItem;
+    move-object/from16 v0, v73
 
     array-length v6, v0
 
-    if-lez v6, :cond_33
+    if-lez v6, :cond_2e
 
     new-instance v6, Ljava/util/ArrayList;
 
     invoke-direct {v6}, Ljava/util/ArrayList;-><init>()V
 
-    move-object/from16 v0, v37
+    move-object/from16 v0, v39
 
     iput-object v6, v0, Lcom/android/server/am/ActivityManagerService$MemItem;->subitems:Ljava/util/ArrayList;
 
-    const/16 v44, 0x0
+    const/16 v46, 0x0
 
-    .restart local v44    # "j":I
-    :goto_17
-    move-object/from16 v0, v71
+    .restart local v46    # "j":I
+    :goto_16
+    move-object/from16 v0, v73
 
     array-length v6, v0
 
-    move/from16 v0, v44
+    move/from16 v0, v46
 
-    if-ge v0, v6, :cond_33
+    if-ge v0, v6, :cond_2e
 
-    add-int/lit8 v6, v44, 0x11
+    add-int/lit8 v6, v46, 0x11
 
     invoke-static {v6}, Landroid/os/Debug$MemoryInfo;->getOtherLabel(I)Ljava/lang/String;
 
-    move-result-object v40
+    move-result-object v42
 
-    .local v40, "name":Ljava/lang/String;
-    move-object/from16 v0, v37
+    .local v42, "name":Ljava/lang/String;
+    move-object/from16 v0, v39
 
     iget-object v6, v0, Lcom/android/server/am/ActivityManagerService$MemItem;->subitems:Ljava/util/ArrayList;
 
-    new-instance v39, Lcom/android/server/am/ActivityManagerService$MemItem;
+    new-instance v41, Lcom/android/server/am/ActivityManagerService$MemItem;
 
-    aget-wide v42, v71, v44
+    aget-wide v44, v73, v46
 
-    move-object/from16 v41, v40
+    move-object/from16 v43, v42
 
-    invoke-direct/range {v39 .. v44}, Lcom/android/server/am/ActivityManagerService$MemItem;-><init>(Ljava/lang/String;Ljava/lang/String;JI)V
+    invoke-direct/range {v41 .. v46}, Lcom/android/server/am/ActivityManagerService$MemItem;-><init>(Ljava/lang/String;Ljava/lang/String;JI)V
 
-    move-object/from16 v0, v39
+    move-object/from16 v0, v41
 
     invoke-virtual {v6, v0}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
 
-    add-int/lit8 v44, v44, 0x1
+    add-int/lit8 v46, v46, 0x1
 
-    goto :goto_17
+    goto :goto_16
 
-    .end local v40    # "name":Ljava/lang/String;
-    .end local v44    # "j":I
-    :cond_33
-    move-object/from16 v0, v70
+    .end local v42    # "name":Ljava/lang/String;
+    .end local v46    # "j":I
+    :cond_2e
+    move-object/from16 v0, v72
 
-    move-object/from16 v1, v37
+    move-object/from16 v1, v39
 
     invoke-virtual {v0, v1}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
 
-    new-instance v45, Lcom/android/server/am/ActivityManagerService$MemItem;
+    new-instance v47, Lcom/android/server/am/ActivityManagerService$MemItem;
 
-    const-string v46, "Unknown"
+    const-string v48, "Unknown"
 
-    const-string v47, "Unknown"
+    const-string v49, "Unknown"
 
-    const/16 v50, -0x3
+    const/16 v52, -0x3
 
-    invoke-direct/range {v45 .. v50}, Lcom/android/server/am/ActivityManagerService$MemItem;-><init>(Ljava/lang/String;Ljava/lang/String;JI)V
+    invoke-direct/range {v47 .. v52}, Lcom/android/server/am/ActivityManagerService$MemItem;-><init>(Ljava/lang/String;Ljava/lang/String;JI)V
 
-    move-object/from16 v0, v70
+    move-object/from16 v0, v72
 
-    move-object/from16 v1, v45
+    move-object/from16 v1, v47
 
     invoke-virtual {v0, v1}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
 
-    const/16 v44, 0x0
+    const/16 v46, 0x0
 
-    .restart local v44    # "j":I
-    :goto_18
+    .restart local v46    # "j":I
+    :goto_17
     const/16 v6, 0x11
 
-    move/from16 v0, v44
+    move/from16 v0, v46
 
-    if-ge v0, v6, :cond_34
+    if-ge v0, v6, :cond_2f
 
-    invoke-static/range {v44 .. v44}, Landroid/os/Debug$MemoryInfo;->getOtherLabel(I)Ljava/lang/String;
+    invoke-static/range {v46 .. v46}, Landroid/os/Debug$MemoryInfo;->getOtherLabel(I)Ljava/lang/String;
 
-    move-result-object v52
+    move-result-object v54
 
-    .local v52, "label":Ljava/lang/String;
-    new-instance v51, Lcom/android/server/am/ActivityManagerService$MemItem;
+    .local v54, "label":Ljava/lang/String;
+    new-instance v53, Lcom/android/server/am/ActivityManagerService$MemItem;
 
-    aget-wide v54, v90, v44
+    aget-wide v56, v91, v46
 
-    move-object/from16 v53, v52
+    move-object/from16 v55, v54
 
-    move/from16 v56, v44
+    move/from16 v58, v46
 
-    invoke-direct/range {v51 .. v56}, Lcom/android/server/am/ActivityManagerService$MemItem;-><init>(Ljava/lang/String;Ljava/lang/String;JI)V
+    invoke-direct/range {v53 .. v58}, Lcom/android/server/am/ActivityManagerService$MemItem;-><init>(Ljava/lang/String;Ljava/lang/String;JI)V
 
-    move-object/from16 v0, v70
+    move-object/from16 v0, v72
 
-    move-object/from16 v1, v51
+    move-object/from16 v1, v53
 
     invoke-virtual {v0, v1}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
 
-    add-int/lit8 v44, v44, 0x1
+    add-int/lit8 v46, v46, 0x1
 
-    goto :goto_18
+    goto :goto_17
 
-    .end local v52    # "label":Ljava/lang/String;
-    :cond_34
-    new-instance v96, Ljava/util/ArrayList;
+    .end local v54    # "label":Ljava/lang/String;
+    :cond_2f
+    new-instance v97, Ljava/util/ArrayList;
 
-    invoke-direct/range {v96 .. v96}, Ljava/util/ArrayList;-><init>()V
+    invoke-direct/range {v97 .. v97}, Ljava/util/ArrayList;-><init>()V
 
-    .local v96, "oomMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    const/16 v44, 0x0
+    .local v97, "oomMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
+    const/16 v46, 0x0
 
-    :goto_19
-    move-object/from16 v0, v99
+    :goto_18
+    move-object/from16 v0, v100
 
     array-length v6, v0
 
-    move/from16 v0, v44
+    move/from16 v0, v46
 
-    if-ge v0, v6, :cond_37
+    if-ge v0, v6, :cond_32
 
-    aget-wide v6, v99, v44
+    aget-wide v6, v100, v46
 
     const-wide/16 v22, 0x0
 
     cmp-long v6, v6, v22
 
-    if-eqz v6, :cond_35
+    if-eqz v6, :cond_30
 
-    if-eqz v13, :cond_36
+    if-eqz v13, :cond_31
 
     sget-object v6, Lcom/android/server/am/ActivityManagerService;->DUMP_MEM_OOM_COMPACT_LABEL:[Ljava/lang/String;
 
-    aget-object v52, v6, v44
+    aget-object v54, v6, v46
 
-    .restart local v52    # "label":Ljava/lang/String;
-    :goto_1a
-    new-instance v51, Lcom/android/server/am/ActivityManagerService$MemItem;
+    .restart local v54    # "label":Ljava/lang/String;
+    :goto_19
+    new-instance v53, Lcom/android/server/am/ActivityManagerService$MemItem;
 
-    aget-wide v54, v99, v44
+    aget-wide v56, v100, v46
 
     sget-object v6, Lcom/android/server/am/ActivityManagerService;->DUMP_MEM_OOM_ADJ:[I
 
-    aget v56, v6, v44
+    aget v58, v6, v46
 
-    move-object/from16 v53, v52
+    move-object/from16 v55, v54
 
-    invoke-direct/range {v51 .. v56}, Lcom/android/server/am/ActivityManagerService$MemItem;-><init>(Ljava/lang/String;Ljava/lang/String;JI)V
+    invoke-direct/range {v53 .. v58}, Lcom/android/server/am/ActivityManagerService$MemItem;-><init>(Ljava/lang/String;Ljava/lang/String;JI)V
 
-    .local v51, "item":Lcom/android/server/am/ActivityManagerService$MemItem;
-    aget-object v6, v98, v44
+    .local v53, "item":Lcom/android/server/am/ActivityManagerService$MemItem;
+    aget-object v6, v99, v46
 
-    move-object/from16 v0, v51
+    move-object/from16 v0, v53
 
     iput-object v6, v0, Lcom/android/server/am/ActivityManagerService$MemItem;->subitems:Ljava/util/ArrayList;
 
-    move-object/from16 v0, v96
+    move-object/from16 v0, v97
 
-    move-object/from16 v1, v51
+    move-object/from16 v1, v53
 
     invoke-virtual {v0, v1}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
 
-    .end local v51    # "item":Lcom/android/server/am/ActivityManagerService$MemItem;
-    .end local v52    # "label":Ljava/lang/String;
-    :cond_35
-    add-int/lit8 v44, v44, 0x1
+    .end local v53    # "item":Lcom/android/server/am/ActivityManagerService$MemItem;
+    .end local v54    # "label":Ljava/lang/String;
+    :cond_30
+    add-int/lit8 v46, v46, 0x1
 
-    goto :goto_19
+    goto :goto_18
 
-    :cond_36
+    :cond_31
     sget-object v6, Lcom/android/server/am/ActivityManagerService;->DUMP_MEM_OOM_LABEL:[Ljava/lang/String;
 
-    aget-object v52, v6, v44
+    aget-object v54, v6, v46
 
-    .restart local v52    # "label":Ljava/lang/String;
-    goto :goto_1a
+    goto :goto_19
 
-    .end local v52    # "label":Ljava/lang/String;
-    :cond_37
-    if-nez p5, :cond_38
+    :cond_32
+    if-nez p5, :cond_33
 
-    if-eqz v97, :cond_43
+    if-nez v98, :cond_33
 
-    :cond_38
-    :goto_1b
-    if-nez v13, :cond_39
+    if-nez v13, :cond_33
+
+    invoke-virtual/range {p2 .. p2}, Ljava/io/PrintWriter;->println()V
 
-    const-string v6, "Total PSS by OOM adjustment:"
+    const-string v6, "Total PSS SWAP by process:"
 
     move-object/from16 v0, p2
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
 
-    :cond_39
-    const-string v54, "  "
+    const-string v56, "  "
 
-    const-string v55, "oom"
+    const-string v57, "proc"
 
-    const/16 v57, 0x0
+    const/16 v59, 0x1
 
-    move-object/from16 v53, p2
+    move-object/from16 v55, p2
 
-    move-object/from16 v56, v96
+    move-object/from16 v58, v104
 
-    move/from16 v58, v13
+    move/from16 v60, v13
 
-    invoke-static/range {v53 .. v58}, Lcom/android/server/am/ActivityManagerService;->dumpMemItems(Ljava/io/PrintWriter;Ljava/lang/String;Ljava/lang/String;Ljava/util/ArrayList;ZZ)V
+    invoke-static/range {v55 .. v60}, Lcom/android/server/am/ActivityManagerService;->dumpMemItems(Ljava/io/PrintWriter;Ljava/lang/String;Ljava/lang/String;Ljava/util/ArrayList;ZZ)V
 
-    if-nez p5, :cond_3a
+    invoke-virtual/range {p2 .. p2}, Ljava/io/PrintWriter;->println()V
 
-    if-eqz v97, :cond_44
+    :cond_33
+    if-nez v13, :cond_34
 
-    :cond_3a
-    :goto_1c
-    if-nez v13, :cond_3b
+    const-string v6, "Total PSS SWAP by OOM adjustment:"
+
+    move-object/from16 v0, p2
+
+    invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
+
+    :cond_34
+    const-string v56, "  "
+
+    const-string v57, "oom"
+
+    const/16 v59, 0x0
+
+    move-object/from16 v55, p2
+
+    move-object/from16 v58, v97
+
+    move/from16 v60, v13
+
+    invoke-static/range {v55 .. v60}, Lcom/android/server/am/ActivityManagerService;->dumpMemItems(Ljava/io/PrintWriter;Ljava/lang/String;Ljava/lang/String;Ljava/util/ArrayList;ZZ)V
+
+    if-nez p5, :cond_36
+
+    if-nez v98, :cond_36
+
+    if-eqz p6, :cond_40
+
+    move-object/from16 v55, p6
+
+    .local v55, "out":Ljava/io/PrintWriter;
+    :goto_1a
+    if-nez v13, :cond_35
+
+    invoke-virtual/range {v55 .. v55}, Ljava/io/PrintWriter;->println()V
+
+    const-string v6, "Total PSS by category:"
+
+    move-object/from16 v0, v55
+
+    invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
+
+    :cond_35
+    const-string v56, "  "
+
+    const-string v57, "cat"
+
+    const/16 v59, 0x1
+
+    move-object/from16 v58, v72
+
+    move/from16 v60, v13
+
+    invoke-static/range {v55 .. v60}, Lcom/android/server/am/ActivityManagerService;->dumpMemItems(Ljava/io/PrintWriter;Ljava/lang/String;Ljava/lang/String;Ljava/util/ArrayList;ZZ)V
+
+    .end local v55    # "out":Ljava/io/PrintWriter;
+    :cond_36
+    if-nez v13, :cond_37
 
     invoke-virtual/range {p2 .. p2}, Ljava/io/PrintWriter;->println()V
 
-    :cond_3b
-    new-instance v88, Lcom/android/internal/util/MemInfoReader;
+    :cond_37
+    new-instance v87, Lcom/android/internal/util/MemInfoReader;
 
-    invoke-direct/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;-><init>()V
+    invoke-direct/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;-><init>()V
 
-    .local v88, "memInfo":Lcom/android/internal/util/MemInfoReader;
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->readMemInfo()V
+    .local v87, "memInfo":Lcom/android/internal/util/MemInfoReader;
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->readMemInfo()V
 
     const-wide/16 v6, 0x0
 
-    cmp-long v6, v64, v6
+    cmp-long v6, v66, v6
 
-    if-lez v6, :cond_3c
+    if-lez v6, :cond_38
 
     monitor-enter p0
 
-    :try_start_9
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getCachedSizeKb()J
+    :try_start_e
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getCachedSizeKb()J
 
-    move-result-wide v66
+    move-result-wide v68
 
-    .local v66, "cachedKb":J
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getFreeSizeKb()J
+    .local v68, "cachedKb":J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getFreeSizeKb()J
 
-    move-result-wide v78
+    move-result-wide v80
 
-    .local v78, "freeKb":J
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getZramTotalSizeKb()J
+    .local v80, "freeKb":J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getZramTotalSizeKb()J
 
     move-result-wide v112
 
     .local v112, "zramKb":J
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getKernelUsedSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getKernelUsedSizeKb()J
 
-    move-result-wide v82
+    move-result-wide v84
 
-    .local v82, "kernelKb":J
+    .local v84, "kernelKb":J
     const-wide/16 v6, 0x400
 
-    mul-long v54, v66, v6
+    mul-long v56, v68, v6
 
     const-wide/16 v6, 0x400
 
-    mul-long v56, v78, v6
+    mul-long v58, v80, v6
 
     const-wide/16 v6, 0x400
 
-    mul-long v58, v112, v6
+    mul-long v60, v112, v6
 
     const-wide/16 v6, 0x400
 
-    mul-long v60, v82, v6
+    mul-long v62, v84, v6
 
     const-wide/16 v6, 0x400
 
-    mul-long v62, v64, v6
+    mul-long v64, v66, v6
 
-    invoke-static/range {v54 .. v63}, Lcom/android/server/am/EventLogTags;->writeAmMeminfo(JJJJJ)V
+    invoke-static/range {v56 .. v65}, Lcom/android/server/am/EventLogTags;->writeAmMeminfo(JJJJJ)V
 
     move-object/from16 v0, p0
 
     iget-object v0, v0, Lcom/android/server/am/ActivityManagerService;->mProcessStats:Lcom/android/server/am/ProcessStatsService;
 
-    move-object/from16 v55, v0
+    move-object/from16 v57, v0
 
-    move-wide/from16 v56, v66
+    move-wide/from16 v58, v68
 
-    move-wide/from16 v58, v78
+    move-wide/from16 v60, v80
 
-    move-wide/from16 v60, v112
+    move-wide/from16 v62, v112
 
-    move-wide/from16 v62, v82
+    move-wide/from16 v64, v84
 
-    invoke-virtual/range {v55 .. v65}, Lcom/android/server/am/ProcessStatsService;->addSysMemUsageLocked(JJJJJ)V
-    :try_end_9
-    .catchall {:try_start_9 .. :try_end_9} :catchall_4
+    invoke-virtual/range {v57 .. v67}, Lcom/android/server/am/ProcessStatsService;->addSysMemUsageLocked(JJJJJ)V
 
     monitor-exit p0
+    :try_end_e
+    .catchall {:try_start_e .. :try_end_e} :catchall_4
 
-    .end local v66    # "cachedKb":J
-    .end local v78    # "freeKb":J
-    .end local v82    # "kernelKb":J
+    .end local v68    # "cachedKb":J
+    .end local v80    # "freeKb":J
+    .end local v84    # "kernelKb":J
     .end local v112    # "zramKb":J
-    :cond_3c
-    if-nez p5, :cond_3d
+    :cond_38
+    if-nez p5, :cond_39
 
-    if-nez v13, :cond_47
+    if-nez v13, :cond_41
 
     const-string v6, "Total RAM: "
 
@@ -44922,7 +45290,7 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getTotalSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getTotalSizeKb()J
 
     move-result-wide v6
 
@@ -44956,20 +45324,20 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
 
-    :goto_1d
+    :goto_1b
     const-string v6, " Free RAM: "
 
     move-object/from16 v0, p2
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getCachedSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getCachedSizeKb()J
 
     move-result-wide v6
 
-    add-long v6, v6, v68
+    add-long v6, v6, v70
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getFreeSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getFreeSizeKb()J
 
     move-result-wide v22
 
@@ -44987,7 +45355,7 @@
 
     move-object/from16 v0, p2
 
-    move-wide/from16 v1, v68
+    move-wide/from16 v1, v70
 
     invoke-virtual {v0, v1, v2}, Ljava/io/PrintWriter;->print(J)V
 
@@ -44997,7 +45365,7 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getCachedSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getCachedSizeKb()J
 
     move-result-wide v6
 
@@ -45011,7 +45379,7 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getFreeSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getFreeSizeKb()J
 
     move-result-wide v6
 
@@ -45025,9 +45393,9 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
 
-    :cond_3d
-    :goto_1e
-    if-nez v13, :cond_48
+    :cond_39
+    :goto_1c
+    if-nez v13, :cond_3a
 
     const-string v6, " Used RAM: "
 
@@ -45035,9 +45403,9 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    sub-long v6, v110, v68
+    sub-long v6, v110, v70
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getKernelUsedSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getKernelUsedSizeKb()J
 
     move-result-wide v22
 
@@ -45053,7 +45421,7 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    sub-long v6, v110, v68
+    sub-long v6, v110, v70
 
     move-object/from16 v0, p2
 
@@ -45065,7 +45433,7 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getKernelUsedSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getKernelUsedSizeKb()J
 
     move-result-wide v6
 
@@ -45085,25 +45453,25 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getTotalSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getTotalSizeKb()J
 
     move-result-wide v6
 
     sub-long v6, v6, v110
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getFreeSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getFreeSizeKb()J
 
     move-result-wide v22
 
     sub-long v6, v6, v22
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getCachedSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getCachedSizeKb()J
 
     move-result-wide v22
 
     sub-long v6, v6, v22
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getKernelUsedSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getKernelUsedSizeKb()J
 
     move-result-wide v22
 
@@ -45119,10 +45487,10 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
 
-    :goto_1f
-    if-nez p5, :cond_4e
+    :cond_3a
+    if-nez p5, :cond_46
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getZramTotalSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getZramTotalSizeKb()J
 
     move-result-wide v6
 
@@ -45130,9 +45498,9 @@
 
     cmp-long v6, v6, v22
 
-    if-eqz v6, :cond_3e
+    if-eqz v6, :cond_3b
 
-    if-nez v13, :cond_49
+    if-nez v13, :cond_42
 
     const-string v6, "     ZRAM: "
 
@@ -45140,7 +45508,7 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getZramTotalSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getZramTotalSizeKb()J
 
     move-result-wide v6
 
@@ -45154,11 +45522,11 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getSwapTotalSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getSwapTotalSizeKb()J
 
     move-result-wide v6
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getSwapFreeSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getSwapFreeSizeKb()J
 
     move-result-wide v22
 
@@ -45174,7 +45542,7 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getSwapTotalSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getSwapTotalSizeKb()J
 
     move-result-wide v6
 
@@ -45188,37 +45556,56 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
 
-    :cond_3e
-    :goto_20
+    :cond_3b
+    :goto_1d
     invoke-direct/range {p0 .. p0}, Lcom/android/server/am/ActivityManagerService;->getKsmInfo()[J
 
-    move-result-object v84
+    move-result-object v83
 
-    .local v84, "ksm":[J
-    if-nez v13, :cond_4b
+    .local v83, "ksm":[J
+    if-nez v13, :cond_43
 
     const/4 v6, 0x1
 
-    aget-wide v6, v84, v6
+    aget-wide v6, v83, v6
 
     const-wide/16 v22, 0x0
 
     cmp-long v6, v6, v22
 
-    if-nez v6, :cond_3f
+    if-nez v6, :cond_3c
 
     const/4 v6, 0x0
 
-    aget-wide v6, v84, v6
+    aget-wide v6, v83, v6
 
     const-wide/16 v22, 0x0
 
     cmp-long v6, v6, v22
 
-    if-eqz v6, :cond_4a
+    if-nez v6, :cond_3c
 
-    :cond_3f
-    :goto_21
+    const/4 v6, 0x2
+
+    aget-wide v6, v83, v6
+
+    const-wide/16 v22, 0x0
+
+    cmp-long v6, v6, v22
+
+    if-nez v6, :cond_3c
+
+    const/4 v6, 0x3
+
+    aget-wide v6, v83, v6
+
+    const-wide/16 v22, 0x0
+
+    cmp-long v6, v6, v22
+
+    if-eqz v6, :cond_3d
+
+    :cond_3c
     const-string v6, "      KSM: "
 
     move-object/from16 v0, p2
@@ -45227,7 +45614,7 @@
 
     const/4 v6, 0x1
 
-    aget-wide v6, v84, v6
+    aget-wide v6, v83, v6
 
     move-object/from16 v0, p2
 
@@ -45241,7 +45628,7 @@
 
     const/4 v6, 0x0
 
-    aget-wide v6, v84, v6
+    aget-wide v6, v83, v6
 
     move-object/from16 v0, p2
 
@@ -45261,7 +45648,7 @@
 
     const/4 v6, 0x2
 
-    aget-wide v6, v84, v6
+    aget-wide v6, v83, v6
 
     move-object/from16 v0, p2
 
@@ -45275,7 +45662,7 @@
 
     const/4 v6, 0x3
 
-    aget-wide v6, v84, v6
+    aget-wide v6, v83, v6
 
     move-object/from16 v0, p2
 
@@ -45287,7 +45674,7 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
 
-    :cond_40
+    :cond_3d
     const-string v6, "   Tuning: "
 
     move-object/from16 v0, p2
@@ -45374,7 +45761,7 @@
 
     move-result v6
 
-    if-eqz v6, :cond_41
+    if-eqz v6, :cond_3e
 
     const-string v6, " (low-ram)"
 
@@ -45382,12 +45769,12 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    :cond_41
+    :cond_3e
     invoke-static {}, Landroid/app/ActivityManager;->isHighEndGfx()Z
 
     move-result v6
 
-    if-eqz v6, :cond_42
+    if-eqz v6, :cond_3f
 
     const-string v6, " (high-end-gfx)"
 
@@ -45395,93 +45782,32 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    :cond_42
+    :cond_3f
     invoke-virtual/range {p2 .. p2}, Ljava/io/PrintWriter;->println()V
 
-    move-object/from16 v15, v89
+    move-object/from16 v15, v90
 
-    .end local v89    # "mi":Landroid/os/Debug$MemoryInfo;
+    .end local v90    # "mi":Landroid/os/Debug$MemoryInfo;
     .restart local v15    # "mi":Landroid/os/Debug$MemoryInfo;
-    goto/16 :goto_f
+    goto/16 :goto_3
 
     .end local v15    # "mi":Landroid/os/Debug$MemoryInfo;
-    .end local v84    # "ksm":[J
-    .end local v88    # "memInfo":Lcom/android/internal/util/MemInfoReader;
-    .restart local v89    # "mi":Landroid/os/Debug$MemoryInfo;
-    :cond_43
-    if-nez v13, :cond_38
-
-    invoke-virtual/range {p2 .. p2}, Ljava/io/PrintWriter;->println()V
-
-    const-string v6, "Total PSS by process:"
-
-    move-object/from16 v0, p2
-
-    invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
-
-    const-string v54, "  "
-
-    const-string v55, "proc"
-
-    const/16 v57, 0x1
-
-    move-object/from16 v53, p2
-
-    move-object/from16 v56, v103
-
-    move/from16 v58, v13
-
-    invoke-static/range {v53 .. v58}, Lcom/android/server/am/ActivityManagerService;->dumpMemItems(Ljava/io/PrintWriter;Ljava/lang/String;Ljava/lang/String;Ljava/util/ArrayList;ZZ)V
-
-    invoke-virtual/range {p2 .. p2}, Ljava/io/PrintWriter;->println()V
-
-    goto/16 :goto_1b
-
-    :cond_44
-    if-eqz p6, :cond_46
-
-    move-object/from16 v53, p6
-
-    .local v53, "out":Ljava/io/PrintWriter;
-    :goto_22
-    if-nez v13, :cond_45
-
-    invoke-virtual/range {v53 .. v53}, Ljava/io/PrintWriter;->println()V
-
-    const-string v6, "Total PSS by category:"
-
-    move-object/from16 v0, v53
-
-    invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
-
-    :cond_45
-    const-string v54, "  "
-
-    const-string v55, "cat"
-
-    const/16 v57, 0x1
-
-    move-object/from16 v56, v70
-
-    move/from16 v58, v13
-
-    invoke-static/range {v53 .. v58}, Lcom/android/server/am/ActivityManagerService;->dumpMemItems(Ljava/io/PrintWriter;Ljava/lang/String;Ljava/lang/String;Ljava/util/ArrayList;ZZ)V
-
-    goto/16 :goto_1c
-
-    .end local v53    # "out":Ljava/io/PrintWriter;
-    :cond_46
-    move-object/from16 v53, p2
+    .end local v83    # "ksm":[J
+    .end local v87    # "memInfo":Lcom/android/internal/util/MemInfoReader;
+    .restart local v90    # "mi":Landroid/os/Debug$MemoryInfo;
+    :cond_40
+    move-object/from16 v55, p2
 
-    .restart local v53    # "out":Ljava/io/PrintWriter;
-    goto :goto_22
+    goto/16 :goto_1a
 
-    .end local v53    # "out":Ljava/io/PrintWriter;
-    .restart local v88    # "memInfo":Lcom/android/internal/util/MemInfoReader;
+    .restart local v87    # "memInfo":Lcom/android/internal/util/MemInfoReader;
     :catchall_4
     move-exception v6
 
+    :try_start_f
     monitor-exit p0
+    :try_end_f
+    .catchall {:try_start_f .. :try_end_f} :catchall_4
 
     throw v6
 
@@ -45492,7 +45818,7 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
 
-    goto/16 :goto_1d
+    goto/16 :goto_1b
 
     :pswitch_1
     const-string v6, "moderate)"
@@ -45501,7 +45827,7 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
 
-    goto/16 :goto_1d
+    goto/16 :goto_1b
 
     :pswitch_2
     const-string v6, "low)"
@@ -45510,7 +45836,7 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
 
-    goto/16 :goto_1d
+    goto/16 :goto_1b
 
     :pswitch_3
     const-string v6, "critical)"
@@ -45519,16 +45845,16 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->println(Ljava/lang/String;)V
 
-    goto/16 :goto_1d
+    goto/16 :goto_1b
 
-    :cond_47
+    :cond_41
     const-string v6, "ram,"
 
     move-object/from16 v0, p2
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getTotalSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getTotalSizeKb()J
 
     move-result-wide v6
 
@@ -45542,13 +45868,13 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getCachedSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getCachedSizeKb()J
 
     move-result-wide v6
 
-    add-long v6, v6, v68
+    add-long v6, v6, v70
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getFreeSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getFreeSizeKb()J
 
     move-result-wide v22
 
@@ -45564,59 +45890,22 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    sub-long v6, v110, v68
-
-    move-object/from16 v0, p2
-
-    invoke-virtual {v0, v6, v7}, Ljava/io/PrintWriter;->println(J)V
-
-    goto/16 :goto_1e
-
-    :cond_48
-    const-string v6, "lostram,"
-
-    move-object/from16 v0, p2
-
-    invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
-
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getTotalSizeKb()J
-
-    move-result-wide v6
-
-    sub-long v6, v6, v110
-
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getFreeSizeKb()J
-
-    move-result-wide v22
-
-    sub-long v6, v6, v22
-
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getCachedSizeKb()J
-
-    move-result-wide v22
-
-    sub-long v6, v6, v22
-
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getKernelUsedSizeKb()J
-
-    move-result-wide v22
-
-    sub-long v6, v6, v22
+    sub-long v6, v110, v70
 
     move-object/from16 v0, p2
 
     invoke-virtual {v0, v6, v7}, Ljava/io/PrintWriter;->println(J)V
 
-    goto/16 :goto_1f
+    goto/16 :goto_1c
 
-    :cond_49
+    :cond_42
     const-string v6, "zram,"
 
     move-object/from16 v0, p2
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getZramTotalSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getZramTotalSizeKb()J
 
     move-result-wide v6
 
@@ -45630,7 +45919,7 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getSwapTotalSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getSwapTotalSizeKb()J
 
     move-result-wide v6
 
@@ -45644,7 +45933,7 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    invoke-virtual/range {v88 .. v88}, Lcom/android/internal/util/MemInfoReader;->getSwapFreeSizeKb()J
+    invoke-virtual/range {v87 .. v87}, Lcom/android/internal/util/MemInfoReader;->getSwapFreeSizeKb()J
 
     move-result-wide v6
 
@@ -45652,33 +45941,10 @@
 
     invoke-virtual {v0, v6, v7}, Ljava/io/PrintWriter;->println(J)V
 
-    goto/16 :goto_20
-
-    .restart local v84    # "ksm":[J
-    :cond_4a
-    const/4 v6, 0x2
-
-    aget-wide v6, v84, v6
-
-    const-wide/16 v22, 0x0
-
-    cmp-long v6, v6, v22
-
-    if-nez v6, :cond_3f
-
-    const/4 v6, 0x3
-
-    aget-wide v6, v84, v6
-
-    const-wide/16 v22, 0x0
-
-    cmp-long v6, v6, v22
-
-    if-eqz v6, :cond_40
-
-    goto/16 :goto_21
+    goto/16 :goto_1d
 
-    :cond_4b
+    .restart local v83    # "ksm":[J
+    :cond_43
     const-string v6, "ksm,"
 
     move-object/from16 v0, p2
@@ -45687,7 +45953,7 @@
 
     const/4 v6, 0x1
 
-    aget-wide v6, v84, v6
+    aget-wide v6, v83, v6
 
     move-object/from16 v0, p2
 
@@ -45701,7 +45967,7 @@
 
     const/4 v6, 0x0
 
-    aget-wide v6, v84, v6
+    aget-wide v6, v83, v6
 
     move-object/from16 v0, p2
 
@@ -45715,7 +45981,7 @@
 
     const/4 v6, 0x2
 
-    aget-wide v6, v84, v6
+    aget-wide v6, v83, v6
 
     move-object/from16 v0, p2
 
@@ -45729,7 +45995,7 @@
 
     const/4 v6, 0x3
 
-    aget-wide v6, v84, v6
+    aget-wide v6, v83, v6
 
     move-object/from16 v0, p2
 
@@ -45791,7 +46057,7 @@
 
     move-result v6
 
-    if-eqz v6, :cond_4c
+    if-eqz v6, :cond_44
 
     const-string v6, ",low-ram"
 
@@ -45799,12 +46065,12 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    :cond_4c
+    :cond_44
     invoke-static {}, Landroid/app/ActivityManager;->isHighEndGfx()Z
 
     move-result v6
 
-    if-eqz v6, :cond_4d
+    if-eqz v6, :cond_45
 
     const-string v6, ",high-end-gfx"
 
@@ -45812,101 +46078,90 @@
 
     invoke-virtual {v0, v6}, Ljava/io/PrintWriter;->print(Ljava/lang/String;)V
 
-    :cond_4d
+    :cond_45
     invoke-virtual/range {p2 .. p2}, Ljava/io/PrintWriter;->println()V
 
-    move-object/from16 v15, v89
+    .end local v83    # "ksm":[J
+    :cond_46
+    move-object/from16 v15, v90
 
-    .end local v89    # "mi":Landroid/os/Debug$MemoryInfo;
+    .end local v90    # "mi":Landroid/os/Debug$MemoryInfo;
     .restart local v15    # "mi":Landroid/os/Debug$MemoryInfo;
-    goto/16 :goto_f
+    goto/16 :goto_3
 
     .end local v15    # "mi":Landroid/os/Debug$MemoryInfo;
-    .end local v37    # "dalvikItem":Lcom/android/server/am/ActivityManagerService$MemItem;
-    .end local v44    # "j":I
-    .end local v70    # "catMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    .end local v84    # "ksm":[J
-    .end local v88    # "memInfo":Lcom/android/internal/util/MemInfoReader;
-    .end local v96    # "oomMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    .restart local v89    # "mi":Landroid/os/Debug$MemoryInfo;
+    .end local v39    # "dalvikItem":Lcom/android/server/am/ActivityManagerService$MemItem;
+    .end local v46    # "j":I
+    .end local v72    # "catMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
+    .end local v87    # "memInfo":Lcom/android/internal/util/MemInfoReader;
+    .end local v97    # "oomMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
+    .restart local v90    # "mi":Landroid/os/Debug$MemoryInfo;
     :catchall_5
     move-exception v6
 
-    move-object/from16 v15, v89
+    move-object/from16 v15, v90
 
-    .end local v89    # "mi":Landroid/os/Debug$MemoryInfo;
+    .end local v90    # "mi":Landroid/os/Debug$MemoryInfo;
     .restart local v15    # "mi":Landroid/os/Debug$MemoryInfo;
-    goto/16 :goto_15
+    goto/16 :goto_13
 
     .end local v15    # "mi":Landroid/os/Debug$MemoryInfo;
-    .end local v36    # "N":I
-    .end local v48    # "otherPss":J
-    .end local v64    # "nativeProcTotalPss":J
-    .end local v68    # "cachedPss":J
-    .end local v71    # "dalvikSubitemPss":[J
-    .end local v72    # "dalvikPss":J
-    .end local v80    # "i":I
-    .end local v81    # "innerArgs":[Ljava/lang/String;
-    .end local v90    # "miscPss":[J
-    .end local v92    # "nativePss":J
-    .end local v98    # "oomProcs":[Ljava/util/ArrayList;, "[Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    .end local v99    # "oomPss":[J
-    .end local v103    # "procMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    .end local v104    # "procMemsMap":Landroid/util/SparseArray;, "Landroid/util/SparseArray<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
+    .end local v38    # "N":I
+    .end local v50    # "otherPss":J
+    .end local v66    # "nativeProcTotalPss":J
+    .end local v70    # "cachedPss":J
+    .end local v73    # "dalvikSubitemPss":[J
+    .end local v74    # "dalvikPss":J
+    .end local v79    # "i":I
+    .end local v82    # "innerArgs":[Ljava/lang/String;
+    .end local v91    # "miscPss":[J
+    .end local v94    # "nativePss":J
+    .end local v99    # "oomProcs":[Ljava/util/ArrayList;, "[Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
+    .end local v100    # "oomPss":[J
+    .end local v104    # "procMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
+    .end local v105    # "procMemsMap":Landroid/util/SparseArray;, "Landroid/util/SparseArray<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
     .end local v110    # "totalPss":J
-    .restart local v77    # "findPid":I
-    .restart local v91    # "nativeProcs":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/internal/os/ProcessCpuTracker$Stats;>;"
+    .restart local v78    # "findPid":I
+    .restart local v92    # "nativeProcs":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/internal/os/ProcessCpuTracker$Stats;>;"
     :catch_1
-    move-exception v76
+    move-exception v6
 
-    .local v76, "e":Ljava/lang/NumberFormatException;
     goto/16 :goto_1
 
-    .end local v76    # "e":Ljava/lang/NumberFormatException;
-    .end local v77    # "findPid":I
-    .end local v91    # "nativeProcs":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/internal/os/ProcessCpuTracker$Stats;>;"
-    .restart local v36    # "N":I
-    .restart local v37    # "dalvikItem":Lcom/android/server/am/ActivityManagerService$MemItem;
-    .restart local v44    # "j":I
-    .restart local v48    # "otherPss":J
-    .restart local v64    # "nativeProcTotalPss":J
-    .restart local v68    # "cachedPss":J
-    .restart local v70    # "catMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    .restart local v71    # "dalvikSubitemPss":[J
-    .restart local v72    # "dalvikPss":J
-    .restart local v80    # "i":I
-    .restart local v81    # "innerArgs":[Ljava/lang/String;
-    .restart local v88    # "memInfo":Lcom/android/internal/util/MemInfoReader;
-    .restart local v89    # "mi":Landroid/os/Debug$MemoryInfo;
-    .restart local v90    # "miscPss":[J
-    .restart local v92    # "nativePss":J
-    .restart local v96    # "oomMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    .restart local v98    # "oomProcs":[Ljava/util/ArrayList;, "[Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    .restart local v99    # "oomPss":[J
-    .restart local v103    # "procMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    .restart local v104    # "procMemsMap":Landroid/util/SparseArray;, "Landroid/util/SparseArray<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
+    .end local v78    # "findPid":I
+    .end local v92    # "nativeProcs":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/internal/os/ProcessCpuTracker$Stats;>;"
+    .restart local v38    # "N":I
+    .restart local v50    # "otherPss":J
+    .restart local v66    # "nativeProcTotalPss":J
+    .restart local v70    # "cachedPss":J
+    .restart local v73    # "dalvikSubitemPss":[J
+    .restart local v74    # "dalvikPss":J
+    .restart local v79    # "i":I
+    .restart local v82    # "innerArgs":[Ljava/lang/String;
+    .restart local v90    # "mi":Landroid/os/Debug$MemoryInfo;
+    .restart local v91    # "miscPss":[J
+    .restart local v94    # "nativePss":J
+    .restart local v99    # "oomProcs":[Ljava/util/ArrayList;, "[Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
+    .restart local v100    # "oomPss":[J
+    .restart local v104    # "procMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
+    .restart local v105    # "procMemsMap":Landroid/util/SparseArray;, "Landroid/util/SparseArray<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
+    .restart local v108    # "st":Lcom/android/internal/os/ProcessCpuTracker$Stats;
     .restart local v110    # "totalPss":J
-    :cond_4e
-    move-object/from16 v15, v89
+    :cond_47
+    move-object/from16 v15, v90
 
-    .end local v89    # "mi":Landroid/os/Debug$MemoryInfo;
+    .end local v90    # "mi":Landroid/os/Debug$MemoryInfo;
     .restart local v15    # "mi":Landroid/os/Debug$MemoryInfo;
-    goto/16 :goto_f
+    goto/16 :goto_10
 
     .end local v15    # "mi":Landroid/os/Debug$MemoryInfo;
-    .end local v37    # "dalvikItem":Lcom/android/server/am/ActivityManagerService$MemItem;
-    .end local v44    # "j":I
-    .end local v70    # "catMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    .end local v88    # "memInfo":Lcom/android/internal/util/MemInfoReader;
-    .end local v96    # "oomMems":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityManagerService$MemItem;>;"
-    .restart local v89    # "mi":Landroid/os/Debug$MemoryInfo;
-    .restart local v108    # "st":Lcom/android/internal/os/ProcessCpuTracker$Stats;
-    :cond_4f
-    move-object/from16 v15, v89
+    .restart local v90    # "mi":Landroid/os/Debug$MemoryInfo;
+    :cond_48
+    move-object/from16 v15, v90
 
-    .end local v89    # "mi":Landroid/os/Debug$MemoryInfo;
+    .end local v90    # "mi":Landroid/os/Debug$MemoryInfo;
     .restart local v15    # "mi":Landroid/os/Debug$MemoryInfo;
-    goto/16 :goto_11
+    goto/16 :goto_15
 
     nop
 
@@ -47384,7 +47639,9 @@
 
     invoke-interface {v10, v11, p3}, Landroid/app/IApplicationThread;->dumpGfxInfo(Ljava/io/FileDescriptor;[Ljava/lang/String;)V
 
-    invoke-virtual {v5, p1}, Lcom/android/internal/os/TransferPipe;->go(Ljava/io/FileDescriptor;)V
+    const-wide/16 v11, 0x7530
+
+    invoke-virtual {v5, p1, v11, p0}, Lcom/android/internal/os/TransferPipe;->go(Ljava/io/FileDescriptor;J)V
     :try_end_1
     .catchall {:try_start_1 .. :try_end_1} :catchall_0
 
@@ -52895,6 +53152,10 @@
     .param p4, "finishTask"    # Z
 
     .prologue
+    invoke-static/range {p0 .. p3}, Lcom/android/server/am/ActivityManagerServiceInjector;->finishActivity(Lcom/android/server/am/ActivityManagerService;Landroid/os/IBinder;ILandroid/content/Intent;)Landroid/os/IBinder;
+
+    move-result-object p1
+
     if-eqz p3, :cond_0
 
     invoke-virtual/range {p3 .. p3}, Landroid/content/Intent;->hasFileDescriptors()Z
@@ -53769,13 +54030,15 @@
     .end local v29    # "uss":Lcom/android/server/am/UserState;
     :cond_8
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/am/ActivityManagerService;->scheduleStartProfilesLocked()V
-    :try_end_2
-    .catchall {:try_start_2 .. :try_end_2} :catchall_1
 
     .end local v23    # "i":I
     .end local v26    # "nmsg":Landroid/os/Message;
     :cond_9
     monitor-exit p0
+    :try_end_2
+    .catchall {:try_start_2 .. :try_end_2} :catchall_1
+
+    invoke-static/range {p0 .. p0}, Lcom/android/server/am/ActivityManagerServiceInjector;->finishBooting(Lcom/android/server/am/ActivityManagerService;)V
 
     return-void
 
@@ -53783,7 +54046,10 @@
     :catchall_1
     move-exception v2
 
+    :try_start_3
     monitor-exit p0
+    :try_end_3
+    .catchall {:try_start_3 .. :try_end_3} :catchall_1
 
     throw v2
 .end method
@@ -55987,8 +56253,6 @@
     .param p1, "token"    # Landroid/os/IBinder;
 
     .prologue
-    const/4 v1, 0x0
-
     monitor-enter p0
 
     :try_start_0
@@ -55999,22 +56263,33 @@
     .local v0, "r":Lcom/android/server/am/ActivityRecord;
     if-eqz v0, :cond_0
 
+    iget-object v1, v0, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
+
+    if-eqz v1, :cond_0
+
     iget-object v1, v0, Lcom/android/server/am/ActivityRecord;->info:Landroid/content/pm/ActivityInfo;
 
     iget-object v1, v1, Landroid/content/pm/ActivityInfo;->packageName:Ljava/lang/String;
-    :try_end_0
-    .catchall {:try_start_0 .. :try_end_0} :catchall_0
 
-    :cond_0
+    :goto_0
     monitor-exit p0
 
     return-object v1
 
+    :cond_0
+    invoke-static {p0, p1}, Lcom/android/server/am/ActivityManagerServiceInjector;->getCallingUidPackage(Lcom/android/server/am/ActivityManagerService;Landroid/os/IBinder;)Ljava/lang/String;
+
+    move-result-object v1
+
+    goto :goto_0
+
     .end local v0    # "r":Lcom/android/server/am/ActivityRecord;
     :catchall_0
     move-exception v1
 
     monitor-exit p0
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
 
     throw v1
 .end method
@@ -66491,10 +66766,24 @@
 
     if-ne v6, v7, :cond_4
 
+    iget-object v6, v1, Lcom/android/server/am/ProcessRecord;->processName:Ljava/lang/String;
+
+    iget-object v7, p1, Landroid/content/pm/ApplicationInfo;->processName:Ljava/lang/String;
+
+    invoke-virtual {v6, v7}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v6
+
+    if-eqz v6, :cond_4
+
     const/4 v6, 0x1
 
     iput-boolean v6, v1, Lcom/android/server/am/ProcessRecord;->persistent:Z
 
+    const/16 v6, -0xc
+
+    iput v6, v1, Lcom/android/server/am/ProcessRecord;->maxAdj:I
+
     goto :goto_2
 .end method
 
@@ -80714,14 +81003,27 @@
     invoke-direct {p0, v10, v11, v2}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
     :cond_5
-    if-eqz p6, :cond_6
+    if-eqz p6, :cond_7
 
     invoke-virtual/range {p6 .. p6}, Landroid/content/ComponentName;->flattenToShortString()Ljava/lang/String;
 
     move-result-object v5
 
     :goto_1
-    if-nez v3, :cond_9
+    iget-object v2, p2, Landroid/content/pm/ApplicationInfo;->processName:Ljava/lang/String;
+
+    invoke-static {v2}, Lcom/android/server/am/ActivityManagerServiceInjector;->processInitBefore(Ljava/lang/String;)Z
+
+    move-result v2
+
+    if-nez v2, :cond_6
+
+    const/4 v2, 0x0
+
+    return-object v2
+
+    :cond_6
+    if-nez v3, :cond_a
 
     const-string v2, "startProcess: creating new process record"
 
@@ -80736,7 +81038,7 @@
     move-result-object v3
 
     .local v3, "app":Lcom/android/server/am/ProcessRecord;
-    if-nez v3, :cond_7
+    if-nez v3, :cond_8
 
     const-string v2, "ActivityManager"
 
@@ -80789,7 +81091,7 @@
     return-object v2
 
     .end local v3    # "app":Lcom/android/server/am/ProcessRecord;
-    :cond_6
+    :cond_7
     const/4 v5, 0x0
 
     .local v5, "hostingNameStr":Ljava/lang/String;
@@ -80797,7 +81099,7 @@
 
     .end local v5    # "hostingNameStr":Ljava/lang/String;
     .restart local v3    # "app":Lcom/android/server/am/ProcessRecord;
-    :cond_7
+    :cond_8
     move-object/from16 v0, p14
 
     iput-object v0, v3, Lcom/android/server/am/ProcessRecord;->crashHandler:Ljava/lang/Runnable;
@@ -80810,15 +81112,15 @@
     :goto_2
     iget-boolean v2, p0, Lcom/android/server/am/ActivityManagerService;->mProcessesReady:Z
 
-    if-nez v2, :cond_8
+    if-nez v2, :cond_9
 
     invoke-virtual {p0, p2}, Lcom/android/server/am/ActivityManagerService;->isAllowedWhileBooting(Landroid/content/pm/ApplicationInfo;)Z
 
     move-result v2
 
-    if-eqz v2, :cond_a
+    if-eqz v2, :cond_b
 
-    :cond_8
+    :cond_9
     const-string v2, "startProcess: stepping in to startProcess"
 
     invoke-direct {p0, v10, v11, v2}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
@@ -80841,12 +81143,12 @@
 
     iget v2, v3, Lcom/android/server/am/ProcessRecord;->pid:I
 
-    if-eqz v2, :cond_c
+    if-eqz v2, :cond_d
 
     :goto_3
     return-object v3
 
-    :cond_9
+    :cond_a
     iget-object v2, p2, Landroid/content/pm/ApplicationInfo;->packageName:Ljava/lang/String;
 
     iget v4, p2, Landroid/content/pm/ApplicationInfo;->versionCode:I
@@ -80861,8 +81163,8 @@
 
     goto :goto_2
 
-    :cond_a
-    if-nez p7, :cond_8
+    :cond_b
+    if-nez p7, :cond_9
 
     iget-object v2, p0, Lcom/android/server/am/ActivityManagerService;->mProcessesOnHold:Ljava/util/ArrayList;
 
@@ -80870,20 +81172,20 @@
 
     move-result v2
 
-    if-nez v2, :cond_b
+    if-nez v2, :cond_c
 
     iget-object v2, p0, Lcom/android/server/am/ActivityManagerService;->mProcessesOnHold:Ljava/util/ArrayList;
 
     invoke-virtual {v2, v3}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
 
-    :cond_b
+    :cond_c
     const-string v2, "startProcess: returning with proc on hold"
 
     invoke-direct {p0, v10, v11, v2}, Lcom/android/server/am/ActivityManagerService;->checkTime(JLjava/lang/String;)V
 
     return-object v3
 
-    :cond_c
+    :cond_d
     const/4 v3, 0x0
 
     goto :goto_3
@@ -81142,7 +81444,38 @@
     throw v0
 
     :cond_0
-    if-nez p4, :cond_1
+    iget-object v0, p0, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+
+    invoke-static {}, Landroid/os/Binder;->getCallingUid()I
+
+    move-result v1
+
+    invoke-static {v1}, Landroid/os/UserHandle;->getUserId(I)I
+
+    move-result v5
+
+    iget-boolean v6, p0, Lcom/android/server/am/ActivityManagerService;->mSystemReady:Z
+
+    move-object v1, p0
+
+    move-object v2, p1
+
+    move-object v3, p2
+
+    move-object v4, p3
+
+    invoke-static/range {v0 .. v6}, Lcom/android/server/am/ExtraActivityManagerService;->checkRunningCompatibility(Landroid/content/Context;Lcom/android/server/am/ActivityManagerService;Landroid/app/IApplicationThread;Landroid/content/Intent;Ljava/lang/String;IZ)Z
+
+    move-result v0
+
+    if-nez v0, :cond_1
+
+    const/4 v10, 0x0
+
+    return-object v10
+
+    :cond_1
+    if-nez p4, :cond_2
 
     new-instance v0, Ljava/lang/IllegalArgumentException;
 
@@ -81152,7 +81485,7 @@
 
     throw v0
 
-    :cond_1
+    :cond_2
     monitor-enter p0
 
     :try_start_0
@@ -82385,135 +82718,147 @@
     .param p1, "userId"    # I
 
     .prologue
-    const/16 v4, 0x2e
+    const/4 v3, 0x1
 
-    const/4 v5, 0x0
+    const/4 v2, 0x0
 
-    const-string v2, "no_debugging_features"
+    const-string v4, "no_debugging_features"
 
-    invoke-virtual {p0, v2, p1}, Lcom/android/server/am/ActivityManagerService;->enforceShellRestriction(Ljava/lang/String;I)V
+    invoke-virtual {p0, v4, p1}, Lcom/android/server/am/ActivityManagerService;->enforceShellRestriction(Ljava/lang/String;I)V
 
     monitor-enter p0
 
     :try_start_0
     invoke-virtual {p0}, Lcom/android/server/am/ActivityManagerService;->getUserManagerLocked()Lcom/android/server/pm/UserManagerService;
 
-    move-result-object v2
+    move-result-object v4
 
-    invoke-virtual {v2, p1}, Lcom/android/server/pm/UserManagerService;->getUserInfo(I)Landroid/content/pm/UserInfo;
+    invoke-virtual {v4, p1}, Lcom/android/server/pm/UserManagerService;->getUserInfo(I)Landroid/content/pm/UserInfo;
 
     move-result-object v0
 
     .local v0, "userInfo":Landroid/content/pm/UserInfo;
     if-nez v0, :cond_0
 
-    const-string v2, "ActivityManager"
+    const-string v3, "ActivityManager"
 
-    new-instance v3, Ljava/lang/StringBuilder;
+    new-instance v4, Ljava/lang/StringBuilder;
 
-    invoke-direct {v3}, Ljava/lang/StringBuilder;-><init>()V
+    invoke-direct {v4}, Ljava/lang/StringBuilder;-><init>()V
 
-    const-string v4, "No user info for user #"
+    const-string v5, "No user info for user #"
 
-    invoke-virtual {v3, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v4, v5}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    move-result-object v3
+    move-result-object v4
 
-    invoke-virtual {v3, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v4, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
-    move-result-object v3
+    move-result-object v4
 
-    invoke-virtual {v3}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    invoke-virtual {v4}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    move-result-object v3
+    move-result-object v4
 
-    invoke-static {v2, v3}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
-    :try_end_0
-    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+    invoke-static {v3, v4}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
 
     monitor-exit p0
 
-    return v5
+    :goto_0
+    return v2
 
     :cond_0
+    invoke-static {p1}, Lcom/android/server/am/ActivityManagerServiceInjector;->isUserSwitchable(I)Z
+
+    move-result v4
+
+    if-nez v4, :cond_1
+
+    monitor-exit p0
+
+    goto :goto_0
+
+    .end local v0    # "userInfo":Landroid/content/pm/UserInfo;
+    :catchall_0
+    move-exception v2
+
+    monitor-exit p0
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    throw v2
+
+    .restart local v0    # "userInfo":Landroid/content/pm/UserInfo;
+    :cond_1
     :try_start_1
     invoke-virtual {v0}, Landroid/content/pm/UserInfo;->isManagedProfile()Z
 
-    move-result v2
+    move-result v4
 
-    if-eqz v2, :cond_1
+    if-eqz v4, :cond_2
 
-    const-string v2, "ActivityManager"
+    const-string v3, "ActivityManager"
 
-    new-instance v3, Ljava/lang/StringBuilder;
+    new-instance v4, Ljava/lang/StringBuilder;
 
-    invoke-direct {v3}, Ljava/lang/StringBuilder;-><init>()V
+    invoke-direct {v4}, Ljava/lang/StringBuilder;-><init>()V
 
-    const-string v4, "Cannot switch to User #"
+    const-string v5, "Cannot switch to User #"
 
-    invoke-virtual {v3, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v4, v5}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    move-result-object v3
+    move-result-object v4
 
-    invoke-virtual {v3, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    invoke-virtual {v4, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
-    move-result-object v3
+    move-result-object v4
 
-    const-string v4, ": not a full user"
+    const-string v5, ": not a full user"
 
-    invoke-virtual {v3, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v4, v5}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    move-result-object v3
+    move-result-object v4
 
-    invoke-virtual {v3}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    invoke-virtual {v4}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    move-result-object v3
+    move-result-object v4
 
-    invoke-static {v2, v3}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
-    :try_end_1
-    .catchall {:try_start_1 .. :try_end_1} :catchall_0
+    invoke-static {v3, v4}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
 
     monitor-exit p0
 
-    return v5
+    goto :goto_0
 
-    :cond_1
-    :try_start_2
+    :cond_2
     iget-object v1, v0, Landroid/content/pm/UserInfo;->name:Ljava/lang/String;
 
     .local v1, "userName":Ljava/lang/String;
     iput p1, p0, Lcom/android/server/am/ActivityManagerService;->mTargetUserId:I
-    :try_end_2
-    .catchall {:try_start_2 .. :try_end_2} :catchall_0
 
     monitor-exit p0
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_0
 
     iget-object v2, p0, Lcom/android/server/am/ActivityManagerService;->mUiHandler:Lcom/android/server/am/ActivityManagerService$UiHandler;
 
+    const/16 v4, 0x2e
+
     invoke-virtual {v2, v4}, Lcom/android/server/am/ActivityManagerService$UiHandler;->removeMessages(I)V
 
     iget-object v2, p0, Lcom/android/server/am/ActivityManagerService;->mUiHandler:Lcom/android/server/am/ActivityManagerService$UiHandler;
 
-    iget-object v3, p0, Lcom/android/server/am/ActivityManagerService;->mUiHandler:Lcom/android/server/am/ActivityManagerService$UiHandler;
-
-    invoke-virtual {v3, v4, p1, v5, v1}, Lcom/android/server/am/ActivityManagerService$UiHandler;->obtainMessage(IIILjava/lang/Object;)Landroid/os/Message;
-
-    move-result-object v3
-
-    invoke-virtual {v2, v3}, Lcom/android/server/am/ActivityManagerService$UiHandler;->sendMessage(Landroid/os/Message;)Z
+    invoke-static {p0, p1, v2}, Lcom/android/server/am/ActivityManagerServiceInjector;->showSwitchingDialog(Lcom/android/server/am/ActivityManagerService;ILandroid/os/Handler;)Z
 
-    const/4 v2, 0x1
+    move-result v2
 
-    return v2
+    if-nez v2, :cond_3
 
-    .end local v0    # "userInfo":Landroid/content/pm/UserInfo;
-    .end local v1    # "userName":Ljava/lang/String;
-    :catchall_0
-    move-exception v2
+    invoke-direct {p0, p1, v3}, Lcom/android/server/am/ActivityManagerService;->startUser(IZ)Z
 
-    monitor-exit p0
+    :cond_3
+    move v2, v3
 
-    throw v2
+    goto :goto_0
 .end method
 
 .method public systemReady(Ljava/lang/Runnable;)V
@@ -83262,6 +83607,12 @@
     move-object/from16 v1, v32
 
     invoke-virtual {v0, v1, v4, v5}, Lcom/android/server/am/ActivityManagerService;->addAppLocked(Landroid/content/pm/ApplicationInfo;ZLjava/lang/String;)Lcom/android/server/am/ProcessRecord;
+
+    move-object/from16 v0, v32
+
+    iget-object v4, v0, Landroid/content/pm/ApplicationInfo;->processName:Ljava/lang/String;
+
+    invoke-static {v4}, Lcom/android/server/am/ActivityManagerServiceInjector;->setProcessInitState(Ljava/lang/String;)Z
     :try_end_e
     .catch Landroid/os/RemoteException; {:try_start_e .. :try_end_e} :catch_0
     .catchall {:try_start_e .. :try_end_e} :catchall_5
@@ -83522,10 +83873,16 @@
     move-object/from16 v0, p0
 
     invoke-virtual {v0, v5, v4}, Lcom/android/server/am/ActivityManagerService;->sendUserSwitchBroadcastsLocked(II)V
+
+    monitor-exit p0
     :try_end_13
     .catchall {:try_start_13 .. :try_end_13} :catchall_5
 
-    monitor-exit p0
+    move-object/from16 v0, p0
+
+    iget-object v4, v0, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+
+    invoke-static {v4}, Lcom/android/server/am/ExtraActivityManagerService;->onSystemReady(Landroid/content/Context;)V
 
     return-void
 
@@ -88173,6 +88530,16 @@
     goto/16 :goto_8
 
     :cond_10
+    iget v3, v4, Lcom/android/server/am/ProcessRecord;->pid:I
+
+    iget-wide v0, v4, Lcom/android/server/am/ProcessRecord;->lastPss:J
+
+    move-wide/from16 v12, v0
+
+    move/from16 v0, v38
+
+    invoke-static {v0, v3, v12, v13}, Lcom/miui/whetstone/client/WhetstoneClientManager;->setCachedPidLam(IIJ)V
+
     add-int/lit8 v38, v38, 0x1
 
     move/from16 v0, v38
--- a/services/smali/com/android/server/am/ActivityStack.smali
+++ b/services/smali/com/android/server/am/ActivityStack.smali
@@ -1477,6 +1477,10 @@
 
     invoke-virtual {p0, p1, v7}, Lcom/android/server/am/ActivityStack;->updateTaskMovement(Lcom/android/server/am/TaskRecord;Z)V
 
+    iget-object v6, p0, Lcom/android/server/am/ActivityStack;->mTaskHistory:Ljava/util/ArrayList;
+
+    invoke-static {p1, v6}, Lcom/android/server/am/ActivityStackInjector;->moveTaskIfNeed(Lcom/android/server/am/TaskRecord;Ljava/util/ArrayList;)Z
+
     return-void
 
     .end local v3    # "notShownWhenLocked":Z
@@ -1688,6 +1692,8 @@
     .param p2, "task"    # Lcom/android/server/am/TaskRecord;
 
     .prologue
+    const/4 v4, 0x0
+
     iget-object v2, p1, Lcom/android/server/am/ActivityRecord;->intent:Landroid/content/Intent;
 
     invoke-virtual {v2}, Landroid/content/Intent;->getData()Landroid/net/Uri;
@@ -1702,12 +1708,19 @@
     move-result-object v1
 
     :goto_0
-    const/16 v2, 0x8
+    const/16 v2, 0x9
 
     new-array v2, v2, [Ljava/lang/Object;
 
-    iget v3, p1, Lcom/android/server/am/ActivityRecord;->userId:I
+    iget-object v3, p1, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
 
+    if-eqz v3, :cond_1
+
+    iget-object v3, p1, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
+
+    iget v3, v3, Lcom/android/server/am/ProcessRecord;->pid:I
+
+    :goto_1
     invoke-static {v3}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
     move-result-object v3
@@ -1782,6 +1795,12 @@
 
     aput-object v3, v2, v4
 
+    const/16 v4, 0x8
+
+    iget-object v3, p1, Lcom/android/server/am/ActivityRecord;->launchedFromPackage:Ljava/lang/String;
+
+    aput-object v3, v2, v4
+
     invoke-static {p0, v2}, Landroid/util/EventLog;->writeEvent(I[Ljava/lang/Object;)I
 
     return-void
@@ -1791,20 +1810,25 @@
 
     .local v1, "strData":Ljava/lang/String;
     goto :goto_0
+
+    :cond_1
+    move v3, v4
+
+    goto :goto_1
 .end method
 
 .method private relaunchActivityLocked(Lcom/android/server/am/ActivityRecord;IZ)Z
-    .locals 11
+    .locals 10
     .param p1, "r"    # Lcom/android/server/am/ActivityRecord;
     .param p2, "changes"    # I
     .param p3, "andResume"    # Z
 
     .prologue
-    const/4 v10, 0x0
+    const/4 v9, 0x0
 
-    const/4 v9, 0x1
+    const/4 v8, 0x1
 
-    const/4 v5, 0x0
+    const/4 v4, 0x0
 
     const/4 v2, 0x0
 
@@ -1816,62 +1840,72 @@
 
     iget-object v2, p1, Lcom/android/server/am/ActivityRecord;->results:Ljava/util/ArrayList;
 
-    .local v2, "results":Ljava/util/List;, "Ljava/util/List<Landroid/app/ResultInfo;>;"
     iget-object v3, p1, Lcom/android/server/am/ActivityRecord;->newIntents:Ljava/util/ArrayList;
 
-    .end local v2    # "results":Ljava/util/List;, "Ljava/util/List<Landroid/app/ResultInfo;>;"
-    .end local v3    # "newIntents":Ljava/util/List;, "Ljava/util/List<Lcom/android/internal/content/ReferrerIntent;>;"
     :cond_0
     if-eqz p3, :cond_1
 
     const/16 v0, 0x7543
 
     :goto_0
-    const/4 v1, 0x4
+    const/4 v1, 0x5
 
-    new-array v1, v1, [Ljava/lang/Object;
+    new-array v5, v1, [Ljava/lang/Object;
 
-    iget v4, p1, Lcom/android/server/am/ActivityRecord;->userId:I
+    iget-object v1, p1, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
 
-    invoke-static {v4}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+    if-eqz v1, :cond_2
 
-    move-result-object v4
+    iget-object v1, p1, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
+
+    iget v1, v1, Lcom/android/server/am/ProcessRecord;->pid:I
 
-    aput-object v4, v1, v5
+    :goto_1
+    invoke-static {v1}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v1
+
+    aput-object v1, v5, v4
 
     invoke-static {p1}, Ljava/lang/System;->identityHashCode(Ljava/lang/Object;)I
 
-    move-result v4
+    move-result v1
 
-    invoke-static {v4}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+    invoke-static {v1}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
-    move-result-object v4
+    move-result-object v1
 
-    aput-object v4, v1, v9
+    aput-object v1, v5, v8
 
-    iget-object v4, p1, Lcom/android/server/am/ActivityRecord;->task:Lcom/android/server/am/TaskRecord;
+    const/4 v1, 0x2
 
-    iget v4, v4, Lcom/android/server/am/TaskRecord;->taskId:I
+    iget-object v6, p1, Lcom/android/server/am/ActivityRecord;->task:Lcom/android/server/am/TaskRecord;
 
-    invoke-static {v4}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+    iget v6, v6, Lcom/android/server/am/TaskRecord;->taskId:I
 
-    move-result-object v4
+    invoke-static {v6}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
-    const/4 v6, 0x2
+    move-result-object v6
 
-    aput-object v4, v1, v6
+    aput-object v6, v5, v1
 
-    iget-object v4, p1, Lcom/android/server/am/ActivityRecord;->shortComponentName:Ljava/lang/String;
+    const/4 v1, 0x3
 
-    const/4 v6, 0x3
+    iget-object v6, p1, Lcom/android/server/am/ActivityRecord;->shortComponentName:Ljava/lang/String;
+
+    aput-object v6, v5, v1
 
-    aput-object v4, v1, v6
+    const/4 v1, 0x4
 
-    invoke-static {v0, v1}, Landroid/util/EventLog;->writeEvent(I[Ljava/lang/Object;)I
+    iget-object v6, p1, Lcom/android/server/am/ActivityRecord;->launchedFromPackage:Ljava/lang/String;
+
+    aput-object v6, v5, v1
+
+    invoke-static {v0, v5}, Landroid/util/EventLog;->writeEvent(I[Ljava/lang/Object;)I
 
     iget-object v0, p1, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
 
-    invoke-virtual {p1, v0, v5}, Lcom/android/server/am/ActivityRecord;->startFreezingScreenLocked(Lcom/android/server/am/ProcessRecord;I)V
+    invoke-virtual {p1, v0, v4}, Lcom/android/server/am/ActivityRecord;->startFreezingScreenLocked(Lcom/android/server/am/ProcessRecord;I)V
 
     iget-object v0, p0, Lcom/android/server/am/ActivityStack;->mStackSupervisor:Lcom/android/server/am/ActivityStackSupervisor;
 
@@ -1888,9 +1922,11 @@
 
     iget-object v1, p1, Lcom/android/server/am/ActivityRecord;->appToken:Landroid/view/IApplicationToken$Stub;
 
-    if-eqz p3, :cond_2
+    if-nez p3, :cond_3
 
-    :goto_1
+    move v5, v8
+
+    :goto_2
     new-instance v6, Landroid/content/res/Configuration;
 
     iget-object v4, p0, Lcom/android/server/am/ActivityStack;->mService:Lcom/android/server/am/ActivityManagerService;
@@ -1911,19 +1947,19 @@
     :try_end_0
     .catch Landroid/os/RemoteException; {:try_start_0 .. :try_end_0} :catch_0
 
-    :goto_2
-    if-eqz p3, :cond_3
+    :goto_3
+    if-eqz p3, :cond_4
 
-    iput-object v10, p1, Lcom/android/server/am/ActivityRecord;->results:Ljava/util/ArrayList;
+    iput-object v9, p1, Lcom/android/server/am/ActivityRecord;->results:Ljava/util/ArrayList;
 
-    iput-object v10, p1, Lcom/android/server/am/ActivityRecord;->newIntents:Ljava/util/ArrayList;
+    iput-object v9, p1, Lcom/android/server/am/ActivityRecord;->newIntents:Ljava/util/ArrayList;
 
     sget-object v0, Lcom/android/server/am/ActivityStack$ActivityState;->RESUMED:Lcom/android/server/am/ActivityStack$ActivityState;
 
     iput-object v0, p1, Lcom/android/server/am/ActivityRecord;->state:Lcom/android/server/am/ActivityStack$ActivityState;
 
-    :goto_3
-    return v9
+    :goto_4
+    return v8
 
     :cond_1
     const/16 v0, 0x7544
@@ -1931,11 +1967,16 @@
     goto :goto_0
 
     :cond_2
-    move v5, v9
+    move v1, v4
 
     goto :goto_1
 
     :cond_3
+    move v5, v4
+
+    goto :goto_2
+
+    :cond_4
     iget-object v0, p0, Lcom/android/server/am/ActivityStack;->mHandler:Landroid/os/Handler;
 
     const/16 v1, 0x65
@@ -1946,13 +1987,12 @@
 
     iput-object v0, p1, Lcom/android/server/am/ActivityRecord;->state:Lcom/android/server/am/ActivityStack$ActivityState;
 
-    goto :goto_3
+    goto :goto_4
 
     :catch_0
-    move-exception v8
+    move-exception v0
 
-    .local v8, "e":Landroid/os/RemoteException;
-    goto :goto_2
+    goto :goto_3
 .end method
 
 .method private removeActivityFromHistoryLocked(Lcom/android/server/am/ActivityRecord;Ljava/lang/String;)V
@@ -3396,7 +3436,7 @@
 
     iget-object v3, v0, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
 
-    if-eqz v3, :cond_36
+    if-eqz v3, :cond_37
 
     move-object/from16 v0, v26
 
@@ -3404,7 +3444,7 @@
 
     iget-object v3, v3, Lcom/android/server/am/ProcessRecord;->thread:Landroid/app/IApplicationThread;
 
-    if-eqz v3, :cond_36
+    if-eqz v3, :cond_37
 
     move-object/from16 v0, p0
 
@@ -4011,14 +4051,23 @@
     invoke-interface {v3, v4, v5}, Landroid/app/IApplicationThread;->scheduleNewIntent(Ljava/util/List;Landroid/os/IBinder;)V
 
     :cond_32
-    const/4 v3, 0x4
+    const/4 v3, 0x5
 
     new-array v3, v3, [Ljava/lang/Object;
 
     move-object/from16 v0, v26
 
-    iget v4, v0, Lcom/android/server/am/ActivityRecord;->userId:I
+    iget-object v4, v0, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
+
+    if-eqz v4, :cond_33
 
+    move-object/from16 v0, v26
+
+    iget-object v4, v0, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
+
+    iget v4, v4, Lcom/android/server/am/ProcessRecord;->pid:I
+
+    :goto_12
     invoke-static {v4}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
     move-result-object v4
@@ -4061,6 +4110,14 @@
 
     aput-object v4, v3, v5
 
+    const/4 v5, 0x4
+
+    move-object/from16 v0, v26
+
+    iget-object v4, v0, Lcom/android/server/am/ActivityRecord;->launchedFromPackage:Ljava/lang/String;
+
+    aput-object v4, v3, v5
+
     const/16 v4, 0x7537
 
     invoke-static {v4, v3}, Landroid/util/EventLog;->writeEvent(I[Ljava/lang/Object;)I
@@ -4161,13 +4218,18 @@
     .end local v16    # "a":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Landroid/app/ResultInfo;>;"
     .end local v25    # "lastState":Lcom/android/server/am/ActivityStack$ActivityState;
     .end local v29    # "notUpdated":Z
-    :goto_12
+    :goto_13
     const/4 v3, 0x1
 
     return v3
 
     .restart local v25    # "lastState":Lcom/android/server/am/ActivityStack$ActivityState;
     .restart local v29    # "notUpdated":Z
+    :cond_33
+    const/4 v4, 0x0
+
+    goto/16 :goto_12
+
     :catch_1
     move-exception v20
 
@@ -4178,7 +4240,7 @@
 
     iput-object v0, v1, Lcom/android/server/am/ActivityRecord;->state:Lcom/android/server/am/ActivityStack$ActivityState;
 
-    if-eqz v24, :cond_33
+    if-eqz v24, :cond_34
 
     move-object/from16 v0, v23
 
@@ -4186,7 +4248,7 @@
 
     iput-object v0, v1, Lcom/android/server/am/ActivityStack;->mResumedActivity:Lcom/android/server/am/ActivityRecord;
 
-    :cond_33
+    :cond_34
     const-string v3, "ActivityManager"
 
     new-instance v4, Ljava/lang/StringBuilder;
@@ -4215,7 +4277,7 @@
 
     iget-boolean v3, v0, Lcom/android/server/am/ActivityRecord;->hasBeenLaunched:Z
 
-    if-nez v3, :cond_35
+    if-nez v3, :cond_36
 
     const/4 v3, 0x1
 
@@ -4223,8 +4285,8 @@
 
     iput-boolean v3, v0, Lcom/android/server/am/ActivityRecord;->hasBeenLaunched:Z
 
-    :cond_34
-    :goto_13
+    :cond_35
+    :goto_14
     move-object/from16 v0, p0
 
     iget-object v3, v0, Lcom/android/server/am/ActivityStack;->mStackSupervisor:Lcom/android/server/am/ActivityStackSupervisor;
@@ -4241,8 +4303,8 @@
 
     return v3
 
-    :cond_35
-    if-eqz v24, :cond_34
+    :cond_36
+    if-eqz v24, :cond_35
 
     move-object/from16 v0, p0
 
@@ -4254,7 +4316,7 @@
 
     move-result v3
 
-    if-eqz v3, :cond_34
+    if-eqz v3, :cond_35
 
     move-object/from16 v0, p0
 
@@ -4312,7 +4374,7 @@
 
     invoke-virtual/range {v3 .. v14}, Lcom/android/server/wm/WindowManagerService;->setAppStartingWindow(Landroid/os/IBinder;Ljava/lang/String;ILandroid/content/res/CompatibilityInfo;Ljava/lang/CharSequence;IIIILandroid/os/IBinder;Z)V
 
-    goto :goto_13
+    goto :goto_14
 
     .end local v20    # "e":Ljava/lang/Exception;
     .restart local v16    # "a":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Landroid/app/ResultInfo;>;"
@@ -4370,12 +4432,12 @@
     .end local v20    # "e":Ljava/lang/Exception;
     .end local v25    # "lastState":Lcom/android/server/am/ActivityStack$ActivityState;
     .end local v29    # "notUpdated":Z
-    :cond_36
+    :cond_37
     move-object/from16 v0, v26
 
     iget-boolean v3, v0, Lcom/android/server/am/ActivityRecord;->hasBeenLaunched:Z
 
-    if-nez v3, :cond_37
+    if-nez v3, :cond_38
 
     const/4 v3, 0x1
 
@@ -4383,7 +4445,7 @@
 
     iput-boolean v3, v0, Lcom/android/server/am/ActivityRecord;->hasBeenLaunched:Z
 
-    :goto_14
+    :goto_15
     move-object/from16 v0, p0
 
     iget-object v3, v0, Lcom/android/server/am/ActivityStack;->mStackSupervisor:Lcom/android/server/am/ActivityStackSupervisor;
@@ -4396,9 +4458,9 @@
 
     invoke-virtual {v3, v0, v4, v5}, Lcom/android/server/am/ActivityStackSupervisor;->startSpecificActivityLocked(Lcom/android/server/am/ActivityRecord;ZZ)V
 
-    goto/16 :goto_12
+    goto/16 :goto_13
 
-    :cond_37
+    :cond_38
     move-object/from16 v0, p0
 
     iget-object v3, v0, Lcom/android/server/am/ActivityStack;->mWindowManager:Lcom/android/server/wm/WindowManagerService;
@@ -4455,7 +4517,7 @@
 
     invoke-virtual/range {v3 .. v14}, Lcom/android/server/wm/WindowManagerService;->setAppStartingWindow(Landroid/os/IBinder;Ljava/lang/String;ILandroid/content/res/CompatibilityInfo;Ljava/lang/CharSequence;IIIILandroid/os/IBinder;Z)V
 
-    goto :goto_14
+    goto :goto_15
 
     .end local v17    # "anim":Z
     .end local v24    # "lastStack":Lcom/android/server/am/ActivityStack;
@@ -4619,7 +4681,19 @@
     return-void
 
     :cond_0
-    const/4 v1, 0x0
+    iget-object v4, p0, Lcom/android/server/am/ActivityStack;->mService:Lcom/android/server/am/ActivityManagerService;
+
+    iget-object v4, v4, Lcom/android/server/am/ActivityManagerService;->mAppOpsService:Lcom/android/server/AppOpsService;
+
+    iget-object v5, p1, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
+
+    iget v5, v5, Lcom/android/server/am/ProcessRecord;->uid:I
+
+    iget-object v6, p1, Lcom/android/server/am/ActivityRecord;->packageName:Ljava/lang/String;
+
+    invoke-virtual {v4, v5, v6}, Lcom/android/server/AppOpsService;->getPrivacyGuardSettingForPackage(ILjava/lang/String;)Z
+
+    move-result v1
 
     .local v1, "privacy":Z
     iget-object v4, p0, Lcom/android/server/am/ActivityStack;->mService:Lcom/android/server/am/ActivityManagerService;
@@ -4859,8 +4933,15 @@
 
     new-array v2, v1, [Ljava/lang/Object;
 
-    iget v1, v0, Lcom/android/server/am/ActivityRecord;->userId:I
+    iget-object v1, v0, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
+
+    if-eqz v1, :cond_2
+
+    iget-object v1, v0, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
 
+    iget v1, v1, Lcom/android/server/am/ProcessRecord;->pid:I
+
+    :goto_1
     invoke-static {v1}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
     move-result-object v1
@@ -4883,13 +4964,13 @@
 
     iget-object v1, p0, Lcom/android/server/am/ActivityStack;->mPausingActivity:Lcom/android/server/am/ActivityRecord;
 
-    if-eqz v1, :cond_2
+    if-eqz v1, :cond_3
 
     iget-object v1, p0, Lcom/android/server/am/ActivityStack;->mPausingActivity:Lcom/android/server/am/ActivityRecord;
 
     iget-object v1, v1, Lcom/android/server/am/ActivityRecord;->shortComponentName:Ljava/lang/String;
 
-    :goto_1
+    :goto_2
     const/4 v3, 0x3
 
     aput-object v1, v2, v3
@@ -4917,9 +4998,14 @@
     goto :goto_0
 
     :cond_2
-    const-string v1, "(none)"
+    move v1, v4
 
     goto :goto_1
+
+    :cond_3
+    const-string v1, "(none)"
+
+    goto :goto_2
 .end method
 
 .method final activityStoppedLocked(Lcom/android/server/am/ActivityRecord;Landroid/os/Bundle;Landroid/os/PersistableBundle;Ljava/lang/CharSequence;)V
@@ -5933,8 +6019,15 @@
 
     new-array v5, v5, [Ljava/lang/Object;
 
-    iget v6, p1, Lcom/android/server/am/ActivityRecord;->userId:I
+    iget-object v6, p1, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
+
+    if-eqz v6, :cond_5
+
+    iget-object v6, p1, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
+
+    iget v6, v6, Lcom/android/server/am/ProcessRecord;->pid:I
 
+    :goto_0
     invoke-static {v6}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
     move-result-object v6
@@ -5986,13 +6079,13 @@
 
     iget-object v5, p1, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
 
-    if-eqz v5, :cond_5
+    if-eqz v5, :cond_6
 
     const/4 v1, 0x1
 
     .local v1, "hadApp":Z
-    :goto_0
-    if-eqz v1, :cond_7
+    :goto_1
+    if-eqz v1, :cond_8
 
     if-eqz p2, :cond_1
 
@@ -6077,18 +6170,22 @@
     iget v8, p1, Lcom/android/server/am/ActivityRecord;->configChangeFlags:I
 
     invoke-interface {v5, v6, v7, v8}, Landroid/app/IApplicationThread;->scheduleDestroyActivity(Landroid/os/IBinder;ZI)V
+
+    iget-object v5, p1, Lcom/android/server/am/ActivityRecord;->info:Landroid/content/pm/ActivityInfo;
+
+    invoke-static {v5}, Lcom/android/server/am/ExtraActivityManagerService;->destroyActivity(Landroid/content/pm/ActivityInfo;)V
     :try_end_0
     .catch Ljava/lang/Exception; {:try_start_0 .. :try_end_0} :catch_0
 
     :cond_2
-    :goto_1
+    :goto_2
     iput-boolean v9, p1, Lcom/android/server/am/ActivityRecord;->nowVisible:Z
 
     iget-boolean v5, p1, Lcom/android/server/am/ActivityRecord;->finishing:Z
 
     if-eqz v5, :cond_3
 
-    if-eqz v4, :cond_6
+    if-eqz v4, :cond_7
 
     :cond_3
     sget-object v5, Lcom/android/server/am/ActivityStack$ActivityState;->DESTROYED:Lcom/android/server/am/ActivityStack$ActivityState;
@@ -6098,7 +6195,7 @@
     iput-object v10, p1, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
 
     .end local v4    # "skipDestroy":Z
-    :goto_2
+    :goto_3
     iput v9, p1, Lcom/android/server/am/ActivityRecord;->configChangeFlags:I
 
     iget-object v5, p0, Lcom/android/server/am/ActivityStack;->mLRUActivities:Ljava/util/ArrayList;
@@ -6144,10 +6241,15 @@
 
     .end local v1    # "hadApp":Z
     :cond_5
+    move v6, v9
+
+    goto/16 :goto_0
+
+    :cond_6
     const/4 v1, 0x0
 
     .restart local v1    # "hadApp":Z
-    goto/16 :goto_0
+    goto/16 :goto_1
 
     .restart local v4    # "skipDestroy":Z
     :catch_0
@@ -6182,10 +6284,10 @@
 
     const/4 v4, 0x1
 
-    goto :goto_1
+    goto :goto_2
 
     .end local v0    # "e":Ljava/lang/Exception;
-    :cond_6
+    :cond_7
     sget-object v5, Lcom/android/server/am/ActivityStack$ActivityState;->DESTROYING:Lcom/android/server/am/ActivityStack$ActivityState;
 
     iput-object v5, p1, Lcom/android/server/am/ActivityRecord;->state:Lcom/android/server/am/ActivityStack$ActivityState;
@@ -6205,14 +6307,14 @@
 
     invoke-virtual {v5, v2, v6, v7}, Landroid/os/Handler;->sendMessageDelayed(Landroid/os/Message;J)Z
 
-    goto :goto_2
+    goto :goto_3
 
     .end local v2    # "msg":Landroid/os/Message;
     .end local v4    # "skipDestroy":Z
-    :cond_7
+    :cond_8
     iget-boolean v5, p1, Lcom/android/server/am/ActivityRecord;->finishing:Z
 
-    if-eqz v5, :cond_8
+    if-eqz v5, :cond_9
 
     new-instance v5, Ljava/lang/StringBuilder;
 
@@ -6236,16 +6338,16 @@
 
     const/4 v3, 0x1
 
-    goto :goto_2
+    goto :goto_3
 
-    :cond_8
+    :cond_9
     sget-object v5, Lcom/android/server/am/ActivityStack$ActivityState;->DESTROYED:Lcom/android/server/am/ActivityStack$ActivityState;
 
     iput-object v5, p1, Lcom/android/server/am/ActivityRecord;->state:Lcom/android/server/am/ActivityStack$ActivityState;
 
     iput-object v10, p1, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
 
-    goto/16 :goto_2
+    goto/16 :goto_3
 .end method
 
 .method dumpActivitiesLocked(Ljava/io/FileDescriptor;Ljava/io/PrintWriter;ZZLjava/lang/String;ZLjava/lang/String;)Z
@@ -7709,7 +7811,7 @@
 
     .local v12, "taskNdx":I
     :goto_2
-    if-ltz v12, :cond_a
+    if-ltz v12, :cond_c
 
     move-object/from16 v0, p0
 
@@ -7767,8 +7869,17 @@
 
     iget v14, v7, Lcom/android/server/am/ActivityRecord;->userId:I
 
-    if-ne v14, v13, :cond_1
+    if-eq v14, v13, :cond_5
+
+    iget v14, v7, Lcom/android/server/am/ActivityRecord;->userId:I
+
+    invoke-static {v14, v13}, Lcom/android/server/am/ActivityStackInjector;->isAllowCross(II)Z
+
+    move-result v14
+
+    if-eqz v14, :cond_1
 
+    :cond_5
     iget v14, v7, Lcom/android/server/am/ActivityRecord;->launchMode:I
 
     const/4 v15, 0x3
@@ -7781,13 +7892,13 @@
     iget-object v1, v8, Lcom/android/server/am/TaskRecord;->affinityIntent:Landroid/content/Intent;
 
     .local v1, "affinityIntent":Landroid/content/Intent;
-    if-eqz v10, :cond_6
+    if-eqz v10, :cond_7
 
     invoke-virtual {v10}, Landroid/content/Intent;->isDocument()Z
 
     move-result v14
 
-    if-eqz v14, :cond_6
+    if-eqz v14, :cond_7
 
     const/4 v11, 0x1
 
@@ -7797,18 +7908,18 @@
     move-result-object v9
 
     :goto_3
-    if-nez v6, :cond_5
+    if-nez v6, :cond_6
 
-    if-eqz v11, :cond_8
+    if-eqz v11, :cond_9
 
-    :cond_5
-    if-eqz v10, :cond_9
+    :cond_6
+    if-eqz v10, :cond_a
 
     invoke-virtual {v10}, Landroid/content/Intent;->getComponent()Landroid/content/ComponentName;
 
     move-result-object v14
 
-    if-eqz v14, :cond_9
+    if-eqz v14, :cond_a
 
     invoke-virtual {v10}, Landroid/content/Intent;->getComponent()Landroid/content/ComponentName;
 
@@ -7818,25 +7929,25 @@
 
     move-result v14
 
-    if-nez v14, :cond_9
+    if-nez v14, :cond_a
 
     invoke-static {v3, v9}, Ljava/util/Objects;->equals(Ljava/lang/Object;Ljava/lang/Object;)Z
 
     move-result v14
 
-    if-eqz v14, :cond_9
+    if-eqz v14, :cond_a
 
     return-object v7
 
     .end local v11    # "taskIsDocument":Z
-    :cond_6
-    if-eqz v1, :cond_7
+    :cond_7
+    if-eqz v1, :cond_8
 
     invoke-virtual {v1}, Landroid/content/Intent;->isDocument()Z
 
     move-result v14
 
-    if-eqz v14, :cond_7
+    if-eqz v14, :cond_8
 
     const/4 v11, 0x1
 
@@ -7850,7 +7961,7 @@
 
     .end local v9    # "taskDocumentData":Landroid/net/Uri;
     .end local v11    # "taskIsDocument":Z
-    :cond_7
+    :cond_8
     const/4 v11, 0x0
 
     .restart local v11    # "taskIsDocument":Z
@@ -7860,10 +7971,10 @@
     goto :goto_3
 
     .end local v9    # "taskDocumentData":Landroid/net/Uri;
-    :cond_8
+    :cond_9
     iget-object v14, v8, Lcom/android/server/am/TaskRecord;->rootAffinity:Ljava/lang/String;
 
-    if-eqz v14, :cond_5
+    if-eqz v14, :cond_6
 
     iget-object v14, v8, Lcom/android/server/am/TaskRecord;->rootAffinity:Ljava/lang/String;
 
@@ -7879,14 +7990,14 @@
 
     return-object v7
 
-    :cond_9
-    if-eqz v1, :cond_1
+    :cond_a
+    if-eqz v1, :cond_b
 
     invoke-virtual {v1}, Landroid/content/Intent;->getComponent()Landroid/content/ComponentName;
 
     move-result-object v14
 
-    if-eqz v14, :cond_1
+    if-eqz v14, :cond_b
 
     invoke-virtual {v1}, Landroid/content/Intent;->getComponent()Landroid/content/ComponentName;
 
@@ -7896,12 +8007,25 @@
 
     move-result v14
 
-    if-nez v14, :cond_1
+    if-nez v14, :cond_b
 
     invoke-static {v3, v9}, Ljava/util/Objects;->equals(Ljava/lang/Object;Ljava/lang/Object;)Z
 
     move-result v14
 
+    if-nez v14, :cond_6
+
+    :cond_b
+    move-object/from16 v0, p0
+
+    iget-object v14, v0, Lcom/android/server/am/ActivityStack;->mTaskHistory:Ljava/util/ArrayList;
+
+    move-object/from16 v0, p1
+
+    invoke-static {v0, v8, v14}, Lcom/android/server/am/ActivityStackInjector;->findMatchTask(Lcom/android/server/am/ActivityRecord;Lcom/android/server/am/TaskRecord;Ljava/util/ArrayList;)Z
+
+    move-result v14
+
     if-eqz v14, :cond_1
 
     return-object v7
@@ -7911,7 +8035,7 @@
     .end local v8    # "task":Lcom/android/server/am/TaskRecord;
     .end local v10    # "taskIntent":Landroid/content/Intent;
     .end local v11    # "taskIsDocument":Z
-    :cond_a
+    :cond_c
     const/4 v14, 0x0
 
     return-object v14
@@ -8024,8 +8148,15 @@
 
     new-array v5, v5, [Ljava/lang/Object;
 
-    iget v6, p1, Lcom/android/server/am/ActivityRecord;->userId:I
+    iget-object v6, p1, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
+
+    if-eqz v6, :cond_4
 
+    iget-object v6, p1, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
+
+    iget v6, v6, Lcom/android/server/am/ProcessRecord;->pid:I
+
+    :goto_0
     invoke-static {v6}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
     move-result-object v6
@@ -8127,21 +8258,21 @@
 
     iget-object v5, p0, Lcom/android/server/am/ActivityStack;->mResumedActivity:Lcom/android/server/am/ActivityRecord;
 
-    if-ne v5, p1, :cond_6
+    if-ne v5, p1, :cond_7
 
-    if-gtz v2, :cond_4
+    if-gtz v2, :cond_5
 
     const/4 v1, 0x1
 
     .local v1, "endTask":Z
-    :goto_0
+    :goto_1
     iget-object v6, p0, Lcom/android/server/am/ActivityStack;->mWindowManager:Lcom/android/server/wm/WindowManagerService;
 
-    if-eqz v1, :cond_5
+    if-eqz v1, :cond_6
 
     const/16 v5, 0x9
 
-    :goto_1
+    :goto_2
     const/4 v7, 0x0
 
     invoke-virtual {v6, v5, v7}, Lcom/android/server/wm/WindowManagerService;->prepareAppTransition(IZ)V
@@ -8182,18 +8313,23 @@
     return v5
 
     :cond_4
+    const/4 v6, 0x0
+
+    goto/16 :goto_0
+
+    :cond_5
     const/4 v1, 0x0
 
     .restart local v1    # "endTask":Z
-    goto :goto_0
+    goto :goto_1
 
-    :cond_5
+    :cond_6
     const/4 v5, 0x7
 
-    goto :goto_1
+    goto :goto_2
 
     .end local v1    # "endTask":Z
-    :cond_6
+    :cond_7
     iget-object v5, p1, Lcom/android/server/am/ActivityRecord;->state:Lcom/android/server/am/ActivityStack$ActivityState;
 
     sget-object v6, Lcom/android/server/am/ActivityStack$ActivityState;->PAUSING:Lcom/android/server/am/ActivityStack$ActivityState;
@@ -8206,17 +8342,17 @@
 
     move-result-object v5
 
-    if-nez v5, :cond_7
+    if-nez v5, :cond_8
 
     const/4 v5, 0x1
 
-    :goto_2
+    :goto_3
     return v5
 
-    :cond_7
+    :cond_8
     const/4 v5, 0x0
 
-    goto :goto_2
+    goto :goto_3
 .end method
 
 .method final finishActivityResultsLocked(Lcom/android/server/am/ActivityRecord;ILandroid/content/Intent;)V
@@ -10766,6 +10902,10 @@
 
     .end local v0    # "i":I
     :cond_3
+    iget-object v4, p0, Lcom/android/server/am/ActivityStack;->mTaskHistory:Ljava/util/ArrayList;
+
+    invoke-static {p0, v4, p1}, Lcom/android/server/am/ActivityStackInjector;->transferOnTopOfHomeForMoveTaskToFrontLocked(Lcom/android/server/am/ActivityStack;Ljava/util/ArrayList;Lcom/android/server/am/TaskRecord;)V
+
     invoke-direct {p0, p1, v5}, Lcom/android/server/am/ActivityStack;->insertTaskAtTop(Lcom/android/server/am/TaskRecord;Lcom/android/server/am/ActivityRecord;)V
 
     invoke-virtual {p0, v5}, Lcom/android/server/am/ActivityStack;->topRunningActivityLocked(Lcom/android/server/am/ActivityRecord;)Lcom/android/server/am/ActivityRecord;
@@ -11975,7 +12115,7 @@
 
     .local v6, "taskNdx":I
     :goto_0
-    if-ltz v6, :cond_9
+    if-ltz v6, :cond_a
 
     iget-object v7, p0, Lcom/android/server/am/ActivityStack;->mTaskHistory:Ljava/util/ArrayList;
 
@@ -11996,7 +12136,7 @@
 
     .local v1, "activityNdx":I
     :goto_1
-    if-ltz v1, :cond_8
+    if-ltz v1, :cond_9
 
     invoke-virtual {v0, v1}, Ljava/util/ArrayList;->get(I)Ljava/lang/Object;
 
@@ -12036,7 +12176,7 @@
 
     .local v5, "remove":Z
     :goto_2
-    if-eqz v5, :cond_7
+    if-eqz v5, :cond_8
 
     iget-boolean v7, v4, Lcom/android/server/am/ActivityRecord;->finishing:Z
 
@@ -12076,6 +12216,15 @@
 
     iget v8, v4, Lcom/android/server/am/ActivityRecord;->userId:I
 
+    iget-object v8, v4, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
+
+    if-eqz v8, :cond_7
+
+    iget-object v8, v4, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
+
+    iget v8, v8, Lcom/android/server/am/ProcessRecord;->pid:I
+
+    :goto_3
     invoke-static {v8}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
     move-result-object v8
@@ -12137,7 +12286,7 @@
     invoke-virtual {v7, v4, v8}, Lcom/android/server/am/ActivityManagerService;->updateUsageStats(Lcom/android/server/am/ActivityRecord;Z)V
 
     :cond_3
-    :goto_3
+    :goto_4
     const/4 v7, 0x1
 
     const/4 v8, 0x1
@@ -12190,6 +12339,11 @@
     goto/16 :goto_2
 
     :cond_7
+    const/4 v8, 0x0
+
+    goto :goto_3
+
+    :cond_8
     const/4 v7, 0x0
 
     iput-object v7, v4, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
@@ -12206,18 +12360,18 @@
 
     iput-object v7, v4, Lcom/android/server/am/ActivityRecord;->icicle:Landroid/os/Bundle;
 
-    goto :goto_3
+    goto :goto_4
 
     .end local v4    # "r":Lcom/android/server/am/ActivityRecord;
     .end local v5    # "remove":Z
-    :cond_8
+    :cond_9
     add-int/lit8 v6, v6, -0x1
 
     goto/16 :goto_0
 
     .end local v0    # "activities":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityRecord;>;"
     .end local v1    # "activityNdx":I
-    :cond_9
+    :cond_a
     return v2
 .end method
 
@@ -13893,7 +14047,7 @@
 .end method
 
 .method final startActivityLocked(Lcom/android/server/am/ActivityRecord;ZZZLandroid/os/Bundle;)V
-    .locals 24
+    .locals 26
     .param p1, "r"    # Lcom/android/server/am/ActivityRecord;
     .param p2, "newTask"    # Z
     .param p3, "doResume"    # Z
@@ -14189,7 +14343,7 @@
 
     move-result v3
 
-    if-lez v3, :cond_1b
+    if-lez v3, :cond_1f
 
     :cond_9
     move/from16 v19, p2
@@ -14237,7 +14391,21 @@
 
     iget-object v3, v0, Lcom/android/server/am/ProcessRecord;->thread:Landroid/app/IApplicationThread;
 
-    if-nez v3, :cond_c
+    if-eqz v3, :cond_b
+
+    move-object/from16 v0, p0
+
+    iget-object v3, v0, Lcom/android/server/am/ActivityStack;->mService:Lcom/android/server/am/ActivityManagerService;
+
+    iget-object v3, v3, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+
+    move-object/from16 v0, p1
+
+    invoke-static {v0, v3}, Lcom/android/server/am/ActivityStackInjector;->isStartingWindowSupported(Lcom/android/server/am/ActivityRecord;Landroid/content/Context;)Z
+
+    move-result v3
+
+    if-eqz v3, :cond_c
 
     :cond_b
     const/16 v19, 0x1
@@ -14543,13 +14711,44 @@
 
     iget-object v4, v0, Lcom/android/server/am/ActivityRecord;->task:Lcom/android/server/am/TaskRecord;
 
-    if-eq v3, v4, :cond_19
+    if-eq v3, v4, :cond_1a
 
     const/16 v16, 0x0
 
     .end local v16    # "prev":Lcom/android/server/am/ActivityRecord;
     :cond_18
     :goto_a
+    const/16 v25, 0x0
+
+    .local v25, "labelRes":I
+    move-object/from16 v0, p0
+
+    iget-object v3, v0, Lcom/android/server/am/ActivityStack;->mService:Lcom/android/server/am/ActivityManagerService;
+
+    iget-object v3, v3, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+
+    move-object/from16 v0, p1
+
+    invoke-static {v0, v3}, Lcom/android/server/am/ActivityStackInjector;->getStartingWindowLabel(Lcom/android/server/am/ActivityRecord;Landroid/content/Context;)Ljava/lang/CharSequence;
+
+    move-result-object v24
+
+    .local v24, "label":Ljava/lang/CharSequence;
+    if-nez v24, :cond_19
+
+    move-object/from16 v0, p0
+
+    iget-object v3, v0, Lcom/android/server/am/ActivityStack;->mService:Lcom/android/server/am/ActivityManagerService;
+
+    iget-object v3, v3, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
+
+    move-object/from16 v0, p1
+
+    invoke-static {v0, v3}, Lcom/android/server/am/ActivityStackInjector;->getStartingWindowLabelRes(Lcom/android/server/am/ActivityRecord;Landroid/content/Context;)I
+
+    move-result v25
+
+    :cond_19
     move-object/from16 v0, p0
 
     iget-object v3, v0, Lcom/android/server/am/ActivityStack;->mWindowManager:Lcom/android/server/wm/WindowManagerService;
@@ -14580,14 +14779,22 @@
 
     move-result-object v7
 
+    if-nez v24, :cond_1b
+
     move-object/from16 v0, p1
 
     iget-object v8, v0, Lcom/android/server/am/ActivityRecord;->nonLocalizedLabel:Ljava/lang/CharSequence;
 
+    :goto_b
+    if-nez v24, :cond_1d
+
+    if-nez v25, :cond_1c
+
     move-object/from16 v0, p1
 
     iget v9, v0, Lcom/android/server/am/ActivityRecord;->labelRes:I
 
+    :goto_c
     move-object/from16 v0, p1
 
     iget v10, v0, Lcom/android/server/am/ActivityRecord;->icon:I
@@ -14600,13 +14807,13 @@
 
     iget v12, v0, Lcom/android/server/am/ActivityRecord;->windowFlags:I
 
-    if-eqz v16, :cond_1a
+    if-eqz v16, :cond_1e
 
     move-object/from16 v0, v16
 
     iget-object v13, v0, Lcom/android/server/am/ActivityRecord;->appToken:Landroid/view/IApplicationToken$Stub;
 
-    :goto_b
+    :goto_d
     move/from16 v14, v19
 
     invoke-virtual/range {v3 .. v14}, Lcom/android/server/wm/WindowManagerService;->setAppStartingWindow(Landroid/os/IBinder;Ljava/lang/String;ILandroid/content/res/CompatibilityInfo;Ljava/lang/CharSequence;IIIILandroid/os/IBinder;Z)V
@@ -14620,7 +14827,7 @@
     goto/16 :goto_8
 
     .restart local v16    # "prev":Lcom/android/server/am/ActivityRecord;
-    :cond_19
+    :cond_1a
     move-object/from16 v0, v16
 
     iget-boolean v3, v0, Lcom/android/server/am/ActivityRecord;->nowVisible:Z
@@ -14633,14 +14840,29 @@
     goto :goto_a
 
     .end local v16    # "prev":Lcom/android/server/am/ActivityRecord;
-    :cond_1a
-    const/4 v13, 0x0
+    :cond_1b
+    move-object/from16 v8, v24
 
     goto :goto_b
 
+    :cond_1c
+    move/from16 v9, v25
+
+    goto :goto_c
+
+    :cond_1d
+    const/4 v9, 0x0
+
+    goto :goto_c
+
+    :cond_1e
+    const/4 v13, 0x0
+
+    goto :goto_d
+
     .end local v15    # "doShow":Z
     .end local v17    # "proc":Lcom/android/server/am/ProcessRecord;
-    :cond_1b
+    :cond_1f
     move-object/from16 v0, p0
 
     iget-object v3, v0, Lcom/android/server/am/ActivityStack;->mWindowManager:Lcom/android/server/wm/WindowManagerService;
@@ -14687,11 +14909,11 @@
 
     and-int/lit16 v10, v10, 0x400
 
-    if-eqz v10, :cond_1c
+    if-eqz v10, :cond_20
 
     const/4 v10, 0x1
 
-    :goto_c
+    :goto_e
     move-object/from16 v0, p1
 
     iget v11, v0, Lcom/android/server/am/ActivityRecord;->userId:I
@@ -14706,11 +14928,11 @@
 
     iget-object v13, v0, Lcom/android/server/am/TaskRecord;->voiceSession:Landroid/service/voice/IVoiceInteractionSession;
 
-    if-eqz v13, :cond_1d
+    if-eqz v13, :cond_21
 
     const/4 v13, 0x1
 
-    :goto_d
+    :goto_f
     move-object/from16 v0, p1
 
     iget-boolean v14, v0, Lcom/android/server/am/ActivityRecord;->mLaunchTaskBehind:Z
@@ -14725,15 +14947,15 @@
     goto/16 :goto_8
 
     .local p5, "options":Landroid/os/Bundle;
-    :cond_1c
+    :cond_20
     const/4 v10, 0x0
 
-    goto :goto_c
+    goto :goto_e
 
-    :cond_1d
+    :cond_21
     const/4 v13, 0x0
 
-    goto :goto_d
+    goto :goto_f
 .end method
 
 .method final startPausingLocked(ZZZZ)Z
@@ -14908,9 +15130,10 @@
 
     iget-object v2, v1, Lcom/android/server/am/ActivityRecord;->task:Lcom/android/server/am/TaskRecord;
 
-    if-eq v0, v2, :cond_a
+    if-eq v0, v2, :cond_b
 
     :cond_5
+    :goto_1
     iget-object v0, p0, Lcom/android/server/am/ActivityStack;->mService:Lcom/android/server/am/ActivityManagerService;
 
     iget-object v0, v0, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
@@ -14919,7 +15142,6 @@
 
     invoke-static {v0, v2, v1}, Lcom/android/server/am/ActivityStackInjector;->captureActivityScreenshot(Landroid/content/Context;Lcom/android/server/wm/WindowManagerService;Lcom/android/server/am/ActivityRecord;)V
 
-    :goto_1
     invoke-virtual {p0, v1}, Lcom/android/server/am/ActivityStack;->screenshotActivities(Lcom/android/server/am/ActivityRecord;)Landroid/graphics/Bitmap;
 
     move-result-object v0
@@ -14937,13 +15159,13 @@
 
     iget-object v0, v1, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
 
-    if-eqz v0, :cond_b
+    if-eqz v0, :cond_c
 
     iget-object v0, v1, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
 
     iget-object v0, v0, Lcom/android/server/am/ProcessRecord;->thread:Landroid/app/IApplicationThread;
 
-    if-eqz v0, :cond_b
+    if-eqz v0, :cond_c
 
     const/4 v0, 0x3
 
@@ -14952,6 +15174,15 @@
 
     iget v2, v1, Lcom/android/server/am/ActivityRecord;->userId:I
 
+    iget-object v2, v1, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
+
+    if-eqz v2, :cond_a
+
+    iget-object v2, v1, Lcom/android/server/am/ActivityRecord;->app:Lcom/android/server/am/ProcessRecord;
+
+    iget v2, v2, Lcom/android/server/am/ProcessRecord;->pid:I
+
+    :goto_2
     invoke-static {v2}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
 
     move-result-object v2
@@ -15006,7 +15237,7 @@
     :try_end_0
     .catch Ljava/lang/Exception; {:try_start_0 .. :try_end_0} :catch_0
 
-    :goto_2
+    :goto_3
     if-nez p2, :cond_7
 
     iget-object v0, p0, Lcom/android/server/am/ActivityStack;->mService:Lcom/android/server/am/ActivityManagerService;
@@ -15015,20 +15246,20 @@
 
     move-result v0
 
-    if-eqz v0, :cond_c
+    if-eqz v0, :cond_d
 
     :cond_7
-    :goto_3
+    :goto_4
     iget-object v0, p0, Lcom/android/server/am/ActivityStack;->mPausingActivity:Lcom/android/server/am/ActivityRecord;
 
-    if-eqz v0, :cond_e
+    if-eqz v0, :cond_f
 
     if-nez p2, :cond_8
 
     invoke-virtual {v1}, Lcom/android/server/am/ActivityRecord;->pauseKeyDispatchingLocked()V
 
     :cond_8
-    if-eqz p4, :cond_d
+    if-eqz p4, :cond_e
 
     const/4 v0, 0x0
 
@@ -15046,9 +15277,17 @@
 
     .restart local v10    # "next":Lcom/android/server/am/ActivityRecord;
     :cond_a
+    :try_start_1
+    iget v2, v1, Lcom/android/server/am/ActivityRecord;->userId:I
+    :try_end_1
+    .catch Ljava/lang/Exception; {:try_start_1 .. :try_end_1} :catch_0
+
+    goto :goto_2
+
+    :cond_b
     if-eqz p2, :cond_6
 
-    goto :goto_1
+    goto/16 :goto_1
 
     :catch_0
     move-exception v8
@@ -15072,10 +15311,10 @@
 
     iput-object v0, p0, Lcom/android/server/am/ActivityStack;->mLastNoHistoryActivity:Lcom/android/server/am/ActivityRecord;
 
-    goto :goto_2
+    goto :goto_3
 
     .end local v8    # "e":Ljava/lang/Exception;
-    :cond_b
+    :cond_c
     const/4 v0, 0x0
 
     iput-object v0, p0, Lcom/android/server/am/ActivityStack;->mPausingActivity:Lcom/android/server/am/ActivityRecord;
@@ -15088,16 +15327,16 @@
 
     iput-object v0, p0, Lcom/android/server/am/ActivityStack;->mLastNoHistoryActivity:Lcom/android/server/am/ActivityRecord;
 
-    goto :goto_2
+    goto :goto_3
 
-    :cond_c
+    :cond_d
     iget-object v0, p0, Lcom/android/server/am/ActivityStack;->mStackSupervisor:Lcom/android/server/am/ActivityStackSupervisor;
 
     invoke-virtual {v0}, Lcom/android/server/am/ActivityStackSupervisor;->acquireLaunchWakelock()V
 
-    goto :goto_3
+    goto :goto_4
 
-    :cond_d
+    :cond_e
     iget-object v0, p0, Lcom/android/server/am/ActivityStack;->mHandler:Landroid/os/Handler;
 
     const/16 v2, 0x65
@@ -15126,8 +15365,8 @@
     return v0
 
     .end local v9    # "msg":Landroid/os/Message;
-    :cond_e
-    if-nez p3, :cond_f
+    :cond_f
+    if-nez p3, :cond_10
 
     iget-object v0, p0, Lcom/android/server/am/ActivityStack;->mStackSupervisor:Lcom/android/server/am/ActivityStackSupervisor;
 
@@ -15139,7 +15378,7 @@
 
     invoke-virtual {v0, v2}, Lcom/android/server/am/ActivityStack;->resumeTopActivityLocked(Lcom/android/server/am/ActivityRecord;)Z
 
-    :cond_f
+    :cond_10
     const/4 v0, 0x0
 
     return v0
--- a/services/smali/com/android/server/am/ActivityStackSupervisor.smali
+++ b/services/smali/com/android/server/am/ActivityStackSupervisor.smali
@@ -559,6 +559,10 @@
 
     iput-object v0, p0, Lcom/android/server/am/ActivityStackSupervisor;->mPendingActivityLaunches:Ljava/util/ArrayList;
 
+    const-wide/16 v0, -0x1
+
+    iput-wide v0, p0, Lcom/android/server/am/ActivityStackSupervisor;->mLastActivityCallTime:J
+
     iput-object p1, p0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
     iput-object p2, p0, Lcom/android/server/am/ActivityStackSupervisor;->mRecentTasks:Lcom/android/server/am/RecentTasks;
@@ -2229,7 +2233,7 @@
     move-result-object v5
 
     .local v5, "r":Lcom/android/server/am/ActivityRecord;
-    if-eqz v5, :cond_3
+    if-eqz v5, :cond_4
 
     move-object/from16 v0, p0
 
@@ -2284,15 +2288,19 @@
 
     move-result v12
 
-    .end local v12    # "booting":Z
     :cond_3
+    iget-object v3, v5, Lcom/android/server/am/ActivityRecord;->info:Landroid/content/pm/ActivityInfo;
+
+    invoke-static {v3}, Lcom/android/server/am/ExtraActivityManagerService;->activityIdle(Landroid/content/pm/ActivityInfo;)V
+
+    :cond_4
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/am/ActivityStackSupervisor;->allResumedActivitiesIdle()Z
 
     move-result v3
 
-    if-eqz v3, :cond_6
+    if-eqz v3, :cond_7
 
-    if-eqz v5, :cond_4
+    if-eqz v5, :cond_5
 
     move-object/from16 v0, p0
 
@@ -2300,7 +2308,7 @@
 
     invoke-virtual {v3}, Lcom/android/server/am/ActivityManagerService;->scheduleAppGcsLocked()V
 
-    :cond_4
+    :cond_5
     move-object/from16 v0, p0
 
     iget-object v3, v0, Lcom/android/server/am/ActivityStackSupervisor;->mLaunchingActivity:Landroid/os/PowerManager$WakeLock;
@@ -2309,7 +2317,7 @@
 
     move-result v3
 
-    if-eqz v3, :cond_5
+    if-eqz v3, :cond_6
 
     move-object/from16 v0, p0
 
@@ -2325,7 +2333,7 @@
 
     invoke-virtual {v3}, Landroid/os/PowerManager$WakeLock;->release()V
 
-    :cond_5
+    :cond_6
     const/4 v3, 0x0
 
     const/4 v4, 0x0
@@ -2334,7 +2342,7 @@
 
     invoke-virtual {v0, v3, v4}, Lcom/android/server/am/ActivityStackSupervisor;->ensureActivitiesVisibleLocked(Lcom/android/server/am/ActivityRecord;I)V
 
-    :cond_6
+    :cond_7
     const/4 v3, 0x1
 
     move-object/from16 v0, p0
@@ -2344,7 +2352,7 @@
     move-result-object v17
 
     .local v17, "stops":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityRecord;>;"
-    if-eqz v17, :cond_a
+    if-eqz v17, :cond_b
 
     invoke-virtual/range {v17 .. v17}, Ljava/util/ArrayList;->size()I
 
@@ -2359,7 +2367,7 @@
 
     move-result v2
 
-    if-lez v2, :cond_7
+    if-lez v2, :cond_8
 
     new-instance v13, Ljava/util/ArrayList;
 
@@ -2378,7 +2386,7 @@
     invoke-virtual {v3}, Ljava/util/ArrayList;->clear()V
 
     .end local v13    # "finishes":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityRecord;>;"
-    :cond_7
+    :cond_8
     move-object/from16 v0, p0
 
     iget-object v3, v0, Lcom/android/server/am/ActivityStackSupervisor;->mStartingUsers:Ljava/util/ArrayList;
@@ -2387,7 +2395,7 @@
 
     move-result v3
 
-    if-lez v3, :cond_8
+    if-lez v3, :cond_9
 
     new-instance v16, Ljava/util/ArrayList;
 
@@ -2408,12 +2416,12 @@
     invoke-virtual {v3}, Ljava/util/ArrayList;->clear()V
 
     .end local v16    # "startingUsers":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/UserState;>;"
-    :cond_8
+    :cond_9
     const/4 v14, 0x0
 
     .local v14, "i":I
     :goto_1
-    if-ge v14, v10, :cond_c
+    if-ge v14, v10, :cond_d
 
     move-object/from16 v0, v17
 
@@ -2430,11 +2438,11 @@
     iget-object v15, v3, Lcom/android/server/am/TaskRecord;->stack:Lcom/android/server/am/ActivityStack;
 
     .local v15, "stack":Lcom/android/server/am/ActivityStack;
-    if-eqz v15, :cond_9
+    if-eqz v15, :cond_a
 
     iget-boolean v3, v5, Lcom/android/server/am/ActivityRecord;->finishing:Z
 
-    if-eqz v3, :cond_b
+    if-eqz v3, :cond_c
 
     const/4 v3, 0x0
 
@@ -2442,7 +2450,7 @@
 
     invoke-virtual {v15, v5, v3, v4}, Lcom/android/server/am/ActivityStack;->finishCurrentActivityLocked(Lcom/android/server/am/ActivityRecord;IZ)Lcom/android/server/am/ActivityRecord;
 
-    :cond_9
+    :cond_a
     :goto_2
     add-int/lit8 v14, v14, 0x1
 
@@ -2452,7 +2460,7 @@
     .end local v15    # "stack":Lcom/android/server/am/ActivityStack;
     .local v13, "finishes":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/ActivityRecord;>;"
     .local v16, "startingUsers":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/UserState;>;"
-    :cond_a
+    :cond_b
     const/4 v10, 0x0
 
     goto :goto_0
@@ -2461,18 +2469,18 @@
     .end local v16    # "startingUsers":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/UserState;>;"
     .restart local v14    # "i":I
     .restart local v15    # "stack":Lcom/android/server/am/ActivityStack;
-    :cond_b
+    :cond_c
     invoke-virtual {v15, v5}, Lcom/android/server/am/ActivityStack;->stopActivityLocked(Lcom/android/server/am/ActivityRecord;)V
 
     goto :goto_2
 
     .end local v15    # "stack":Lcom/android/server/am/ActivityStack;
-    :cond_c
+    :cond_d
     const/4 v14, 0x0
 
     .end local v11    # "activityRemoved":Z
     :goto_3
-    if-ge v14, v2, :cond_e
+    if-ge v14, v2, :cond_f
 
     invoke-virtual {v13, v14}, Ljava/util/ArrayList;->get(I)Ljava/lang/Object;
 
@@ -2487,7 +2495,7 @@
     iget-object v15, v3, Lcom/android/server/am/TaskRecord;->stack:Lcom/android/server/am/ActivityStack;
 
     .restart local v15    # "stack":Lcom/android/server/am/ActivityStack;
-    if-eqz v15, :cond_d
+    if-eqz v15, :cond_e
 
     const-string v3, "finish-idle"
 
@@ -2499,16 +2507,16 @@
 
     or-int/2addr v11, v3
 
-    :cond_d
+    :cond_e
     add-int/lit8 v14, v14, 0x1
 
     goto :goto_3
 
     .end local v15    # "stack":Lcom/android/server/am/ActivityStack;
-    :cond_e
-    if-nez v12, :cond_10
+    :cond_f
+    if-nez v12, :cond_11
 
-    if-eqz v16, :cond_f
+    if-eqz v16, :cond_10
 
     const/4 v14, 0x0
 
@@ -2517,7 +2525,7 @@
 
     move-result v3
 
-    if-ge v14, v3, :cond_f
+    if-ge v14, v3, :cond_10
 
     move-object/from16 v0, p0
 
@@ -2537,7 +2545,7 @@
 
     goto :goto_4
 
-    :cond_f
+    :cond_10
     move-object/from16 v0, p0
 
     iget-object v3, v0, Lcom/android/server/am/ActivityStackSupervisor;->mStartingBackgroundUsers:Ljava/util/ArrayList;
@@ -2546,7 +2554,7 @@
 
     move-result v3
 
-    if-lez v3, :cond_10
+    if-lez v3, :cond_11
 
     new-instance v16, Ljava/util/ArrayList;
 
@@ -2572,7 +2580,7 @@
 
     move-result v3
 
-    if-ge v14, v3, :cond_10
+    if-ge v14, v3, :cond_11
 
     move-object/from16 v0, p0
 
@@ -2593,18 +2601,18 @@
     goto :goto_5
 
     .end local v16    # "startingUsers":Ljava/util/ArrayList;, "Ljava/util/ArrayList<Lcom/android/server/am/UserState;>;"
-    :cond_10
+    :cond_11
     move-object/from16 v0, p0
 
     iget-object v3, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
     invoke-virtual {v3}, Lcom/android/server/am/ActivityManagerService;->trimApplications()V
 
-    if-eqz v11, :cond_11
+    if-eqz v11, :cond_12
 
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/am/ActivityStackSupervisor;->resumeTopActivitiesLocked()Z
 
-    :cond_11
+    :cond_12
     return-object v5
 .end method
 
@@ -7696,7 +7704,7 @@
 
     iget-boolean v4, v0, Lcom/android/server/am/ActivityRecord;->launchFailed:Z
 
-    if-eqz v4, :cond_13
+    if-eqz v4, :cond_14
 
     const-string v4, "ActivityManager"
 
@@ -8949,6 +8957,10 @@
 
     const/4 v2, 0x0
 
+    iget-object v1, p1, Lcom/android/server/am/ActivityRecord;->packageName:Ljava/lang/String;
+
+    invoke-static {v1}, Lcom/android/server/am/ActivityStackSupervisorInjector;->updateScreenPaperMode(Ljava/lang/String;)V
+
     iget-object v1, p1, Lcom/android/server/am/ActivityRecord;->task:Lcom/android/server/am/TaskRecord;
 
     iget-object v0, v1, Lcom/android/server/am/TaskRecord;->stack:Lcom/android/server/am/ActivityStack;
@@ -10930,7 +10942,7 @@
 .end method
 
 .method final startActivityLocked(Landroid/app/IApplicationThread;Landroid/content/Intent;Ljava/lang/String;Landroid/content/pm/ActivityInfo;Landroid/service/voice/IVoiceInteractionSession;Lcom/android/internal/app/IVoiceInteractor;Landroid/os/IBinder;Ljava/lang/String;IIILjava/lang/String;IIILandroid/os/Bundle;ZZ[Lcom/android/server/am/ActivityRecord;Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;Lcom/android/server/am/TaskRecord;)I
-    .locals 41
+    .locals 43
     .param p1, "caller"    # Landroid/app/IApplicationThread;
     .param p2, "intent"    # Landroid/content/Intent;
     .param p3, "resolvedType"    # Ljava/lang/String;
@@ -12009,7 +12021,7 @@
 
     move/from16 v0, v25
 
-    if-ne v0, v5, :cond_20
+    if-ne v0, v5, :cond_21
 
     new-instance v5, Ljava/lang/StringBuilder;
 
@@ -12137,7 +12149,7 @@
 
     move-result v5
 
-    if-eqz v5, :cond_21
+    if-eqz v5, :cond_22
 
     const/4 v5, 0x0
 
@@ -12149,9 +12161,32 @@
 
     iget-object v5, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
+    iget-object v5, v5, Lcom/android/server/am/ActivityManagerService;->mAppOpsService:Lcom/android/server/AppOpsService;
+
+    move-object/from16 v0, p0
+
+    move-object/from16 v1, p2
+
+    move-object/from16 v2, p12
+
+    move/from16 v3, p11
+
+    invoke-static {v5, v0, v1, v2, v3}, Lcom/android/server/am/ExtraActivityManagerService;->isAllowedStartActivity(Lcom/android/server/AppOpsService;Lcom/android/server/am/ActivityStackSupervisor;Landroid/content/Intent;Ljava/lang/String;I)Z
+
+    move-result v5
+
+    if-nez v5, :cond_1e
+
+    const/16 v24, 0x1
+
+    :cond_1e
+    move-object/from16 v0, p0
+
+    iget-object v5, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
+
     iget-object v5, v5, Lcom/android/server/am/ActivityManagerService;->mController:Landroid/app/IActivityController;
 
-    if-eqz v5, :cond_1e
+    if-eqz v5, :cond_1f
 
     :try_start_2
     invoke-virtual/range {p2 .. p2}, Landroid/content/Intent;->cloneFilter()Landroid/content/Intent;
@@ -12179,7 +12214,7 @@
 
     move-result v5
 
-    if-eqz v5, :cond_22
+    if-eqz v5, :cond_23
 
     const/4 v5, 0x0
 
@@ -12187,11 +12222,11 @@
     or-int v24, v24, v5
 
     .end local v40    # "watchIntent":Landroid/content/Intent;
-    :cond_1e
+    :cond_1f
     :goto_e
-    if-eqz v24, :cond_23
+    if-eqz v24, :cond_24
 
-    if-eqz v6, :cond_1f
+    if-eqz v6, :cond_20
 
     const/4 v5, -0x1
 
@@ -12205,7 +12240,7 @@
 
     invoke-virtual/range {v4 .. v10}, Lcom/android/server/am/ActivityStack;->sendActivityResultLocked(ILcom/android/server/am/ActivityRecord;Ljava/lang/String;IILandroid/content/Intent;)V
 
-    :cond_1f
+    :cond_20
     invoke-static/range {p16 .. p16}, Landroid/app/ActivityOptions;->abort(Landroid/os/Bundle;)V
 
     const/4 v5, 0x0
@@ -12215,7 +12250,7 @@
     .local v24, "abort":Z
     .restart local v25    # "actionRestriction":I
     .restart local v27    # "componentRestriction":I
-    :cond_20
+    :cond_21
     const/4 v5, 0x2
 
     move/from16 v0, v27
@@ -12318,14 +12353,14 @@
     .end local v25    # "actionRestriction":I
     .end local v27    # "componentRestriction":I
     .end local v32    # "message":Ljava/lang/String;
-    :cond_21
+    :cond_22
     const/4 v5, 0x1
 
     goto/16 :goto_c
 
     .local v24, "abort":Z
     .restart local v40    # "watchIntent":Landroid/content/Intent;
-    :cond_22
+    :cond_23
     const/4 v5, 0x1
 
     goto/16 :goto_d
@@ -12346,7 +12381,7 @@
     goto/16 :goto_e
 
     .end local v29    # "e":Landroid/os/RemoteException;
-    :cond_23
+    :cond_24
     new-instance v7, Lcom/android/server/am/ActivityRecord;
 
     move-object/from16 v0, p0
@@ -12359,7 +12394,7 @@
 
     iget-object v15, v5, Lcom/android/server/am/ActivityManagerService;->mConfiguration:Landroid/content/res/Configuration;
 
-    if-eqz p5, :cond_27
+    if-eqz p5, :cond_29
 
     const/16 v20, 0x1
 
@@ -12393,18 +12428,18 @@
     invoke-direct/range {v7 .. v23}, Lcom/android/server/am/ActivityRecord;-><init>(Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/ProcessRecord;ILjava/lang/String;Landroid/content/Intent;Ljava/lang/String;Landroid/content/pm/ActivityInfo;Landroid/content/res/Configuration;Lcom/android/server/am/ActivityRecord;Ljava/lang/String;IZZLcom/android/server/am/ActivityStackSupervisor;Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;Landroid/os/Bundle;)V
 
     .local v7, "r":Lcom/android/server/am/ActivityRecord;
-    if-eqz p19, :cond_24
+    if-eqz p19, :cond_25
 
     const/4 v5, 0x0
 
     aput-object v7, p19, v5
 
-    :cond_24
+    :cond_25
     iget-object v5, v7, Lcom/android/server/am/ActivityRecord;->appTimeTracker:Lcom/android/server/am/AppTimeTracker;
 
-    if-nez v5, :cond_25
+    if-nez v5, :cond_26
 
-    if-eqz v35, :cond_25
+    if-eqz v35, :cond_26
 
     move-object/from16 v0, v35
 
@@ -12412,7 +12447,7 @@
 
     iput-object v5, v7, Lcom/android/server/am/ActivityRecord;->appTimeTracker:Lcom/android/server/am/AppTimeTracker;
 
-    :cond_25
+    :cond_26
     move-object/from16 v0, p0
 
     iget-object v0, v0, Lcom/android/server/am/ActivityStackSupervisor;->mFocusedStack:Lcom/android/server/am/ActivityStack;
@@ -12420,13 +12455,72 @@
     move-object/from16 v36, v0
 
     .local v36, "stack":Lcom/android/server/am/ActivityStack;
-    if-nez p5, :cond_28
+    move-object/from16 v0, p0
+
+    iget-object v5, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
+
+    iget-object v5, v5, Lcom/android/server/am/ActivityManagerService;->mUserProfileGroupIdsSelfLocked:Landroid/util/SparseIntArray;
+
+    const/4 v8, -0x1
+
+    move/from16 v0, v39
+
+    invoke-virtual {v5, v0, v8}, Landroid/util/SparseIntArray;->get(II)I
+
+    move-result v41
+
+    .local v41, "activityProfileGroup":I
+    move-object/from16 v0, p0
+
+    iget-object v5, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
+
+    iget-object v5, v5, Lcom/android/server/am/ActivityManagerService;->mUserProfileGroupIdsSelfLocked:Landroid/util/SparseIntArray;
+
+    move-object/from16 v0, v36
+
+    iget v8, v0, Lcom/android/server/am/ActivityStack;->mCurrentUser:I
+
+    const/4 v9, -0x1
+
+    invoke-virtual {v5, v8, v9}, Landroid/util/SparseIntArray;->get(II)I
+
+    move-result v42
+
+    .local v42, "stackProfileGroup":I
+    move-object/from16 v0, v36
+
+    iget v5, v0, Lcom/android/server/am/ActivityStack;->mCurrentUser:I
+
+    move/from16 v0, v39
+
+    if-eq v0, v5, :cond_27
+
+    const/4 v5, -0x1
+
+    move/from16 v0, v39
+
+    if-eq v0, v5, :cond_27
+
+    const/4 v5, -0x1
+
+    move/from16 v0, v42
+
+    if-eq v0, v5, :cond_2a
+
+    move/from16 v0, v41
+
+    move/from16 v1, v42
+
+    if-ne v0, v1, :cond_2a
+
+    :cond_27
+    if-nez p5, :cond_2b
 
     move-object/from16 v0, v36
 
     iget-object v5, v0, Lcom/android/server/am/ActivityStack;->mResumedActivity:Lcom/android/server/am/ActivityRecord;
 
-    if-eqz v5, :cond_26
+    if-eqz v5, :cond_28
 
     move-object/from16 v0, v36
 
@@ -12440,9 +12534,9 @@
 
     move/from16 v0, p11
 
-    if-eq v5, v0, :cond_28
+    if-eq v5, v0, :cond_2b
 
-    :cond_26
+    :cond_28
     move-object/from16 v0, p0
 
     iget-object v8, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
@@ -12461,7 +12555,7 @@
 
     move-result v5
 
-    if-nez v5, :cond_28
+    if-nez v5, :cond_2b
 
     new-instance v34, Lcom/android/server/am/ActivityStackSupervisor$PendingActivityLaunch;
 
@@ -12493,21 +12587,26 @@
     .end local v7    # "r":Lcom/android/server/am/ActivityRecord;
     .end local v34    # "pal":Lcom/android/server/am/ActivityStackSupervisor$PendingActivityLaunch;
     .end local v36    # "stack":Lcom/android/server/am/ActivityStack;
-    :cond_27
+    :cond_29
     const/16 v20, 0x0
 
-    goto :goto_f
+    goto/16 :goto_f
 
     .restart local v7    # "r":Lcom/android/server/am/ActivityRecord;
     .restart local v36    # "stack":Lcom/android/server/am/ActivityStack;
-    :cond_28
+    :cond_2a
+    const/4 v5, -0x6
+
+    return v5
+
+    :cond_2b
     move-object/from16 v0, p0
 
     iget-object v5, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
     iget-boolean v5, v5, Lcom/android/server/am/ActivityManagerService;->mDidAppSwitch:Z
 
-    if-eqz v5, :cond_2a
+    if-eqz v5, :cond_2d
 
     move-object/from16 v0, p0
 
@@ -12546,14 +12645,14 @@
 
     move-result v30
 
-    if-gez v30, :cond_29
+    if-gez v30, :cond_2c
 
     invoke-virtual/range {p0 .. p0}, Lcom/android/server/am/ActivityStackSupervisor;->notifyActivityDrawnForKeyguard()V
 
-    :cond_29
+    :cond_2c
     return v30
 
-    :cond_2a
+    :cond_2d
     move-object/from16 v0, p0
 
     iget-object v5, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
@@ -12566,7 +12665,7 @@
 .end method
 
 .method final startActivityMayWait(Landroid/app/IApplicationThread;ILjava/lang/String;Landroid/content/Intent;Ljava/lang/String;Landroid/service/voice/IVoiceInteractionSession;Lcom/android/internal/app/IVoiceInteractor;Landroid/os/IBinder;Ljava/lang/String;IILandroid/app/ProfilerInfo;Landroid/app/IActivityManager$WaitResult;Landroid/content/res/Configuration;Landroid/os/Bundle;ZILandroid/app/IActivityContainer;Lcom/android/server/am/TaskRecord;)I
-    .locals 48
+    .locals 46
     .param p1, "caller"    # Landroid/app/IApplicationThread;
     .param p2, "callingUid"    # I
     .param p3, "callingPackage"    # Ljava/lang/String;
@@ -12611,9 +12710,9 @@
 
     if-eqz v4, :cond_1
 
-    const/16 v28, 0x1
+    const/16 v30, 0x1
 
-    .local v28, "componentSpecified":Z
+    .local v30, "componentSpecified":Z
     :goto_0
     new-instance v5, Landroid/content/Intent;
 
@@ -12635,277 +12734,249 @@
 
     invoke-virtual/range {v4 .. v9}, Lcom/android/server/am/ActivityStackSupervisor;->resolveActivity(Landroid/content/Intent;Ljava/lang/String;ILandroid/app/ProfilerInfo;I)Landroid/content/pm/ActivityInfo;
 
-    move-result-object v32
-
-    .local v32, "aInfo":Landroid/content/pm/ActivityInfo;
-    move-object/from16 v30, p18
+    move-result-object v7
 
-    check-cast v30, Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;
+    .local v7, "aInfo":Landroid/content/pm/ActivityInfo;
+    invoke-static {}, Lcom/android/server/am/ActivityStackSupervisorInjector;->isXSpaceActive()Z
 
-    .local v30, "container":Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;
-    move-object/from16 v0, p0
+    move-result v4
 
-    iget-object v0, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
+    if-eqz v4, :cond_19
 
-    move-object/from16 v47, v0
+    move-object/from16 v0, p0
 
-    monitor-enter v47
+    iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
-    if-eqz v30, :cond_2
+    iget-object v6, v4, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
 
-    :try_start_0
-    move-object/from16 v0, v30
+    if-eqz p8, :cond_2
 
-    iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;->mParentActivity:Lcom/android/server/am/ActivityRecord;
+    const/4 v9, 0x1
 
-    if-eqz v4, :cond_2
+    :goto_1
+    move-object v8, v5
 
-    move-object/from16 v0, v30
+    move/from16 v10, p10
 
-    iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;->mParentActivity:Lcom/android/server/am/ActivityRecord;
+    move/from16 v11, p17
 
-    iget-object v4, v4, Lcom/android/server/am/ActivityRecord;->state:Lcom/android/server/am/ActivityStack$ActivityState;
+    move-object/from16 v12, p3
 
-    sget-object v6, Lcom/android/server/am/ActivityStack$ActivityState;->RESUMED:Lcom/android/server/am/ActivityStack$ActivityState;
-    :try_end_0
-    .catchall {:try_start_0 .. :try_end_0} :catchall_1
+    invoke-static/range {v6 .. v12}, Lcom/android/server/am/ActivityStackSupervisorInjector;->checkXSpaceControl(Landroid/content/Context;Landroid/content/pm/ActivityInfo;Landroid/content/Intent;ZIILjava/lang/String;)Landroid/content/Intent;
 
-    if-eq v4, v6, :cond_2
+    move-result-object p4
 
-    const/4 v4, -0x6
+    .end local v5    # "intent":Landroid/content/Intent;
+    .restart local p4    # "intent":Landroid/content/Intent;
+    move-object/from16 v8, p4
 
-    monitor-exit v47
+    move-object/from16 v9, p0
 
-    return v4
+    move-object/from16 v10, p12
 
-    .end local v5    # "intent":Landroid/content/Intent;
-    .end local v28    # "componentSpecified":Z
-    .end local v30    # "container":Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;
-    .end local v32    # "aInfo":Landroid/content/pm/ActivityInfo;
-    .restart local p4    # "intent":Landroid/content/Intent;
-    :cond_1
-    const/16 v28, 0x0
+    move-object/from16 v11, p5
 
-    .restart local v28    # "componentSpecified":Z
-    goto :goto_0
+    move/from16 v12, p11
 
-    .end local p4    # "intent":Landroid/content/Intent;
-    .restart local v5    # "intent":Landroid/content/Intent;
-    .restart local v30    # "container":Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;
-    .restart local v32    # "aInfo":Landroid/content/pm/ActivityInfo;
-    :cond_2
-    :try_start_1
-    invoke-virtual {v5}, Landroid/content/Intent;->getAction()Ljava/lang/String;
+    move/from16 v13, p17
 
-    move-result-object v4
+    move-object/from16 v14, p3
 
-    if-eqz v4, :cond_3
+    invoke-static/range {v7 .. v14}, Lcom/android/server/am/ActivityStackSupervisorInjector;->resolveXSpaceIntent(Landroid/content/pm/ActivityInfo;Landroid/content/Intent;Lcom/android/server/am/ActivityStackSupervisor;Landroid/app/ProfilerInfo;Ljava/lang/String;IILjava/lang/String;)Landroid/content/pm/ActivityInfo;
 
-    invoke-direct/range {p0 .. p0}, Lcom/android/server/am/ActivityStackSupervisor;->isProvisioned()Z
-    :try_end_1
-    .catchall {:try_start_1 .. :try_end_1} :catchall_1
+    move-result-object v7
 
-    move-result v4
+    :goto_2
+    move-object/from16 v0, p0
 
-    if-eqz v4, :cond_4
+    iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
-    :cond_3
-    :try_start_2
-    invoke-virtual {v5}, Landroid/content/Intent;->getComponent()Landroid/content/ComponentName;
+    iget-object v8, v4, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
 
-    move-result-object v4
+    move-object/from16 v0, p0
 
-    if-eqz v4, :cond_8
+    iget-object v9, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
-    invoke-static {}, Landroid/app/AppGlobals;->getPackageManager()Landroid/content/pm/IPackageManager;
+    move-object/from16 v0, p0
 
-    move-result-object v4
+    iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
-    invoke-virtual {v5}, Landroid/content/Intent;->getComponent()Landroid/content/ComponentName;
+    iget-boolean v14, v4, Lcom/android/server/am/ActivityManagerService;->mSystemReady:Z
 
-    move-result-object v6
+    move-object/from16 v10, p1
 
-    move-object/from16 v0, p3
+    move-object v11, v7
 
-    move/from16 v1, p2
+    move-object/from16 v12, p4
 
-    move/from16 v2, p17
+    move/from16 v13, p17
 
-    invoke-interface {v4, v0, v1, v6, v2}, Landroid/content/pm/IPackageManager;->isComponentProtected(Ljava/lang/String;ILandroid/content/ComponentName;I)Z
+    invoke-static/range {v8 .. v14}, Lcom/android/server/am/ExtraActivityManagerService;->checkRunningCompatibility(Landroid/content/Context;Lcom/android/server/am/ActivityManagerService;Landroid/app/IApplicationThread;Landroid/content/pm/ActivityInfo;Landroid/content/Intent;IZ)Z
 
     move-result v4
 
-    if-eqz v4, :cond_8
+    if-nez v4, :cond_3
 
-    invoke-virtual {v5}, Landroid/content/Intent;->getFlags()I
+    const/16 v42, 0x5
 
-    move-result v4
+    :goto_3
+    return v42
 
-    and-int/lit8 v4, v4, 0x1
+    .end local v7    # "aInfo":Landroid/content/pm/ActivityInfo;
+    .end local v30    # "componentSpecified":Z
+    :cond_1
+    const/16 v30, 0x0
 
-    if-nez v4, :cond_7
+    goto :goto_0
 
-    const/16 v37, 0x1
+    .end local p4    # "intent":Landroid/content/Intent;
+    .restart local v5    # "intent":Landroid/content/Intent;
+    .restart local v7    # "aInfo":Landroid/content/pm/ActivityInfo;
+    .restart local v30    # "componentSpecified":Z
+    :cond_2
+    const/4 v9, 0x0
 
-    .local v37, "isProtected":Z
-    :goto_1
-    if-eqz v37, :cond_9
+    goto :goto_1
 
+    .end local v5    # "intent":Landroid/content/Intent;
+    .restart local p4    # "intent":Landroid/content/Intent;
+    :cond_3
     move-object/from16 v0, p0
 
     iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
-    iget-object v4, v4, Lcom/android/server/am/ActivityManagerService;->mHandler:Lcom/android/server/am/ActivityManagerService$MainHandler;
-
-    const/16 v6, 0x3e
+    iget-object v8, v4, Lcom/android/server/am/ActivityManagerService;->mContext:Landroid/content/Context;
 
-    invoke-virtual {v4, v6}, Lcom/android/server/am/ActivityManagerService$MainHandler;->obtainMessage(I)Landroid/os/Message;
+    move-object/from16 v0, p0
 
-    move-result-object v38
+    iget-object v9, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
-    .local v38, "msg":Landroid/os/Message;
-    move/from16 v0, p11
+    if-eqz p8, :cond_4
 
-    invoke-virtual {v5, v0}, Landroid/content/Intent;->setFlags(I)Landroid/content/Intent;
+    const/4 v14, 0x1
 
-    const-string v4, "com.android.settings.PROTECTED_APPS_USER_ID"
+    :goto_4
+    move-object/from16 v10, p1
 
-    move/from16 v0, p17
+    move-object v11, v7
 
-    invoke-virtual {v5, v4, v0}, Landroid/content/Intent;->putExtra(Ljava/lang/String;I)Landroid/content/Intent;
+    move-object/from16 v12, p4
 
-    move-object/from16 v0, v38
+    move-object/from16 v13, p5
 
-    iput-object v5, v0, Landroid/os/Message;->obj:Ljava/lang/Object;
+    move/from16 v15, p10
 
-    move-object/from16 v0, p0
+    move/from16 v16, p16
 
-    iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
+    move/from16 v17, p17
 
-    iget-object v4, v4, Lcom/android/server/am/ActivityManagerService;->mHandler:Lcom/android/server/am/ActivityManagerService$MainHandler;
+    invoke-static/range {v8 .. v17}, Lcom/android/server/am/ActivityStackSupervisorInjector;->checkStartActivityPermission(Landroid/content/Context;Lcom/android/server/am/ActivityManagerService;Landroid/app/IApplicationThread;Landroid/content/pm/ActivityInfo;Landroid/content/Intent;Ljava/lang/String;ZIZI)Landroid/content/Intent;
 
-    move-object/from16 v0, v38
+    move-result-object p4
 
-    invoke-virtual {v4, v0}, Lcom/android/server/am/ActivityManagerService$MainHandler;->sendMessage(Landroid/os/Message;)Z
-    :try_end_2
-    .catch Landroid/os/RemoteException; {:try_start_2 .. :try_end_2} :catch_0
-    .catchall {:try_start_2 .. :try_end_2} :catchall_1
+    move-object/from16 v0, p4
 
-    const/4 v4, -0x8
+    move-object/from16 v1, p0
 
-    monitor-exit v47
+    move-object/from16 v2, p12
 
-    return v4
+    move/from16 v3, p17
 
-    .end local v37    # "isProtected":Z
-    .end local v38    # "msg":Landroid/os/Message;
-    :cond_4
-    :try_start_3
-    invoke-virtual {v5}, Landroid/content/Intent;->getAction()Ljava/lang/String;
+    invoke-static {v7, v0, v1, v2, v3}, Lcom/android/server/am/ActivityStackSupervisorInjector;->resolveCheckIntent(Landroid/content/pm/ActivityInfo;Landroid/content/Intent;Lcom/android/server/am/ActivityStackSupervisor;Landroid/app/ProfilerInfo;I)Landroid/content/pm/ActivityInfo;
 
-    move-result-object v4
+    move-result-object v7
 
-    const-string v6, "android.intent.action.SEARCH"
+    move-object/from16 v0, p4
 
-    invoke-virtual {v4, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    invoke-static {v0, v7}, Lcom/android/server/am/ExtraActivityManagerService;->requestSplashScreen(Landroid/content/Intent;Landroid/content/pm/ActivityInfo;)Landroid/content/Intent;
 
-    move-result v6
+    move-result-object p4
 
-    if-eqz v6, :cond_6
+    move-object/from16 v0, p4
 
-    :cond_5
-    :goto_2
-    const-string v4, "ActivityManager"
+    move-object/from16 v1, p0
 
-    const-string v6, "not starting assist intent while not provisioned"
+    move-object/from16 v2, p12
 
-    invoke-static {v4, v6}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
-    :try_end_3
-    .catchall {:try_start_3 .. :try_end_3} :catchall_1
+    move/from16 v3, p17
 
-    const/4 v4, -0x8
+    invoke-static {v7, v0, v1, v2, v3}, Lcom/android/server/am/ExtraActivityManagerService;->resolveSplashIntent(Landroid/content/pm/ActivityInfo;Landroid/content/Intent;Lcom/android/server/am/ActivityStackSupervisor;Landroid/app/ProfilerInfo;I)Landroid/content/pm/ActivityInfo;
 
-    monitor-exit v47
+    move-result-object v7
 
-    return v4
+    move-object/from16 v32, p18
 
-    :cond_6
-    :try_start_4
-    const-string v6, "android.intent.action.WEB_SEARCH"
+    check-cast v32, Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;
 
-    invoke-virtual {v4, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    .local v32, "container":Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;
+    move-object/from16 v0, p0
 
-    move-result v6
+    iget-object v6, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
-    if-nez v6, :cond_5
+    monitor-enter v6
 
-    const-string v6, "android.intent.action.PROCESS_TEXT"
+    if-eqz v32, :cond_5
 
-    invoke-virtual {v4, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
-
-    move-result v6
-
-    if-nez v6, :cond_5
+    :try_start_0
+    move-object/from16 v0, v32
 
-    const-string v6, "android.intent.action.ASSIST"
+    iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;->mParentActivity:Lcom/android/server/am/ActivityRecord;
 
-    invoke-virtual {v4, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    if-eqz v4, :cond_5
 
-    move-result v6
+    move-object/from16 v0, v32
 
-    if-nez v6, :cond_5
+    iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;->mParentActivity:Lcom/android/server/am/ActivityRecord;
 
-    const-string v6, "android.intent.action.VOICE_ASSIST"
+    iget-object v4, v4, Lcom/android/server/am/ActivityRecord;->state:Lcom/android/server/am/ActivityStack$ActivityState;
 
-    invoke-virtual {v4, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    sget-object v8, Lcom/android/server/am/ActivityStack$ActivityState;->RESUMED:Lcom/android/server/am/ActivityStack$ActivityState;
 
-    move-result v4
+    if-eq v4, v8, :cond_5
 
-    if-eqz v4, :cond_3
+    const/16 v42, -0x6
 
-    goto :goto_2
+    monitor-exit v6
 
-    :cond_7
-    const/16 v37, 0x0
+    goto :goto_3
 
-    .restart local v37    # "isProtected":Z
-    goto :goto_1
+    :catchall_0
+    move-exception v4
 
-    .end local v37    # "isProtected":Z
-    :cond_8
-    const/16 v37, 0x0
+    monitor-exit v6
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
 
-    .restart local v37    # "isProtected":Z
-    goto :goto_1
+    throw v4
 
-    .end local v37    # "isProtected":Z
-    :catch_0
-    move-exception v34
+    .end local v32    # "container":Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;
+    :cond_4
+    const/4 v14, 0x0
 
-    .local v34, "e":Landroid/os/RemoteException;
-    invoke-virtual/range {v34 .. v34}, Landroid/os/RemoteException;->printStackTrace()V
+    goto :goto_4
 
-    .end local v34    # "e":Landroid/os/RemoteException;
-    :cond_9
+    .restart local v32    # "container":Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;
+    :cond_5
+    :try_start_1
     invoke-static {}, Landroid/os/Binder;->getCallingPid()I
 
-    move-result v23
+    move-result v25
 
-    .local v23, "realCallingPid":I
+    .local v25, "realCallingPid":I
     invoke-static {}, Landroid/os/Binder;->getCallingUid()I
 
-    move-result v24
+    move-result v26
 
-    .local v24, "realCallingUid":I
-    if-ltz p2, :cond_f
+    .local v26, "realCallingUid":I
+    if-ltz p2, :cond_c
 
-    const/16 v20, -0x1
+    const/16 v22, -0x1
 
-    .local v20, "callingPid":I
-    :goto_3
-    if-eqz v30, :cond_a
+    .local v22, "callingPid":I
+    :goto_5
+    if-eqz v32, :cond_6
 
-    move-object/from16 v0, v30
+    move-object/from16 v0, v32
 
     iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;->mStack:Lcom/android/server/am/ActivityStack;
 
@@ -12913,18 +12984,18 @@
 
     move-result v4
 
-    if-eqz v4, :cond_11
+    if-eqz v4, :cond_e
 
-    :cond_a
+    :cond_6
     move-object/from16 v0, p0
 
     iget-object v0, v0, Lcom/android/server/am/ActivityStackSupervisor;->mFocusedStack:Lcom/android/server/am/ActivityStack;
 
-    move-object/from16 v45, v0
+    move-object/from16 v43, v0
 
-    .local v45, "stack":Lcom/android/server/am/ActivityStack;
-    :goto_4
-    if-eqz p14, :cond_12
+    .local v43, "stack":Lcom/android/server/am/ActivityStack;
+    :goto_6
+    if-eqz p14, :cond_f
 
     move-object/from16 v0, p0
 
@@ -12938,47 +13009,41 @@
 
     move-result v4
 
-    if-eqz v4, :cond_12
+    if-eqz v4, :cond_f
 
     const/4 v4, 0x1
 
-    :goto_5
-    move-object/from16 v0, v45
+    :goto_7
+    move-object/from16 v0, v43
 
     iput-boolean v4, v0, Lcom/android/server/am/ActivityStack;->mConfigWillChange:Z
 
     invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
 
-    move-result-wide v40
+    move-result-wide v38
 
-    .local v40, "origId":J
-    if-eqz v32, :cond_13
+    .local v38, "origId":J
+    if-eqz v7, :cond_b
 
-    move-object/from16 v0, v32
-
-    iget-object v4, v0, Landroid/content/pm/ActivityInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
+    iget-object v4, v7, Landroid/content/pm/ActivityInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
 
     iget v4, v4, Landroid/content/pm/ApplicationInfo;->privateFlags:I
 
     and-int/lit8 v4, v4, 0x2
 
-    if-eqz v4, :cond_13
-
-    move-object/from16 v0, v32
+    if-eqz v4, :cond_b
 
-    iget-object v4, v0, Landroid/content/pm/ActivityInfo;->processName:Ljava/lang/String;
+    iget-object v4, v7, Landroid/content/pm/ActivityInfo;->processName:Ljava/lang/String;
 
-    move-object/from16 v0, v32
+    iget-object v8, v7, Landroid/content/pm/ActivityInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
 
-    iget-object v6, v0, Landroid/content/pm/ActivityInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
-
-    iget-object v6, v6, Landroid/content/pm/ApplicationInfo;->packageName:Ljava/lang/String;
+    iget-object v8, v8, Landroid/content/pm/ApplicationInfo;->packageName:Ljava/lang/String;
 
-    invoke-virtual {v4, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    invoke-virtual {v4, v8}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
     move-result v4
 
-    if-eqz v4, :cond_1c
+    if-eqz v4, :cond_b
 
     move-object/from16 v0, p0
 
@@ -12998,13 +13063,11 @@
 
     iget v4, v4, Landroid/content/pm/ApplicationInfo;->uid:I
 
-    move-object/from16 v0, v32
-
-    iget-object v6, v0, Landroid/content/pm/ActivityInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
+    iget-object v8, v7, Landroid/content/pm/ActivityInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
 
-    iget v6, v6, Landroid/content/pm/ApplicationInfo;->uid:I
+    iget v8, v8, Landroid/content/pm/ApplicationInfo;->uid:I
 
-    if-ne v4, v6, :cond_14
+    if-ne v4, v8, :cond_7
 
     move-object/from16 v0, p0
 
@@ -13014,612 +13077,669 @@
 
     iget-object v4, v4, Lcom/android/server/am/ProcessRecord;->processName:Ljava/lang/String;
 
-    move-object/from16 v0, v32
+    iget-object v8, v7, Landroid/content/pm/ActivityInfo;->processName:Ljava/lang/String;
 
-    iget-object v6, v0, Landroid/content/pm/ActivityInfo;->processName:Ljava/lang/String;
-
-    invoke-virtual {v4, v6}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
-    :try_end_4
-    .catchall {:try_start_4 .. :try_end_4} :catchall_1
+    invoke-virtual {v4, v8}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
     move-result v4
 
-    if-eqz v4, :cond_14
+    if-nez v4, :cond_b
 
-    :cond_b
-    move-object/from16 v14, v32
+    :cond_7
+    move/from16 v11, p2
 
-    .end local v32    # "aInfo":Landroid/content/pm/ActivityInfo;
-    .local v14, "aInfo":Landroid/content/pm/ActivityInfo;
-    move-object/from16 p4, v5
+    .local v11, "appCallingUid":I
+    if-eqz p1, :cond_8
 
-    .end local v5    # "intent":Landroid/content/Intent;
-    .end local v14    # "aInfo":Landroid/content/pm/ActivityInfo;
-    .end local p1    # "caller":Landroid/app/IApplicationThread;
-    .end local p5    # "resolvedType":Ljava/lang/String;
-    .restart local p4    # "intent":Landroid/content/Intent;
-    :goto_6
-    const/16 v29, 0x0
+    move-object/from16 v0, p0
 
-    move-object/from16 v10, p0
+    iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
-    move-object/from16 v11, p1
+    move-object/from16 v0, p1
 
-    move-object/from16 v12, p4
+    invoke-virtual {v4, v0}, Lcom/android/server/am/ActivityManagerService;->getRecordForAppLocked(Landroid/app/IApplicationThread;)Lcom/android/server/am/ProcessRecord;
 
-    move-object/from16 v13, p5
+    move-result-object v34
 
-    move-object/from16 v15, p6
+    .local v34, "callerApp":Lcom/android/server/am/ProcessRecord;
+    if-eqz v34, :cond_10
 
-    move-object/from16 v16, p7
+    move-object/from16 v0, v34
 
-    move-object/from16 v17, p8
+    iget-object v4, v0, Lcom/android/server/am/ProcessRecord;->info:Landroid/content/pm/ApplicationInfo;
 
-    move-object/from16 v18, p9
+    iget v11, v4, Landroid/content/pm/ApplicationInfo;->uid:I
 
-    move/from16 v19, p10
+    .end local v34    # "callerApp":Lcom/android/server/am/ProcessRecord;
+    :cond_8
+    move-object/from16 v0, p0
 
-    move/from16 v21, p2
+    iget-object v8, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
+
+    const/4 v9, 0x2
 
-    move-object/from16 v22, p3
+    const-string v10, "android"
 
-    move/from16 v25, p11
+    const/4 v13, 0x0
 
-    move-object/from16 v26, p15
+    const/4 v14, 0x0
 
-    move/from16 v27, p16
+    const/4 v15, 0x0
 
-    move-object/from16 v31, p19
+    const/4 v4, 0x1
 
-    :try_start_5
-    invoke-virtual/range {v10 .. v31}, Lcom/android/server/am/ActivityStackSupervisor;->startActivityLocked(Landroid/app/IApplicationThread;Landroid/content/Intent;Ljava/lang/String;Landroid/content/pm/ActivityInfo;Landroid/service/voice/IVoiceInteractionSession;Lcom/android/internal/app/IVoiceInteractor;Landroid/os/IBinder;Ljava/lang/String;IIILjava/lang/String;IIILandroid/os/Bundle;ZZ[Lcom/android/server/am/ActivityRecord;Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;Lcom/android/server/am/TaskRecord;)I
+    new-array v0, v4, [Landroid/content/Intent;
 
-    move-result v44
+    move-object/from16 v16, v0
 
-    .local v44, "res":I
-    invoke-static/range {v40 .. v41}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+    const/4 v4, 0x0
 
-    move-object/from16 v0, v45
+    aput-object p4, v16, v4
 
-    iget-boolean v4, v0, Lcom/android/server/am/ActivityStack;->mConfigWillChange:Z
+    const/4 v4, 0x1
 
-    if-eqz v4, :cond_c
+    new-array v0, v4, [Ljava/lang/String;
+
+    move-object/from16 v17, v0
+
+    const/4 v4, 0x0
+
+    aput-object p5, v17, v4
+
+    const/high16 v18, 0x50000000
+
+    const/16 v19, 0x0
+
+    move/from16 v12, p17
+
+    invoke-virtual/range {v8 .. v19}, Lcom/android/server/am/ActivityManagerService;->getIntentSenderLocked(ILjava/lang/String;IILandroid/os/IBinder;Ljava/lang/String;I[Landroid/content/Intent;[Ljava/lang/String;ILandroid/os/Bundle;)Landroid/content/IIntentSender;
+
+    move-result-object v44
+
+    .local v44, "target":Landroid/content/IIntentSender;
+    new-instance v37, Landroid/content/Intent;
+
+    invoke-direct/range {v37 .. v37}, Landroid/content/Intent;-><init>()V
+
+    .local v37, "newIntent":Landroid/content/Intent;
+    if-ltz p10, :cond_9
+
+    const-string v4, "has_result"
+
+    const/4 v8, 0x1
+
+    move-object/from16 v0, v37
+
+    invoke-virtual {v0, v4, v8}, Landroid/content/Intent;->putExtra(Ljava/lang/String;Z)Landroid/content/Intent;
+
+    :cond_9
+    const-string v4, "intent"
+
+    new-instance v8, Landroid/content/IntentSender;
+
+    move-object/from16 v0, v44
+
+    invoke-direct {v8, v0}, Landroid/content/IntentSender;-><init>(Landroid/content/IIntentSender;)V
+
+    move-object/from16 v0, v37
+
+    invoke-virtual {v0, v4, v8}, Landroid/content/Intent;->putExtra(Ljava/lang/String;Landroid/os/Parcelable;)Landroid/content/Intent;
 
     move-object/from16 v0, p0
 
     iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
-    const-string v6, "android.permission.CHANGE_CONFIGURATION"
-
-    const-string v7, "updateConfiguration()"
+    iget-object v4, v4, Lcom/android/server/am/ActivityManagerService;->mHeavyWeightProcess:Lcom/android/server/am/ProcessRecord;
 
-    invoke-virtual {v4, v6, v7}, Lcom/android/server/am/ActivityManagerService;->enforceCallingPermission(Ljava/lang/String;Ljava/lang/String;)V
+    iget-object v4, v4, Lcom/android/server/am/ProcessRecord;->activities:Ljava/util/ArrayList;
 
-    const/4 v4, 0x0
+    invoke-virtual {v4}, Ljava/util/ArrayList;->size()I
 
-    move-object/from16 v0, v45
+    move-result v4
 
-    iput-boolean v4, v0, Lcom/android/server/am/ActivityStack;->mConfigWillChange:Z
+    if-lez v4, :cond_a
 
     move-object/from16 v0, p0
 
     iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
-    const/4 v6, 0x0
+    iget-object v4, v4, Lcom/android/server/am/ActivityManagerService;->mHeavyWeightProcess:Lcom/android/server/am/ProcessRecord;
 
-    const/4 v7, 0x0
+    iget-object v4, v4, Lcom/android/server/am/ProcessRecord;->activities:Ljava/util/ArrayList;
 
     const/4 v8, 0x0
 
-    move-object/from16 v0, p14
+    invoke-virtual {v4, v8}, Ljava/util/ArrayList;->get(I)Ljava/lang/Object;
 
-    invoke-virtual {v4, v0, v6, v7, v8}, Lcom/android/server/am/ActivityManagerService;->updateConfigurationLocked(Landroid/content/res/Configuration;Lcom/android/server/am/ActivityRecord;ZZ)Z
+    move-result-object v36
 
-    :cond_c
-    if-eqz p13, :cond_e
+    check-cast v36, Lcom/android/server/am/ActivityRecord;
 
-    move/from16 v0, v44
+    .local v36, "hist":Lcom/android/server/am/ActivityRecord;
+    const-string v4, "cur_app"
 
-    move-object/from16 v1, p13
+    move-object/from16 v0, v36
 
-    iput v0, v1, Landroid/app/IActivityManager$WaitResult;->result:I
+    iget-object v8, v0, Lcom/android/server/am/ActivityRecord;->packageName:Ljava/lang/String;
 
-    if-nez v44, :cond_1a
+    move-object/from16 v0, v37
 
-    move-object/from16 v0, p0
+    invoke-virtual {v0, v4, v8}, Landroid/content/Intent;->putExtra(Ljava/lang/String;Ljava/lang/String;)Landroid/content/Intent;
 
-    iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mWaitingActivityLaunched:Ljava/util/ArrayList;
+    const-string v4, "cur_task"
 
-    move-object/from16 v0, p13
+    move-object/from16 v0, v36
 
-    invoke-virtual {v4, v0}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
-    :try_end_5
-    .catchall {:try_start_5 .. :try_end_5} :catchall_0
+    iget-object v8, v0, Lcom/android/server/am/ActivityRecord;->task:Lcom/android/server/am/TaskRecord;
 
-    :cond_d
-    :try_start_6
-    move-object/from16 v0, p0
+    iget v8, v8, Lcom/android/server/am/TaskRecord;->taskId:I
 
-    iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
+    move-object/from16 v0, v37
 
-    invoke-virtual {v4}, Lcom/android/server/am/ActivityManagerService;->wait()V
-    :try_end_6
-    .catch Ljava/lang/InterruptedException; {:try_start_6 .. :try_end_6} :catch_3
-    .catchall {:try_start_6 .. :try_end_6} :catchall_0
+    invoke-virtual {v0, v4, v8}, Landroid/content/Intent;->putExtra(Ljava/lang/String;I)Landroid/content/Intent;
 
-    :goto_7
-    :try_start_7
-    move-object/from16 v0, p13
+    .end local v36    # "hist":Lcom/android/server/am/ActivityRecord;
+    :cond_a
+    const-string v4, "new_app"
 
-    iget-boolean v4, v0, Landroid/app/IActivityManager$WaitResult;->timeout:Z
+    iget-object v8, v7, Landroid/content/pm/ActivityInfo;->packageName:Ljava/lang/String;
 
-    if-nez v4, :cond_e
+    move-object/from16 v0, v37
 
-    move-object/from16 v0, p13
+    invoke-virtual {v0, v4, v8}, Landroid/content/Intent;->putExtra(Ljava/lang/String;Ljava/lang/String;)Landroid/content/Intent;
 
-    iget-object v4, v0, Landroid/app/IActivityManager$WaitResult;->who:Landroid/content/ComponentName;
-    :try_end_7
-    .catchall {:try_start_7 .. :try_end_7} :catchall_0
+    invoke-virtual/range {p4 .. p4}, Landroid/content/Intent;->getFlags()I
 
-    if-eqz v4, :cond_d
+    move-result v4
 
-    :cond_e
-    :goto_8
-    monitor-exit v47
+    move-object/from16 v0, v37
 
-    return v44
+    invoke-virtual {v0, v4}, Landroid/content/Intent;->setFlags(I)Landroid/content/Intent;
 
-    .end local v20    # "callingPid":I
-    .end local v40    # "origId":J
-    .end local v44    # "res":I
-    .end local v45    # "stack":Lcom/android/server/am/ActivityStack;
-    .end local p4    # "intent":Landroid/content/Intent;
-    .restart local v5    # "intent":Landroid/content/Intent;
-    .restart local v32    # "aInfo":Landroid/content/pm/ActivityInfo;
-    .restart local p1    # "caller":Landroid/app/IApplicationThread;
-    .restart local p5    # "resolvedType":Ljava/lang/String;
-    :cond_f
-    if-nez p1, :cond_10
+    const-string v4, "android"
 
-    move/from16 v20, v23
+    const-class v8, Lcom/android/internal/app/HeavyWeightSwitcherActivity;
 
-    .restart local v20    # "callingPid":I
-    move/from16 p2, v24
+    invoke-virtual {v8}, Ljava/lang/Class;->getName()Ljava/lang/String;
 
-    goto/16 :goto_3
+    move-result-object v8
 
-    .end local v20    # "callingPid":I
-    :cond_10
-    const/16 p2, -0x1
+    move-object/from16 v0, v37
 
-    const/16 v20, -0x1
+    invoke-virtual {v0, v4, v8}, Landroid/content/Intent;->setClassName(Ljava/lang/String;Ljava/lang/String;)Landroid/content/Intent;
 
-    .restart local v20    # "callingPid":I
-    goto/16 :goto_3
+    move-object/from16 p4, v37
 
-    :cond_11
-    :try_start_8
-    move-object/from16 v0, v30
+    const/16 p5, 0x0
 
-    iget-object v0, v0, Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;->mStack:Lcom/android/server/am/ActivityStack;
+    const/16 p1, 0x0
 
-    move-object/from16 v45, v0
+    invoke-static {}, Landroid/os/Binder;->getCallingUid()I
 
-    .restart local v45    # "stack":Lcom/android/server/am/ActivityStack;
-    goto/16 :goto_4
+    move-result p2
 
-    :cond_12
-    const/4 v4, 0x0
+    invoke-static {}, Landroid/os/Binder;->getCallingPid()I
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_0
 
-    goto/16 :goto_5
+    move-result v22
 
-    .restart local v40    # "origId":J
-    :cond_13
-    move-object/from16 v14, v32
+    const/16 v30, 0x1
 
-    .end local v32    # "aInfo":Landroid/content/pm/ActivityInfo;
-    .restart local v14    # "aInfo":Landroid/content/pm/ActivityInfo;
-    move-object/from16 p4, v5
+    :try_start_2
+    invoke-static {}, Landroid/app/AppGlobals;->getPackageManager()Landroid/content/pm/IPackageManager;
 
-    .end local v5    # "intent":Landroid/content/Intent;
-    .restart local p4    # "intent":Landroid/content/Intent;
-    goto/16 :goto_6
+    move-result-object v4
 
-    .end local v14    # "aInfo":Landroid/content/pm/ActivityInfo;
-    .end local p4    # "intent":Landroid/content/Intent;
-    .restart local v5    # "intent":Landroid/content/Intent;
-    .restart local v32    # "aInfo":Landroid/content/pm/ActivityInfo;
-    :cond_14
-    move/from16 v9, p2
+    const/4 v8, 0x0
+
+    const v9, 0x10400
 
-    .local v9, "appCallingUid":I
-    if-eqz p1, :cond_15
+    move-object/from16 v0, p4
+
+    move/from16 v1, p17
 
+    invoke-interface {v4, v0, v8, v9, v1}, Landroid/content/pm/IPackageManager;->resolveIntent(Landroid/content/Intent;Ljava/lang/String;II)Landroid/content/pm/ResolveInfo;
+
+    move-result-object v41
+
+    .local v41, "rInfo":Landroid/content/pm/ResolveInfo;
+    if-eqz v41, :cond_11
+
+    move-object/from16 v0, v41
+
+    iget-object v7, v0, Landroid/content/pm/ResolveInfo;->activityInfo:Landroid/content/pm/ActivityInfo;
+
+    :goto_8
     move-object/from16 v0, p0
 
     iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
-    move-object/from16 v0, p1
+    move/from16 v0, p17
 
-    invoke-virtual {v4, v0}, Lcom/android/server/am/ActivityManagerService;->getRecordForAppLocked(Landroid/app/IApplicationThread;)Lcom/android/server/am/ProcessRecord;
+    invoke-virtual {v4, v7, v0}, Lcom/android/server/am/ActivityManagerService;->getActivityInfoForUser(Landroid/content/pm/ActivityInfo;I)Landroid/content/pm/ActivityInfo;
+    :try_end_2
+    .catch Landroid/os/RemoteException; {:try_start_2 .. :try_end_2} :catch_0
+    .catchall {:try_start_2 .. :try_end_2} :catchall_0
 
-    move-result-object v33
+    move-result-object v7
 
-    .local v33, "callerApp":Lcom/android/server/am/ProcessRecord;
-    if-eqz v33, :cond_18
+    .end local v11    # "appCallingUid":I
+    .end local v37    # "newIntent":Landroid/content/Intent;
+    .end local v41    # "rInfo":Landroid/content/pm/ResolveInfo;
+    .end local v44    # "target":Landroid/content/IIntentSender;
+    :cond_b
+    :goto_9
+    const/4 v4, 0x0
 
-    move-object/from16 v0, v33
+    :try_start_3
+    move-object/from16 v0, v43
 
-    iget-object v4, v0, Lcom/android/server/am/ProcessRecord;->info:Landroid/content/pm/ApplicationInfo;
+    invoke-virtual {v0, v4}, Lcom/android/server/am/ActivityStack;->topRunningActivityLocked(Lcom/android/server/am/ActivityRecord;)Lcom/android/server/am/ActivityRecord;
 
-    iget v9, v4, Landroid/content/pm/ApplicationInfo;->uid:I
+    move-result-object v45
+
+    .local v45, "topr":Lcom/android/server/am/ActivityRecord;
+    if-eqz v45, :cond_12
+
+    const-string v4, "com.android.incallui.InCallActivity"
+
+    move-object/from16 v0, v45
+
+    iget-object v8, v0, Lcom/android/server/am/ActivityRecord;->info:Landroid/content/pm/ActivityInfo;
+
+    iget-object v8, v8, Landroid/content/pm/ActivityInfo;->name:Ljava/lang/String;
+
+    invoke-virtual {v4, v8}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v4
+
+    if-eqz v4, :cond_12
 
-    .end local v33    # "callerApp":Lcom/android/server/am/ProcessRecord;
-    :cond_15
     move-object/from16 v0, p0
 
-    iget-object v6, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
+    iget-wide v8, v0, Lcom/android/server/am/ActivityStackSupervisor;->mLastActivityCallTime:J
 
-    const-string v8, "android"
+    const-wide/16 v12, 0x3e8
 
-    const/4 v4, 0x1
+    add-long/2addr v8, v12
 
-    new-array v14, v4, [Landroid/content/Intent;
+    invoke-static {}, Ljava/lang/System;->currentTimeMillis()J
 
-    const/4 v4, 0x0
+    move-result-wide v12
 
-    aput-object v5, v14, v4
+    cmp-long v4, v8, v12
 
-    const/4 v4, 0x1
+    if-lez v4, :cond_12
 
-    new-array v15, v4, [Ljava/lang/String;
+    const-string v4, "ActivityManager"
 
-    const/4 v4, 0x0
+    new-instance v8, Ljava/lang/StringBuilder;
+
+    invoke-direct {v8}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v9, "app switch:"
+
+    invoke-virtual {v8, v9}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v8
+
+    invoke-virtual {v8, v7}, Ljava/lang/StringBuilder;->append(Ljava/lang/Object;)Ljava/lang/StringBuilder;
+
+    move-result-object v8
+
+    const-string v9, " stopped for "
+
+    invoke-virtual {v8, v9}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v8
+
+    const-string v9, "com.android.incallui.InCallActivity"
+
+    invoke-virtual {v8, v9}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v8
+
+    const-string v9, "in "
+
+    invoke-virtual {v8, v9}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v8
+
+    const/16 v9, 0x3e8
+
+    invoke-virtual {v8, v9}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+
+    move-result-object v8
+
+    const-string v9, " ms.Try later."
+
+    invoke-virtual {v8, v9}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v8
+
+    invoke-virtual {v8}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    aput-object p5, v15, v4
+    move-result-object v8
 
-    const/4 v7, 0x2
+    invoke-static {v4, v8}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
 
-    const/4 v11, 0x0
+    const/16 v42, 0x4
 
-    const/4 v12, 0x0
+    monitor-exit v6
 
-    const/4 v13, 0x0
+    goto/16 :goto_3
 
-    const/high16 v16, 0x50000000
+    .end local v22    # "callingPid":I
+    .end local v38    # "origId":J
+    .end local v43    # "stack":Lcom/android/server/am/ActivityStack;
+    .end local v45    # "topr":Lcom/android/server/am/ActivityRecord;
+    :cond_c
+    if-nez p1, :cond_d
 
-    const/16 v17, 0x0
+    move/from16 v22, v25
 
-    move/from16 v10, p17
+    .restart local v22    # "callingPid":I
+    move/from16 p2, v26
 
-    invoke-virtual/range {v6 .. v17}, Lcom/android/server/am/ActivityManagerService;->getIntentSenderLocked(ILjava/lang/String;IILandroid/os/IBinder;Ljava/lang/String;I[Landroid/content/Intent;[Ljava/lang/String;ILandroid/os/Bundle;)Landroid/content/IIntentSender;
+    goto/16 :goto_5
 
-    move-result-object v46
+    .end local v22    # "callingPid":I
+    :cond_d
+    const/16 p2, -0x1
 
-    .local v46, "target":Landroid/content/IIntentSender;
-    new-instance v39, Landroid/content/Intent;
+    move/from16 v22, p2
 
-    invoke-direct/range {v39 .. v39}, Landroid/content/Intent;-><init>()V
+    .restart local v22    # "callingPid":I
+    goto/16 :goto_5
 
-    .local v39, "newIntent":Landroid/content/Intent;
-    if-ltz p10, :cond_16
+    :cond_e
+    move-object/from16 v0, v32
 
-    const-string v4, "has_result"
+    iget-object v0, v0, Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;->mStack:Lcom/android/server/am/ActivityStack;
 
-    const/4 v6, 0x1
+    move-object/from16 v43, v0
 
-    move-object/from16 v0, v39
+    .restart local v43    # "stack":Lcom/android/server/am/ActivityStack;
+    goto/16 :goto_6
 
-    invoke-virtual {v0, v4, v6}, Landroid/content/Intent;->putExtra(Ljava/lang/String;Z)Landroid/content/Intent;
+    :cond_f
+    const/4 v4, 0x0
 
-    :cond_16
-    const-string v4, "intent"
+    goto/16 :goto_7
 
-    new-instance v6, Landroid/content/IntentSender;
+    .restart local v11    # "appCallingUid":I
+    .restart local v34    # "callerApp":Lcom/android/server/am/ProcessRecord;
+    .restart local v38    # "origId":J
+    :cond_10
+    const-string v4, "ActivityManager"
 
-    move-object/from16 v0, v46
+    new-instance v8, Ljava/lang/StringBuilder;
 
-    invoke-direct {v6, v0}, Landroid/content/IntentSender;-><init>(Landroid/content/IIntentSender;)V
+    invoke-direct {v8}, Ljava/lang/StringBuilder;-><init>()V
 
-    move-object/from16 v0, v39
+    const-string v9, "Unable to find app for caller "
 
-    invoke-virtual {v0, v4, v6}, Landroid/content/Intent;->putExtra(Ljava/lang/String;Landroid/os/Parcelable;)Landroid/content/Intent;
+    invoke-virtual {v8, v9}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    move-object/from16 v0, p0
+    move-result-object v8
 
-    iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
+    move-object/from16 v0, p1
 
-    iget-object v4, v4, Lcom/android/server/am/ActivityManagerService;->mHeavyWeightProcess:Lcom/android/server/am/ProcessRecord;
+    invoke-virtual {v8, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/Object;)Ljava/lang/StringBuilder;
 
-    iget-object v4, v4, Lcom/android/server/am/ProcessRecord;->activities:Ljava/util/ArrayList;
+    move-result-object v8
 
-    invoke-virtual {v4}, Ljava/util/ArrayList;->size()I
+    const-string v9, " (pid="
 
-    move-result v4
+    invoke-virtual {v8, v9}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    if-lez v4, :cond_17
+    move-result-object v8
 
-    move-object/from16 v0, p0
+    move/from16 v0, v22
 
-    iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
+    invoke-virtual {v8, v0}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
-    iget-object v4, v4, Lcom/android/server/am/ActivityManagerService;->mHeavyWeightProcess:Lcom/android/server/am/ProcessRecord;
+    move-result-object v8
 
-    iget-object v4, v4, Lcom/android/server/am/ProcessRecord;->activities:Ljava/util/ArrayList;
+    const-string v9, ") when starting: "
 
-    const/4 v6, 0x0
+    invoke-virtual {v8, v9}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    invoke-virtual {v4, v6}, Ljava/util/ArrayList;->get(I)Ljava/lang/Object;
+    move-result-object v8
 
-    move-result-object v36
+    invoke-virtual/range {p4 .. p4}, Landroid/content/Intent;->toString()Ljava/lang/String;
 
-    check-cast v36, Lcom/android/server/am/ActivityRecord;
+    move-result-object v9
 
-    .local v36, "hist":Lcom/android/server/am/ActivityRecord;
-    const-string v4, "cur_app"
+    invoke-virtual {v8, v9}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
-    move-object/from16 v0, v36
+    move-result-object v8
 
-    iget-object v6, v0, Lcom/android/server/am/ActivityRecord;->packageName:Ljava/lang/String;
+    invoke-virtual {v8}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
 
-    move-object/from16 v0, v39
+    move-result-object v8
 
-    invoke-virtual {v0, v4, v6}, Landroid/content/Intent;->putExtra(Ljava/lang/String;Ljava/lang/String;)Landroid/content/Intent;
+    invoke-static {v4, v8}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
 
-    const-string v4, "cur_task"
+    invoke-static/range {p15 .. p15}, Landroid/app/ActivityOptions;->abort(Landroid/os/Bundle;)V
 
-    move-object/from16 v0, v36
+    const/16 v42, -0x4
 
-    iget-object v6, v0, Lcom/android/server/am/ActivityRecord;->task:Lcom/android/server/am/TaskRecord;
+    monitor-exit v6
 
-    iget v6, v6, Lcom/android/server/am/TaskRecord;->taskId:I
+    goto/16 :goto_3
 
-    move-object/from16 v0, v39
+    .end local v34    # "callerApp":Lcom/android/server/am/ProcessRecord;
+    .restart local v37    # "newIntent":Landroid/content/Intent;
+    .restart local v41    # "rInfo":Landroid/content/pm/ResolveInfo;
+    .restart local v44    # "target":Landroid/content/IIntentSender;
+    :cond_11
+    const/4 v7, 0x0
 
-    invoke-virtual {v0, v4, v6}, Landroid/content/Intent;->putExtra(Ljava/lang/String;I)Landroid/content/Intent;
+    goto/16 :goto_8
 
-    .end local v36    # "hist":Lcom/android/server/am/ActivityRecord;
-    :cond_17
-    const-string v4, "new_app"
+    .end local v41    # "rInfo":Landroid/content/pm/ResolveInfo;
+    :catch_0
+    move-exception v35
 
-    move-object/from16 v0, v32
+    .local v35, "e":Landroid/os/RemoteException;
+    const/4 v7, 0x0
 
-    iget-object v6, v0, Landroid/content/pm/ActivityInfo;->packageName:Ljava/lang/String;
+    goto/16 :goto_9
 
-    move-object/from16 v0, v39
+    .end local v11    # "appCallingUid":I
+    .end local v35    # "e":Landroid/os/RemoteException;
+    .end local v37    # "newIntent":Landroid/content/Intent;
+    .end local v44    # "target":Landroid/content/IIntentSender;
+    .restart local v45    # "topr":Lcom/android/server/am/ActivityRecord;
+    :cond_12
+    invoke-static {}, Ljava/lang/System;->currentTimeMillis()J
 
-    invoke-virtual {v0, v4, v6}, Landroid/content/Intent;->putExtra(Ljava/lang/String;Ljava/lang/String;)Landroid/content/Intent;
+    move-result-wide v8
 
-    invoke-virtual {v5}, Landroid/content/Intent;->getFlags()I
+    move-object/from16 v0, p0
 
-    move-result v4
+    iput-wide v8, v0, Lcom/android/server/am/ActivityStackSupervisor;->mLastActivityCallTime:J
 
-    move-object/from16 v0, v39
+    move-object/from16 v12, v43
 
-    invoke-virtual {v0, v4}, Landroid/content/Intent;->setFlags(I)Landroid/content/Intent;
+    move-object/from16 v13, p1
 
-    const-string v4, "android"
+    move/from16 v14, p2
 
-    const-class v6, Lcom/android/internal/app/HeavyWeightSwitcherActivity;
+    move-object/from16 v15, p3
 
-    invoke-virtual {v6}, Ljava/lang/Class;->getName()Ljava/lang/String;
+    move-object/from16 v16, p4
 
-    move-result-object v6
+    move-object/from16 v17, v7
 
-    move-object/from16 v0, v39
+    move-object/from16 v18, p8
 
-    invoke-virtual {v0, v4, v6}, Landroid/content/Intent;->setClassName(Ljava/lang/String;Ljava/lang/String;)Landroid/content/Intent;
-    :try_end_8
-    .catchall {:try_start_8 .. :try_end_8} :catchall_1
+    move/from16 v19, p10
 
-    move-object/from16 p4, v39
+    move/from16 v20, p17
 
-    .end local v5    # "intent":Landroid/content/Intent;
-    .restart local p4    # "intent":Landroid/content/Intent;
-    const/16 p5, 0x0
+    invoke-static/range {v12 .. v20}, Lcom/android/server/am/ActivityStackSupervisorInjector;->updateInfoBeforeRealStartActivity(Lcom/android/server/am/ActivityStack;Landroid/app/IApplicationThread;ILjava/lang/String;Landroid/content/Intent;Landroid/content/pm/ActivityInfo;Landroid/os/IBinder;II)V
 
-    .local p5, "resolvedType":Ljava/lang/String;
-    const/16 p1, 0x0
+    const/16 v31, 0x0
 
-    .local p1, "caller":Landroid/app/IApplicationThread;
-    :try_start_9
-    invoke-static {}, Landroid/os/Binder;->getCallingUid()I
+    move-object/from16 v12, p0
 
-    move-result p2
+    move-object/from16 v13, p1
 
-    invoke-static {}, Landroid/os/Binder;->getCallingPid()I
-    :try_end_9
-    .catchall {:try_start_9 .. :try_end_9} :catchall_2
+    move-object/from16 v14, p4
 
-    move-result v20
+    move-object/from16 v15, p5
 
-    const/16 v28, 0x1
+    move-object/from16 v16, v7
 
-    :try_start_a
-    invoke-static {}, Landroid/app/AppGlobals;->getPackageManager()Landroid/content/pm/IPackageManager;
+    move-object/from16 v17, p6
 
-    move-result-object v4
+    move-object/from16 v18, p7
 
-    const/4 v6, 0x0
+    move-object/from16 v19, p8
 
-    const v7, 0x10400
+    move-object/from16 v20, p9
 
-    move-object/from16 v0, p4
+    move/from16 v21, p10
 
-    move/from16 v1, p17
+    move/from16 v23, p2
 
-    invoke-interface {v4, v0, v6, v7, v1}, Landroid/content/pm/IPackageManager;->resolveIntent(Landroid/content/Intent;Ljava/lang/String;II)Landroid/content/pm/ResolveInfo;
+    move-object/from16 v24, p3
 
-    move-result-object v43
+    move/from16 v27, p11
 
-    .local v43, "rInfo":Landroid/content/pm/ResolveInfo;
-    if-eqz v43, :cond_19
+    move-object/from16 v28, p15
 
-    move-object/from16 v0, v43
+    move/from16 v29, p16
 
-    iget-object v14, v0, Landroid/content/pm/ResolveInfo;->activityInfo:Landroid/content/pm/ActivityInfo;
-    :try_end_a
-    .catch Landroid/os/RemoteException; {:try_start_a .. :try_end_a} :catch_1
-    .catchall {:try_start_a .. :try_end_a} :catchall_2
+    move-object/from16 v33, p19
 
-    .end local v32    # "aInfo":Landroid/content/pm/ActivityInfo;
-    :goto_9
-    :try_start_b
-    move-object/from16 v0, p0
+    invoke-virtual/range {v12 .. v33}, Lcom/android/server/am/ActivityStackSupervisor;->startActivityLocked(Landroid/app/IApplicationThread;Landroid/content/Intent;Ljava/lang/String;Landroid/content/pm/ActivityInfo;Landroid/service/voice/IVoiceInteractionSession;Lcom/android/internal/app/IVoiceInteractor;Landroid/os/IBinder;Ljava/lang/String;IIILjava/lang/String;IIILandroid/os/Bundle;ZZ[Lcom/android/server/am/ActivityRecord;Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;Lcom/android/server/am/TaskRecord;)I
 
-    iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
+    move-result v42
 
-    move/from16 v0, p17
+    .local v42, "res":I
+    invoke-static/range {v38 .. v39}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
-    invoke-virtual {v4, v14, v0}, Lcom/android/server/am/ActivityManagerService;->getActivityInfoForUser(Landroid/content/pm/ActivityInfo;I)Landroid/content/pm/ActivityInfo;
-    :try_end_b
-    .catch Landroid/os/RemoteException; {:try_start_b .. :try_end_b} :catch_4
-    .catchall {:try_start_b .. :try_end_b} :catchall_0
+    move-object/from16 v0, v43
 
-    move-result-object v14
+    iget-boolean v4, v0, Lcom/android/server/am/ActivityStack;->mConfigWillChange:Z
 
-    .restart local v14    # "aInfo":Landroid/content/pm/ActivityInfo;
-    goto/16 :goto_6
+    if-eqz v4, :cond_13
 
-    .end local v14    # "aInfo":Landroid/content/pm/ActivityInfo;
-    .end local v39    # "newIntent":Landroid/content/Intent;
-    .end local v43    # "rInfo":Landroid/content/pm/ResolveInfo;
-    .end local v46    # "target":Landroid/content/IIntentSender;
-    .end local p4    # "intent":Landroid/content/Intent;
-    .restart local v5    # "intent":Landroid/content/Intent;
-    .restart local v32    # "aInfo":Landroid/content/pm/ActivityInfo;
-    .restart local v33    # "callerApp":Lcom/android/server/am/ProcessRecord;
-    .local p1, "caller":Landroid/app/IApplicationThread;
-    .local p5, "resolvedType":Ljava/lang/String;
-    :cond_18
-    :try_start_c
-    const-string v4, "ActivityManager"
+    move-object/from16 v0, p0
 
-    new-instance v6, Ljava/lang/StringBuilder;
+    iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
-    invoke-direct {v6}, Ljava/lang/StringBuilder;-><init>()V
+    const-string v8, "android.permission.CHANGE_CONFIGURATION"
 
-    const-string v7, "Unable to find app for caller "
+    const-string v9, "updateConfiguration()"
 
-    invoke-virtual {v6, v7}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    invoke-virtual {v4, v8, v9}, Lcom/android/server/am/ActivityManagerService;->enforceCallingPermission(Ljava/lang/String;Ljava/lang/String;)V
 
-    move-result-object v6
+    const/4 v4, 0x0
 
-    move-object/from16 v0, p1
+    move-object/from16 v0, v43
 
-    invoke-virtual {v6, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/Object;)Ljava/lang/StringBuilder;
+    iput-boolean v4, v0, Lcom/android/server/am/ActivityStack;->mConfigWillChange:Z
 
-    move-result-object v6
+    move-object/from16 v0, p0
 
-    const-string v7, " (pid="
+    iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
-    invoke-virtual {v6, v7}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    const/4 v8, 0x0
 
-    move-result-object v6
+    const/4 v9, 0x0
 
-    move/from16 v0, v20
+    const/4 v10, 0x0
 
-    invoke-virtual {v6, v0}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
+    move-object/from16 v0, p14
 
-    move-result-object v6
+    invoke-virtual {v4, v0, v8, v9, v10}, Lcom/android/server/am/ActivityManagerService;->updateConfigurationLocked(Landroid/content/res/Configuration;Lcom/android/server/am/ActivityRecord;ZZ)Z
 
-    const-string v7, ") when starting: "
+    :cond_13
+    if-eqz p13, :cond_15
 
-    invoke-virtual {v6, v7}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    move/from16 v0, v42
 
-    move-result-object v6
+    move-object/from16 v1, p13
 
-    invoke-virtual {v5}, Landroid/content/Intent;->toString()Ljava/lang/String;
+    iput v0, v1, Landroid/app/IActivityManager$WaitResult;->result:I
 
-    move-result-object v7
+    if-nez v42, :cond_16
 
-    invoke-virtual {v6, v7}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+    move-object/from16 v0, p0
 
-    move-result-object v6
+    iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mWaitingActivityLaunched:Ljava/util/ArrayList;
 
-    invoke-virtual {v6}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    move-object/from16 v0, p13
 
-    move-result-object v6
+    invoke-virtual {v4, v0}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
+    :try_end_3
+    .catchall {:try_start_3 .. :try_end_3} :catchall_0
 
-    invoke-static {v4, v6}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
+    :cond_14
+    :try_start_4
+    move-object/from16 v0, p0
 
-    invoke-static/range {p15 .. p15}, Landroid/app/ActivityOptions;->abort(Landroid/os/Bundle;)V
-    :try_end_c
-    .catchall {:try_start_c .. :try_end_c} :catchall_1
+    iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
-    const/4 v4, -0x4
+    invoke-virtual {v4}, Ljava/lang/Object;->wait()V
+    :try_end_4
+    .catch Ljava/lang/InterruptedException; {:try_start_4 .. :try_end_4} :catch_2
+    .catchall {:try_start_4 .. :try_end_4} :catchall_0
 
-    monitor-exit v47
+    :goto_a
+    :try_start_5
+    move-object/from16 v0, p13
 
-    return v4
+    iget-boolean v4, v0, Landroid/app/IActivityManager$WaitResult;->timeout:Z
 
-    .end local v5    # "intent":Landroid/content/Intent;
-    .end local v33    # "callerApp":Lcom/android/server/am/ProcessRecord;
-    .restart local v39    # "newIntent":Landroid/content/Intent;
-    .restart local v43    # "rInfo":Landroid/content/pm/ResolveInfo;
-    .restart local v46    # "target":Landroid/content/IIntentSender;
-    .local p1, "caller":Landroid/app/IApplicationThread;
-    .restart local p4    # "intent":Landroid/content/Intent;
-    .local p5, "resolvedType":Ljava/lang/String;
-    :cond_19
-    const/4 v14, 0x0
+    if-nez v4, :cond_15
 
-    .local v14, "aInfo":Landroid/content/pm/ActivityInfo;
-    goto :goto_9
+    move-object/from16 v0, p13
 
-    .end local v14    # "aInfo":Landroid/content/pm/ActivityInfo;
-    .end local v43    # "rInfo":Landroid/content/pm/ResolveInfo;
-    :catch_1
-    move-exception v34
+    iget-object v4, v0, Landroid/app/IActivityManager$WaitResult;->who:Landroid/content/ComponentName;
 
-    .restart local v34    # "e":Landroid/os/RemoteException;
-    move-object/from16 v14, v32
+    if-eqz v4, :cond_14
 
-    .end local v32    # "aInfo":Landroid/content/pm/ActivityInfo;
-    :goto_a
-    const/4 v14, 0x0
+    :cond_15
+    :goto_b
+    monitor-exit v6
 
-    .restart local v14    # "aInfo":Landroid/content/pm/ActivityInfo;
-    goto/16 :goto_6
+    goto/16 :goto_3
 
-    .end local v9    # "appCallingUid":I
-    .end local v14    # "aInfo":Landroid/content/pm/ActivityInfo;
-    .end local v34    # "e":Landroid/os/RemoteException;
-    .end local v39    # "newIntent":Landroid/content/Intent;
-    .end local v46    # "target":Landroid/content/IIntentSender;
-    .end local p1    # "caller":Landroid/app/IApplicationThread;
-    .end local p5    # "resolvedType":Ljava/lang/String;
-    .restart local v44    # "res":I
-    :cond_1a
+    :cond_16
     const/4 v4, 0x2
 
-    move/from16 v0, v44
+    move/from16 v0, v42
 
-    if-ne v0, v4, :cond_e
+    if-ne v0, v4, :cond_15
 
     const/4 v4, 0x0
 
-    :try_start_d
-    move-object/from16 v0, v45
+    move-object/from16 v0, v43
 
     invoke-virtual {v0, v4}, Lcom/android/server/am/ActivityStack;->topRunningActivityLocked(Lcom/android/server/am/ActivityRecord;)Lcom/android/server/am/ActivityRecord;
 
-    move-result-object v42
+    move-result-object v40
 
-    .local v42, "r":Lcom/android/server/am/ActivityRecord;
-    move-object/from16 v0, v42
+    .local v40, "r":Lcom/android/server/am/ActivityRecord;
+    move-object/from16 v0, v40
 
     iget-boolean v4, v0, Lcom/android/server/am/ActivityRecord;->nowVisible:Z
 
-    if-eqz v4, :cond_1b
+    if-eqz v4, :cond_17
 
-    move-object/from16 v0, v42
+    move-object/from16 v0, v40
 
     iget-object v4, v0, Lcom/android/server/am/ActivityRecord;->state:Lcom/android/server/am/ActivityStack$ActivityState;
 
-    sget-object v6, Lcom/android/server/am/ActivityStack$ActivityState;->RESUMED:Lcom/android/server/am/ActivityStack$ActivityState;
+    sget-object v8, Lcom/android/server/am/ActivityStack$ActivityState;->RESUMED:Lcom/android/server/am/ActivityStack$ActivityState;
 
-    if-ne v4, v6, :cond_1b
+    if-ne v4, v8, :cond_17
 
     const/4 v4, 0x0
 
@@ -13629,71 +13749,46 @@
 
     new-instance v4, Landroid/content/ComponentName;
 
-    move-object/from16 v0, v42
+    move-object/from16 v0, v40
 
-    iget-object v6, v0, Lcom/android/server/am/ActivityRecord;->info:Landroid/content/pm/ActivityInfo;
+    iget-object v8, v0, Lcom/android/server/am/ActivityRecord;->info:Landroid/content/pm/ActivityInfo;
 
-    iget-object v6, v6, Landroid/content/pm/ActivityInfo;->packageName:Ljava/lang/String;
+    iget-object v8, v8, Landroid/content/pm/ActivityInfo;->packageName:Ljava/lang/String;
 
-    move-object/from16 v0, v42
+    move-object/from16 v0, v40
 
-    iget-object v7, v0, Lcom/android/server/am/ActivityRecord;->info:Landroid/content/pm/ActivityInfo;
+    iget-object v9, v0, Lcom/android/server/am/ActivityRecord;->info:Landroid/content/pm/ActivityInfo;
 
-    iget-object v7, v7, Landroid/content/pm/ActivityInfo;->name:Ljava/lang/String;
+    iget-object v9, v9, Landroid/content/pm/ActivityInfo;->name:Ljava/lang/String;
 
-    invoke-direct {v4, v6, v7}, Landroid/content/ComponentName;-><init>(Ljava/lang/String;Ljava/lang/String;)V
+    invoke-direct {v4, v8, v9}, Landroid/content/ComponentName;-><init>(Ljava/lang/String;Ljava/lang/String;)V
 
     move-object/from16 v0, p13
 
     iput-object v4, v0, Landroid/app/IActivityManager$WaitResult;->who:Landroid/content/ComponentName;
 
-    const-wide/16 v6, 0x0
+    const-wide/16 v8, 0x0
 
     move-object/from16 v0, p13
 
-    iput-wide v6, v0, Landroid/app/IActivityManager$WaitResult;->totalTime:J
+    iput-wide v8, v0, Landroid/app/IActivityManager$WaitResult;->totalTime:J
 
-    const-wide/16 v6, 0x0
+    const-wide/16 v8, 0x0
 
     move-object/from16 v0, p13
 
-    iput-wide v6, v0, Landroid/app/IActivityManager$WaitResult;->thisTime:J
-    :try_end_d
-    .catchall {:try_start_d .. :try_end_d} :catchall_0
-
-    goto/16 :goto_8
-
-    .end local v42    # "r":Lcom/android/server/am/ActivityRecord;
-    .end local v44    # "res":I
-    :catchall_0
-    move-exception v4
-
-    .end local v20    # "callingPid":I
-    .end local v23    # "realCallingPid":I
-    .end local v24    # "realCallingUid":I
-    .end local v40    # "origId":J
-    .end local v45    # "stack":Lcom/android/server/am/ActivityStack;
-    :goto_b
-    monitor-exit v47
+    iput-wide v8, v0, Landroid/app/IActivityManager$WaitResult;->thisTime:J
 
-    throw v4
+    goto :goto_b
 
-    .restart local v20    # "callingPid":I
-    .restart local v23    # "realCallingPid":I
-    .restart local v24    # "realCallingUid":I
-    .restart local v40    # "origId":J
-    .restart local v42    # "r":Lcom/android/server/am/ActivityRecord;
-    .restart local v44    # "res":I
-    .restart local v45    # "stack":Lcom/android/server/am/ActivityStack;
-    :cond_1b
-    :try_start_e
+    :cond_17
     invoke-static {}, Landroid/os/SystemClock;->uptimeMillis()J
 
-    move-result-wide v6
+    move-result-wide v8
 
     move-object/from16 v0, p13
 
-    iput-wide v6, v0, Landroid/app/IActivityManager$WaitResult;->thisTime:J
+    iput-wide v8, v0, Landroid/app/IActivityManager$WaitResult;->thisTime:J
 
     move-object/from16 v0, p0
 
@@ -13702,140 +13797,65 @@
     move-object/from16 v0, p13
 
     invoke-virtual {v4, v0}, Ljava/util/ArrayList;->add(Ljava/lang/Object;)Z
-    :try_end_e
-    .catchall {:try_start_e .. :try_end_e} :catchall_0
+    :try_end_5
+    .catchall {:try_start_5 .. :try_end_5} :catchall_0
 
-    :goto_c
-    :try_start_f
+    :cond_18
+    :try_start_6
     move-object/from16 v0, p0
 
     iget-object v4, v0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
-    invoke-virtual {v4}, Lcom/android/server/am/ActivityManagerService;->wait()V
-    :try_end_f
-    .catch Ljava/lang/InterruptedException; {:try_start_f .. :try_end_f} :catch_2
-    .catchall {:try_start_f .. :try_end_f} :catchall_0
+    invoke-virtual {v4}, Ljava/lang/Object;->wait()V
+    :try_end_6
+    .catch Ljava/lang/InterruptedException; {:try_start_6 .. :try_end_6} :catch_1
+    .catchall {:try_start_6 .. :try_end_6} :catchall_0
 
-    :goto_d
-    :try_start_10
+    :goto_c
+    :try_start_7
     move-object/from16 v0, p13
 
     iget-boolean v4, v0, Landroid/app/IActivityManager$WaitResult;->timeout:Z
 
-    if-nez v4, :cond_e
+    if-nez v4, :cond_15
 
     move-object/from16 v0, p13
 
     iget-object v4, v0, Landroid/app/IActivityManager$WaitResult;->who:Landroid/content/ComponentName;
-    :try_end_10
-    .catchall {:try_start_10 .. :try_end_10} :catchall_0
-
-    if-nez v4, :cond_e
-
-    goto :goto_c
-
-    .end local v20    # "callingPid":I
-    .end local v23    # "realCallingPid":I
-    .end local v24    # "realCallingUid":I
-    .end local v40    # "origId":J
-    .end local v42    # "r":Lcom/android/server/am/ActivityRecord;
-    .end local v44    # "res":I
-    .end local v45    # "stack":Lcom/android/server/am/ActivityStack;
-    .end local p4    # "intent":Landroid/content/Intent;
-    .restart local v5    # "intent":Landroid/content/Intent;
-    .restart local v32    # "aInfo":Landroid/content/pm/ActivityInfo;
-    .local p1, "caller":Landroid/app/IApplicationThread;
-    .local p5, "resolvedType":Ljava/lang/String;
-    :catchall_1
-    move-exception v4
-
-    move-object/from16 v14, v32
+    :try_end_7
+    .catchall {:try_start_7 .. :try_end_7} :catchall_0
 
-    .end local v32    # "aInfo":Landroid/content/pm/ActivityInfo;
-    .local v14, "aInfo":Landroid/content/pm/ActivityInfo;
-    move-object/from16 p4, v5
+    if-eqz v4, :cond_18
 
-    .end local v5    # "intent":Landroid/content/Intent;
-    .restart local p4    # "intent":Landroid/content/Intent;
     goto :goto_b
 
-    .end local v14    # "aInfo":Landroid/content/pm/ActivityInfo;
-    .restart local v9    # "appCallingUid":I
-    .restart local v20    # "callingPid":I
-    .restart local v23    # "realCallingPid":I
-    .restart local v24    # "realCallingUid":I
-    .restart local v32    # "aInfo":Landroid/content/pm/ActivityInfo;
-    .restart local v39    # "newIntent":Landroid/content/Intent;
-    .restart local v40    # "origId":J
-    .restart local v45    # "stack":Lcom/android/server/am/ActivityStack;
-    .restart local v46    # "target":Landroid/content/IIntentSender;
-    .local p1, "caller":Landroid/app/IApplicationThread;
-    .local p5, "resolvedType":Ljava/lang/String;
-    :catchall_2
+    :catch_1
     move-exception v4
 
-    move-object/from16 v14, v32
-
-    .end local v32    # "aInfo":Landroid/content/pm/ActivityInfo;
-    .restart local v14    # "aInfo":Landroid/content/pm/ActivityInfo;
-    goto :goto_b
+    goto :goto_c
 
-    .end local v9    # "appCallingUid":I
-    .end local v14    # "aInfo":Landroid/content/pm/ActivityInfo;
-    .end local v39    # "newIntent":Landroid/content/Intent;
-    .end local v46    # "target":Landroid/content/IIntentSender;
-    .end local p1    # "caller":Landroid/app/IApplicationThread;
-    .end local p5    # "resolvedType":Ljava/lang/String;
-    .restart local v42    # "r":Lcom/android/server/am/ActivityRecord;
-    .restart local v44    # "res":I
+    .end local v40    # "r":Lcom/android/server/am/ActivityRecord;
     :catch_2
-    move-exception v35
-
-    .local v35, "e":Ljava/lang/InterruptedException;
-    goto :goto_d
-
-    .end local v35    # "e":Ljava/lang/InterruptedException;
-    .end local v42    # "r":Lcom/android/server/am/ActivityRecord;
-    :catch_3
-    move-exception v35
-
-    .restart local v35    # "e":Ljava/lang/InterruptedException;
-    goto/16 :goto_7
-
-    .end local v35    # "e":Ljava/lang/InterruptedException;
-    .end local v44    # "res":I
-    .restart local v9    # "appCallingUid":I
-    .restart local v39    # "newIntent":Landroid/content/Intent;
-    .restart local v43    # "rInfo":Landroid/content/pm/ResolveInfo;
-    .restart local v46    # "target":Landroid/content/IIntentSender;
-    .restart local p1    # "caller":Landroid/app/IApplicationThread;
-    .restart local p5    # "resolvedType":Ljava/lang/String;
-    :catch_4
-    move-exception v34
+    move-exception v4
 
-    .restart local v34    # "e":Landroid/os/RemoteException;
     goto :goto_a
 
-    .end local v9    # "appCallingUid":I
-    .end local v34    # "e":Landroid/os/RemoteException;
-    .end local v39    # "newIntent":Landroid/content/Intent;
-    .end local v43    # "rInfo":Landroid/content/pm/ResolveInfo;
-    .end local v46    # "target":Landroid/content/IIntentSender;
+    .end local v22    # "callingPid":I
+    .end local v25    # "realCallingPid":I
+    .end local v26    # "realCallingUid":I
+    .end local v32    # "container":Lcom/android/server/am/ActivityStackSupervisor$ActivityContainer;
+    .end local v38    # "origId":J
+    .end local v42    # "res":I
+    .end local v43    # "stack":Lcom/android/server/am/ActivityStack;
+    .end local v45    # "topr":Lcom/android/server/am/ActivityRecord;
     .end local p4    # "intent":Landroid/content/Intent;
     .restart local v5    # "intent":Landroid/content/Intent;
-    .restart local v32    # "aInfo":Landroid/content/pm/ActivityInfo;
-    .local p1, "caller":Landroid/app/IApplicationThread;
-    .local p5, "resolvedType":Ljava/lang/String;
-    :cond_1c
-    move-object/from16 v14, v32
-
-    .end local v32    # "aInfo":Landroid/content/pm/ActivityInfo;
-    .restart local v14    # "aInfo":Landroid/content/pm/ActivityInfo;
+    :cond_19
     move-object/from16 p4, v5
 
     .end local v5    # "intent":Landroid/content/Intent;
     .restart local p4    # "intent":Landroid/content/Intent;
-    goto/16 :goto_6
+    goto/16 :goto_2
 .end method
 
 .method final startActivityUncheckedLocked(Lcom/android/server/am/ActivityRecord;Lcom/android/server/am/ActivityRecord;Landroid/service/voice/IVoiceInteractionSession;Lcom/android/internal/app/IVoiceInteractor;IZLandroid/os/Bundle;Lcom/android/server/am/TaskRecord;)I
@@ -16649,6 +16669,16 @@
 
     .end local v11    # "e":Landroid/os/RemoteException;
     :cond_1
+    iget-object v0, p1, Lcom/android/server/am/ActivityRecord;->info:Landroid/content/pm/ActivityInfo;
+
+    iget-object v0, v0, Landroid/content/pm/ActivityInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
+
+    iget-object v1, p1, Lcom/android/server/am/ActivityRecord;->info:Landroid/content/pm/ActivityInfo;
+
+    iget v1, v1, Landroid/content/pm/ActivityInfo;->theme:I
+
+    iput v1, v0, Landroid/content/pm/ApplicationInfo;->nextActivityTheme:I
+
     iget-object v0, p0, Lcom/android/server/am/ActivityStackSupervisor;->mService:Lcom/android/server/am/ActivityManagerService;
 
     iget-object v1, p1, Lcom/android/server/am/ActivityRecord;->processName:Ljava/lang/String;
--- a/services/smali/com/android/server/am/BroadcastQueue.smali
+++ b/services/smali/com/android/server/am/BroadcastQueue.smali
@@ -340,7 +340,7 @@
     move-result v17
 
     .local v17, "perm":I
-    if-eqz v17, :cond_5
+    if-eqz v17, :cond_6
 
     const-string v2, "BroadcastQueue"
 
@@ -511,7 +511,7 @@
     move-result v17
 
     .restart local v17    # "perm":I
-    if-eqz v17, :cond_6
+    if-eqz v17, :cond_7
 
     const-string v2, "BroadcastQueue"
 
@@ -991,6 +991,37 @@
     const/16 v18, 0x1
 
     :cond_4
+    if-nez v18, :cond_5
+
+    move-object/from16 v0, p1
+
+    iget v2, v0, Lcom/android/server/am/BroadcastRecord;->appOp:I
+
+    const/4 v4, -0x1
+
+    if-eq v2, v4, :cond_5
+
+    move-object/from16 v0, p0
+
+    iget-object v2, v0, Lcom/android/server/am/BroadcastQueue;->mService:Lcom/android/server/am/ActivityManagerService;
+
+    move-object/from16 v0, p1
+
+    iget v4, v0, Lcom/android/server/am/BroadcastRecord;->appOp:I
+
+    move-object/from16 v0, p1
+
+    move-object/from16 v1, p2
+
+    invoke-static {v2, v0, v1, v4}, Lcom/android/server/am/BroadcastQueueInjector;->isSkip(Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/BroadcastRecord;Lcom/android/server/am/BroadcastFilter;I)Z
+
+    move-result v2
+
+    if-eqz v2, :cond_5
+
+    const/16 v18, 0x1
+
+    :cond_5
     move-object/from16 v0, p0
 
     iget-object v2, v0, Lcom/android/server/am/BroadcastQueue;->mService:Lcom/android/server/am/ActivityManagerService;
@@ -1023,12 +1054,12 @@
 
     move-result v2
 
-    if-nez v2, :cond_8
+    if-nez v2, :cond_9
 
     return-void
 
     .restart local v17    # "perm":I
-    :cond_5
+    :cond_6
     move-object/from16 v0, p2
 
     iget-object v2, v0, Lcom/android/server/am/BroadcastFilter;->requiredPermission:Ljava/lang/String;
@@ -1181,7 +1212,7 @@
     .end local v16    # "opCode":I
     .restart local v3    # "requiredPermission":Ljava/lang/String;
     .restart local v15    # "i":I
-    :cond_6
+    :cond_7
     invoke-static {v3}, Landroid/app/AppOpsManager;->permissionToOpCode(Ljava/lang/String;)I
 
     move-result v13
@@ -1189,13 +1220,13 @@
     .local v13, "appOp":I
     const/4 v2, -0x1
 
-    if-eq v13, v2, :cond_7
+    if-eq v13, v2, :cond_8
 
     move-object/from16 v0, p1
 
     iget v2, v0, Lcom/android/server/am/BroadcastRecord;->appOp:I
 
-    if-eq v13, v2, :cond_7
+    if-eq v13, v2, :cond_8
 
     move-object/from16 v0, p0
 
@@ -1217,7 +1248,7 @@
 
     move-result v2
 
-    if-eqz v2, :cond_7
+    if-eqz v2, :cond_8
 
     const-string v2, "BroadcastQueue"
 
@@ -1355,7 +1386,7 @@
 
     goto/16 :goto_2
 
-    :cond_7
+    :cond_8
     add-int/lit8 v15, v15, 0x1
 
     goto/16 :goto_1
@@ -1364,14 +1395,14 @@
     .end local v13    # "appOp":I
     .end local v15    # "i":I
     .end local v17    # "perm":I
-    :cond_8
+    :cond_9
     move-object/from16 v0, p2
 
     iget-object v2, v0, Lcom/android/server/am/BroadcastFilter;->receiverList:Lcom/android/server/am/ReceiverList;
 
     iget-object v2, v2, Lcom/android/server/am/ReceiverList;->app:Lcom/android/server/am/ProcessRecord;
 
-    if-eqz v2, :cond_9
+    if-eqz v2, :cond_a
 
     move-object/from16 v0, p2
 
@@ -1381,9 +1412,9 @@
 
     iget-boolean v2, v2, Lcom/android/server/am/ProcessRecord;->crashing:Z
 
-    if-eqz v2, :cond_a
+    if-eqz v2, :cond_b
 
-    :cond_9
+    :cond_a
     const-string v2, "BroadcastQueue"
 
     new-instance v4, Ljava/lang/StringBuilder;
@@ -1444,10 +1475,10 @@
 
     const/16 v18, 0x1
 
-    :cond_a
-    if-nez v18, :cond_c
+    :cond_b
+    if-nez v18, :cond_e
 
-    if-eqz p3, :cond_b
+    if-eqz p3, :cond_c
 
     move-object/from16 v0, p2
 
@@ -1489,7 +1520,7 @@
 
     iget-object v2, v2, Lcom/android/server/am/ReceiverList;->app:Lcom/android/server/am/ProcessRecord;
 
-    if-eqz v2, :cond_b
+    if-eqz v2, :cond_c
 
     move-object/from16 v0, p2
 
@@ -1521,7 +1552,32 @@
 
     invoke-virtual {v2, v4}, Lcom/android/server/am/ActivityManagerService;->updateOomAdjLocked(Lcom/android/server/am/ProcessRecord;)Z
 
-    :cond_b
+    :cond_c
+    move-object/from16 v0, p0
+
+    iget-object v2, v0, Lcom/android/server/am/BroadcastQueue;->mService:Lcom/android/server/am/ActivityManagerService;
+
+    move-object/from16 v0, p2
+
+    iget-object v4, v0, Lcom/android/server/am/BroadcastFilter;->receiverList:Lcom/android/server/am/ReceiverList;
+
+    iget-object v4, v4, Lcom/android/server/am/ReceiverList;->app:Lcom/android/server/am/ProcessRecord;
+
+    const/4 v5, 0x0
+
+    move-object/from16 v0, p0
+
+    move-object/from16 v1, p1
+
+    invoke-static {v0, v2, v1, v4, v5}, Lcom/android/server/am/BroadcastQueueInjector;->checkReceiverAppDealBroadcast(Lcom/android/server/am/BroadcastQueue;Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/BroadcastRecord;Lcom/android/server/am/ProcessRecord;Z)Z
+
+    move-result v2
+
+    if-nez v2, :cond_d
+
+    goto/16 :goto_3
+
+    :cond_d
     :try_start_0
     move-object/from16 v0, p2
 
@@ -1569,7 +1625,7 @@
 
     invoke-static/range {v4 .. v12}, Lcom/android/server/am/BroadcastQueue;->performReceiveLocked(Lcom/android/server/am/ProcessRecord;Landroid/content/IIntentReceiver;Landroid/content/Intent;ILjava/lang/String;Landroid/os/Bundle;ZZI)V
 
-    if-eqz p3, :cond_c
+    if-eqz p3, :cond_e
 
     const/4 v2, 0x3
 
@@ -1579,7 +1635,7 @@
     :try_end_0
     .catch Landroid/os/RemoteException; {:try_start_0 .. :try_end_0} :catch_0
 
-    :cond_c
+    :cond_e
     :goto_3
     return-void
 
@@ -1613,7 +1669,7 @@
 
     invoke-static {v2, v4, v14}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
 
-    if-eqz p3, :cond_c
+    if-eqz p3, :cond_e
 
     const/4 v2, 0x0
 
@@ -1641,7 +1697,7 @@
 
     iget-object v2, v2, Lcom/android/server/am/ReceiverList;->app:Lcom/android/server/am/ProcessRecord;
 
-    if-eqz v2, :cond_c
+    if-eqz v2, :cond_e
 
     move-object/from16 v0, p2
 
@@ -1756,6 +1812,19 @@
 
     iput-object p1, p2, Lcom/android/server/am/ProcessRecord;->curReceiver:Lcom/android/server/am/BroadcastRecord;
 
+    iget-object v0, p0, Lcom/android/server/am/BroadcastQueue;->mService:Lcom/android/server/am/ActivityManagerService;
+
+    const/4 v1, 0x1
+
+    invoke-static {p0, v0, p1, p2, v1}, Lcom/android/server/am/BroadcastQueueInjector;->checkReceiverAppDealBroadcast(Lcom/android/server/am/BroadcastQueue;Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/BroadcastRecord;Lcom/android/server/am/ProcessRecord;Z)Z
+
+    move-result v0
+
+    if-nez v0, :cond_1
+
+    goto :goto_0
+
+    :cond_1
     const/16 v0, 0xb
 
     invoke-virtual {p2, v0}, Lcom/android/server/am/ProcessRecord;->forceProcessStateUpTo(I)V
@@ -1832,7 +1901,7 @@
 
     const/4 v10, 0x1
 
-    if-nez v10, :cond_1
+    if-nez v10, :cond_2
 
     iput-object v11, p1, Lcom/android/server/am/BroadcastRecord;->receiver:Landroid/os/IBinder;
 
@@ -1840,13 +1909,14 @@
 
     iput-object v11, p2, Lcom/android/server/am/ProcessRecord;->curReceiver:Lcom/android/server/am/BroadcastRecord;
 
-    :cond_1
+    :cond_2
+    :goto_0
     return-void
 
     :catchall_0
     move-exception v0
 
-    if-nez v10, :cond_2
+    if-nez v10, :cond_3
 
     iput-object v11, p1, Lcom/android/server/am/BroadcastRecord;->receiver:Landroid/os/IBinder;
 
@@ -1854,7 +1924,7 @@
 
     iput-object v11, p2, Lcom/android/server/am/ProcessRecord;->curReceiver:Lcom/android/server/am/BroadcastRecord;
 
-    :cond_2
+    :cond_3
     throw v0
 .end method
 
@@ -5226,7 +5296,7 @@
     move-result v37
 
     .local v37, "perm":I
-    if-eqz v37, :cond_1d
+    if-eqz v37, :cond_1e
 
     move-object/from16 v0, v27
 
@@ -5234,7 +5304,7 @@
 
     iget-boolean v4, v4, Landroid/content/pm/ActivityInfo;->exported:Z
 
-    if-nez v4, :cond_1c
+    if-nez v4, :cond_1d
 
     const-string v4, "BroadcastQueue"
 
@@ -5437,7 +5507,7 @@
     move-result v37
 
     :goto_a
-    if-eqz v37, :cond_1e
+    if-eqz v37, :cond_1f
 
     :try_start_b
     const-string v4, "BroadcastQueue"
@@ -5669,6 +5739,37 @@
     :cond_17
     if-nez v43, :cond_18
 
+    move-object/from16 v0, v39
+
+    iget v4, v0, Lcom/android/server/am/BroadcastRecord;->appOp:I
+
+    const/4 v6, -0x1
+
+    if-eq v4, v6, :cond_18
+
+    move-object/from16 v0, p0
+
+    iget-object v4, v0, Lcom/android/server/am/BroadcastQueue;->mService:Lcom/android/server/am/ActivityManagerService;
+
+    move-object/from16 v0, v39
+
+    iget v6, v0, Lcom/android/server/am/BroadcastRecord;->appOp:I
+
+    move-object/from16 v0, v39
+
+    move-object/from16 v1, v27
+
+    invoke-static {v4, v0, v1, v6}, Lcom/android/server/am/BroadcastQueueInjector;->isSkip(Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/BroadcastRecord;Landroid/content/pm/ResolveInfo;I)Z
+
+    move-result v4
+
+    if-eqz v4, :cond_18
+
+    const/16 v43, 0x1
+
+    :cond_18
+    if-nez v43, :cond_19
+
     move-object/from16 v0, p0
 
     iget-object v4, v0, Lcom/android/server/am/BroadcastQueue;->mService:Lcom/android/server/am/ActivityManagerService;
@@ -5705,11 +5806,11 @@
 
     move-result v4
 
-    if-eqz v4, :cond_20
+    if-eqz v4, :cond_21
 
     const/16 v43, 0x0
 
-    :cond_18
+    :cond_19
     :goto_c
     const/16 v30, 0x0
 
@@ -5763,7 +5864,7 @@
 
     and-int/2addr v4, v6
 
-    if-eqz v4, :cond_19
+    if-eqz v4, :cond_1a
 
     const-string v4, "android.permission.INTERACT_ACROSS_USERS"
 
@@ -5779,7 +5880,7 @@
 
     move-result v4
 
-    if-eqz v4, :cond_19
+    if-eqz v4, :cond_1a
 
     const-string v4, "BroadcastQueue"
 
@@ -5821,12 +5922,12 @@
 
     const/16 v43, 0x1
 
-    :cond_19
+    :cond_1a
     move-object/from16 v0, v39
 
     iget-object v4, v0, Lcom/android/server/am/BroadcastRecord;->curApp:Lcom/android/server/am/ProcessRecord;
 
-    if-eqz v4, :cond_1a
+    if-eqz v4, :cond_1b
 
     move-object/from16 v0, v39
 
@@ -5834,7 +5935,7 @@
 
     iget-boolean v4, v4, Lcom/android/server/am/ProcessRecord;->crashing:Z
 
-    if-eqz v4, :cond_1a
+    if-eqz v4, :cond_1b
 
     const-string v4, "BroadcastQueue"
 
@@ -5898,8 +5999,8 @@
 
     const/16 v43, 0x1
 
-    :cond_1a
-    if-nez v43, :cond_1b
+    :cond_1b
+    if-nez v43, :cond_1c
 
     const/16 v28, 0x0
 
@@ -5936,12 +6037,12 @@
 
     .end local v28    # "isAvailable":Z
     :goto_e
-    if-nez v28, :cond_1b
+    if-nez v28, :cond_1c
 
     const/16 v43, 0x1
 
-    :cond_1b
-    if-eqz v43, :cond_21
+    :cond_1c
+    if-eqz v43, :cond_22
 
     const/4 v4, 0x0
 
@@ -5970,7 +6071,7 @@
 
     return-void
 
-    :cond_1c
+    :cond_1d
     :try_start_10
     const-string v4, "BroadcastQueue"
 
@@ -6082,7 +6183,7 @@
 
     goto/16 :goto_7
 
-    :cond_1d
+    :cond_1e
     move-object/from16 v0, v27
 
     iget-object v4, v0, Landroid/content/pm/ResolveInfo;->activityInfo:Landroid/content/pm/ActivityInfo;
@@ -6258,7 +6359,7 @@
     goto/16 :goto_a
 
     .end local v19    # "e":Landroid/os/RemoteException;
-    :cond_1e
+    :cond_1f
     invoke-static/range {v42 .. v42}, Landroid/app/AppOpsManager;->permissionToOpCode(Ljava/lang/String;)I
 
     move-result v16
@@ -6268,7 +6369,7 @@
 
     move/from16 v0, v16
 
-    if-eq v0, v4, :cond_1f
+    if-eq v0, v4, :cond_20
 
     move-object/from16 v0, v39
 
@@ -6276,7 +6377,7 @@
 
     move/from16 v0, v16
 
-    if-eq v0, v4, :cond_1f
+    if-eq v0, v4, :cond_20
 
     move-object/from16 v0, p0
 
@@ -6304,7 +6405,7 @@
 
     move-result v4
 
-    if-eqz v4, :cond_1f
+    if-eqz v4, :cond_20
 
     const-string v4, "BroadcastQueue"
 
@@ -6398,7 +6499,7 @@
 
     goto/16 :goto_b
 
-    :cond_1f
+    :cond_20
     add-int/lit8 v26, v26, 0x1
 
     goto/16 :goto_9
@@ -6406,7 +6507,7 @@
     .end local v16    # "appOp":I
     .end local v26    # "i":I
     .end local v42    # "requiredPermission":Ljava/lang/String;
-    :cond_20
+    :cond_21
     const/16 v43, 0x1
 
     goto/16 :goto_c
@@ -6469,7 +6570,7 @@
 
     .end local v20    # "e":Ljava/lang/Exception;
     .end local v28    # "isAvailable":Z
-    :cond_21
+    :cond_22
     const/4 v4, 0x1
 
     move-object/from16 v0, v39
@@ -6506,9 +6607,9 @@
 
     const/16 v6, 0x3e8
 
-    if-eq v4, v6, :cond_22
+    if-eq v4, v6, :cond_23
 
-    if-eqz v30, :cond_22
+    if-eqz v30, :cond_23
 
     move-object/from16 v0, p0
 
@@ -6524,7 +6625,7 @@
 
     move-result v4
 
-    if-eqz v4, :cond_22
+    if-eqz v4, :cond_23
 
     move-object/from16 v0, p0
 
@@ -6544,7 +6645,7 @@
 
     iput-object v4, v0, Landroid/content/pm/ResolveInfo;->activityInfo:Landroid/content/pm/ActivityInfo;
 
-    :cond_22
+    :cond_23
     move-object/from16 v0, v27
 
     iget-object v4, v0, Landroid/content/pm/ResolveInfo;->activityInfo:Landroid/content/pm/ActivityInfo;
@@ -6553,7 +6654,7 @@
 
     iput-object v4, v0, Lcom/android/server/am/BroadcastRecord;->curReceiver:Landroid/content/pm/ActivityInfo;
 
-    if-eqz v17, :cond_23
+    if-eqz v17, :cond_24
 
     invoke-virtual/range {v17 .. v17}, Landroid/app/BroadcastOptions;->getTemporaryAppWhitelistDuration()J
 
@@ -6563,7 +6664,7 @@
 
     cmp-long v4, v6, v8
 
-    if-lez v4, :cond_23
+    if-lez v4, :cond_24
 
     invoke-virtual/range {v17 .. v17}, Landroid/app/BroadcastOptions;->getTemporaryAppWhitelistDuration()J
 
@@ -6579,7 +6680,7 @@
     :try_end_10
     .catchall {:try_start_10 .. :try_end_10} :catchall_0
 
-    :cond_23
+    :cond_24
     :try_start_11
     invoke-static {}, Landroid/app/AppGlobals;->getPackageManager()Landroid/content/pm/IPackageManager;
 
@@ -6630,13 +6731,13 @@
     move-result-object v15
 
     .local v15, "app":Lcom/android/server/am/ProcessRecord;
-    if-eqz v15, :cond_24
+    if-eqz v15, :cond_25
 
     iget-object v4, v15, Lcom/android/server/am/ProcessRecord;->thread:Landroid/app/IApplicationThread;
     :try_end_12
     .catchall {:try_start_12 .. :try_end_12} :catchall_0
 
-    if-eqz v4, :cond_24
+    if-eqz v4, :cond_25
 
     :try_start_13
     move-object/from16 v0, v27
@@ -6854,7 +6955,49 @@
     invoke-static {v4, v6, v0}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
 
     .end local v19    # "e":Landroid/os/RemoteException;
-    :cond_24
+    :cond_25
+    move-object/from16 v0, p0
+
+    iget-object v4, v0, Lcom/android/server/am/BroadcastQueue;->mService:Lcom/android/server/am/ActivityManagerService;
+
+    move-object/from16 v0, p0
+
+    move-object/from16 v1, v39
+
+    move-object/from16 v2, v27
+
+    invoke-static {v0, v4, v1, v2}, Lcom/android/server/am/BroadcastQueueInjector;->checkApplicationAutoStart(Lcom/android/server/am/BroadcastQueue;Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/BroadcastRecord;Landroid/content/pm/ResolveInfo;)Z
+
+    move-result v4
+
+    if-nez v4, :cond_26
+
+    monitor-exit v45
+
+    return-void
+
+    :cond_26
+    move-object/from16 v0, p0
+
+    iget-object v4, v0, Lcom/android/server/am/BroadcastQueue;->mService:Lcom/android/server/am/ActivityManagerService;
+
+    move-object/from16 v0, p0
+
+    move-object/from16 v1, v39
+
+    move-object/from16 v2, v27
+
+    invoke-static {v0, v4, v1, v2}, Lcom/android/server/am/BroadcastQueueInjector;->processBroadcastHookLocked(Lcom/android/server/am/BroadcastQueue;Lcom/android/server/am/ActivityManagerService;Lcom/android/server/am/BroadcastRecord;Landroid/content/pm/ResolveInfo;)Z
+
+    move-result v4
+
+    if-nez v4, :cond_27
+
+    monitor-exit v45
+
+    return-void
+
+    :cond_27
     move-object/from16 v0, p0
 
     iget-object v4, v0, Lcom/android/server/am/BroadcastQueue;->mService:Lcom/android/server/am/ActivityManagerService;
@@ -6893,7 +7036,7 @@
 
     and-int/2addr v7, v11
 
-    if-eqz v7, :cond_25
+    if-eqz v7, :cond_28
 
     const/4 v11, 0x1
 
@@ -6912,7 +7055,7 @@
 
     iput-object v4, v0, Lcom/android/server/am/BroadcastRecord;->curApp:Lcom/android/server/am/ProcessRecord;
 
-    if-nez v4, :cond_26
+    if-nez v4, :cond_29
 
     const-string v4, "BroadcastQueue"
 
@@ -7026,12 +7169,85 @@
 
     return-void
 
-    :cond_25
+    :cond_28
     const/4 v11, 0x0
 
     goto/16 :goto_10
 
-    :cond_26
+    :cond_29
+    const/16 v6, 0x7578
+
+    const/4 v4, 0x5
+
+    new-array v7, v4, [Ljava/lang/Object;
+
+    const/4 v4, 0x0
+
+    move-object/from16 v0, v39
+
+    iget v8, v0, Lcom/android/server/am/BroadcastRecord;->callingUid:I
+
+    invoke-static {v8}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v8
+
+    aput-object v8, v7, v4
+
+    const/4 v4, 0x1
+
+    move-object/from16 v0, v39
+
+    iget-object v8, v0, Lcom/android/server/am/BroadcastRecord;->callerPackage:Ljava/lang/String;
+
+    aput-object v8, v7, v4
+
+    const/4 v4, 0x2
+
+    move-object/from16 v0, v39
+
+    iget-object v8, v0, Lcom/android/server/am/BroadcastRecord;->intent:Landroid/content/Intent;
+
+    invoke-virtual {v8}, Landroid/content/Intent;->getAction()Ljava/lang/String;
+
+    move-result-object v8
+
+    aput-object v8, v7, v4
+
+    const/4 v4, 0x3
+
+    move-object/from16 v0, v39
+
+    iget-object v8, v0, Lcom/android/server/am/BroadcastRecord;->curApp:Lcom/android/server/am/ProcessRecord;
+
+    iget v8, v8, Lcom/android/server/am/ProcessRecord;->uid:I
+
+    invoke-static {v8}, Ljava/lang/Integer;->valueOf(I)Ljava/lang/Integer;
+
+    move-result-object v8
+
+    aput-object v8, v7, v4
+
+    const/4 v8, 0x4
+
+    move-object/from16 v0, v39
+
+    iget-object v4, v0, Lcom/android/server/am/BroadcastRecord;->curComponent:Landroid/content/ComponentName;
+
+    if-eqz v4, :cond_2a
+
+    move-object/from16 v0, v39
+
+    iget-object v4, v0, Lcom/android/server/am/BroadcastRecord;->curComponent:Landroid/content/ComponentName;
+
+    invoke-virtual {v4}, Landroid/content/ComponentName;->toShortString()Ljava/lang/String;
+
+    move-result-object v4
+
+    :goto_11
+    aput-object v4, v7, v8
+
+    invoke-static {v6, v7}, Landroid/util/EventLog;->writeEvent(I[Ljava/lang/Object;)I
+
     :try_start_16
     move-object/from16 v0, v39
 
@@ -7051,6 +7267,11 @@
 
     return-void
 
+    :cond_2a
+    const-string v4, "--"
+
+    goto :goto_11
+
     .end local v15    # "app":Lcom/android/server/am/ProcessRecord;
     :catch_7
     move-exception v19
--- a/services/smali/com/android/server/am/ServiceRecord$1.smali
+++ b/services/smali/com/android/server/am/ServiceRecord$1.smali
@@ -193,7 +193,17 @@
 
     const/4 v4, 0x0
 
-    invoke-virtual {v2, v3, v4}, Landroid/content/Context;->createPackageContext(Ljava/lang/String;I)Landroid/content/Context;
+    new-instance v5, Landroid/os/UserHandle;
+
+    move-object/from16 v0, p0
+
+    iget-object v6, v0, Lcom/android/server/am/ServiceRecord$1;->this$0:Lcom/android/server/am/ServiceRecord;
+
+    iget v6, v6, Lcom/android/server/am/ServiceRecord;->userId:I
+
+    invoke-direct {v5, v6}, Landroid/os/UserHandle;-><init>(I)V
+
+    invoke-virtual {v2, v3, v4, v5}, Landroid/content/Context;->createPackageContextAsUser(Ljava/lang/String;ILandroid/os/UserHandle;)Landroid/content/Context;
 
     move-result-object v12
 
--- a/services/smali/com/android/server/pm/Installer.smali
+++ b/services/smali/com/android/server/pm/Installer.smali
@@ -261,6 +261,21 @@
 
     invoke-virtual {v0, p3}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
+    invoke-static {p1}, Lcom/android/server/pm/Installer;->escapeNull(Ljava/lang/String;)Ljava/lang/String;
+
+    move-result-object v1
+
+    invoke-static {v1, p3, p2}, Landroid/service/securespaces/SpaceEncryptionManager;->setOpClearUserData(Ljava/lang/String;ILjava/lang/String;)Z
+
+    move-result v1
+
+    if-eqz v1, :cond_0
+
+    const/4 v1, 0x0
+
+    goto :goto_0
+
+    :cond_0
     iget-object v1, p0, Lcom/android/server/pm/Installer;->mInstaller:Lcom/android/internal/os/InstallerConnection;
 
     invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
@@ -271,6 +286,7 @@
 
     move-result v1
 
+    :goto_0
     return v1
 .end method
 
@@ -392,6 +408,17 @@
 
     invoke-virtual {v0, p1}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
+    invoke-static {p1}, Landroid/service/securespaces/SpaceEncryptionManager;->setOpCreateUserConfig(I)Z
+
+    move-result v1
+
+    if-eqz v1, :cond_0
+
+    const/4 v1, 0x0
+
+    goto :goto_0
+
+    :cond_0
     iget-object v1, p0, Lcom/android/server/pm/Installer;->mInstaller:Lcom/android/internal/os/InstallerConnection;
 
     invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
@@ -402,6 +429,7 @@
 
     move-result v1
 
+    :goto_0
     return v1
 .end method
 
@@ -474,12 +502,27 @@
 
     invoke-virtual {v0, v2}, Ljava/lang/StringBuilder;->append(C)Ljava/lang/StringBuilder;
 
-    if-eqz p5, :cond_0
+    if-eqz p5, :cond_1
 
     .end local p5    # "seinfo":Ljava/lang/String;
     :goto_0
     invoke-virtual {v0, p5}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
 
+    invoke-static {p1}, Lcom/android/server/pm/Installer;->escapeNull(Ljava/lang/String;)Ljava/lang/String;
+
+    move-result-object v1
+
+    invoke-static {v1, p4, p2, p3, p5}, Landroid/service/securespaces/SpaceEncryptionManager;->setOpCreateUserData(Ljava/lang/String;ILjava/lang/String;ILjava/lang/String;)Z
+
+    move-result v1
+
+    if-eqz v1, :cond_0
+
+    const/4 v1, 0x0
+
+    goto :goto_1
+
+    :cond_0
     iget-object v1, p0, Lcom/android/server/pm/Installer;->mInstaller:Lcom/android/internal/os/InstallerConnection;
 
     invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
@@ -490,10 +533,11 @@
 
     move-result v1
 
+    :goto_1
     return v1
 
     .restart local p5    # "seinfo":Ljava/lang/String;
-    :cond_0
+    :cond_1
     const-string p5, "!"
 
     goto :goto_0
@@ -548,6 +592,21 @@
 
     invoke-virtual {v0, p3}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
+    invoke-static {p1}, Lcom/android/server/pm/Installer;->escapeNull(Ljava/lang/String;)Ljava/lang/String;
+
+    move-result-object v1
+
+    invoke-static {v1, p3, p2}, Landroid/service/securespaces/SpaceEncryptionManager;->setOpDeleteCacheFiles(Ljava/lang/String;ILjava/lang/String;)Z
+
+    move-result v1
+
+    if-eqz v1, :cond_0
+
+    const/4 v1, 0x0
+
+    goto :goto_0
+
+    :cond_0
     iget-object v1, p0, Lcom/android/server/pm/Installer;->mInstaller:Lcom/android/internal/os/InstallerConnection;
 
     invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
@@ -558,6 +617,7 @@
 
     move-result v1
 
+    :goto_0
     return v1
 .end method
 
@@ -610,6 +670,21 @@
 
     invoke-virtual {v0, p3}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
+    invoke-static {p1}, Lcom/android/server/pm/Installer;->escapeNull(Ljava/lang/String;)Ljava/lang/String;
+
+    move-result-object v1
+
+    invoke-static {v1, p3, p2}, Landroid/service/securespaces/SpaceEncryptionManager;->setOpDeleteCodeCacheFiles(Ljava/lang/String;ILjava/lang/String;)Z
+
+    move-result v1
+
+    if-eqz v1, :cond_0
+
+    const/4 v1, 0x0
+
+    goto :goto_0
+
+    :cond_0
     iget-object v1, p0, Lcom/android/server/pm/Installer;->mInstaller:Lcom/android/internal/os/InstallerConnection;
 
     invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
@@ -620,6 +695,7 @@
 
     move-result v1
 
+    :goto_0
     return v1
 .end method
 
@@ -1546,6 +1622,21 @@
 
     invoke-virtual {v0, p4}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
+    invoke-static {p1}, Lcom/android/server/pm/Installer;->escapeNull(Ljava/lang/String;)Ljava/lang/String;
+
+    move-result-object v1
+
+    invoke-static {v1, p4, p2, p3}, Landroid/service/securespaces/SpaceEncryptionManager;->setOpLinkNativeLibraryDir(Ljava/lang/String;ILjava/lang/String;Ljava/lang/String;)Z
+
+    move-result v1
+
+    if-eqz v1, :cond_2
+
+    const/4 v1, 0x0
+
+    return v1
+
+    :cond_2
     iget-object v1, p0, Lcom/android/server/pm/Installer;->mInstaller:Lcom/android/internal/os/InstallerConnection;
 
     invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
@@ -1778,6 +1869,21 @@
 
     invoke-virtual {v0, p3}, Ljava/lang/StringBuilder;->append(I)Ljava/lang/StringBuilder;
 
+    invoke-static {p1}, Lcom/android/server/pm/Installer;->escapeNull(Ljava/lang/String;)Ljava/lang/String;
+
+    move-result-object v1
+
+    invoke-static {v1, p3, p2}, Landroid/service/securespaces/SpaceEncryptionManager;->setOpRemove(Ljava/lang/String;ILjava/lang/String;)Z
+
+    move-result v1
+
+    if-eqz v1, :cond_0
+
+    const/4 v1, 0x0
+
+    goto :goto_0
+
+    :cond_0
     iget-object v1, p0, Lcom/android/server/pm/Installer;->mInstaller:Lcom/android/internal/os/InstallerConnection;
 
     invoke-virtual {v0}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
@@ -1788,6 +1894,7 @@
 
     move-result v1
 
+    :goto_0
     return v1
 .end method
 
--- a/services/smali/com/android/server/pm/PackageManagerService$PackageHandler.smali
+++ b/services/smali/com/android/server/pm/PackageManagerService$PackageHandler.smali
@@ -1132,6 +1132,12 @@
 
     invoke-static {v2, v3, v5, v7}, Lcom/android/server/pm/PackageManagerService;->-wrap27(Lcom/android/server/pm/PackageManagerService;Landroid/content/pm/PackageParser$Package;I[Ljava/lang/String;)V
 
+    const-string v2, "grant_runtime_permissions"
+
+    const/4 v3, 0x1
+
+    invoke-virtual {v6, v2, v3}, Landroid/os/Bundle;->putBoolean(Ljava/lang/String;Z)V
+
     :cond_16
     const/4 v2, 0x0
 
@@ -1837,8 +1843,6 @@
 
     const/4 v7, 0x1
 
-    invoke-virtual {v2, v3, v5, v7}, Landroid/app/AppOpsManager;->setPrivacyGuardSettingForPackage(ILjava/lang/String;Z)V
-
     goto/16 :goto_f
 
     .end local v42    # "privacyGuard":Z
@@ -2745,6 +2749,8 @@
 
     goto/16 :goto_0
 
+    nop
+
     :pswitch_data_0
     .packed-switch 0x1
         :pswitch_6
@@ -2769,25 +2775,48 @@
 .end method
 
 .method public handleMessage(Landroid/os/Message;)V
-    .locals 2
+    .locals 3
     .param p1, "msg"    # Landroid/os/Message;
 
     .prologue
-    const/16 v1, 0xa
+    const/16 v2, 0xa
 
     :try_start_0
-    invoke-virtual {p0, p1}, Lcom/android/server/pm/PackageManagerService$PackageHandler;->doHandleMessage(Landroid/os/Message;)V
+    iget-object v0, p0, Lcom/android/server/pm/PackageManagerService$PackageHandler;->this$0:Lcom/android/server/pm/PackageManagerService;
+
+    iget-object v0, v0, Lcom/android/server/pm/PackageManagerService;->mContext:Landroid/content/Context;
+
+    iget-object v1, p0, Lcom/android/server/pm/PackageManagerService$PackageHandler;->this$0:Lcom/android/server/pm/PackageManagerService;
+
+    iget-boolean v1, v1, Lcom/android/server/pm/PackageManagerService;->mSystemReady:Z
+
+    invoke-static {v0, p1, v1}, Lcom/android/server/pm/PackageManagerServiceInjector;->checkApk(Landroid/content/Context;Landroid/os/Message;Z)Z
     :try_end_0
     .catchall {:try_start_0 .. :try_end_0} :catchall_0
 
-    invoke-static {v1}, Landroid/os/Process;->setThreadPriority(I)V
+    move-result v0
+
+    if-nez v0, :cond_0
 
+    invoke-static {v2}, Landroid/os/Process;->setThreadPriority(I)V
+
+    :goto_0
     return-void
 
+    :cond_0
+    :try_start_1
+    invoke-virtual {p0, p1}, Lcom/android/server/pm/PackageManagerService$PackageHandler;->doHandleMessage(Landroid/os/Message;)V
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_0
+
+    invoke-static {v2}, Landroid/os/Process;->setThreadPriority(I)V
+
+    goto :goto_0
+
     :catchall_0
     move-exception v0
 
-    invoke-static {v1}, Landroid/os/Process;->setThreadPriority(I)V
+    invoke-static {v2}, Landroid/os/Process;->setThreadPriority(I)V
 
     throw v0
 .end method
--- a/services/smali/com/android/server/pm/PackageManagerService$deleteApplicationCacheFiles.smali
+++ b/services/smali/com/android/server/pm/PackageManagerService$deleteApplicationCacheFiles.smali
@@ -0,0 +1,132 @@
+.class Lcom/android/server/pm/PackageManagerService$deleteApplicationCacheFiles;
+.super Ljava/lang/Object;
+.source "PackageManagerService.java"
+
+# interfaces
+.implements Ljava/lang/Runnable;
+
+
+# annotations
+.annotation system Ldalvik/annotation/EnclosingMethod;
+    value = Lcom/android/server/pm/PackageManagerService;->deleteApplicationCacheFilesForUser(Ljava/lang/String;ILandroid/content/pm/IPackageDataObserver;)V
+.end annotation
+
+.annotation system Ldalvik/annotation/InnerClass;
+    accessFlags = 0x0
+    name = null
+.end annotation
+
+
+# instance fields
+.field final synthetic this$0:Lcom/android/server/pm/PackageManagerService;
+
+.field final synthetic val$observer:Landroid/content/pm/IPackageDataObserver;
+
+.field final synthetic val$packageName:Ljava/lang/String;
+
+.field final synthetic val$userId:I
+
+
+# direct methods
+.method constructor <init>(Lcom/android/server/pm/PackageManagerService;Ljava/lang/String;ILandroid/content/pm/IPackageDataObserver;)V
+    .locals 0
+
+    .prologue
+    iput-object p1, p0, Lcom/android/server/pm/PackageManagerService$deleteApplicationCacheFiles;->this$0:Lcom/android/server/pm/PackageManagerService;
+
+    iput-object p2, p0, Lcom/android/server/pm/PackageManagerService$deleteApplicationCacheFiles;->val$packageName:Ljava/lang/String;
+
+    iput p3, p0, Lcom/android/server/pm/PackageManagerService$deleteApplicationCacheFiles;->val$userId:I
+
+    iput-object p4, p0, Lcom/android/server/pm/PackageManagerService$deleteApplicationCacheFiles;->val$observer:Landroid/content/pm/IPackageDataObserver;
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public run()V
+    .locals 6
+
+    .prologue
+    iget-object v2, p0, Lcom/android/server/pm/PackageManagerService$deleteApplicationCacheFiles;->this$0:Lcom/android/server/pm/PackageManagerService;
+
+    iget-object v2, v2, Lcom/android/server/pm/PackageManagerService;->mHandler:Lcom/android/server/pm/PackageManagerService$PackageHandler;
+
+    invoke-virtual {v2, p0}, Lcom/android/server/pm/PackageManagerService$PackageHandler;->removeCallbacks(Ljava/lang/Runnable;)V
+
+    iget-object v2, p0, Lcom/android/server/pm/PackageManagerService$deleteApplicationCacheFiles;->this$0:Lcom/android/server/pm/PackageManagerService;
+
+    iget-object v3, v2, Lcom/android/server/pm/PackageManagerService;->mInstallLock:Ljava/lang/Object;
+
+    monitor-enter v3
+
+    :try_start_0
+    iget-object v2, p0, Lcom/android/server/pm/PackageManagerService$deleteApplicationCacheFiles;->this$0:Lcom/android/server/pm/PackageManagerService;
+
+    iget-object v4, p0, Lcom/android/server/pm/PackageManagerService$deleteApplicationCacheFiles;->val$packageName:Ljava/lang/String;
+
+    iget v5, p0, Lcom/android/server/pm/PackageManagerService$deleteApplicationCacheFiles;->val$userId:I
+
+    invoke-static {v2, v4, v5}, Lcom/android/server/pm/PackageManagerService;->-wrap2(Lcom/android/server/pm/PackageManagerService;Ljava/lang/String;I)Z
+
+    move-result v1
+
+    .local v1, "succeded":Z
+    monitor-exit v3
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+
+    iget-object v2, p0, Lcom/android/server/pm/PackageManagerService$deleteApplicationCacheFiles;->this$0:Lcom/android/server/pm/PackageManagerService;
+
+    iget-object v3, p0, Lcom/android/server/pm/PackageManagerService$deleteApplicationCacheFiles;->val$packageName:Ljava/lang/String;
+
+    iget v4, p0, Lcom/android/server/pm/PackageManagerService$deleteApplicationCacheFiles;->val$userId:I
+
+    const/4 v5, 0x0
+
+    invoke-static {v2, v3, v4, v5}, Lcom/android/server/pm/PackageManagerService;->-wrap24(Lcom/android/server/pm/PackageManagerService;Ljava/lang/String;IZ)V
+
+    iget-object v2, p0, Lcom/android/server/pm/PackageManagerService$deleteApplicationCacheFiles;->val$observer:Landroid/content/pm/IPackageDataObserver;
+
+    if-eqz v2, :cond_0
+
+    :try_start_1
+    iget-object v2, p0, Lcom/android/server/pm/PackageManagerService$deleteApplicationCacheFiles;->val$observer:Landroid/content/pm/IPackageDataObserver;
+
+    iget-object v3, p0, Lcom/android/server/pm/PackageManagerService$deleteApplicationCacheFiles;->val$packageName:Ljava/lang/String;
+
+    invoke-interface {v2, v3, v1}, Landroid/content/pm/IPackageDataObserver;->onRemoveCompleted(Ljava/lang/String;Z)V
+    :try_end_1
+    .catch Landroid/os/RemoteException; {:try_start_1 .. :try_end_1} :catch_0
+
+    :cond_0
+    :goto_0
+    return-void
+
+    .end local v1    # "succeded":Z
+    :catchall_0
+    move-exception v2
+
+    :try_start_2
+    monitor-exit v3
+    :try_end_2
+    .catchall {:try_start_2 .. :try_end_2} :catchall_0
+
+    throw v2
+
+    .restart local v1    # "succeded":Z
+    :catch_0
+    move-exception v0
+
+    .local v0, "e":Landroid/os/RemoteException;
+    const-string v2, "PackageManager"
+
+    const-string v3, "Observer no longer exists."
+
+    invoke-static {v2, v3}, Landroid/util/Log;->i(Ljava/lang/String;Ljava/lang/String;)I
+
+    goto :goto_0
+.end method
--- a/services/smali/com/android/server/pm/PackageManagerService$processPackageManagerQueue.smali
+++ b/services/smali/com/android/server/pm/PackageManagerService$processPackageManagerQueue.smali
@@ -0,0 +1,65 @@
+.class Lcom/android/server/pm/PackageManagerService$processPackageManagerQueue;
+.super Ljava/lang/Object;
+.source "PackageManagerService.java"
+
+# interfaces
+.implements Ljava/lang/Runnable;
+
+
+# annotations
+.annotation system Ldalvik/annotation/EnclosingMethod;
+    value = Lcom/android/server/pm/PackageManagerService;->processPackageManagerQueue(ILcom/android/server/securespaces/PackageManagerQueue;)V
+.end annotation
+
+.annotation system Ldalvik/annotation/InnerClass;
+    accessFlags = 0x0
+    name = null
+.end annotation
+
+
+# instance fields
+.field final synthetic this$0:Lcom/android/server/pm/PackageManagerService;
+
+.field final synthetic val$packageManagerQueue:Lcom/android/server/securespaces/PackageManagerQueue;
+
+.field final synthetic val$userId:I
+
+
+# direct methods
+.method constructor <init>(Lcom/android/server/pm/PackageManagerService;Lcom/android/server/securespaces/PackageManagerQueue;I)V
+    .locals 0
+
+    .prologue
+    iput-object p1, p0, Lcom/android/server/pm/PackageManagerService$processPackageManagerQueue;->this$0:Lcom/android/server/pm/PackageManagerService;
+
+    iput-object p2, p0, Lcom/android/server/pm/PackageManagerService$processPackageManagerQueue;->val$packageManagerQueue:Lcom/android/server/securespaces/PackageManagerQueue;
+
+    iput p3, p0, Lcom/android/server/pm/PackageManagerService$processPackageManagerQueue;->val$userId:I
+
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+
+    return-void
+.end method
+
+
+# virtual methods
+.method public run()V
+    .locals 4
+
+    .prologue
+    iget-object v0, p0, Lcom/android/server/pm/PackageManagerService$processPackageManagerQueue;->val$packageManagerQueue:Lcom/android/server/securespaces/PackageManagerQueue;
+
+    iget-object v1, p0, Lcom/android/server/pm/PackageManagerService$processPackageManagerQueue;->this$0:Lcom/android/server/pm/PackageManagerService;
+
+    iget-object v1, v1, Lcom/android/server/pm/PackageManagerService;->mInstaller:Lcom/android/server/pm/Installer;
+
+    iget-object v2, p0, Lcom/android/server/pm/PackageManagerService$processPackageManagerQueue;->this$0:Lcom/android/server/pm/PackageManagerService;
+
+    iget-object v2, v2, Lcom/android/server/pm/PackageManagerService;->mInstallLock:Ljava/lang/Object;
+
+    iget v3, p0, Lcom/android/server/pm/PackageManagerService$processPackageManagerQueue;->val$userId:I
+
+    invoke-virtual {v0, v1, v2, v3}, Lcom/android/server/securespaces/PackageManagerQueue;->processQueue(Lcom/android/server/pm/Installer;Ljava/lang/Object;I)V
+
+    return-void
+.end method
--- a/services/smali/com/android/server/pm/PackageManagerService.smali
+++ b/services/smali/com/android/server/pm/PackageManagerService.smali
@@ -1863,6 +1863,14 @@
 
     move-object/from16 v0, p0
 
+    iget-object v2, v0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
+
+    const/4 v4, 0x1
+
+    invoke-static {v2, v4}, Lcom/android/server/pm/PackageManagerServiceInjector;->addMiuiSharedUids(Lcom/android/server/pm/Settings;Z)V
+
+    move-object/from16 v0, p0
+
     iget-boolean v2, v0, Lcom/android/server/pm/PackageManagerService;->mLazyDexOpt:Z
 
     if-eqz v2, :cond_5
@@ -2903,6 +2911,32 @@
 
     move-result-object v2
 
+    const-string v4, "/framework-miui-res.apk"
+
+    invoke-virtual {v2, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v2
+
+    invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v2
+
+    move-object/from16 v0, v30
+
+    invoke-virtual {v0, v2}, Landroid/util/ArraySet;->add(Ljava/lang/Object;)Z
+
+    new-instance v2, Ljava/lang/StringBuilder;
+
+    invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
+
+    invoke-virtual/range {v51 .. v51}, Ljava/io/File;->getPath()Ljava/lang/String;
+
+    move-result-object v4
+
+    invoke-virtual {v2, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v2
+
     const-string v4, "/core-libart.jar"
 
     invoke-virtual {v2, v4}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
@@ -3648,6 +3682,8 @@
 
     invoke-interface/range {v67 .. v67}, Ljava/util/Iterator;->remove()V
 
+    invoke-static/range {v66 .. v66}, Lcom/android/server/pm/PackageManagerServiceInjector;->removePackageFromSharedUser(Lcom/android/server/pm/PackageSetting;)V
+
     new-instance v2, Ljava/lang/StringBuilder;
 
     invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
@@ -3783,6 +3819,14 @@
 
     iget-object v2, v0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
 
+    move-object/from16 v0, p0
+
+    invoke-static {v0, v2}, Lcom/android/server/pm/PackageManagerServiceInjector;->performPreinstallApp(Lcom/android/server/pm/PackageManagerService;Lcom/android/server/pm/Settings;)V
+
+    move-object/from16 v0, p0
+
+    iget-object v2, v0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
+
     invoke-virtual {v2}, Lcom/android/server/pm/Settings;->pruneSharedUsersLPw()V
 
     move-object/from16 v0, p0
@@ -5465,7 +5509,7 @@
 .end method
 
 .method private adjustCpuAbisForSharedUserLPw(Ljava/util/Set;Landroid/content/pm/PackageParser$Package;ZZZ)V
-    .locals 16
+    .locals 0
     .param p2, "scannedPackage"    # Landroid/content/pm/PackageParser$Package;
     .param p3, "forceDexOpt"    # Z
     .param p4, "deferDexOpt"    # Z
@@ -5484,357 +5528,8 @@
 
     .prologue
     .local p1, "packagesForUser":Ljava/util/Set;, "Ljava/util/Set<Lcom/android/server/pm/PackageSetting;>;"
-    const/4 v13, 0x0
-
-    .local v13, "requiredInstructionSet":Ljava/lang/String;
-    if-eqz p2, :cond_0
-
-    move-object/from16 v0, p2
-
-    iget-object v1, v0, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
-
-    iget-object v1, v1, Landroid/content/pm/ApplicationInfo;->primaryCpuAbi:Ljava/lang/String;
-
-    if-eqz v1, :cond_0
-
-    move-object/from16 v0, p2
-
-    iget-object v1, v0, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
-
-    iget-object v1, v1, Landroid/content/pm/ApplicationInfo;->primaryCpuAbi:Ljava/lang/String;
-
-    invoke-static {v1}, Ldalvik/system/VMRuntime;->getInstructionSet(Ljava/lang/String;)Ljava/lang/String;
-
-    move-result-object v13
-
-    .end local v13    # "requiredInstructionSet":Ljava/lang/String;
-    :cond_0
-    const/4 v14, 0x0
-
-    .local v14, "requirer":Lcom/android/server/pm/PackageSetting;
-    invoke-interface/range {p1 .. p1}, Ljava/lang/Iterable;->iterator()Ljava/util/Iterator;
-
-    move-result-object v12
-
-    .end local v14    # "requirer":Lcom/android/server/pm/PackageSetting;
-    .local v12, "ps$iterator":Ljava/util/Iterator;
-    :cond_1
-    :goto_0
-    invoke-interface {v12}, Ljava/util/Iterator;->hasNext()Z
-
-    move-result v1
-
-    if-eqz v1, :cond_6
-
-    invoke-interface {v12}, Ljava/util/Iterator;->next()Ljava/lang/Object;
-
-    move-result-object v11
-
-    check-cast v11, Lcom/android/server/pm/PackageSetting;
-
-    .local v11, "ps":Lcom/android/server/pm/PackageSetting;
-    if-eqz p2, :cond_2
-
-    move-object/from16 v0, p2
-
-    iget-object v1, v0, Landroid/content/pm/PackageParser$Package;->packageName:Ljava/lang/String;
-
-    iget-object v2, v11, Lcom/android/server/pm/PackageSetting;->name:Ljava/lang/String;
-
-    invoke-virtual {v1, v2}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
-
-    move-result v1
-
-    if-nez v1, :cond_1
-
-    :cond_2
-    iget-object v1, v11, Lcom/android/server/pm/PackageSetting;->primaryCpuAbiString:Ljava/lang/String;
-
-    if-eqz v1, :cond_1
-
-    iget-object v1, v11, Lcom/android/server/pm/PackageSetting;->primaryCpuAbiString:Ljava/lang/String;
-
-    invoke-static {v1}, Ldalvik/system/VMRuntime;->getInstructionSet(Ljava/lang/String;)Ljava/lang/String;
-
-    move-result-object v10
-
-    .local v10, "instructionSet":Ljava/lang/String;
-    if-eqz v13, :cond_3
-
-    invoke-virtual {v10, v13}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
-
-    move-result v1
-
-    if-eqz v1, :cond_4
-
-    :cond_3
-    :goto_1
-    if-nez v13, :cond_1
-
-    move-object v13, v10
-
-    .local v13, "requiredInstructionSet":Ljava/lang/String;
-    move-object v14, v11
-
-    .local v14, "requirer":Lcom/android/server/pm/PackageSetting;
-    goto :goto_0
-
-    .end local v13    # "requiredInstructionSet":Ljava/lang/String;
-    .end local v14    # "requirer":Lcom/android/server/pm/PackageSetting;
-    :cond_4
-    new-instance v1, Ljava/lang/StringBuilder;
-
-    invoke-direct {v1}, Ljava/lang/StringBuilder;-><init>()V
-
-    const-string v2, "Instruction set mismatch, "
-
-    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
-
-    move-result-object v2
-
-    if-nez v14, :cond_5
-
-    const-string v1, "[caller]"
-
-    :goto_2
-    invoke-virtual {v2, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/Object;)Ljava/lang/StringBuilder;
-
-    move-result-object v1
-
-    const-string v2, " requires "
-
-    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
-
-    move-result-object v1
-
-    invoke-virtual {v1, v13}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
-
-    move-result-object v1
-
-    const-string v2, " whereas "
-
-    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
-
-    move-result-object v1
-
-    invoke-virtual {v1, v11}, Ljava/lang/StringBuilder;->append(Ljava/lang/Object;)Ljava/lang/StringBuilder;
-
-    move-result-object v1
-
-    const-string v2, " requires "
-
-    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
-
-    move-result-object v1
-
-    invoke-virtual {v1, v10}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
-
-    move-result-object v1
-
-    invoke-virtual {v1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
-
-    move-result-object v9
-
-    .local v9, "errorMessage":Ljava/lang/String;
-    const-string v1, "PackageManager"
-
-    invoke-static {v1, v9}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
-
-    goto :goto_1
-
-    .end local v9    # "errorMessage":Ljava/lang/String;
-    :cond_5
-    move-object v1, v14
-
-    goto :goto_2
-
-    .end local v10    # "instructionSet":Ljava/lang/String;
-    .end local v11    # "ps":Lcom/android/server/pm/PackageSetting;
-    :cond_6
-    if-eqz v13, :cond_c
-
-    if-eqz v14, :cond_a
-
-    iget-object v8, v14, Lcom/android/server/pm/PackageSetting;->primaryCpuAbiString:Ljava/lang/String;
-
-    .local v8, "adjustedAbi":Ljava/lang/String;
-    if-eqz p2, :cond_7
-
-    move-object/from16 v0, p2
-
-    iget-object v1, v0, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
-
-    iput-object v8, v1, Landroid/content/pm/ApplicationInfo;->primaryCpuAbi:Ljava/lang/String;
-
-    :cond_7
-    :goto_3
-    invoke-interface/range {p1 .. p1}, Ljava/lang/Iterable;->iterator()Ljava/util/Iterator;
-
-    move-result-object v12
-
-    :cond_8
-    :goto_4
-    invoke-interface {v12}, Ljava/util/Iterator;->hasNext()Z
-
-    move-result v1
-
-    if-eqz v1, :cond_c
-
-    invoke-interface {v12}, Ljava/util/Iterator;->next()Ljava/lang/Object;
-
-    move-result-object v11
-
-    check-cast v11, Lcom/android/server/pm/PackageSetting;
-
-    .restart local v11    # "ps":Lcom/android/server/pm/PackageSetting;
-    if-eqz p2, :cond_9
-
-    move-object/from16 v0, p2
-
-    iget-object v1, v0, Landroid/content/pm/PackageParser$Package;->packageName:Ljava/lang/String;
-
-    iget-object v2, v11, Lcom/android/server/pm/PackageSetting;->name:Ljava/lang/String;
-
-    invoke-virtual {v1, v2}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
-
-    move-result v1
-
-    if-nez v1, :cond_8
-
-    :cond_9
-    iget-object v1, v11, Lcom/android/server/pm/PackageSetting;->primaryCpuAbiString:Ljava/lang/String;
-
-    if-nez v1, :cond_8
-
-    iput-object v8, v11, Lcom/android/server/pm/PackageSetting;->primaryCpuAbiString:Ljava/lang/String;
-
-    iget-object v1, v11, Lcom/android/server/pm/PackageSetting;->pkg:Landroid/content/pm/PackageParser$Package;
-
-    if-eqz v1, :cond_8
-
-    iget-object v1, v11, Lcom/android/server/pm/PackageSetting;->pkg:Landroid/content/pm/PackageParser$Package;
-
-    iget-object v1, v1, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
-
-    if-eqz v1, :cond_8
-
-    iget-object v1, v11, Lcom/android/server/pm/PackageSetting;->pkg:Landroid/content/pm/PackageParser$Package;
-
-    iget-object v1, v1, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
-
-    iput-object v8, v1, Landroid/content/pm/ApplicationInfo;->primaryCpuAbi:Ljava/lang/String;
-
-    const-string v1, "PackageManager"
-
-    new-instance v2, Ljava/lang/StringBuilder;
-
-    invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
-
-    const-string v3, "Adjusting ABI for : "
-
-    invoke-virtual {v2, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
-
-    move-result-object v2
-
-    iget-object v3, v11, Lcom/android/server/pm/PackageSetting;->name:Ljava/lang/String;
-
-    invoke-virtual {v2, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
-
-    move-result-object v2
-
-    const-string v3, " to "
-
-    invoke-virtual {v2, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
-
-    move-result-object v2
-
-    invoke-virtual {v2, v8}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
-
-    move-result-object v2
-
-    invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+    invoke-static/range {p0 .. p5}, Lcom/android/server/pm/PackageManagerServiceInjector;->adjustCpuAbisForSharedUserLPw(Lcom/android/server/pm/PackageManagerService;Ljava/util/Set;Landroid/content/pm/PackageParser$Package;ZZZ)V
 
-    move-result-object v2
-
-    invoke-static {v1, v2}, Landroid/util/Slog;->i(Ljava/lang/String;Ljava/lang/String;)I
-
-    move-object/from16 v0, p0
-
-    iget-object v1, v0, Lcom/android/server/pm/PackageManagerService;->mPackageDexOptimizer:Lcom/android/server/pm/PackageDexOptimizer;
-
-    iget-object v2, v11, Lcom/android/server/pm/PackageSetting;->pkg:Landroid/content/pm/PackageParser$Package;
-
-    const/4 v3, 0x0
-
-    const/4 v6, 0x1
-
-    move/from16 v4, p3
-
-    move/from16 v5, p4
-
-    move/from16 v7, p5
-
-    invoke-virtual/range {v1 .. v7}, Lcom/android/server/pm/PackageDexOptimizer;->performDexOpt(Landroid/content/pm/PackageParser$Package;[Ljava/lang/String;ZZZZ)I
-
-    move-result v15
-
-    .local v15, "result":I
-    const/4 v1, -0x1
-
-    if-ne v15, v1, :cond_b
-
-    const/4 v1, 0x0
-
-    iput-object v1, v11, Lcom/android/server/pm/PackageSetting;->primaryCpuAbiString:Ljava/lang/String;
-
-    iget-object v1, v11, Lcom/android/server/pm/PackageSetting;->pkg:Landroid/content/pm/PackageParser$Package;
-
-    iget-object v1, v1, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
-
-    const/4 v2, 0x0
-
-    iput-object v2, v1, Landroid/content/pm/ApplicationInfo;->primaryCpuAbi:Ljava/lang/String;
-
-    return-void
-
-    .end local v8    # "adjustedAbi":Ljava/lang/String;
-    .end local v11    # "ps":Lcom/android/server/pm/PackageSetting;
-    .end local v15    # "result":I
-    :cond_a
-    move-object/from16 v0, p2
-
-    iget-object v1, v0, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
-
-    iget-object v8, v1, Landroid/content/pm/ApplicationInfo;->primaryCpuAbi:Ljava/lang/String;
-
-    .restart local v8    # "adjustedAbi":Ljava/lang/String;
-    goto/16 :goto_3
-
-    .restart local v11    # "ps":Lcom/android/server/pm/PackageSetting;
-    .restart local v15    # "result":I
-    :cond_b
-    move-object/from16 v0, p0
-
-    iget-object v1, v0, Lcom/android/server/pm/PackageManagerService;->mInstaller:Lcom/android/server/pm/Installer;
-
-    iget-object v2, v11, Lcom/android/server/pm/PackageSetting;->codePathString:Ljava/lang/String;
-
-    invoke-static {}, Lcom/android/server/pm/InstructionSets;->getPreferredInstructionSet()Ljava/lang/String;
-
-    move-result-object v3
-
-    invoke-static {v3}, Lcom/android/server/pm/InstructionSets;->getDexCodeInstructionSet(Ljava/lang/String;)Ljava/lang/String;
-
-    move-result-object v3
-
-    invoke-virtual {v1, v2, v3}, Lcom/android/server/pm/Installer;->rmdex(Ljava/lang/String;Ljava/lang/String;)I
-
-    goto/16 :goto_4
-
-    .end local v8    # "adjustedAbi":Ljava/lang/String;
-    .end local v11    # "ps":Lcom/android/server/pm/PackageSetting;
-    .end local v15    # "result":I
-    :cond_c
     return-void
 .end method
 
@@ -6929,8 +6624,56 @@
     .local v11, "N":I
     const/4 v1, 0x1
 
-    if-ne v11, v1, :cond_0
+    if-ne v11, v1, :cond_3
+
+    invoke-virtual/range {p1 .. p1}, Landroid/content/Intent;->getComponent()Landroid/content/ComponentName;
+
+    move-result-object v1
+
+    if-nez v1, :cond_2
+
+    const-string v1, "http"
+
+    invoke-virtual/range {p1 .. p1}, Landroid/content/Intent;->getScheme()Ljava/lang/String;
+
+    move-result-object v2
+
+    invoke-virtual {v1, v2}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v1
+
+    if-nez v1, :cond_0
+
+    const-string v1, "https"
+
+    invoke-virtual/range {p1 .. p1}, Landroid/content/Intent;->getScheme()Ljava/lang/String;
+
+    move-result-object v2
+
+    invoke-virtual {v1, v2}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v1
+
+    if-eqz v1, :cond_2
+
+    :cond_0
+    invoke-static/range {p0 .. p5}, Lcom/android/server/pm/PackageManagerServiceInjector;->checkMiuiIntent(Lcom/android/server/pm/PackageManagerService;Landroid/content/Intent;Ljava/lang/String;ILjava/util/List;I)Landroid/content/pm/ResolveInfo;
+
+    move-result-object v14
+
+    .local v14, "ri":Landroid/content/pm/ResolveInfo;
+    iget-object v1, p0, Lcom/android/server/pm/PackageManagerService;->mResolveInfo:Landroid/content/pm/ResolveInfo;
+
+    if-eq v14, v1, :cond_2
+
+    .end local v11    # "N":I
+    .end local v14    # "ri":Landroid/content/pm/ResolveInfo;
+    :cond_1
+    :goto_0
+    return-object v14
 
+    .restart local v11    # "N":I
+    :cond_2
     const/4 v1, 0x0
 
     move-object/from16 v0, p4
@@ -6941,12 +6684,14 @@
 
     check-cast v1, Landroid/content/pm/ResolveInfo;
 
-    return-object v1
+    move-object v14, v1
 
-    :cond_0
+    goto :goto_0
+
+    :cond_3
     const/4 v1, 0x1
 
-    if-le v11, v1, :cond_8
+    if-le v11, v1, :cond_a
 
     invoke-virtual/range {p1 .. p1}, Landroid/content/Intent;->getFlags()I
 
@@ -6954,12 +6699,12 @@
 
     and-int/lit8 v1, v1, 0x8
 
-    if-eqz v1, :cond_3
+    if-eqz v1, :cond_6
 
     const/4 v9, 0x1
 
     .local v9, "debug":Z
-    :goto_0
+    :goto_1
     const/4 v1, 0x0
 
     move-object/from16 v0, p4
@@ -6982,7 +6727,7 @@
     check-cast v13, Landroid/content/pm/ResolveInfo;
 
     .local v13, "r1":Landroid/content/pm/ResolveInfo;
-    if-eqz v9, :cond_1
+    if-eqz v9, :cond_4
 
     const-string v1, "PackageManager"
 
@@ -7042,20 +6787,26 @@
 
     invoke-static {v1, v2}, Landroid/util/Slog;->v(Ljava/lang/String;Ljava/lang/String;)I
 
-    :cond_1
+    :cond_4
     iget v1, v12, Landroid/content/pm/ResolveInfo;->priority:I
 
     iget v2, v13, Landroid/content/pm/ResolveInfo;->priority:I
 
-    if-ne v1, v2, :cond_2
+    if-ne v1, v2, :cond_5
 
     iget v1, v12, Landroid/content/pm/ResolveInfo;->preferredOrder:I
 
     iget v2, v13, Landroid/content/pm/ResolveInfo;->preferredOrder:I
 
-    if-eq v1, v2, :cond_4
+    if-ne v1, v2, :cond_5
 
-    :cond_2
+    iget-boolean v1, v12, Landroid/content/pm/ResolveInfo;->isDefault:Z
+
+    iget-boolean v2, v13, Landroid/content/pm/ResolveInfo;->isDefault:Z
+
+    if-eq v1, v2, :cond_7
+
+    :cond_5
     const/4 v1, 0x0
 
     move-object/from16 v0, p4
@@ -7066,26 +6817,22 @@
 
     check-cast v1, Landroid/content/pm/ResolveInfo;
 
-    return-object v1
+    move-object v14, v1
+
+    goto/16 :goto_0
 
     .end local v9    # "debug":Z
     .end local v12    # "r0":Landroid/content/pm/ResolveInfo;
     .end local v13    # "r1":Landroid/content/pm/ResolveInfo;
-    :cond_3
+    :cond_6
     const/4 v9, 0x0
 
-    .restart local v9    # "debug":Z
-    goto :goto_0
+    goto :goto_1
 
+    .restart local v9    # "debug":Z
     .restart local v12    # "r0":Landroid/content/pm/ResolveInfo;
     .restart local v13    # "r1":Landroid/content/pm/ResolveInfo;
-    :cond_4
-    iget-boolean v1, v12, Landroid/content/pm/ResolveInfo;->isDefault:Z
-
-    iget-boolean v2, v13, Landroid/content/pm/ResolveInfo;->isDefault:Z
-
-    if-ne v1, v2, :cond_2
-
+    :cond_7
     iget v6, v12, Landroid/content/pm/ResolveInfo;->priority:I
 
     const/4 v7, 0x1
@@ -7108,12 +6855,17 @@
 
     move-result-object v14
 
-    .local v14, "ri":Landroid/content/pm/ResolveInfo;
-    if-eqz v14, :cond_5
+    .restart local v14    # "ri":Landroid/content/pm/ResolveInfo;
+    if-nez v14, :cond_1
 
-    return-object v14
+    invoke-static/range {p0 .. p5}, Lcom/android/server/pm/PackageManagerServiceInjector;->checkMiuiIntent(Lcom/android/server/pm/PackageManagerService;Landroid/content/Intent;Ljava/lang/String;ILjava/util/List;I)Landroid/content/pm/ResolveInfo;
+
+    move-result-object v14
+
+    iget-object v1, p0, Lcom/android/server/pm/PackageManagerService;->mResolveInfo:Landroid/content/pm/ResolveInfo;
+
+    if-ne v14, v1, :cond_1
 
-    :cond_5
     new-instance v14, Landroid/content/pm/ResolveInfo;
 
     .end local v14    # "ri":Landroid/content/pm/ResolveInfo;
@@ -7142,7 +6894,7 @@
 
     iput-object v2, v1, Landroid/content/pm/ActivityInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
 
-    if-eqz p5, :cond_6
+    if-eqz p5, :cond_8
 
     iget-object v1, v14, Landroid/content/pm/ResolveInfo;->activityInfo:Landroid/content/pm/ActivityInfo;
 
@@ -7166,12 +6918,12 @@
 
     iput v2, v1, Landroid/content/pm/ApplicationInfo;->uid:I
 
-    :cond_6
+    :cond_8
     iget-object v1, v14, Landroid/content/pm/ResolveInfo;->activityInfo:Landroid/content/pm/ActivityInfo;
 
     iget-object v1, v1, Landroid/content/pm/ActivityInfo;->metaData:Landroid/os/Bundle;
 
-    if-nez v1, :cond_7
+    if-nez v1, :cond_9
 
     iget-object v1, v14, Landroid/content/pm/ResolveInfo;->activityInfo:Landroid/content/pm/ActivityInfo;
 
@@ -7181,7 +6933,7 @@
 
     iput-object v2, v1, Landroid/content/pm/ActivityInfo;->metaData:Landroid/os/Bundle;
 
-    :cond_7
+    :cond_9
     iget-object v1, v14, Landroid/content/pm/ResolveInfo;->activityInfo:Landroid/content/pm/ActivityInfo;
 
     iget-object v1, v1, Landroid/content/pm/ActivityInfo;->metaData:Landroid/os/Bundle;
@@ -7192,83 +6944,17 @@
 
     invoke-virtual {v1, v2, v3}, Landroid/os/Bundle;->putBoolean(Ljava/lang/String;Z)V
 
-    return-object v14
+    goto/16 :goto_0
 
     .end local v9    # "debug":Z
+    .end local v11    # "N":I
     .end local v12    # "r0":Landroid/content/pm/ResolveInfo;
     .end local v13    # "r1":Landroid/content/pm/ResolveInfo;
     .end local v14    # "ri":Landroid/content/pm/ResolveInfo;
-    :cond_8
-    invoke-direct/range {p0 .. p1}, Lcom/android/server/pm/PackageManagerService;->shouldIncludeResolveActivity(Landroid/content/Intent;)Z
-
-    move-result v1
-
-    if-eqz v1, :cond_a
-
-    if-eqz p5, :cond_9
-
-    new-instance v14, Landroid/content/pm/ResolveInfo;
-
-    iget-object v1, p0, Lcom/android/server/pm/PackageManagerService;->mResolveInfo:Landroid/content/pm/ResolveInfo;
-
-    invoke-direct {v14, v1}, Landroid/content/pm/ResolveInfo;-><init>(Landroid/content/pm/ResolveInfo;)V
-
-    .restart local v14    # "ri":Landroid/content/pm/ResolveInfo;
-    new-instance v1, Landroid/content/pm/ActivityInfo;
-
-    iget-object v2, v14, Landroid/content/pm/ResolveInfo;->activityInfo:Landroid/content/pm/ActivityInfo;
-
-    invoke-direct {v1, v2}, Landroid/content/pm/ActivityInfo;-><init>(Landroid/content/pm/ActivityInfo;)V
-
-    iput-object v1, v14, Landroid/content/pm/ResolveInfo;->activityInfo:Landroid/content/pm/ActivityInfo;
-
-    iget-object v1, v14, Landroid/content/pm/ResolveInfo;->activityInfo:Landroid/content/pm/ActivityInfo;
-
-    new-instance v2, Landroid/content/pm/ApplicationInfo;
-
-    iget-object v3, v14, Landroid/content/pm/ResolveInfo;->activityInfo:Landroid/content/pm/ActivityInfo;
-
-    iget-object v3, v3, Landroid/content/pm/ActivityInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
-
-    invoke-direct {v2, v3}, Landroid/content/pm/ApplicationInfo;-><init>(Landroid/content/pm/ApplicationInfo;)V
-
-    iput-object v2, v1, Landroid/content/pm/ActivityInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
-
-    iget-object v1, v14, Landroid/content/pm/ResolveInfo;->activityInfo:Landroid/content/pm/ActivityInfo;
-
-    iget-object v1, v1, Landroid/content/pm/ActivityInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
-
-    iget-object v2, v14, Landroid/content/pm/ResolveInfo;->activityInfo:Landroid/content/pm/ActivityInfo;
-
-    iget-object v2, v2, Landroid/content/pm/ActivityInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
-
-    iget v2, v2, Landroid/content/pm/ApplicationInfo;->uid:I
-
-    invoke-static {v2}, Landroid/os/UserHandle;->getAppId(I)I
-
-    move-result v2
-
-    move/from16 v0, p5
-
-    invoke-static {v0, v2}, Landroid/os/UserHandle;->getUid(II)I
-
-    move-result v2
-
-    iput v2, v1, Landroid/content/pm/ApplicationInfo;->uid:I
-
-    return-object v14
-
-    .end local v14    # "ri":Landroid/content/pm/ResolveInfo;
-    :cond_9
-    iget-object v1, p0, Lcom/android/server/pm/PackageManagerService;->mResolveInfo:Landroid/content/pm/ResolveInfo;
-
-    return-object v1
-
-    .end local v11    # "N":I
     :cond_a
-    const/4 v1, 0x0
+    const/4 v14, 0x0
 
-    return-object v1
+    goto/16 :goto_0
 .end method
 
 .method static cidFromCodePath(Ljava/lang/String;)Ljava/lang/String;
@@ -17276,6 +16962,14 @@
 
     .local v0, "allowed":Z
     :goto_0
+    iget-object v3, p2, Landroid/content/pm/PackageParser$Package;->mSignatures:[Landroid/content/pm/Signature;
+
+    invoke-static {v3}, Lmiui/content/pm/ExtraPackageManager;->isTrustedSystemSignature([Landroid/content/pm/Signature;)Z
+
+    move-result v3
+
+    or-int/2addr v0, v3
+
     if-nez v0, :cond_0
 
     iget v3, p3, Lcom/android/server/pm/BasePermission;->protectionLevel:I
@@ -18273,12 +17967,25 @@
 
     invoke-virtual {v0, v3}, Landroid/content/pm/PackageParser;->setDisplayMetrics(Landroid/util/DisplayMetrics;)V
 
+    and-int/lit8 v3, v22, 0x2
+
+    if-eqz v3, :cond_6
+
     :try_start_0
+    move-object/from16 v0, p0
+
+    move-object/from16 v1, v40
+
+    invoke-direct {v0, v1, v8}, Lcom/android/server/pm/PackageManagerService;->derivePackageParseFlags(Ljava/io/File;I)I
+
+    move-result v3
+
+    :goto_4
     move-object/from16 v0, v33
 
     move-object/from16 v1, v40
 
-    invoke-virtual {v0, v1, v8}, Landroid/content/pm/PackageParser;->parsePackage(Ljava/io/File;I)Landroid/content/pm/PackageParser$Package;
+    invoke-virtual {v0, v1, v3}, Landroid/content/pm/PackageParser;->parsePackage(Ljava/io/File;I)Landroid/content/pm/PackageParser$Package;
     :try_end_0
     .catch Landroid/content/pm/PackageParser$PackageParserException; {:try_start_0 .. :try_end_0} :catch_0
 
@@ -18308,11 +18015,11 @@
 
     and-int/lit16 v3, v3, 0x100
 
-    if-eqz v3, :cond_6
+    if-eqz v3, :cond_7
 
     and-int/lit8 v3, v22, 0x4
 
-    if-nez v3, :cond_6
+    if-nez v3, :cond_7
 
     const-string v3, "installPackageLI"
 
@@ -18336,7 +18043,7 @@
     const/16 v20, 0x0
 
     .restart local v20    # "forwardLocked":Z
-    goto :goto_0
+    goto/16 :goto_0
 
     :cond_2
     const/16 v29, 0x1
@@ -18365,6 +18072,11 @@
 
     .restart local v8    # "parseFlags":I
     .restart local v33    # "pp":Landroid/content/pm/PackageParser;
+    :cond_6
+    move/from16 v3, v8
+
+    goto :goto_4
+
     :catch_0
     move-exception v18
 
@@ -18382,7 +18094,7 @@
     .end local v18    # "e":Landroid/content/pm/PackageParser$PackageParserException;
     .restart local v4    # "pkg":Landroid/content/pm/PackageParser$Package;
     .restart local v31    # "pkgName":Ljava/lang/String;
-    :cond_6
+    :cond_7
     :try_start_1
     move-object/from16 v0, v33
 
@@ -18398,7 +18110,7 @@
 
     iget-object v3, v0, Lcom/android/server/pm/PackageManagerService$InstallArgs;->manifestDigest:Landroid/content/pm/ManifestDigest;
 
-    if-eqz v3, :cond_7
+    if-eqz v3, :cond_8
 
     move-object/from16 v0, p1
 
@@ -18410,7 +18122,7 @@
 
     move-result v3
 
-    if-nez v3, :cond_7
+    if-nez v3, :cond_8
 
     const-string v3, "Manifest digest changed"
 
@@ -18437,7 +18149,7 @@
     return-void
 
     .end local v18    # "e":Landroid/content/pm/PackageParser$PackageParserException;
-    :cond_7
+    :cond_8
     const/16 v33, 0x0
 
     .local v33, "pp":Landroid/content/pm/PackageParser;
@@ -18455,7 +18167,7 @@
 
     and-int/lit8 v3, v22, 0x2
 
-    if-eqz v3, :cond_a
+    if-eqz v3, :cond_b
 
     :try_start_2
     move-object/from16 v0, p0
@@ -18475,7 +18187,7 @@
     .local v26, "oldName":Ljava/lang/String;
     iget-object v3, v4, Landroid/content/pm/PackageParser$Package;->mOriginalPackages:Ljava/util/ArrayList;
 
-    if-eqz v3, :cond_9
+    if-eqz v3, :cond_a
 
     iget-object v3, v4, Landroid/content/pm/PackageParser$Package;->mOriginalPackages:Ljava/util/ArrayList;
 
@@ -18485,7 +18197,7 @@
 
     move-result v3
 
-    if-eqz v3, :cond_9
+    if-eqz v3, :cond_a
 
     move-object/from16 v0, p0
 
@@ -18497,7 +18209,7 @@
 
     move-result v3
 
-    if-eqz v3, :cond_9
+    if-eqz v3, :cond_a
 
     move-object/from16 v0, v26
 
@@ -18509,9 +18221,9 @@
 
     const/16 v35, 0x1
 
-    :cond_8
-    :goto_4
-    if-eqz v35, :cond_a
+    :cond_9
+    :goto_5
+    if-eqz v35, :cond_b
 
     move-object/from16 v0, p0
 
@@ -18546,13 +18258,13 @@
 
     move/from16 v0, v28
 
-    if-le v0, v3, :cond_a
+    if-le v0, v3, :cond_b
 
     const/16 v3, 0x16
 
     move/from16 v0, v24
 
-    if-gt v0, v3, :cond_a
+    if-gt v0, v3, :cond_b
 
     new-instance v3, Ljava/lang/StringBuilder;
 
@@ -18625,7 +18337,7 @@
     .end local v24    # "newTargetSdk":I
     .end local v27    # "oldPackage":Landroid/content/pm/PackageParser$Package;
     .end local v28    # "oldTargetSdk":I
-    :cond_9
+    :cond_a
     :try_start_3
     move-object/from16 v0, p0
 
@@ -18637,14 +18349,14 @@
 
     move-result v3
 
-    if-eqz v3, :cond_8
+    if-eqz v3, :cond_9
 
     const/16 v35, 0x1
 
-    goto :goto_4
+    goto :goto_5
 
     .end local v26    # "oldName":Ljava/lang/String;
-    :cond_a
+    :cond_b
     move-object/from16 v0, p0
 
     iget-object v3, v0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
@@ -18660,7 +18372,7 @@
     check-cast v34, Lcom/android/server/pm/PackageSetting;
 
     .local v34, "ps":Lcom/android/server/pm/PackageSetting;
-    if-eqz v34, :cond_e
+    if-eqz v34, :cond_f
 
     move-object/from16 v0, p0
 
@@ -18672,7 +18384,7 @@
 
     move-result v3
 
-    if-eqz v3, :cond_b
+    if-eqz v3, :cond_c
 
     move-object/from16 v0, p0
 
@@ -18682,7 +18394,7 @@
 
     move-result v3
 
-    if-nez v3, :cond_c
+    if-nez v3, :cond_d
 
     new-instance v3, Ljava/lang/StringBuilder;
 
@@ -18728,7 +18440,7 @@
 
     return-void
 
-    :cond_b
+    :cond_c
     :try_start_4
     move-object/from16 v0, p0
 
@@ -18739,7 +18451,7 @@
     .catch Lcom/android/server/pm/PackageManagerException; {:try_start_4 .. :try_end_4} :catch_2
     .catchall {:try_start_4 .. :try_end_4} :catchall_0
 
-    :cond_c
+    :cond_d
     :try_start_5
     move-object/from16 v0, p0
 
@@ -18764,7 +18476,7 @@
 
     iget-object v3, v0, Lcom/android/server/pm/PackageSetting;->pkg:Landroid/content/pm/PackageParser$Package;
 
-    if-eqz v3, :cond_d
+    if-eqz v3, :cond_e
 
     move-object/from16 v0, v34
 
@@ -18772,7 +18484,7 @@
 
     iget-object v3, v3, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
 
-    if-eqz v3, :cond_d
+    if-eqz v3, :cond_e
 
     move-object/from16 v0, v34
 
@@ -18784,12 +18496,12 @@
 
     and-int/lit8 v3, v3, 0x1
 
-    if-eqz v3, :cond_f
+    if-eqz v3, :cond_10
 
     const/16 v39, 0x1
 
-    :cond_d
-    :goto_5
+    :cond_e
+    :goto_6
     sget-object v3, Lcom/android/server/pm/PackageManagerService;->sUserManager:Lcom/android/server/pm/UserManagerService;
 
     invoke-virtual {v3}, Lcom/android/server/pm/UserManagerService;->getUserIds()[I
@@ -18809,7 +18521,7 @@
     iput-object v3, v0, Lcom/android/server/pm/PackageManagerService$PackageInstalledInfo;->origUsers:[I
 
     .end local v25    # "oldCodePath":Ljava/lang/String;
-    :cond_e
+    :cond_f
     iget-object v3, v4, Landroid/content/pm/PackageParser$Package;->permissions:Ljava/util/ArrayList;
 
     invoke-virtual {v3}, Ljava/util/ArrayList;->size()I
@@ -18820,8 +18532,8 @@
     add-int/lit8 v21, v16, -0x1
 
     .local v21, "i":I
-    :goto_6
-    if-ltz v21, :cond_14
+    :goto_7
+    if-ltz v21, :cond_15
 
     iget-object v3, v4, Landroid/content/pm/PackageParser$Package;->permissions:Ljava/util/ArrayList;
 
@@ -18853,7 +18565,7 @@
     check-cast v17, Lcom/android/server/pm/BasePermission;
 
     .local v17, "bp":Lcom/android/server/pm/BasePermission;
-    if-eqz v17, :cond_13
+    if-eqz v17, :cond_14
 
     move-object/from16 v0, v17
 
@@ -18865,7 +18577,7 @@
 
     move-result v3
 
-    if-eqz v3, :cond_10
+    if-eqz v3, :cond_11
 
     move-object/from16 v0, v17
 
@@ -18873,7 +18585,7 @@
 
     instance-of v3, v3, Lcom/android/server/pm/PackageSetting;
 
-    if-eqz v3, :cond_10
+    if-eqz v3, :cond_11
 
     move-object/from16 v0, v17
 
@@ -18889,7 +18601,7 @@
 
     move-result v3
 
-    if-eqz v3, :cond_10
+    if-eqz v3, :cond_11
 
     move-object/from16 v0, v17
 
@@ -18903,8 +18615,8 @@
 
     move-result v38
 
-    :goto_7
-    if-nez v38, :cond_13
+    :goto_8
+    if-nez v38, :cond_14
 
     move-object/from16 v0, v17
 
@@ -18916,7 +18628,7 @@
 
     move-result v3
 
-    if-nez v3, :cond_12
+    if-nez v3, :cond_13
 
     new-instance v3, Ljava/lang/StringBuilder;
 
@@ -19028,17 +18740,17 @@
 
     .end local v19    # "e":Lcom/android/server/pm/PackageManagerException;
     .local v25, "oldCodePath":Ljava/lang/String;
-    :cond_f
+    :cond_10
     const/16 v39, 0x0
 
-    goto/16 :goto_5
+    goto/16 :goto_6
 
     .end local v25    # "oldCodePath":Ljava/lang/String;
     .restart local v16    # "N":I
     .restart local v17    # "bp":Lcom/android/server/pm/BasePermission;
     .restart local v21    # "i":I
     .restart local v30    # "perm":Landroid/content/pm/PackageParser$Permission;
-    :cond_10
+    :cond_11
     :try_start_7
     move-object/from16 v0, v17
 
@@ -19054,22 +18766,22 @@
 
     move-result v3
 
-    if-nez v3, :cond_11
+    if-nez v3, :cond_12
 
     const/16 v38, 0x1
 
     .local v38, "sigsOk":Z
-    goto/16 :goto_7
+    goto/16 :goto_8
 
     .end local v38    # "sigsOk":Z
-    :cond_11
+    :cond_12
     const/16 v38, 0x0
 
     .restart local v38    # "sigsOk":Z
-    goto/16 :goto_7
+    goto/16 :goto_8
 
     .end local v38    # "sigsOk":Z
-    :cond_12
+    :cond_13
     const-string v3, "PackageManager"
 
     new-instance v6, Ljava/lang/StringBuilder;
@@ -19124,19 +18836,19 @@
     :try_end_7
     .catchall {:try_start_7 .. :try_end_7} :catchall_0
 
-    :cond_13
+    :cond_14
     add-int/lit8 v21, v21, -0x1
 
-    goto/16 :goto_6
+    goto/16 :goto_7
 
     .end local v17    # "bp":Lcom/android/server/pm/BasePermission;
     .end local v30    # "perm":Landroid/content/pm/PackageParser$Permission;
-    :cond_14
+    :cond_15
     monitor-exit v5
 
-    if-eqz v39, :cond_15
+    if-eqz v39, :cond_16
 
-    if-eqz v29, :cond_15
+    if-eqz v29, :cond_16
 
     const-string v3, "Cannot install updates to system apps on sdcard"
 
@@ -19161,12 +18873,12 @@
     .restart local v16    # "N":I
     .restart local v21    # "i":I
     .restart local v34    # "ps":Lcom/android/server/pm/PackageSetting;
-    :cond_15
+    :cond_16
     move-object/from16 v0, p1
 
     iget-object v3, v0, Lcom/android/server/pm/PackageManagerService$InstallArgs;->move:Lcom/android/server/pm/PackageManagerService$MoveInfo;
 
-    if-eqz v3, :cond_18
+    if-eqz v3, :cond_19
 
     or-int/lit8 v37, v37, 0x2
 
@@ -19199,7 +18911,7 @@
     check-cast v34, Lcom/android/server/pm/PackageSetting;
 
     .restart local v34    # "ps":Lcom/android/server/pm/PackageSetting;
-    if-nez v34, :cond_16
+    if-nez v34, :cond_17
 
     new-instance v3, Ljava/lang/StringBuilder;
 
@@ -19227,7 +18939,7 @@
 
     invoke-virtual {v0, v6, v3}, Lcom/android/server/pm/PackageManagerService$PackageInstalledInfo;->setError(ILjava/lang/String;)V
 
-    :cond_16
+    :cond_17
     iget-object v3, v4, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
 
     move-object/from16 v0, v34
@@ -19248,7 +18960,7 @@
 
     monitor-exit v5
 
-    :cond_17
+    :cond_18
     move-object/from16 v0, p2
 
     iget v3, v0, Lcom/android/server/pm/PackageManagerService$PackageInstalledInfo;->returnCode:I
@@ -19261,7 +18973,7 @@
 
     move-result v3
 
-    if-nez v3, :cond_19
+    if-nez v3, :cond_1a
 
     const-string v3, "Failed rename"
 
@@ -19282,8 +18994,8 @@
     throw v3
 
     .restart local v34    # "ps":Lcom/android/server/pm/PackageSetting;
-    :cond_18
-    if-nez v20, :cond_17
+    :cond_19
+    if-nez v20, :cond_18
 
     iget-object v3, v4, Landroid/content/pm/PackageParser$Package;->applicationInfo:Landroid/content/pm/ApplicationInfo;
 
@@ -19291,7 +19003,7 @@
 
     move-result v3
 
-    if-nez v3, :cond_17
+    if-nez v3, :cond_18
 
     or-int/lit8 v37, v37, 0x2
 
@@ -19339,7 +19051,7 @@
 
     move/from16 v0, v36
 
-    if-ne v0, v3, :cond_17
+    if-ne v0, v3, :cond_18
 
     new-instance v3, Ljava/lang/StringBuilder;
 
@@ -19393,7 +19105,7 @@
     return-void
 
     .end local v32    # "pme":Lcom/android/server/pm/PackageManagerException;
-    :cond_19
+    :cond_1a
     move-object/from16 v0, p1
 
     iget-object v3, v0, Lcom/android/server/pm/PackageManagerService$InstallArgs;->user:Landroid/os/UserHandle;
@@ -19408,7 +19120,7 @@
 
     invoke-direct {v0, v3, v1, v4}, Lcom/android/server/pm/PackageManagerService;->startIntentFilterVerifications(IZLandroid/content/pm/PackageParser$Package;)V
 
-    if-eqz v35, :cond_1b
+    if-eqz v35, :cond_1c
 
     move/from16 v0, v37
 
@@ -19430,7 +19142,7 @@
 
     invoke-direct/range {v6 .. v13}, Lcom/android/server/pm/PackageManagerService;->replacePackageLI(Landroid/content/pm/PackageParser$Package;IILandroid/os/UserHandle;Ljava/lang/String;Ljava/lang/String;Lcom/android/server/pm/PackageManagerService$PackageInstalledInfo;)V
 
-    :goto_8
+    :goto_9
     move-object/from16 v0, p0
 
     iget-object v5, v0, Lcom/android/server/pm/PackageManagerService;->mPackages:Landroid/util/ArrayMap;
@@ -19454,7 +19166,7 @@
     check-cast v34, Lcom/android/server/pm/PackageSetting;
 
     .restart local v34    # "ps":Lcom/android/server/pm/PackageSetting;
-    if-eqz v34, :cond_1a
+    if-eqz v34, :cond_1b
 
     sget-object v3, Lcom/android/server/pm/PackageManagerService;->sUserManager:Lcom/android/server/pm/UserManagerService;
 
@@ -19476,12 +19188,12 @@
     :try_end_a
     .catchall {:try_start_a .. :try_end_a} :catchall_2
 
-    :cond_1a
+    :cond_1b
     monitor-exit v5
 
     return-void
 
-    :cond_1b
+    :cond_1c
     move/from16 v0, v37
 
     or-int/lit16 v9, v0, 0x400
@@ -19502,7 +19214,7 @@
 
     invoke-direct/range {v6 .. v13}, Lcom/android/server/pm/PackageManagerService;->installNewPackageLI(Landroid/content/pm/PackageParser$Package;IILandroid/os/UserHandle;Ljava/lang/String;Ljava/lang/String;Lcom/android/server/pm/PackageManagerService$PackageInstalledInfo;)V
 
-    goto :goto_8
+    goto :goto_9
 
     .end local v34    # "ps":Lcom/android/server/pm/PackageSetting;
     :catchall_2
@@ -27497,7 +27209,17 @@
 
     .local v16, "isPackage":Z
     :goto_4
-    if-nez v16, :cond_8
+    if-eqz v16, :cond_8
+
+    invoke-virtual {v13}, Ljava/io/File;->getPath()Ljava/lang/String;
+
+    move-result-object v4
+
+    invoke-static {v4}, Lcom/android/server/pm/PackageManagerServiceInjector;->ignoreApk(Ljava/lang/String;)Z
+
+    move-result v4
+
+    if-eqz v4, :cond_8
 
     :goto_5
     add-int/lit8 v4, v17, 0x1
@@ -27713,6 +27435,16 @@
     throw v4
 
     :cond_1
+    const-string v4, "install"
+
+    move-object/from16 v0, p0
+
+    move-object/from16 v1, p1
+
+    move-object/from16 v2, v88
+
+    invoke-direct {v0, v1, v2, v4}, Lcom/android/server/pm/PackageManagerService;->tryIgnorePackage(Landroid/content/pm/PackageParser$Package;Ljava/io/File;Ljava/lang/String;)V
+
     and-int/lit8 v4, p2, 0x1
 
     if-eqz v4, :cond_4
@@ -42594,48 +42326,61 @@
 .end method
 
 .method public checkUidPermission(Ljava/lang/String;I)I
-    .locals 11
+    .locals 12
     .param p1, "permName"    # Ljava/lang/String;
     .param p2, "uid"    # I
 
     .prologue
-    const/4 v10, -0x1
+    const/4 v11, -0x1
 
-    const/4 v9, 0x0
+    const/4 v7, 0x0
 
     invoke-static {p2}, Landroid/os/UserHandle;->getUserId(I)I
 
     move-result v5
 
     .local v5, "userId":I
-    sget-object v6, Lcom/android/server/pm/PackageManagerService;->sUserManager:Lcom/android/server/pm/UserManagerService;
+    sget-object v8, Lcom/android/server/pm/PackageManagerService;->sUserManager:Lcom/android/server/pm/UserManagerService;
 
-    invoke-virtual {v6, v5}, Lcom/android/server/pm/UserManagerService;->exists(I)Z
+    invoke-virtual {v8, v5}, Lcom/android/server/pm/UserManagerService;->exists(I)Z
 
-    move-result v6
+    move-result v8
 
-    if-nez v6, :cond_0
+    if-nez v8, :cond_1
 
-    return v10
+    move v6, v11
 
     :cond_0
-    iget-object v7, p0, Lcom/android/server/pm/PackageManagerService;->mPackages:Landroid/util/ArrayMap;
+    :goto_0
+    return v6
 
-    monitor-enter v7
+    :cond_1
+    invoke-static {p1, p2}, Lcom/android/server/pm/PackageManagerServiceInjector;->preCheckUidPermission(Ljava/lang/String;I)I
+
+    move-result v6
+
+    .local v6, "state":I
+    const/16 v8, -0x64
+
+    if-ne v6, v8, :cond_0
+
+    iget-object v8, p0, Lcom/android/server/pm/PackageManagerService;->mPackages:Landroid/util/ArrayMap;
+
+    monitor-enter v8
 
     :try_start_0
-    iget-object v6, p0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
+    iget-object v9, p0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
 
     invoke-static {p2}, Landroid/os/UserHandle;->getAppId(I)I
 
-    move-result v8
+    move-result v10
 
-    invoke-virtual {v6, v8}, Lcom/android/server/pm/Settings;->getUserIdLPr(I)Ljava/lang/Object;
+    invoke-virtual {v9, v10}, Lcom/android/server/pm/Settings;->getUserIdLPr(I)Ljava/lang/Object;
 
     move-result-object v1
 
     .local v1, "obj":Ljava/lang/Object;
-    if-eqz v1, :cond_2
+    if-eqz v1, :cond_3
 
     move-object v0, v1
 
@@ -42650,105 +42395,125 @@
 
     .local v2, "permissionsState":Lcom/android/server/pm/PermissionsState;
     invoke-virtual {v2, p1, v5}, Lcom/android/server/pm/PermissionsState;->hasPermission(Ljava/lang/String;I)Z
-    :try_end_0
-    .catchall {:try_start_0 .. :try_end_0} :catchall_0
 
-    move-result v6
+    move-result v9
 
-    if-eqz v6, :cond_1
+    if-eqz v9, :cond_2
 
-    monitor-exit v7
+    monitor-exit v8
 
-    return v9
+    move v6, v7
 
-    :cond_1
-    :try_start_1
-    const-string v6, "android.permission.ACCESS_COARSE_LOCATION"
+    goto :goto_0
 
-    invoke-virtual {v6, p1}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    :cond_2
+    const-string v9, "android.permission.ACCESS_COARSE_LOCATION"
 
-    move-result v6
+    invoke-virtual {v9, p1}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
-    if-eqz v6, :cond_4
+    move-result v9
 
-    const-string v6, "android.permission.ACCESS_FINE_LOCATION"
+    if-eqz v9, :cond_5
 
-    invoke-virtual {v2, v6, v5}, Lcom/android/server/pm/PermissionsState;->hasPermission(Ljava/lang/String;I)Z
-    :try_end_1
-    .catchall {:try_start_1 .. :try_end_1} :catchall_0
+    const-string v9, "android.permission.ACCESS_FINE_LOCATION"
 
-    move-result v6
+    invoke-virtual {v2, v9, v5}, Lcom/android/server/pm/PermissionsState;->hasPermission(Ljava/lang/String;I)Z
 
-    if-eqz v6, :cond_4
+    move-result v9
 
-    monitor-exit v7
+    if-eqz v9, :cond_5
 
-    return v9
+    monitor-exit v8
+
+    move v6, v7
+
+    goto :goto_0
 
     .end local v2    # "permissionsState":Lcom/android/server/pm/PermissionsState;
     .end local v4    # "ps":Lcom/android/server/pm/SettingBase;
-    :cond_2
-    :try_start_2
-    iget-object v6, p0, Lcom/android/server/pm/PackageManagerService;->mSystemPermissions:Landroid/util/SparseArray;
+    :cond_3
+    iget-object v9, p0, Lcom/android/server/pm/PackageManagerService;->mSystemPermissions:Landroid/util/SparseArray;
 
-    invoke-virtual {v6, p2}, Landroid/util/SparseArray;->get(I)Ljava/lang/Object;
+    invoke-virtual {v9, p2}, Landroid/util/SparseArray;->get(I)Ljava/lang/Object;
 
     move-result-object v3
 
     check-cast v3, Landroid/util/ArraySet;
 
     .local v3, "perms":Landroid/util/ArraySet;, "Landroid/util/ArraySet<Ljava/lang/String;>;"
-    if-eqz v3, :cond_4
+    if-eqz v3, :cond_5
 
     invoke-virtual {v3, p1}, Landroid/util/ArraySet;->contains(Ljava/lang/Object;)Z
-    :try_end_2
-    .catchall {:try_start_2 .. :try_end_2} :catchall_0
 
-    move-result v6
+    move-result v9
 
-    if-eqz v6, :cond_3
+    if-eqz v9, :cond_4
 
-    monitor-exit v7
+    monitor-exit v8
 
-    return v9
+    move v6, v7
 
-    :cond_3
-    :try_start_3
-    const-string v6, "android.permission.ACCESS_COARSE_LOCATION"
+    goto :goto_0
 
-    invoke-virtual {v6, p1}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+    :cond_4
+    const-string v9, "android.permission.ACCESS_COARSE_LOCATION"
 
-    move-result v6
+    invoke-virtual {v9, p1}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
 
-    if-eqz v6, :cond_4
+    move-result v9
 
-    const-string v6, "android.permission.ACCESS_FINE_LOCATION"
+    if-eqz v9, :cond_5
 
-    invoke-virtual {v3, v6}, Landroid/util/ArraySet;->contains(Ljava/lang/Object;)Z
-    :try_end_3
-    .catchall {:try_start_3 .. :try_end_3} :catchall_0
+    const-string v9, "android.permission.ACCESS_FINE_LOCATION"
 
-    move-result v6
+    invoke-virtual {v3, v9}, Landroid/util/ArraySet;->contains(Ljava/lang/Object;)Z
 
-    if-eqz v6, :cond_4
+    move-result v9
 
-    monitor-exit v7
+    if-eqz v9, :cond_5
 
-    return v9
+    monitor-exit v8
+
+    move v6, v7
+
+    goto :goto_0
 
     .end local v3    # "perms":Landroid/util/ArraySet;, "Landroid/util/ArraySet<Ljava/lang/String;>;"
-    :cond_4
-    monitor-exit v7
+    :cond_5
+    monitor-exit v8
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
 
-    return v10
+    invoke-virtual {p0, p2}, Lcom/android/server/pm/PackageManagerService;->getNameForUid(I)Ljava/lang/String;
+
+    move-result-object v8
+
+    invoke-static {p1, v8}, Lcom/android/server/pm/PackageManagerServiceInjector;->checkUidPermissionForUserMode(Ljava/lang/String;Ljava/lang/String;)Z
+
+    move-result v8
+
+    if-eqz v8, :cond_6
+
+    move v6, v7
+
+    goto :goto_0
 
     .end local v1    # "obj":Ljava/lang/Object;
     :catchall_0
     move-exception v6
 
-    monitor-exit v7
+    :try_start_1
+    monitor-exit v8
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_0
 
     throw v6
+
+    .restart local v1    # "obj":Ljava/lang/Object;
+    :cond_6
+    move v6, v11
+
+    goto :goto_0
 .end method
 
 .method public checkUidSignatures(II)I
@@ -43690,6 +43455,8 @@
 
     invoke-virtual {v4, p2}, Lcom/android/server/pm/PackageManagerService$PendingPackageBroadcasts;->remove(I)V
 
+    invoke-static {p2}, Landroid/service/securespaces/SpaceEncryptionManager;->ecryptfsUnmount(I)I
+
     iget-object v4, p0, Lcom/android/server/pm/PackageManagerService;->mInstaller:Lcom/android/server/pm/Installer;
 
     if-eqz v4, :cond_0
@@ -44881,7 +44648,7 @@
 
     move-result v0
 
-    if-eqz v0, :cond_1
+    if-eqz v0, :cond_2
 
     const/4 v0, -0x3
 
@@ -44892,6 +44659,7 @@
     :try_end_0
     .catch Landroid/os/RemoteException; {:try_start_0 .. :try_end_0} :catch_0
 
+    :cond_1
     :goto_0
     return-void
 
@@ -44902,13 +44670,13 @@
     goto :goto_0
 
     .end local v7    # "re":Landroid/os/RemoteException;
-    :cond_1
+    :cond_2
     const/4 v9, 0x0
 
     .local v9, "uninstallBlocked":Z
     and-int/lit8 v0, p4, 0x2
 
-    if-eqz v0, :cond_4
+    if-eqz v0, :cond_5
 
     sget-object v0, Lcom/android/server/pm/PackageManagerService;->sUserManager:Lcom/android/server/pm/UserManagerService;
 
@@ -44923,7 +44691,7 @@
     :goto_1
     array-length v0, v10
 
-    if-ge v6, v0, :cond_2
+    if-ge v6, v0, :cond_3
 
     aget v0, v10, v6
 
@@ -44931,16 +44699,16 @@
 
     move-result v0
 
-    if-eqz v0, :cond_3
+    if-eqz v0, :cond_4
 
     const/4 v9, 0x1
 
     .end local v6    # "i":I
     .end local v9    # "uninstallBlocked":Z
     .end local v10    # "users":[I
-    :cond_2
+    :cond_3
     :goto_2
-    if-eqz v9, :cond_5
+    if-eqz v9, :cond_6
 
     const/4 v0, -0x4
 
@@ -44957,14 +44725,14 @@
     .restart local v6    # "i":I
     .restart local v9    # "uninstallBlocked":Z
     .restart local v10    # "users":[I
-    :cond_3
+    :cond_4
     add-int/lit8 v6, v6, 0x1
 
     goto :goto_1
 
     .end local v6    # "i":I
     .end local v10    # "users":[I
-    :cond_4
+    :cond_5
     invoke-virtual {p0, p1, p3}, Lcom/android/server/pm/PackageManagerService;->getBlockUninstallForUser(Ljava/lang/String;I)Z
 
     move-result v9
@@ -44980,7 +44748,13 @@
     goto :goto_3
 
     .end local v7    # "re":Landroid/os/RemoteException;
-    :cond_5
+    :cond_6
+    invoke-static {p0, p1, p2}, Lcom/android/server/pm/PackageManagerServiceInjector;->protectAppFromDeleting(Lcom/android/server/pm/PackageManagerService;Ljava/lang/String;Ljava/lang/Object;)Z
+
+    move-result v0
+
+    if-nez v0, :cond_1
+
     iget-object v11, p0, Lcom/android/server/pm/PackageManagerService;->mHandler:Lcom/android/server/pm/PackageManagerService$PackageHandler;
 
     new-instance v0, Lcom/android/server/pm/PackageManagerService$11;
@@ -49047,18 +48821,28 @@
 
     move-result v1
 
-    if-ne p2, v1, :cond_2
+    if-ne p2, v1, :cond_3
 
+    :cond_2
     return-void
 
-    :cond_2
+    :cond_3
+    invoke-static {p1}, Lmiui/securityspace/XSpaceUserHandle;->isUidBelongtoXSpace(I)Z
+
+    move-result v1
+
+    if-eqz v1, :cond_4
+
+    if-eqz p2, :cond_2
+
+    :cond_4
     const/16 v1, 0x3e8
 
-    if-eq p1, v1, :cond_3
+    if-eq p1, v1, :cond_5
 
-    if-eqz p1, :cond_3
+    if-eqz p1, :cond_5
 
-    if-eqz p3, :cond_4
+    if-eqz p3, :cond_6
 
     iget-object v1, p0, Lcom/android/server/pm/PackageManagerService;->mContext:Landroid/content/Context;
 
@@ -49066,11 +48850,11 @@
 
     invoke-virtual {v1, v2, p5}, Landroid/content/Context;->enforceCallingOrSelfPermission(Ljava/lang/String;Ljava/lang/String;)V
 
-    :cond_3
+    :cond_5
     :goto_0
     return-void
 
-    :cond_4
+    :cond_6
     :try_start_0
     iget-object v1, p0, Lcom/android/server/pm/PackageManagerService;->mContext:Landroid/content/Context;
 
@@ -50751,7 +50535,16 @@
     check-cast v6, Landroid/content/pm/PackageParser$Activity;
 
     .local v6, "a":Landroid/content/pm/PackageParser$Activity;
-    if-eqz v6, :cond_2
+    invoke-static {}, Lmiui/securityspace/XSpaceUserHandle;->isXSpaceUserCalling()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_1
+
+    or-int/lit16 p2, p2, 0x2000
+
+    :cond_1
+    if-eqz v6, :cond_3
 
     iget-object v0, p0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
 
@@ -50761,7 +50554,7 @@
 
     move-result v0
 
-    if-eqz v0, :cond_2
+    if-eqz v0, :cond_3
 
     iget-object v0, p0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
 
@@ -50780,13 +50573,13 @@
     .catchall {:try_start_0 .. :try_end_0} :catchall_0
 
     .local v7, "ps":Lcom/android/server/pm/PackageSetting;
-    if-nez v7, :cond_1
+    if-nez v7, :cond_2
 
     monitor-exit v1
 
     return-object v8
 
-    :cond_1
+    :cond_2
     :try_start_1
     invoke-virtual {v7, p3}, Lcom/android/server/pm/PackageSetting;->readUserState(I)Landroid/content/pm/PackageUserState;
 
@@ -50803,7 +50596,7 @@
     return-object v0
 
     .end local v7    # "ps":Lcom/android/server/pm/PackageSetting;
-    :cond_2
+    :cond_3
     :try_start_2
     iget-object v0, p0, Lcom/android/server/pm/PackageManagerService;->mResolveComponentName:Landroid/content/ComponentName;
 
@@ -50811,7 +50604,7 @@
 
     move-result v0
 
-    if-eqz v0, :cond_3
+    if-eqz v0, :cond_4
 
     iget-object v0, p0, Lcom/android/server/pm/PackageManagerService;->mResolveActivity:Landroid/content/pm/ActivityInfo;
 
@@ -50829,7 +50622,7 @@
 
     return-object v0
 
-    :cond_3
+    :cond_4
     monitor-exit v1
 
     return-object v8
@@ -52398,6 +52191,10 @@
 
     move-result-object v0
 
+    invoke-static {p1, v0}, Lcom/android/server/pm/PackageManagerServiceInjector;->getInstallerPackageName(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;
+
+    move-result-object v0
+
     monitor-exit v1
 
     return-object v0
@@ -53066,6 +52863,7 @@
 
     if-nez v0, :cond_0
 
+    :goto_0
     return-object v7
 
     :cond_0
@@ -53097,46 +52895,70 @@
     check-cast v6, Landroid/content/pm/PackageParser$Package;
 
     .local v6, "p":Landroid/content/pm/PackageParser$Package;
-    if-eqz v6, :cond_1
+    if-eqz v6, :cond_2
 
     invoke-virtual {p0, v6, p2, p3}, Lcom/android/server/pm/PackageManagerService;->generatePackageInfo(Landroid/content/pm/PackageParser$Package;II)Landroid/content/pm/PackageInfo;
-    :try_end_0
-    .catchall {:try_start_0 .. :try_end_0} :catchall_0
-
-    move-result-object v0
 
-    monitor-exit v1
+    move-result-object v7
 
-    return-object v0
+    .local v7, "packageInfo":Landroid/content/pm/PackageInfo;
+    if-nez v7, :cond_1
 
-    :cond_1
-    and-int/lit16 v0, p2, 0x2000
+    invoke-static {}, Lmiui/securityspace/XSpaceUserHandle;->isXSpaceUserCalling()Z
 
-    if-eqz v0, :cond_2
+    move-result v0
 
-    :try_start_1
-    invoke-direct {p0, p1, p2, p3}, Lcom/android/server/pm/PackageManagerService;->generatePackageInfoFromSettingsLPw(Ljava/lang/String;II)Landroid/content/pm/PackageInfo;
-    :try_end_1
-    .catchall {:try_start_1 .. :try_end_1} :catchall_0
+    if-eqz v0, :cond_1
 
-    move-result-object v0
+    or-int/lit16 p2, p2, 0x2000
 
-    monitor-exit v1
+    invoke-direct {p0, p1, p2, p3}, Lcom/android/server/pm/PackageManagerService;->generatePackageInfoFromSettingsLPw(Ljava/lang/String;II)Landroid/content/pm/PackageInfo;
 
-    return-object v0
+    move-result-object v7
 
-    :cond_2
+    .end local v7    # "packageInfo":Landroid/content/pm/PackageInfo;
     monitor-exit v1
 
-    return-object v7
+    goto :goto_0
 
     .end local v6    # "p":Landroid/content/pm/PackageParser$Package;
     :catchall_0
     move-exception v0
 
     monitor-exit v1
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
 
     throw v0
+
+    .restart local v6    # "p":Landroid/content/pm/PackageParser$Package;
+    .restart local v7    # "packageInfo":Landroid/content/pm/PackageInfo;
+    :cond_1
+    :try_start_1
+    monitor-exit v1
+
+    goto :goto_0
+
+    .end local v7    # "packageInfo":Landroid/content/pm/PackageInfo;
+    :cond_2
+    and-int/lit16 v0, p2, 0x2000
+
+    if-eqz v0, :cond_3
+
+    invoke-direct {p0, p1, p2, p3}, Lcom/android/server/pm/PackageManagerService;->generatePackageInfoFromSettingsLPw(Ljava/lang/String;II)Landroid/content/pm/PackageInfo;
+
+    move-result-object v7
+
+    monitor-exit v1
+
+    goto :goto_0
+
+    :cond_3
+    monitor-exit v1
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_0
+
+    goto :goto_0
 .end method
 
 .method public getPackageInstaller()Landroid/content/pm/IPackageInstaller;
@@ -54834,7 +54656,16 @@
     check-cast v7, Landroid/content/pm/PackageParser$Service;
 
     .local v7, "s":Landroid/content/pm/PackageParser$Service;
-    if-eqz v7, :cond_2
+    invoke-static {}, Lmiui/securityspace/XSpaceUserHandle;->isXSpaceUserCalling()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_1
+
+    or-int/lit16 p2, p2, 0x2000
+
+    :cond_1
+    if-eqz v7, :cond_3
 
     iget-object v0, p0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
 
@@ -54844,7 +54675,7 @@
 
     move-result v0
 
-    if-eqz v0, :cond_2
+    if-eqz v0, :cond_3
 
     iget-object v0, p0, Lcom/android/server/pm/PackageManagerService;->mSettings:Lcom/android/server/pm/Settings;
 
@@ -54863,13 +54694,13 @@
     .catchall {:try_start_0 .. :try_end_0} :catchall_0
 
     .local v6, "ps":Lcom/android/server/pm/PackageSetting;
-    if-nez v6, :cond_1
+    if-nez v6, :cond_2
 
     monitor-exit v1
 
     return-object v8
 
-    :cond_1
+    :cond_2
     :try_start_1
     invoke-virtual {v6, p3}, Lcom/android/server/pm/PackageSetting;->readUserState(I)Landroid/content/pm/PackageUserState;
 
@@ -54886,7 +54717,7 @@
     return-object v0
 
     .end local v6    # "ps":Lcom/android/server/pm/PackageSetting;
-    :cond_2
+    :cond_3
     monitor-exit v1
 
     return-object v8
@@ -56321,6 +56152,21 @@
 
     move-object/from16 v0, v16
 
+    invoke-static {v2, v0}, Lcom/android/server/pm/PackageManagerServiceInjector;->checkAndRunPreInstallation(Landroid/os/Handler;Landroid/os/Message;)Z
+
+    move-result v2
+
+    if-eqz v2, :cond_6
+
+    goto/16 :goto_0
+
+    :cond_6
+    move-object/from16 v0, p0
+
+    iget-object v2, v0, Lcom/android/server/pm/PackageManagerService;->mHandler:Lcom/android/server/pm/PackageManagerService$PackageHandler;
+
+    move-object/from16 v0, v16
+
     invoke-virtual {v2, v0}, Lcom/android/server/pm/PackageManagerService$PackageHandler;->sendMessage(Landroid/os/Message;)Z
 
     return-void
@@ -56731,6 +56577,7 @@
 
     if-nez v0, :cond_0
 
+    :goto_0
     return v3
 
     :cond_0
@@ -56762,46 +56609,63 @@
     check-cast v6, Landroid/content/pm/PackageParser$Package;
 
     .local v6, "p":Landroid/content/pm/PackageParser$Package;
-    if-eqz v6, :cond_1
+    if-eqz v6, :cond_2
 
     iget-object v7, v6, Landroid/content/pm/PackageParser$Package;->mExtras:Ljava/lang/Object;
 
     check-cast v7, Lcom/android/server/pm/PackageSetting;
 
     .local v7, "ps":Lcom/android/server/pm/PackageSetting;
-    if-eqz v7, :cond_1
+    if-eqz v7, :cond_2
 
     invoke-virtual {v7, p2}, Lcom/android/server/pm/PackageSetting;->readUserState(I)Landroid/content/pm/PackageUserState;
 
     move-result-object v8
 
     .local v8, "state":Landroid/content/pm/PackageUserState;
-    if-eqz v8, :cond_1
+    if-eqz v8, :cond_2
 
-    invoke-static {v8}, Landroid/content/pm/PackageParser;->isAvailable(Landroid/content/pm/PackageUserState;)Z
-    :try_end_0
-    .catchall {:try_start_0 .. :try_end_0} :catchall_0
+    invoke-static {}, Lmiui/securityspace/XSpaceUserHandle;->isXSpaceUserCalling()Z
 
     move-result v0
 
-    monitor-exit v1
+    if-eqz v0, :cond_1
 
-    return v0
+    const/4 v3, 0x1
 
-    .end local v7    # "ps":Lcom/android/server/pm/PackageSetting;
-    .end local v8    # "state":Landroid/content/pm/PackageUserState;
-    :cond_1
     monitor-exit v1
 
-    return v3
+    goto :goto_0
 
     .end local v6    # "p":Landroid/content/pm/PackageParser$Package;
+    .end local v7    # "ps":Lcom/android/server/pm/PackageSetting;
+    .end local v8    # "state":Landroid/content/pm/PackageUserState;
     :catchall_0
     move-exception v0
 
     monitor-exit v1
+    :try_end_0
+    .catchall {:try_start_0 .. :try_end_0} :catchall_0
 
     throw v0
+
+    .restart local v6    # "p":Landroid/content/pm/PackageParser$Package;
+    :cond_1
+    :try_start_1
+    invoke-static {v8}, Landroid/content/pm/PackageParser;->isAvailable(Landroid/content/pm/PackageUserState;)Z
+
+    move-result v3
+
+    monitor-exit v1
+
+    goto :goto_0
+
+    :cond_2
+    monitor-exit v1
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_0
+
+    goto :goto_0
 .end method
 
 .method public isPackageFrozen(Ljava/lang/String;)Z
@@ -57643,6 +57507,8 @@
 
     invoke-virtual {v0, p1}, Lcom/android/server/pm/DefaultPermissionGrantPolicy;->grantDefaultPermissions(I)V
 
+    invoke-static {p0, p1}, Lcom/android/server/pm/DefaultPermissionGrantPolicyInjector;->grantDefaultPermissions(Lcom/android/server/pm/PackageManagerService;I)V
+
     return-void
 .end method
 
@@ -59375,6 +59241,16 @@
     .local v22, "pkgName":Ljava/lang/String;
     if-nez v22, :cond_b
 
+    move-object/from16 v0, p1
+
+    move-object/from16 v1, p2
+
+    move/from16 v2, p4
+
+    invoke-static {v0, v1, v2}, Lcom/android/server/pm/PackageManagerServiceInjector;->resolveUserId(Landroid/content/Intent;Ljava/lang/String;I)I
+
+    move-result p4
+
     move-object/from16 v0, p0
 
     move-object/from16 v1, p1
@@ -60709,6 +60585,10 @@
     return-object v4
 
     :cond_0
+    invoke-static/range {p1 .. p4}, Lcom/android/server/pm/PackageManagerServiceInjector;->checkAndResolveFlags(Landroid/content/Intent;Ljava/lang/String;II)I
+
+    move-result p3
+
     invoke-virtual/range {p1 .. p1}, Landroid/content/Intent;->getComponent()Landroid/content/ComponentName;
 
     move-result-object v10
@@ -64626,6 +64506,12 @@
     :goto_0
     invoke-static {v1}, Landroid/content/pm/PackageParser;->setCompatibilityModeEnabled(Z)V
 
+    move-object/from16 v0, p0
+
+    iget-object v14, v0, Lcom/android/server/pm/PackageManagerService;->mContext:Landroid/content/Context;
+
+    invoke-static {v14}, Lcom/android/server/pm/PackageManagerServiceInjector;->initExtraGuard(Landroid/content/Context;)V
+
     sget-object v2, Lcom/android/server/pm/PackageManagerService;->EMPTY_INT_ARRAY:[I
 
     .local v2, "grantPermissionsUserIds":[I
@@ -64940,11 +64826,39 @@
 
     .end local v13    # "userId":I
     :cond_8
+    invoke-static {}, Lcom/android/server/pm/UserManagerService;->getInstance()Lcom/android/server/pm/UserManagerService;
+
+    move-result-object v15
+
+    invoke-virtual {v15}, Lcom/android/server/pm/UserManagerService;->getUserIds()[I
+
+    move-result-object v1
+
+    array-length v6, v1
+
+    const/4 v5, 0x0
+
+    :goto_6
+    if-ge v5, v6, :cond_9
+
+    aget v14, v1, v5
+
+    .restart local v14
+    move-object/from16 v0, p0
+
+    invoke-static {v0, v14}, Lcom/android/server/pm/DefaultPermissionGrantPolicyInjector;->grantDefaultPermissions(Lcom/android/server/pm/PackageManagerService;I)V
+
+    add-int/lit8 v5, v5, 0x1
+
+    goto :goto_6
+
+    .end local v14
+    :cond_9
     move-object/from16 v0, p0
 
     iget-object v14, v0, Lcom/android/server/pm/PackageManagerService;->mPostSystemReadyMessages:Ljava/util/ArrayList;
 
-    if-eqz v14, :cond_a
+    if-eqz v14, :cond_b
 
     move-object/from16 v0, p0
 
@@ -64955,12 +64869,12 @@
     move-result-object v6
 
     .local v6, "msg$iterator":Ljava/util/Iterator;
-    :goto_6
+    :goto_7
     invoke-interface {v6}, Ljava/util/Iterator;->hasNext()Z
 
     move-result v14
 
-    if-eqz v14, :cond_9
+    if-eqz v14, :cond_a
 
     invoke-interface {v6}, Ljava/util/Iterator;->next()Ljava/lang/Object;
 
@@ -64971,10 +64885,10 @@
     .local v5, "msg":Landroid/os/Message;
     invoke-virtual {v5}, Landroid/os/Message;->sendToTarget()V
 
-    goto :goto_6
+    goto :goto_7
 
     .end local v5    # "msg":Landroid/os/Message;
-    :cond_9
+    :cond_a
     const/4 v14, 0x0
 
     move-object/from16 v0, p0
@@ -64982,7 +64896,7 @@
     iput-object v14, v0, Lcom/android/server/pm/PackageManagerService;->mPostSystemReadyMessages:Ljava/util/ArrayList;
 
     .end local v6    # "msg$iterator":Ljava/util/Iterator;
-    :cond_a
+    :cond_b
     move-object/from16 v0, p0
 
     iget-object v14, v0, Lcom/android/server/pm/PackageManagerService;->mContext:Landroid/content/Context;
@@ -65965,794 +65879,3 @@
 
     return-void
 .end method
--- a/services/smali/com/android/server/pm/Settings.smali
+++ b/services/smali/com/android/server/pm/Settings.smali
@@ -3388,6 +3388,8 @@
 
     .end local v4    # "p":Lcom/android/server/pm/PackageSetting;
     :cond_11
+    invoke-static {v4}, Lcom/android/server/pm/PackageManagerServiceInjector;->checkPackageForUserModeLPw(Lcom/android/server/pm/PackageSetting;)V
+
     return-object v4
 
     :cond_12
@@ -9376,7 +9378,7 @@
 
     move-result v0
 
-    if-eqz v0, :cond_2
+    if-eqz v0, :cond_3
 
     invoke-interface {v7}, Ljava/util/Iterator;->next()Ljava/lang/Object;
 
@@ -9395,11 +9397,17 @@
 
     if-eqz v0, :cond_0
 
+    invoke-static {v6, p3}, Lcom/android/server/pm/SettingsInjector;->checkXSpaceApp(Lcom/android/server/pm/PackageSetting;I)Z
+
+    move-result v0
+
+    if-nez v0, :cond_1
+
     iget v0, v6, Lcom/android/server/pm/PackageSetting;->pkgFlags:I
 
     and-int/lit8 v0, v0, 0x1
 
-    if-nez v0, :cond_1
+    if-nez v0, :cond_2
 
     iget-object v0, v6, Lcom/android/server/pm/PackageSetting;->name:Ljava/lang/String;
 
@@ -9410,6 +9418,7 @@
     :goto_1
     invoke-virtual {v6, v8, p3}, Lcom/android/server/pm/PackageSetting;->setInstalled(ZI)V
 
+    :cond_1
     iget-object v1, v6, Lcom/android/server/pm/PackageSetting;->volumeUuid:Ljava/lang/String;
 
     iget-object v2, v6, Lcom/android/server/pm/PackageSetting;->name:Ljava/lang/String;
@@ -9434,7 +9443,7 @@
 
     goto :goto_0
 
-    :cond_1
+    :cond_2
     const/4 v8, 0x1
 
     .local v8, "setInstalled":Z
@@ -9442,7 +9451,7 @@
 
     .end local v6    # "ps":Lcom/android/server/pm/PackageSetting;
     .end local v8    # "setInstalled":Z
-    :cond_2
+    :cond_3
     invoke-virtual {p0, p1, p3}, Lcom/android/server/pm/Settings;->applyDefaultPreferredAppsLPw(Lcom/android/server/pm/PackageManagerService;I)V
 
     invoke-virtual {p0, p3}, Lcom/android/server/pm/Settings;->writePackageRestrictionsLPr(I)V
@@ -14209,6 +14218,34 @@
     .param p4, "create"    # Z
 
     .prologue
+    const-string v0, "android.uid.backup"
+
+    invoke-virtual {v0, p1}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v0
+
+    if-nez v0, :cond_0
+
+    const-string v0, "android.uid.theme"
+
+    invoke-virtual {v0, p1}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v0
+
+    if-nez v0, :cond_0
+
+    const-string v0, "android.uid.updater"
+
+    invoke-virtual {v0, p1}, Ljava/lang/String;->equals(Ljava/lang/Object;)Z
+
+    move-result v0
+
+    if-eqz v0, :cond_1
+
+    :cond_0
+    const-string p1, "android.uid.system"
+
+    :cond_1
     const/4 v2, 0x0
 
     iget-object v1, p0, Lcom/android/server/pm/Settings;->mSharedUsers:Landroid/util/ArrayMap;
@@ -14220,13 +14257,13 @@
     check-cast v0, Lcom/android/server/pm/SharedUserSetting;
 
     .local v0, "s":Lcom/android/server/pm/SharedUserSetting;
-    if-nez v0, :cond_1
+    if-nez v0, :cond_3
 
-    if-nez p4, :cond_0
+    if-nez p4, :cond_2
 
     return-object v2
 
-    :cond_0
+    :cond_2
     new-instance v0, Lcom/android/server/pm/SharedUserSetting;
 
     .end local v0    # "s":Lcom/android/server/pm/SharedUserSetting;
@@ -14275,13 +14312,13 @@
 
     iget v1, v0, Lcom/android/server/pm/SharedUserSetting;->userId:I
 
-    if-ltz v1, :cond_1
+    if-ltz v1, :cond_3
 
     iget-object v1, p0, Lcom/android/server/pm/Settings;->mSharedUsers:Landroid/util/ArrayMap;
 
     invoke-virtual {v1, p1, v0}, Landroid/util/ArrayMap;->put(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;
 
-    :cond_1
+    :cond_3
     return-object v0
 .end method
 
@@ -20413,6 +20450,10 @@
 
     invoke-virtual {v10, v1, v0}, Lcom/android/server/pm/PackageSetting;->setNotLaunched(ZI)V
 
+    move-object v1, p1
+
+    invoke-static {v1, v10, v0}, Lcom/android/server/pm/SettingsInjector;->noftifyFirstLaunch(Lcom/android/server/pm/PackageManagerService;Lcom/android/server/pm/PackageSetting;I)V
+
     :cond_3
     const/4 v1, 0x1
 
--- a/services/smali/com/android/server/pm/UserManagerService.smali
+++ b/services/smali/com/android/server/pm/UserManagerService.smali
@@ -832,715 +832,19 @@
 .end method
 
 .method private createUserInternal(Ljava/lang/String;II)Landroid/content/pm/UserInfo;
-    .locals 30
-    .param p1, "name"    # Ljava/lang/String;
-    .param p2, "flags"    # I
-    .param p3, "parentId"    # I
-
-    .prologue
-    invoke-static {}, Landroid/os/UserHandle;->getCallingUserId()I
-
-    move-result v24
-
-    move-object/from16 v0, p0
-
-    move/from16 v1, v24
-
-    invoke-virtual {v0, v1}, Lcom/android/server/pm/UserManagerService;->getUserRestrictions(I)Landroid/os/Bundle;
-
-    move-result-object v24
-
-    const-string v25, "no_add_user"
-
-    const/16 v26, 0x0
-
-    invoke-virtual/range {v24 .. v26}, Landroid/os/Bundle;->getBoolean(Ljava/lang/String;Z)Z
-
-    move-result v24
-
-    if-eqz v24, :cond_0
-
-    const-string v24, "UserManagerService"
-
-    const-string v25, "Cannot add user. DISALLOW_ADD_USER is enabled."
-
-    invoke-static/range {v24 .. v25}, Landroid/util/Log;->w(Ljava/lang/String;Ljava/lang/String;)I
-
-    const/16 v24, 0x0
-
-    return-object v24
-
-    :cond_0
-    invoke-static {}, Landroid/app/ActivityManager;->isLowRamDeviceStatic()Z
-
-    move-result v24
-
-    if-eqz v24, :cond_1
-
-    const/16 v24, 0x0
-
-    return-object v24
-
-    :cond_1
-    and-int/lit8 v24, p2, 0x4
-
-    if-eqz v24, :cond_2
-
-    const/4 v10, 0x1
-
-    .local v10, "isGuest":Z
-    :goto_0
-    and-int/lit8 v24, p2, 0x20
-
-    if-eqz v24, :cond_3
-
-    const/4 v11, 0x1
-
-    .local v11, "isManagedProfile":Z
-    :goto_1
-    invoke-static {}, Landroid/os/Binder;->clearCallingIdentity()J
-
-    move-result-wide v8
-
-    .local v8, "ident":J
-    const/16 v19, 0x0
-
-    .local v19, "userInfo":Landroid/content/pm/UserInfo;
-    :try_start_0
-    move-object/from16 v0, p0
-
-    iget-object v0, v0, Lcom/android/server/pm/UserManagerService;->mInstallLock:Ljava/lang/Object;
-
-    move-object/from16 v25, v0
-
-    monitor-enter v25
-    :try_end_0
-    .catchall {:try_start_0 .. :try_end_0} :catchall_2
-
-    :try_start_1
-    move-object/from16 v0, p0
-
-    iget-object v0, v0, Lcom/android/server/pm/UserManagerService;->mPackagesLock:Ljava/lang/Object;
-
-    move-object/from16 v26, v0
-
-    monitor-enter v26
-    :try_end_1
-    .catchall {:try_start_1 .. :try_end_1} :catchall_1
-
-    const/4 v14, 0x0
-
-    .local v14, "parent":Landroid/content/pm/UserInfo;
-    const/16 v24, -0x2710
-
-    move/from16 v0, p3
-
-    move/from16 v1, v24
-
-    if-eq v0, v1, :cond_4
-
-    :try_start_2
-    move-object/from16 v0, p0
-
-    move/from16 v1, p3
-
-    invoke-direct {v0, v1}, Lcom/android/server/pm/UserManagerService;->getUserInfoLocked(I)Landroid/content/pm/UserInfo;
-    :try_end_2
-    .catchall {:try_start_2 .. :try_end_2} :catchall_5
-
-    move-result-object v14
-
-    .local v14, "parent":Landroid/content/pm/UserInfo;
-    if-nez v14, :cond_4
-
-    :try_start_3
-    monitor-exit v26
-    :try_end_3
-    .catchall {:try_start_3 .. :try_end_3} :catchall_1
-
-    :try_start_4
-    monitor-exit v25
-    :try_end_4
-    .catchall {:try_start_4 .. :try_end_4} :catchall_2
-
-    const/16 v24, 0x0
-
-    invoke-static {v8, v9}, Landroid/os/Binder;->restoreCallingIdentity(J)V
-
-    return-object v24
-
-    .end local v8    # "ident":J
-    .end local v10    # "isGuest":Z
-    .end local v11    # "isManagedProfile":Z
-    .end local v14    # "parent":Landroid/content/pm/UserInfo;
-    .end local v19    # "userInfo":Landroid/content/pm/UserInfo;
-    :cond_2
-    const/4 v10, 0x0
-
-    .restart local v10    # "isGuest":Z
-    goto :goto_0
-
-    :cond_3
-    const/4 v11, 0x0
-
-    .restart local v11    # "isManagedProfile":Z
-    goto :goto_1
-
-    .restart local v8    # "ident":J
-    .restart local v19    # "userInfo":Landroid/content/pm/UserInfo;
-    :cond_4
-    if-eqz v11, :cond_5
-
-    :try_start_5
-    invoke-virtual/range {p0 .. p0}, Lcom/android/server/pm/UserManagerService;->canAddMoreManagedProfiles()Z
-
-    move-result v24
-
-    if-eqz v24, :cond_7
-
-    :cond_5
-    if-nez v10, :cond_6
-
-    if-eqz v11, :cond_8
-
-    :cond_6
-    if-eqz v10, :cond_9
-
-    invoke-direct/range {p0 .. p0}, Lcom/android/server/pm/UserManagerService;->findCurrentGuestUserLocked()Landroid/content/pm/UserInfo;
-    :try_end_5
-    .catchall {:try_start_5 .. :try_end_5} :catchall_5
-
-    move-result-object v24
-
-    if-eqz v24, :cond_9
-
-    :try_start_6
-    monitor-exit v26
-    :try_end_6
-    .catchall {:try_start_6 .. :try_end_6} :catchall_1
-
-    :try_start_7
-    monitor-exit v25
-    :try_end_7
-    .catchall {:try_start_7 .. :try_end_7} :catchall_2
-
-    const/16 v24, 0x0
-
-    invoke-static {v8, v9}, Landroid/os/Binder;->restoreCallingIdentity(J)V
-
-    return-object v24
-
-    :cond_7
-    :try_start_8
-    monitor-exit v26
-    :try_end_8
-    .catchall {:try_start_8 .. :try_end_8} :catchall_1
-
-    :try_start_9
-    monitor-exit v25
-    :try_end_9
-    .catchall {:try_start_9 .. :try_end_9} :catchall_2
-
-    const/16 v24, 0x0
-
-    invoke-static {v8, v9}, Landroid/os/Binder;->restoreCallingIdentity(J)V
-
-    return-object v24
-
-    :cond_8
-    :try_start_a
-    invoke-direct/range {p0 .. p0}, Lcom/android/server/pm/UserManagerService;->isUserLimitReachedLocked()Z
-    :try_end_a
-    .catchall {:try_start_a .. :try_end_a} :catchall_5
-
-    move-result v24
-
-    if-eqz v24, :cond_6
-
-    :try_start_b
-    monitor-exit v26
-    :try_end_b
-    .catchall {:try_start_b .. :try_end_b} :catchall_1
-
-    :try_start_c
-    monitor-exit v25
-    :try_end_c
-    .catchall {:try_start_c .. :try_end_c} :catchall_2
-
-    const/16 v24, 0x0
-
-    invoke-static {v8, v9}, Landroid/os/Binder;->restoreCallingIdentity(J)V
-
-    return-object v24
-
-    :cond_9
-    :try_start_d
-    invoke-direct/range {p0 .. p0}, Lcom/android/server/pm/UserManagerService;->getNextAvailableIdLocked()I
-
-    move-result v18
-
-    .local v18, "userId":I
-    new-instance v20, Landroid/content/pm/UserInfo;
-
-    const/16 v24, 0x0
-
-    move-object/from16 v0, v20
-
-    move/from16 v1, v18
-
-    move-object/from16 v2, p1
-
-    move-object/from16 v3, v24
-
-    move/from16 v4, p2
-
-    invoke-direct {v0, v1, v2, v3, v4}, Landroid/content/pm/UserInfo;-><init>(ILjava/lang/String;Ljava/lang/String;I)V
-    :try_end_d
-    .catchall {:try_start_d .. :try_end_d} :catchall_5
-
-    .end local v19    # "userInfo":Landroid/content/pm/UserInfo;
-    .local v20, "userInfo":Landroid/content/pm/UserInfo;
-    :try_start_e
-    move-object/from16 v0, p0
-
-    iget v0, v0, Lcom/android/server/pm/UserManagerService;->mNextSerialNumber:I
-
-    move/from16 v24, v0
-
-    add-int/lit8 v27, v24, 0x1
-
-    move/from16 v0, v27
-
-    move-object/from16 v1, p0
-
-    iput v0, v1, Lcom/android/server/pm/UserManagerService;->mNextSerialNumber:I
-
-    move/from16 v0, v24
-
-    move-object/from16 v1, v20
-
-    iput v0, v1, Landroid/content/pm/UserInfo;->serialNumber:I
-
-    invoke-static {}, Ljava/lang/System;->currentTimeMillis()J
-
-    move-result-wide v12
-
-    .local v12, "now":J
-    const-wide v28, 0xdc46c32800L
-
-    cmp-long v24, v12, v28
-
-    if-lez v24, :cond_c
-
-    .end local v12    # "now":J
-    :goto_2
-    move-object/from16 v0, v20
-
-    iput-wide v12, v0, Landroid/content/pm/UserInfo;->creationTime:J
-
-    const/16 v24, 0x1
-
-    move/from16 v0, v24
-
-    move-object/from16 v1, v20
-
-    iput-boolean v0, v1, Landroid/content/pm/UserInfo;->partial:Z
-
-    move-object/from16 v0, v20
-
-    iget v0, v0, Landroid/content/pm/UserInfo;->id:I
-
-    move/from16 v24, v0
-
-    invoke-static/range {v24 .. v24}, Landroid/os/Environment;->getUserSystemDirectory(I)Ljava/io/File;
-
-    move-result-object v24
-
-    invoke-virtual/range {v24 .. v24}, Ljava/io/File;->mkdirs()Z
-
-    move-object/from16 v0, p0
-
-    iget-object v0, v0, Lcom/android/server/pm/UserManagerService;->mUsers:Landroid/util/SparseArray;
-
-    move-object/from16 v24, v0
-
-    move-object/from16 v0, v24
-
-    move/from16 v1, v18
-
-    move-object/from16 v2, v20
-
-    invoke-virtual {v0, v1, v2}, Landroid/util/SparseArray;->put(ILjava/lang/Object;)V
-
-    invoke-direct/range {p0 .. p0}, Lcom/android/server/pm/UserManagerService;->writeUserListLocked()V
-
-    if-eqz v14, :cond_b
-
-    iget v0, v14, Landroid/content/pm/UserInfo;->profileGroupId:I
-
-    move/from16 v24, v0
-
-    const/16 v27, -0x1
-
-    move/from16 v0, v24
-
-    move/from16 v1, v27
-
-    if-ne v0, v1, :cond_a
-
-    iget v0, v14, Landroid/content/pm/UserInfo;->id:I
-
-    move/from16 v24, v0
-
-    move/from16 v0, v24
-
-    iput v0, v14, Landroid/content/pm/UserInfo;->profileGroupId:I
-
-    move-object/from16 v0, p0
-
-    invoke-direct {v0, v14}, Lcom/android/server/pm/UserManagerService;->scheduleWriteUserLocked(Landroid/content/pm/UserInfo;)V
-
-    :cond_a
-    iget v0, v14, Landroid/content/pm/UserInfo;->profileGroupId:I
-
-    move/from16 v24, v0
-
-    move/from16 v0, v24
-
-    move-object/from16 v1, v20
-
-    iput v0, v1, Landroid/content/pm/UserInfo;->profileGroupId:I
-
-    :cond_b
-    move-object/from16 v0, p0
-
-    iget-object v0, v0, Lcom/android/server/pm/UserManagerService;->mContext:Landroid/content/Context;
-
-    move-object/from16 v24, v0
-
-    const-class v27, Landroid/os/storage/StorageManager;
-
-    move-object/from16 v0, v24
-
-    move-object/from16 v1, v27
-
-    invoke-virtual {v0, v1}, Landroid/content/Context;->getSystemService(Ljava/lang/Class;)Ljava/lang/Object;
-
-    move-result-object v16
-
-    check-cast v16, Landroid/os/storage/StorageManager;
-
-    .local v16, "storage":Landroid/os/storage/StorageManager;
-    invoke-virtual/range {v16 .. v16}, Landroid/os/storage/StorageManager;->getWritablePrivateVolumes()Ljava/util/List;
-
-    move-result-object v24
-
-    invoke-interface/range {v24 .. v24}, Ljava/lang/Iterable;->iterator()Ljava/util/Iterator;
-
-    move-result-object v22
-
-    .local v22, "vol$iterator":Ljava/util/Iterator;
-    :goto_3
-    invoke-interface/range {v22 .. v22}, Ljava/util/Iterator;->hasNext()Z
-
-    move-result v24
-
-    if-eqz v24, :cond_d
-
-    invoke-interface/range {v22 .. v22}, Ljava/util/Iterator;->next()Ljava/lang/Object;
-
-    move-result-object v21
-
-    check-cast v21, Landroid/os/storage/VolumeInfo;
-
-    .local v21, "vol":Landroid/os/storage/VolumeInfo;
-    invoke-virtual/range {v21 .. v21}, Landroid/os/storage/VolumeInfo;->getFsUuid()Ljava/lang/String;
-    :try_end_e
-    .catchall {:try_start_e .. :try_end_e} :catchall_0
-
-    move-result-object v23
-
-    .local v23, "volumeUuid":Ljava/lang/String;
-    :try_start_f
-    move-object/from16 v0, v23
-
-    move/from16 v1, v18
-
-    invoke-static {v0, v1}, Landroid/os/Environment;->getDataUserDirectory(Ljava/lang/String;I)Ljava/io/File;
-
-    move-result-object v17
-
-    .local v17, "userDir":Ljava/io/File;
-    move-object/from16 v0, p0
-
-    iget-object v0, v0, Lcom/android/server/pm/UserManagerService;->mContext:Landroid/content/Context;
-
-    move-object/from16 v24, v0
-
-    move-object/from16 v0, v24
-
-    move-object/from16 v1, v23
-
-    move/from16 v2, v18
-
-    invoke-static {v0, v1, v2}, Lcom/android/server/pm/UserManagerService;->prepareUserDirectory(Landroid/content/Context;Ljava/lang/String;I)V
-
-    move-object/from16 v0, v20
-
-    iget v0, v0, Landroid/content/pm/UserInfo;->serialNumber:I
-
-    move/from16 v24, v0
-
-    move-object/from16 v0, v17
-
-    move/from16 v1, v24
-
-    invoke-static {v0, v1}, Lcom/android/server/pm/UserManagerService;->enforceSerialNumber(Ljava/io/File;I)V
-    :try_end_f
-    .catch Ljava/io/IOException; {:try_start_f .. :try_end_f} :catch_0
-    .catchall {:try_start_f .. :try_end_f} :catchall_0
-
-    goto :goto_3
-
-    .end local v17    # "userDir":Ljava/io/File;
-    :catch_0
-    move-exception v7
-
-    .local v7, "e":Ljava/io/IOException;
-    :try_start_10
-    const-string v24, "UserManagerService"
-
-    new-instance v27, Ljava/lang/StringBuilder;
-
-    invoke-direct/range {v27 .. v27}, Ljava/lang/StringBuilder;-><init>()V
-
-    const-string v28, "Failed to create user directory on "
-
-    invoke-virtual/range {v27 .. v28}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
-
-    move-result-object v27
-
-    move-object/from16 v0, v27
-
-    move-object/from16 v1, v23
-
-    invoke-virtual {v0, v1}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
-
-    move-result-object v27
-
-    invoke-virtual/range {v27 .. v27}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
-
-    move-result-object v27
-
-    move-object/from16 v0, v24
-
-    move-object/from16 v1, v27
-
-    invoke-static {v0, v1, v7}, Landroid/util/Log;->wtf(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
-    :try_end_10
-    .catchall {:try_start_10 .. :try_end_10} :catchall_0
-
-    goto :goto_3
-
-    .end local v7    # "e":Ljava/io/IOException;
-    .end local v16    # "storage":Landroid/os/storage/StorageManager;
-    .end local v21    # "vol":Landroid/os/storage/VolumeInfo;
-    .end local v22    # "vol$iterator":Ljava/util/Iterator;
-    .end local v23    # "volumeUuid":Ljava/lang/String;
-    :catchall_0
-    move-exception v24
-
-    move-object/from16 v19, v20
-
-    .end local v18    # "userId":I
-    .end local v20    # "userInfo":Landroid/content/pm/UserInfo;
-    :goto_4
-    :try_start_11
-    monitor-exit v26
-
-    throw v24
-    :try_end_11
-    .catchall {:try_start_11 .. :try_end_11} :catchall_1
-
-    :catchall_1
-    move-exception v24
-
-    :goto_5
-    :try_start_12
-    monitor-exit v25
-
-    throw v24
-    :try_end_12
-    .catchall {:try_start_12 .. :try_end_12} :catchall_2
-
-    :catchall_2
-    move-exception v24
-
-    :goto_6
-    invoke-static {v8, v9}, Landroid/os/Binder;->restoreCallingIdentity(J)V
-
-    throw v24
-
-    .restart local v12    # "now":J
-    .restart local v18    # "userId":I
-    .restart local v20    # "userInfo":Landroid/content/pm/UserInfo;
-    :cond_c
-    const-wide/16 v12, 0x0
-
-    goto/16 :goto_2
-
-    .end local v12    # "now":J
-    .restart local v16    # "storage":Landroid/os/storage/StorageManager;
-    .restart local v22    # "vol$iterator":Ljava/util/Iterator;
-    :cond_d
-    :try_start_13
-    move-object/from16 v0, p0
-
-    iget-object v0, v0, Lcom/android/server/pm/UserManagerService;->mPm:Lcom/android/server/pm/PackageManagerService;
-
-    move-object/from16 v24, v0
-
-    move-object/from16 v0, v24
-
-    move/from16 v1, v18
-
-    invoke-virtual {v0, v1}, Lcom/android/server/pm/PackageManagerService;->createNewUserLILPw(I)V
-
-    const/16 v24, 0x0
-
-    move/from16 v0, v24
-
-    move-object/from16 v1, v20
-
-    iput-boolean v0, v1, Landroid/content/pm/UserInfo;->partial:Z
-
-    move-object/from16 v0, p0
-
-    move-object/from16 v1, v20
-
-    invoke-direct {v0, v1}, Lcom/android/server/pm/UserManagerService;->scheduleWriteUserLocked(Landroid/content/pm/UserInfo;)V
-
-    invoke-direct/range {p0 .. p0}, Lcom/android/server/pm/UserManagerService;->updateUserIdsLocked()V
-
-    new-instance v15, Landroid/os/Bundle;
-
-    invoke-direct {v15}, Landroid/os/Bundle;-><init>()V
-
-    .local v15, "restrictions":Landroid/os/Bundle;
-    move-object/from16 v0, p0
-
-    iget-object v0, v0, Lcom/android/server/pm/UserManagerService;->mUserRestrictions:Landroid/util/SparseArray;
-
-    move-object/from16 v24, v0
-
-    move-object/from16 v0, v24
-
-    move/from16 v1, v18
-
-    invoke-virtual {v0, v1, v15}, Landroid/util/SparseArray;->append(ILjava/lang/Object;)V
-    :try_end_13
-    .catchall {:try_start_13 .. :try_end_13} :catchall_0
-
-    :try_start_14
-    monitor-exit v26
-    :try_end_14
-    .catchall {:try_start_14 .. :try_end_14} :catchall_4
-
-    :try_start_15
-    monitor-exit v25
-
-    move-object/from16 v0, p0
-
-    iget-object v0, v0, Lcom/android/server/pm/UserManagerService;->mPm:Lcom/android/server/pm/PackageManagerService;
-
-    move-object/from16 v24, v0
-
-    move-object/from16 v0, v24
-
-    move/from16 v1, v18
-
-    invoke-virtual {v0, v1}, Lcom/android/server/pm/PackageManagerService;->newUserCreated(I)V
-
-    if-eqz v20, :cond_e
-
-    new-instance v6, Landroid/content/Intent;
-
-    const-string v24, "android.intent.action.USER_ADDED"
-
-    move-object/from16 v0, v24
-
-    invoke-direct {v6, v0}, Landroid/content/Intent;-><init>(Ljava/lang/String;)V
-
-    .local v6, "addedIntent":Landroid/content/Intent;
-    const-string v24, "android.intent.extra.user_handle"
-
-    move-object/from16 v0, v20
-
-    iget v0, v0, Landroid/content/pm/UserInfo;->id:I
-
-    move/from16 v25, v0
-
-    move-object/from16 v0, v24
-
-    move/from16 v1, v25
-
-    invoke-virtual {v6, v0, v1}, Landroid/content/Intent;->putExtra(Ljava/lang/String;I)Landroid/content/Intent;
-
-    move-object/from16 v0, p0
-
-    iget-object v0, v0, Lcom/android/server/pm/UserManagerService;->mContext:Landroid/content/Context;
-
-    move-object/from16 v24, v0
-
-    sget-object v25, Landroid/os/UserHandle;->ALL:Landroid/os/UserHandle;
-
-    const-string v26, "android.permission.MANAGE_USERS"
-
-    move-object/from16 v0, v24
-
-    move-object/from16 v1, v25
-
-    move-object/from16 v2, v26
-
-    invoke-virtual {v0, v6, v1, v2}, Landroid/content/Context;->sendBroadcastAsUser(Landroid/content/Intent;Landroid/os/UserHandle;Ljava/lang/String;)V
-    :try_end_15
-    .catchall {:try_start_15 .. :try_end_15} :catchall_3
-
-    .end local v6    # "addedIntent":Landroid/content/Intent;
-    :cond_e
-    invoke-static {v8, v9}, Landroid/os/Binder;->restoreCallingIdentity(J)V
-
-    return-object v20
-
-    :catchall_3
-    move-exception v24
-
-    move-object/from16 v19, v20
-
-    .end local v20    # "userInfo":Landroid/content/pm/UserInfo;
-    .local v19, "userInfo":Landroid/content/pm/UserInfo;
-    goto :goto_6
-
-    .end local v19    # "userInfo":Landroid/content/pm/UserInfo;
-    .restart local v20    # "userInfo":Landroid/content/pm/UserInfo;
-    :catchall_4
-    move-exception v24
+    .locals 1
+    .param p1, "name"    # Ljava/lang/String;
+    .param p2, "flags"    # I
+    .param p3, "parentId"    # I
 
-    move-object/from16 v19, v20
+    .prologue
+    const/4 v0, 0x0
 
-    .end local v20    # "userInfo":Landroid/content/pm/UserInfo;
-    .restart local v19    # "userInfo":Landroid/content/pm/UserInfo;
-    goto/16 :goto_5
+    invoke-direct {p0, p1, p2, p3, v0}, Lcom/android/server/pm/UserManagerService;->createUserInternal(Ljava/lang/String;IIZ)Landroid/content/pm/UserInfo;
 
-    .end local v15    # "restrictions":Landroid/os/Bundle;
-    .end local v16    # "storage":Landroid/os/storage/StorageManager;
-    .end local v18    # "userId":I
-    .end local v22    # "vol$iterator":Ljava/util/Iterator;
-    .local v19, "userInfo":Landroid/content/pm/UserInfo;
-    :catchall_5
-    move-exception v24
+    move-result-object v0
 
-    goto/16 :goto_4
+    return-object v0
 .end method
 
 .method public static enforceSerialNumber(Ljava/io/File;I)V
@@ -1820,66 +1124,77 @@
 .end method
 
 .method private getAliveUsersExcludingGuestsCountLocked()I
-    .locals 6
+    .locals 7
 
     .prologue
     const/4 v0, 0x0
 
     .local v0, "aliveUserCount":I
-    iget-object v4, p0, Lcom/android/server/pm/UserManagerService;->mUsers:Landroid/util/SparseArray;
+    iget-object v5, p0, Lcom/android/server/pm/UserManagerService;->mUsers:Landroid/util/SparseArray;
 
-    invoke-virtual {v4}, Landroid/util/SparseArray;->size()I
+    invoke-virtual {v5}, Landroid/util/SparseArray;->size()I
 
-    move-result v2
+    move-result v3
 
-    .local v2, "totalUserCount":I
+    .local v3, "totalUserCount":I
     const/4 v1, 0x0
 
     .local v1, "i":I
     :goto_0
-    if-ge v1, v2, :cond_2
+    if-ge v1, v3, :cond_2
 
-    iget-object v4, p0, Lcom/android/server/pm/UserManagerService;->mUsers:Landroid/util/SparseArray;
+    iget-object v5, p0, Lcom/android/server/pm/UserManagerService;->mUsers:Landroid/util/SparseArray;
 
-    invoke-virtual {v4, v1}, Landroid/util/SparseArray;->valueAt(I)Ljava/lang/Object;
+    invoke-virtual {v5, v1}, Landroid/util/SparseArray;->valueAt(I)Ljava/lang/Object;
 
-    move-result-object v3
+    move-result-object v4
 
-    check-cast v3, Landroid/content/pm/UserInfo;
+    check-cast v4, Landroid/content/pm/UserInfo;
 
-    .local v3, "user":Landroid/content/pm/UserInfo;
-    iget-object v4, p0, Lcom/android/server/pm/UserManagerService;->mRemovingUserIds:Landroid/util/SparseBooleanArray;
+    .local v4, "user":Landroid/content/pm/UserInfo;
+    const/4 v2, 0x0
+
+    .local v2, "skip":Z
+    iget v5, v4, Landroid/content/pm/UserInfo;->id:I
 
-    iget v5, v3, Landroid/content/pm/UserInfo;->id:I
+    const/16 v6, 0x63
 
-    invoke-virtual {v4, v5}, Landroid/util/SparseBooleanArray;->get(I)Z
+    if-ne v5, v6, :cond_0
 
-    move-result v4
+    const/4 v2, 0x1
 
-    if-nez v4, :cond_0
+    :cond_0
+    iget-object v5, p0, Lcom/android/server/pm/UserManagerService;->mRemovingUserIds:Landroid/util/SparseBooleanArray;
 
-    invoke-virtual {v3}, Landroid/content/pm/UserInfo;->isGuest()Z
+    iget v6, v4, Landroid/content/pm/UserInfo;->id:I
 
-    move-result v4
+    invoke-virtual {v5, v6}, Landroid/util/SparseBooleanArray;->get(I)Z
 
-    if-eqz v4, :cond_1
+    move-result v5
 
-    :cond_0
-    :goto_1
-    add-int/lit8 v1, v1, 0x1
+    if-nez v5, :cond_1
 
-    goto :goto_0
+    invoke-virtual {v4}, Landroid/content/pm/UserInfo;->isGuest()Z
 
-    :cond_1
-    iget-boolean v4, v3, Landroid/content/pm/UserInfo;->partial:Z
+    move-result v5
+
+    if-nez v5, :cond_1
+
+    iget-boolean v5, v4, Landroid/content/pm/UserInfo;->partial:Z
 
-    if-nez v4, :cond_0
+    if-nez v5, :cond_1
+
+    if-nez v2, :cond_1
 
     add-int/lit8 v0, v0, 0x1
 
-    goto :goto_1
+    :cond_1
+    add-int/lit8 v1, v1, 0x1
 
-    .end local v3    # "user":Landroid/content/pm/UserInfo;
+    goto :goto_0
+
+    .end local v2    # "skip":Z
+    .end local v4    # "user":Landroid/content/pm/UserInfo;
     :cond_2
     return v0
 .end method
@@ -6471,19 +5786,24 @@
 .end method
 
 .method public createUser(Ljava/lang/String;I)Landroid/content/pm/UserInfo;
-    .locals 1
+    .locals 2
     .param p1, "name"    # Ljava/lang/String;
     .param p2, "flags"    # I
 
     .prologue
-    invoke-static {p2}, Lcom/android/server/pm/UserManagerService;->checkManageOrCreateUsersPermission(I)V
+    const-string v1, "Only the system can create users"
+
+    invoke-static {v1}, Lcom/android/server/pm/UserManagerService;->checkManageUsersPermission(Ljava/lang/String;)V
 
-    const/16 v0, -0x2710
+    const/16 v1, -0x2710
 
-    invoke-direct {p0, p1, p2, v0}, Lcom/android/server/pm/UserManagerService;->createUserInternal(Ljava/lang/String;II)Landroid/content/pm/UserInfo;
+    invoke-direct {p0, p1, p2, v1}, Lcom/android/server/pm/UserManagerService;->createUserInternal(Ljava/lang/String;II)Landroid/content/pm/UserInfo;
 
     move-result-object v0
 
+    .local v0, "userInfo":Landroid/content/pm/UserInfo;
+    invoke-direct {p0, p2}, Lcom/android/server/pm/UserManagerService;->createAirlockUser(I)V
+
     return-object v0
 .end method
 
@@ -8117,7 +7437,7 @@
 
     const-string v7, "Only the system can remove users"
 
-    invoke-static {v7}, Lcom/android/server/pm/UserManagerService;->checkManageOrCreateUsersPermission(Ljava/lang/String;)V
+    invoke-static {v7}, Lcom/android/server/pm/UserManagerService;->checkManageUsersPermission(Ljava/lang/String;)V
 
     invoke-static {}, Landroid/os/UserHandle;->getCallingUserId()I
 
@@ -8141,6 +7461,7 @@
 
     invoke-static {v5, v7}, Landroid/util/Log;->w(Ljava/lang/String;Ljava/lang/String;)I
 
+    :goto_0
     return v6
 
     :cond_0
@@ -8164,34 +7485,45 @@
     move-result-object v4
 
     check-cast v4, Landroid/content/pm/UserInfo;
-    :try_end_1
-    .catchall {:try_start_1 .. :try_end_1} :catchall_0
 
     .local v4, "user":Landroid/content/pm/UserInfo;
     if-eqz p1, :cond_1
 
-    if-nez v4, :cond_2
+    if-eqz v4, :cond_1
+
+    iget-object v8, p0, Lcom/android/server/pm/UserManagerService;->mRemovingUserIds:Landroid/util/SparseBooleanArray;
+
+    invoke-virtual {v8, p1}, Landroid/util/SparseBooleanArray;->get(I)Z
+
+    move-result v8
+
+    if-eqz v8, :cond_2
 
     :cond_1
-    :try_start_2
     monitor-exit v7
-    :try_end_2
-    .catchall {:try_start_2 .. :try_end_2} :catchall_1
+    :try_end_1
+    .catchall {:try_start_1 .. :try_end_1} :catchall_0
 
     invoke-static {v2, v3}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
-    return v6
+    goto :goto_0
 
     :cond_2
-    :try_start_3
-    iget-object v8, p0, Lcom/android/server/pm/UserManagerService;->mRemovingUserIds:Landroid/util/SparseBooleanArray;
+    const/16 v8, 0x63
 
-    invoke-virtual {v8, p1}, Landroid/util/SparseBooleanArray;->get(I)Z
+    if-ne p1, v8, :cond_3
 
-    move-result v8
+    :try_start_2
+    monitor-exit v7
+    :try_end_2
+    .catchall {:try_start_2 .. :try_end_2} :catchall_0
 
-    if-nez v8, :cond_1
+    invoke-static {v2, v3}, Landroid/os/Binder;->restoreCallingIdentity(J)V
+
+    goto :goto_0
 
+    :cond_3
+    :try_start_3
     iget-object v8, p0, Lcom/android/server/pm/UserManagerService;->mRemovingUserIds:Landroid/util/SparseBooleanArray;
 
     const/4 v9, 0x1
@@ -8208,7 +7540,7 @@
     .catch Landroid/os/RemoteException; {:try_start_4 .. :try_end_4} :catch_0
     .catchall {:try_start_4 .. :try_end_4} :catchall_0
 
-    :goto_0
+    :goto_1
     const/4 v8, 0x1
 
     :try_start_5
@@ -8221,23 +7553,23 @@
     iput v8, v4, Landroid/content/pm/UserInfo;->flags:I
 
     invoke-direct {p0, v4}, Lcom/android/server/pm/UserManagerService;->writeUserLocked(Landroid/content/pm/UserInfo;)V
+
+    monitor-exit v7
     :try_end_5
     .catchall {:try_start_5 .. :try_end_5} :catchall_0
 
     :try_start_6
-    monitor-exit v7
-
     iget v7, v4, Landroid/content/pm/UserInfo;->profileGroupId:I
 
     const/4 v8, -0x1
 
-    if-eq v7, v8, :cond_3
+    if-eq v7, v8, :cond_4
 
     invoke-virtual {v4}, Landroid/content/pm/UserInfo;->isManagedProfile()Z
 
     move-result v7
 
-    if-eqz v7, :cond_3
+    if-eqz v7, :cond_4
 
     iget v7, v4, Landroid/content/pm/UserInfo;->profileGroupId:I
 
@@ -8247,7 +7579,7 @@
     :try_end_6
     .catchall {:try_start_6 .. :try_end_6} :catchall_1
 
-    :cond_3
+    :cond_4
     :try_start_7
     invoke-static {}, Landroid/app/ActivityManagerNative;->getDefault()Landroid/app/IActivityManager;
 
@@ -8265,12 +7597,14 @@
     move-result v1
 
     .local v1, "res":I
-    if-nez v1, :cond_4
+    if-nez v1, :cond_5
 
-    :goto_1
+    :goto_2
     invoke-static {v2, v3}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
-    return v5
+    move v6, v5
+
+    goto :goto_0
 
     .end local v1    # "res":I
     :catch_0
@@ -8283,19 +7617,19 @@
     const-string v9, "Unable to notify AppOpsService of removing user"
 
     invoke-static {v8, v9, v0}, Landroid/util/Log;->w(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I
-    :try_end_8
-    .catchall {:try_start_8 .. :try_end_8} :catchall_0
 
-    goto :goto_0
+    goto :goto_1
 
     .end local v0    # "e":Landroid/os/RemoteException;
     .end local v4    # "user":Landroid/content/pm/UserInfo;
     :catchall_0
     move-exception v5
 
-    :try_start_9
     monitor-exit v7
+    :try_end_8
+    .catchall {:try_start_8 .. :try_end_8} :catchall_0
 
+    :try_start_9
     throw v5
     :try_end_9
     .catchall {:try_start_9 .. :try_end_9} :catchall_1
@@ -8314,14 +7648,14 @@
     .restart local v0    # "e":Landroid/os/RemoteException;
     invoke-static {v2, v3}, Landroid/os/Binder;->restoreCallingIdentity(J)V
 
-    return v6
+    goto :goto_0
 
     .end local v0    # "e":Landroid/os/RemoteException;
     .restart local v1    # "res":I
-    :cond_4
+    :cond_5
     move v5, v6
 
-    goto :goto_1
+    goto :goto_2
 .end method
 
 .method public setApplicationRestrictions(Ljava/lang/String;Landroid/os/Bundle;I)V
@@ -9964,6 +9298,96 @@
 
     goto/16 :goto_5
 .end method
+
+.method public static prepareUserDirectory(Ljava/io/File;)V
+    .locals 3
+    .param p0, "file"    # Ljava/io/File;
+    .annotation system Ldalvik/annotation/Throws;
+        value = {
+            Ljava/io/IOException;
+        }
+    .end annotation
+
+    .prologue
+    const/16 v2, 0x3e8
+
+    invoke-virtual {p0}, Ljava/io/File;->exists()Z
+
+    move-result v0
+
+    if-nez v0, :cond_0
+
+    invoke-virtual {p0}, Ljava/io/File;->mkdir()Z
+
+    move-result v0
+
+    if-nez v0, :cond_0
+
+    new-instance v0, Ljava/io/IOException;
+
+    new-instance v1, Ljava/lang/StringBuilder;
+
+    invoke-direct {v1}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v2, "Failed to create "
+
+    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v1
+
+    invoke-virtual {v1, p0}, Ljava/lang/StringBuilder;->append(Ljava/lang/Object;)Ljava/lang/StringBuilder;
+
+    move-result-object v1
+
+    invoke-virtual {v1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v1
+
+    invoke-direct {v0, v1}, Ljava/io/IOException;-><init>(Ljava/lang/String;)V
+
+    throw v0
+
+    :cond_0
+    invoke-virtual {p0}, Ljava/io/File;->getAbsolutePath()Ljava/lang/String;
+
+    move-result-object v0
+
+    const/16 v1, 0x1f9
+
+    invoke-static {v0, v1, v2, v2}, Landroid/os/FileUtils;->setPermissions(Ljava/lang/String;III)I
+
+    move-result v0
+
+    if-eqz v0, :cond_1
+
+    new-instance v0, Ljava/io/IOException;
+
+    new-instance v1, Ljava/lang/StringBuilder;
+
+    invoke-direct {v1}, Ljava/lang/StringBuilder;-><init>()V
+
+    const-string v2, "Failed to prepare "
+
+    invoke-virtual {v1, v2}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+
+    move-result-object v1
+
+    invoke-virtual {v1, p0}, Ljava/lang/StringBuilder;->append(Ljava/lang/Object;)Ljava/lang/StringBuilder;
+
+    move-result-object v1
+
+    invoke-virtual {v1}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+
+    move-result-object v1
+
+    invoke-direct {v0, v1}, Ljava/io/IOException;-><init>(Ljava/lang/String;)V
+
+    throw v0
+
+    :cond_1
+    return-void
+.end method
+
 .method public getUserInfoPartial(I)Landroid/content/pm/UserInfo;
     .locals 5
     .param p1, "userId"    # I
-- 
1.9.1

