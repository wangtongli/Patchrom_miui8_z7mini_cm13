From c40c703ebd1c7aff452be343f7e2ddaceefbd99d Mon Sep 17 00:00:00 2001
From: wangtongli <tongliwang@tju.edu.cn>
Date: Thu, 3 Nov 2016 19:43:54 +0800
Subject: [PATCH] fix-long-screenshot

---
 framework/smali/android/app/Activity.smali         | 10 ++++--
 framework/smali/android/app/Application.smali      |  9 +++--
 .../android/app/ApplicationPackageManager.smali    | 15 +++++++++
 framework/smali/android/app/BackStackState.smali   | 16 +++++++++
 framework/smali/android/app/ContextImpl.smali      |  7 +++-
 framework/smali/android/app/Dialog.smali           |  4 +--
 .../smali/android/app/FragmentManagerImpl$6.smali  |  7 +++-
 framework/smali/android/app/LoadedApk.smali        |  7 +++-
 framework/smali/android/app/Notification.smali     | 39 +++++++++++++++++++---
 9 files changed, 100 insertions(+), 14 deletions(-)

--- a/framework/smali/android/app/Activity.smali
+++ b/framework/smali/android/app/Activity.smali
@@ -1192,9 +1192,9 @@
 
     invoke-virtual {v1, v2}, Landroid/app/FragmentController;->attachHost(Landroid/app/Fragment;)V
 
-    new-instance v1, Lcom/android/internal/policy/PhoneWindow;
+    new-instance v1, Lcom/android/internal/policy/MiuiPhoneWindow;
 
-    invoke-direct {v1, p0}, Lcom/android/internal/policy/PhoneWindow;-><init>(Landroid/content/Context;)V
+    invoke-direct {v1, p0}, Lcom/android/internal/policy/MiuiPhoneWindow;-><init>(Landroid/content/Context;)V
 
     iput-object v1, p0, Landroid/app/Activity;->mWindow:Landroid/view/Window;
 
@@ -5539,6 +5539,11 @@
     .locals 1
 
     .prologue
+    invoke-static {}, Lcom/miui/whetstone/app/WhetstoneAppManager;->getInstance()Lcom/miui/whetstone/app/WhetstoneAppManager;
+
+    move-result-object v0
+
+    invoke-virtual {v0, p0}, Lcom/miui/whetstone/app/WhetstoneAppManager;->onResume(Landroid/app/Activity;)V
     invoke-virtual {p0}, Landroid/app/Activity;->getApplication()Landroid/app/Application;
 
     move-result-object v0
@@ -5553,6 +5558,7 @@
 
     iput-boolean v0, p0, Landroid/app/Activity;->mCalled:Z
 
+    invoke-static {p0}, Landroid/app/ActivityInjector;->checkAccessControl(Landroid/app/Activity;)V
     return-void
 .end method
 
--- a/framework/smali/android/app/Application.smali
+++ b/framework/smali/android/app/Application.smali
@@ -533,9 +533,15 @@
 .end method
 
 .method public onCreate()V
-    .locals 0
+    .locals 1
 
     .prologue
+    invoke-static {}, Lcom/miui/whetstone/app/WhetstoneAppManager;->getInstance()Lcom/miui/whetstone/app/WhetstoneAppManager;
+
+    move-result-object v0
+
+    invoke-virtual {v0, p0}, Lcom/miui/whetstone/app/WhetstoneAppManager;->attach(Landroid/content/Context;)V
+
     return-void
 .end method
 
--- a/framework/smali/android/app/ApplicationPackageManager.smali
+++ b/framework/smali/android/app/ApplicationPackageManager.smali
@@ -223,6 +223,17 @@
     return v1
 
     :cond_0
+    invoke-static {v0}, Lmiui/securityspace/XSpaceUserHandle;->isXSpaceUser(Landroid/content/pm/UserInfo;)Z
+
+    move-result v1
+
+    if-eqz v1, :cond_miui_0
+
+    sget v1, Landroid/miui/R$drawable;->ic_corp_icon_xspace:I
+
+    return v1
+
+    :cond_miui_0
     const/4 v1, 0x0
 
     return v1
@@ -4309,6 +4320,10 @@
     move-result-object v10
 
     .local v10, "r":Landroid/content/res/Resources;
+    iget-object v0, p1, Landroid/content/pm/ApplicationInfo;->packageName:Ljava/lang/String;
+
+    invoke-static {v10, v0}, Landroid/miui/ResourcesManager;->initMiuiResource(Landroid/content/res/Resources;Ljava/lang/String;)V
+
     if-eqz v10, :cond_4
 
     return-object v10
--- a/framework/smali/android/app/BackStackState.smali
+++ b/framework/smali/android/app/BackStackState.smali
@@ -718,6 +718,22 @@
 
     .end local v8    # "pos":I
     .restart local v7    # "pos":I
+    iget v10, v6, Landroid/app/BackStackRecord$Op;->enterAnim:I
+
+    iput v10, v1, Landroid/app/BackStackRecord;->mEnterAnim:I
+
+    iget v10, v6, Landroid/app/BackStackRecord$Op;->exitAnim:I
+
+    iput v10, v1, Landroid/app/BackStackRecord;->mExitAnim:I
+
+    iget v10, v6, Landroid/app/BackStackRecord$Op;->popEnterAnim:I
+
+    iput v10, v1, Landroid/app/BackStackRecord;->mPopEnterAnim:I
+
+    iget v10, v6, Landroid/app/BackStackRecord$Op;->popExitAnim:I
+
+    iput v10, v1, Landroid/app/BackStackRecord;->mPopExitAnim:I
+
     invoke-virtual {v1, v6}, Landroid/app/BackStackRecord;->addOp(Landroid/app/BackStackRecord$Op;)V
 
     add-int/lit8 v5, v5, 0x1
--- a/framework/smali/android/app/ContextImpl.smali
+++ b/framework/smali/android/app/ContextImpl.smali
@@ -395,6 +395,12 @@
 
     move-result-object v14
 
+    iget-object v2, p0, Landroid/app/ContextImpl;->mPackageInfo:Landroid/app/LoadedApk;
+
+    iget-object v2, v2, Landroid/app/LoadedApk;->mPackageName:Ljava/lang/String;
+
+    invoke-static {v14, v2}, Landroid/miui/ResourcesManager;->initMiuiResource(Landroid/content/res/Resources;Ljava/lang/String;)V
+
     :cond_4
     :goto_4
     iput-object v14, p0, Landroid/app/ContextImpl;->mResources:Landroid/content/res/Resources;
--- a/framework/smali/android/app/Dialog.smali
+++ b/framework/smali/android/app/Dialog.smali
@@ -180,11 +180,11 @@
 
     iput-object v2, p0, Landroid/app/Dialog;->mWindowManager:Landroid/view/WindowManager;
 
-    new-instance v1, Lcom/android/internal/policy/PhoneWindow;
+    new-instance v1, Lcom/android/internal/policy/MiuiPhoneWindow;
 
     iget-object v2, p0, Landroid/app/Dialog;->mContext:Landroid/content/Context;
 
-    invoke-direct {v1, v2}, Lcom/android/internal/policy/PhoneWindow;-><init>(Landroid/content/Context;)V
+    invoke-direct {v1, v2}, Lcom/android/internal/policy/MiuiPhoneWindow;-><init>(Landroid/content/Context;)V
 
     .local v1, "w":Landroid/view/Window;
     iput-object v1, p0, Landroid/app/Dialog;->mWindow:Landroid/view/Window;
--- a/framework/smali/android/app/FragmentManagerImpl$6.smali
+++ b/framework/smali/android/app/FragmentManagerImpl$6.smali
@@ -51,6 +51,12 @@
 
     iget-object v0, p0, Landroid/app/FragmentManagerImpl$6;->val$finalFragment:Landroid/app/Fragment;
 
+    iget-boolean v0, v0, Landroid/app/Fragment;->mHidden:Z
+
+    if-eqz v0, :cond_0
+
+    iget-object v0, p0, Landroid/app/FragmentManagerImpl$6;->val$finalFragment:Landroid/app/Fragment;
+
     iget-object v0, v0, Landroid/app/Fragment;->mView:Landroid/view/View;
 
     const/16 v1, 0x8
--- a/framework/smali/android/app/LoadedApk.smali
+++ b/framework/smali/android/app/LoadedApk.smali
@@ -2442,6 +2442,12 @@
 
     iput-object v0, p0, Landroid/app/LoadedApk;->mResources:Landroid/content/res/Resources;
 
+    iget-object v0, p0, Landroid/app/LoadedApk;->mResources:Landroid/content/res/Resources;
+
+    iget-object v1, p0, Landroid/app/LoadedApk;->mPackageName:Ljava/lang/String;
+
+    invoke-static {v0, v1}, Landroid/miui/ResourcesManager;->initMiuiResource(Landroid/content/res/Resources;Ljava/lang/String;)V
+
     :cond_0
     iget-object v0, p0, Landroid/app/LoadedApk;->mResources:Landroid/content/res/Resources;
 
--- a/framework/smali/android/app/Notification.smali
+++ b/framework/smali/android/app/Notification.smali
@@ -213,6 +213,8 @@
 
 .field public deleteIntent:Landroid/app/PendingIntent;
 
+.field public extraNotification:Landroid/app/MiuiNotification;
+
 .field public extras:Landroid/os/Bundle;
 
 .field public flags:I
@@ -406,6 +408,12 @@
 
     iput-object v0, p0, Landroid/app/Notification;->extras:Landroid/os/Bundle;
 
+    new-instance v0, Landroid/app/MiuiNotification;
+
+    invoke-direct {v0}, Landroid/app/MiuiNotification;-><init>()V
+
+    iput-object v0, p0, Landroid/app/Notification;->extraNotification:Landroid/app/MiuiNotification;
+
     invoke-static {}, Ljava/lang/System;->currentTimeMillis()J
 
     move-result-wide v0
@@ -446,6 +454,12 @@
 
     iput-object v0, p0, Landroid/app/Notification;->extras:Landroid/os/Bundle;
 
+    new-instance v0, Landroid/app/MiuiNotification;
+
+    invoke-direct {v0}, Landroid/app/MiuiNotification;-><init>()V
+
+    iput-object v0, p0, Landroid/app/Notification;->extraNotification:Landroid/app/MiuiNotification;
+
     iput p1, p0, Landroid/app/Notification;->icon:I
 
     iput-object p2, p0, Landroid/app/Notification;->tickerText:Ljava/lang/CharSequence;
@@ -486,6 +500,12 @@
 
     iput-object v0, p0, Landroid/app/Notification;->extras:Landroid/os/Bundle;
 
+    new-instance v0, Landroid/app/MiuiNotification;
+
+    invoke-direct {v0}, Landroid/app/MiuiNotification;-><init>()V
+
+    iput-object v0, p0, Landroid/app/Notification;->extraNotification:Landroid/app/MiuiNotification;
+
     new-instance v0, Landroid/app/Notification$Builder;
 
     invoke-direct {v0, p1}, Landroid/app/Notification$Builder;-><init>(Landroid/content/Context;)V
@@ -904,6 +924,10 @@
 
     iput v1, p0, Landroid/app/Notification;->color:I
 
+    iget-object v1, p0, Landroid/app/Notification;->extraNotification:Landroid/app/MiuiNotification;
+
+    invoke-virtual {v1, p1}, Landroid/app/MiuiNotification;->readFromParcel(Landroid/os/Parcel;)V
+
     return-void
 .end method
 
@@ -1516,6 +1540,12 @@
     invoke-virtual {p1}, Landroid/app/Notification;->lightenPayload()V
 
     :cond_b
+    iget-object v5, p1, Landroid/app/Notification;->extraNotification:Landroid/app/MiuiNotification;
+
+    iget-object v6, p0, Landroid/app/Notification;->extraNotification:Landroid/app/MiuiNotification;
+
+    invoke-virtual {v5, v6}, Landroid/app/MiuiNotification;->setTo(Landroid/app/MiuiNotification;)V
+
     return-void
 .end method
 
@@ -2392,6 +2422,10 @@
 
     invoke-virtual {p1, v0}, Landroid/os/Parcel;->writeInt(I)V
 
+    iget-object v0, p0, Landroid/app/Notification;->extraNotification:Landroid/app/MiuiNotification;
+
+    invoke-virtual {v0, p1, p2}, Landroid/app/MiuiNotification;->writeToParcel(Landroid/os/Parcel;I)V
+
     return-void
 
     :cond_1
-- 
1.9.1

